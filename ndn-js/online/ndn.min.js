/*
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
  MIT
 <a href="https://github.com/bitcoinjs/bitcoinjs-lib/blob/master/LICENSE">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
*/
(function(na,u){"object"===typeof exports?module.exports.printStackTrace=u():"function"===typeof define&&define.amd?define(u):na.printStackTrace=u()})(this,function(){function na(u){u=u||{guess:!0};var J=u.e||null,T=!!u.guess,U=u.mode||null;u=new na.implementation;J=u.run(J,U);return T?u.guessAnonymousFunctions(J):J}na.implementation=function(){};na.implementation.prototype={run:function(u,J){u=u||this.createException();J=J||this.mode(u);return"other"===J?this.other(arguments.callee):this[J](u)},
createException:function(){try{this.undef()}catch(u){return u}},mode:function(u){return"undefined"!==typeof window&&-1<window.navigator.userAgent.indexOf("PhantomJS")?"phantomjs":u.arguments&&u.stack?"chrome":u.stack&&u.sourceURL?"safari":u.stack&&u.number?"ie":u.stack&&u.fileName?"firefox":u.message&&u["opera#sourceloc"]?!u.stacktrace||-1<u.message.indexOf("\n")&&u.message.split("\n").length>u.stacktrace.split("\n").length?"opera9":"opera10a":u.message&&u.stack&&u.stacktrace?0>u.stacktrace.indexOf("called from line")?
"opera10b":"opera11":u.stack&&!u.fileName?"chrome":"other"},instrumentFunction:function(u,J,T){u=u||window;var U=u[J];u[J]=function(){T.call(this,na().slice(4));return u[J]._instrumented.apply(this,arguments)};u[J]._instrumented=U},deinstrumentFunction:function(u,J){u[J].constructor===Function&&u[J]._instrumented&&u[J]._instrumented.constructor===Function&&(u[J]=u[J]._instrumented)},chrome:function(u){return(u.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,
"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(u){return u.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(u){return u.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(u){return u.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(u){var J=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;u=u.stacktrace.split("\n");for(var T=[],U=0,X=u.length;U<X;U+=2){var K=J.exec(u[U]);if(K){var A=K[4]+":"+K[1]+":"+K[2],K=K[3]||"global code",K=K.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");T.push(K+"@"+A+" -- "+u[U+1].replace(/^\s+/,""))}}return T},opera10b:function(u){var J=/^(.*)@(.+):(\d+)$/;u=u.stacktrace.split("\n");
for(var T=[],U=0,X=u.length;U<X;U++){var K=J.exec(u[U]);K&&T.push((K[1]?K[1]+"()":"global code")+"@"+K[2]+":"+K[3])}return T},opera10a:function(u){var J=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;u=u.stacktrace.split("\n");for(var T=[],U=0,X=u.length;U<X;U+=2){var K=J.exec(u[U]);K&&T.push((K[3]||"{anonymous}")+"()@"+K[2]+":"+K[1]+" -- "+u[U+1].replace(/^\s+/,""))}return T},opera9:function(u){var J=/Line (\d+).*script (?:in )?(\S+)/i;u=u.message.split("\n");for(var T=[],U=2,X=u.length;U<
X;U+=2){var K=J.exec(u[U]);K&&T.push("{anonymous}()@"+K[2]+":"+K[1]+" -- "+u[U+1].replace(/^\s+/,""))}return T},phantomjs:function(u){var J=/(\S+) \((\S+)\)/i;u=u.stack.split("\n");for(var T=[],U=1,X=u.length;U<X;U++){u[U]=u[U].replace(/^\s+at\s+/gm,"");var K=J.exec(u[U]);K?T.push(K[1]+"()@"+K[2]):T.push("{anonymous}()@"+u[U])}return T},other:function(u){for(var J=/function(?:\s+([\w$]+))?\s*\(/,T=[],U,X,K=Array.prototype.slice;u&&10>T.length;){U=J.test(u.toString())?RegExp.$1||"{anonymous}":"{anonymous}";
try{X=K.call(u.arguments||[])}catch(A){X=["Cannot access arguments: "+A]}T[T.length]=U+"("+this.stringifyArguments(X)+")";try{u=u.caller}catch(na){T[T.length]="Cannot access caller: "+na;break}}return T},stringifyArguments:function(u){for(var J=[],T=Array.prototype.slice,U=0;U<u.length;++U){var X=u[U];void 0===X?J[U]="undefined":null===X?J[U]="null":X.constructor&&(J[U]=X.constructor===Array?3>X.length?"["+this.stringifyArguments(X)+"]":"["+this.stringifyArguments(T.call(X,0,1))+"..."+this.stringifyArguments(T.call(X,
-1))+"]":X.constructor===Object?"#object":X.constructor===Function?"#function":X.constructor===String?'"'+X+'"':X.constructor===Number?X:"?")}return J.join(",")},sourceCache:{},ajax:function(u){var J=this.createXMLHTTPObject();if(J)try{return J.open("GET",u,!1),J.send(null),J.responseText}catch(T){}return""},createXMLHTTPObject:function(){for(var u,J=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},
function(){return new ActiveXObject("Microsoft.XMLHTTP")}],T=0;T<J.length;T++)try{return u=J[T](),this.createXMLHTTPObject=J[T],u}catch(U){}},isSameDomain:function(u){return"undefined"!==typeof location&&-1!==u.indexOf(location.hostname)},getSource:function(u){u in this.sourceCache||(this.sourceCache[u]=this.ajax(u).split("\n"));return this.sourceCache[u]},guessAnonymousFunctions:function(u){for(var J=0;J<u.length;++J){var T=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,U=u[J],X=/\{anonymous\}\(.*\)@(.*)/.exec(U);
if(X){var K=T.exec(X[1]);K&&(T=K[1],X=K[2],K=K[3]||0,T&&this.isSameDomain(T)&&X&&(T=this.guessAnonymousFunction(T,X,K),u[J]=U.replace("{anonymous}",T)))}}return u},guessAnonymousFunction:function(u,J,T){var U;try{U=this.findFunctionName(this.getSource(u),J)}catch(X){U="getSource failed with url: "+u+", exception: "+X.toString()}return U},findFunctionName:function(u,J){for(var T=/function\s+([^(]*?)\s*\(([^)]*)\)/,U=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,X=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,
K="",A,na=Math.min(J,20),qd,Kb=0;Kb<na;++Kb)if(A=u[J-Kb-1],qd=A.indexOf("//"),0<=qd&&(A=A.substr(0,qd)),A)if(K=A+K,(A=U.exec(K))&&A[1]||(A=T.exec(K))&&A[1]||(A=X.exec(K))&&A[1])return A[1];return"(?)"}};return na});
(function(na){function u(e){var k="",h,d=0,q,p;for(h=0;h<e.length&&e.charAt(h)!=Fd;++h)p=Xb.indexOf(e.charAt(h)),0>p||(0==d?(k+=Yb.charAt(p>>2),q=p&3,d=1):1==d?(k+=Yb.charAt(q<<2|p>>4),q=p&15,d=2):2==d?(k+=Yb.charAt(q),k+=Yb.charAt(p>>2),q=p&3,d=3):(k+=Yb.charAt(q<<2|p>>4),k+=Yb.charAt(p&15),d=0));1==d&&(k+=Yb.charAt(q<<2));return k}function J(){this.j=this.i=0;this.S=[]}function T(){var e=(new Date).getTime();Cb[Pa++]^=e&255;Cb[Pa++]^=e>>8&255;Cb[Pa++]^=e>>16&255;Cb[Pa++]^=e>>24&255;Pa>=Gd&&(Pa-=
Gd)}function U(){}function X(e,k){return new z(e,k)}function K(e,k,h){for(var d="",q=0;d.length<k;)d+=h(String.fromCharCode.apply(String,e.concat([(q&4278190080)>>24,(q&16711680)>>16,(q&65280)>>8,q&255]))),q+=1;return d}function A(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function Sd(e,k,h){for(var d="",q=0;d.length<k;)d+=h(e+String.fromCharCode.apply(String,[(q&4278190080)>>24,(q&16711680)>>16,(q&65280)>>8,q&255])),q+=1;return d}function qd(e){var k=[],h=H.getStartPosOfV_AtObj(e,
0),d=H.getPosOfNextSibling_AtObj(e,h),q=H.getPosOfNextSibling_AtObj(e,d),p=H.getPosOfNextSibling_AtObj(e,q),a=H.getPosOfNextSibling_AtObj(e,p),b=H.getPosOfNextSibling_AtObj(e,a),c=H.getPosOfNextSibling_AtObj(e,b),f=H.getPosOfNextSibling_AtObj(e,c),g=H.getPosOfNextSibling_AtObj(e,f);k.push(h,d,q,p,a,b,c,f,g);h=H.getHexOfV_AtObj(e,k[0]);d=H.getHexOfV_AtObj(e,k[1]);q=H.getHexOfV_AtObj(e,k[2]);p=H.getHexOfV_AtObj(e,k[3]);a=H.getHexOfV_AtObj(e,k[4]);b=H.getHexOfV_AtObj(e,k[5]);c=H.getHexOfV_AtObj(e,k[6]);
f=H.getHexOfV_AtObj(e,k[7]);e=H.getHexOfV_AtObj(e,k[8]);k=[];k.push(h,d,q,p,a,b,c,f,e);return k}function Kb(e,k){for(var h="",d=k/4-e.length,q=0;q<d;q++)h+="0";return h+e}function Td(e,k){var h=O.crypto.Util.hashString(e,k);return this.signWithMessageHash(h,k)}function se(e){return Td.call(this,e,"sha1")}function te(e){return Td.call(this,e,"sha256")}function ue(e,k,h){for(var d="",q=0;d.length<k;)d+=hextorstr(h(rstrtohex(e+String.fromCharCode.apply(String,[(q&4278190080)>>24,(q&16711680)>>16,(q&
65280)>>8,q&255])))),q+=1;return d}function ve(e,k,h){e=rstrtohex(e);e=O.crypto.Util.hashHex(e,k);void 0===h&&(h=-1);return this.signWithMessageHashPSS(e,k,h)}function ce(e){for(var k in O.crypto.Util.DIGESTINFOHEAD){var h=O.crypto.Util.DIGESTINFOHEAD[k],d=h.length;if(e.substring(0,d)==h)return[k,e.substring(d)]}return[]}function sd(e,k){var h=X(e,16);var d=this.n.toString(16),q=this.e.toString(16),p=new A;p.setPublic(d,q);h=p.doPublic(h).toString(16).replace(/^1f+00/,"");d=ce(h);0==d.length?h=!1:
(h=d[1],d=O.crypto.Util.hashString(k,d[0]),h=h==d);return h}function Hd(e,k){k=k.replace(Ud,"");k=k.replace(/[ \n]+/g,"");var h=X(k,16);if(h.bitLength()>this.n.bitLength())return 0;var h=this.doPublic(h).toString(16).replace(/^1f+00/,""),d=ce(h);if(0==d.length)return!1;h=d[1];d=O.crypto.Util.hashString(e,d[0]);return h==d}function de(e,k,h,d){e=rstrtohex(e);e=O.crypto.Util.hashHex(e,h);void 0===d&&(d=-1);return this.verifyWithMessageHashPSS(e,k,h,d)}function ga(){this.hex=this.subjectPublicKeyRSA_hE=
this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null;this.getSerialNumberHex=function(){return H.getDecendantHexVByNthList(this.hex,0,[0,1])};this.getIssuerHex=function(){return H.getDecendantHexTLVByNthList(this.hex,0,[0,3])};this.getIssuerString=function(){return ga.hex2dn(H.getDecendantHexTLVByNthList(this.hex,0,[0,3]))};this.getSubjectHex=function(){return H.getDecendantHexTLVByNthList(this.hex,0,[0,5])};this.getSubjectString=function(){return ga.hex2dn(H.getDecendantHexTLVByNthList(this.hex,
0,[0,5]))};this.getNotBefore=function(){var e=H.getDecendantHexVByNthList(this.hex,0,[0,4,0]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.getNotAfter=function(){var e=H.getDecendantHexVByNthList(this.hex,0,[0,4,1]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.readCertPEM=function(e){e=ga.pemToHex(e);var k=ga.getPublicKeyHexArrayFromCertHex(e),h=new A;h.setPublic(k[0],k[1]);this.subjectPublicKeyRSA=h;this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=
k[1];this.hex=e};this.readCertPEMWithoutRSAInit=function(e){e=ga.pemToHex(e);var k=ga.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(k[0],k[1]);this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=k[1];this.hex=e}}function ja(){return new z(null)}function Ob(e,k,h,d,q,p){for(;0<=--p;){var a=k*this[e++]+h[d]+q;q=Math.floor(a/67108864);h[d++]=a&67108863}return q}function we(e,k,h,d,q,p){var a=k&32767;for(k>>=15;0<=--p;){var b=this[e]&32767,c=this[e++]>>15,f=k*b+c*a,b=
a*b+((f&32767)<<15)+h[d]+(q&1073741823);q=(b>>>30)+(f>>>15)+k*c+(q>>>30);h[d++]=b&1073741823}return q}function ee(e,k,h,d,q,p){var a=k&16383;for(k>>=14;0<=--p;){var b=this[e]&16383,c=this[e++]>>14,f=k*b+c*a,b=a*b+((f&16383)<<14)+h[d]+q;q=(b>>28)+(f>>14)+k*c;h[d++]=b&268435455}return q}function Zc(e,k){var h=xe[e.charCodeAt(k)];return null==h?-1:h}function Kc(e){var k=ja();k.fromInt(e);return k}function Id(e){var k=1,h;0!=(h=e>>>16)&&(e=h,k+=16);0!=(h=e>>8)&&(e=h,k+=8);0!=(h=e>>4)&&(e=h,k+=4);0!=(h=
e>>2)&&(e=h,k+=2);0!=e>>1&&(k+=1);return k}function zc(e){this.m=e}function Qa(e){this.m=e;this.mp=e.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<e.DB-15)-1;this.mt2=2*e.t}function Le(e,k){return e&k}function Vd(e,k){return e|k}function Wd(e,k){return e^k}function $c(e,k){return e&~k}function ad(){}function Jd(e){return e}function Lc(e){this.r2=ja();this.q3=ja();z.ONE.dlShiftTo(2*e.t,this.r2);this.mu=this.r2.divide(e);this.m=e}function g(e,k,h){if(!(this instanceof g))return new g(e,
k,h);var d=typeof e;if("base64"===k&&"string"===d)for(e=g.stringtrim(e);0!==e.length%4;)e+="=";var q;if("number"===d)q=g.coerce(e);else if("string"===d)q=g.byteLength(e,k);else if("object"===d)q=g.coerce(e.length);else throw Error("First argument needs to be a number, array or string.");var p;g._useTypedArrays?p=g._augment(new Uint8Array(q)):(p=this,p.length=q,p._isBuffer=!0);if(g._useTypedArrays&&"number"===typeof e.byteLength)p._set(e);else if(g.isArrayish(e))if(g.isBuffer(e))for(k=0;k<q;k++)p[k]=
e.readUInt8(k);else for(k=0;k<q;k++)p[k]=(e[k]%256+256)%256;else if("string"===d)p.write(e,0,k);else if("number"===d&&!g._useTypedArrays&&!h)for(k=0;k<q;k++)p[k]=0;return p}function S(e){if(e)return e.__proto__=S.prototype,e}function va(e){if(e)return e.__proto__=va.prototype,e}function Pb(e){if(e)return e.__proto__=Pb.prototype,e}function x(e){if(e)return e.__proto__=x.prototype,e}function Mc(e){x.call(this,e)}function E(e){x.call(this,e)}function fc(e){if(e)return e.__proto__=fc.prototype,e}var a=
a||{},r=a;r.printStackTrace=na.printStackTrace;var Hb=function(){var e=!1;if("undefined"!==typeof crypto&&crypto&&crypto.subtle){var k={name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:{name:"SHA-256"},publicExponent:new Uint8Array([1,0,1])},h;crypto.subtle.generateKey(k,!0,["sign","verify"]).then(function(d){h=d;return crypto.subtle.sign(k,d.privateKey,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.verify(k,h.publicKey,d,new Uint8Array([1,2,3,4,5]))}).then(function(d){return crypto.subtle.exportKey("pkcs8",
h.privateKey)}).then(function(d){return crypto.subtle.importKey("pkcs8",d,k,!0,["sign"])}).then(function(d){return crypto.subtle.exportKey("spki",h.publicKey)}).then(function(d){return crypto.subtle.importKey("spki",d,k,!0,["verify"])}).then(function(d){d=new Uint8Array([1,2,3,4,5]);return crypto.subtle.digest({name:"SHA-256"},d.buffer)}).then(function(d){e=!0},function(d){console.log("DetectSubtleCrypto encountered error, not using crypto.subtle: ",d)})}return function(){return e}}();r.UseSubtleCrypto=
Hb;var Zb=Zb||function(e,k){var h={},d=h.lib={},q=d.Base=function(){function d(){}return{extend:function(e){d.prototype=this;var h=new d;e&&h.mixIn(e);h.hasOwnProperty("init")||(h.init=function(){h.$super.init.apply(this,arguments)});h.init.prototype=h;h.$super=this;return h},create:function(){var d=this.extend();d.init.apply(d,arguments);return d},init:function(){},mixIn:function(d){for(var e in d)d.hasOwnProperty(e)&&(this[e]=d[e]);d.hasOwnProperty("toString")&&(this.toString=d.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),
p=d.WordArray=q.extend({init:function(d,e){d=this.words=d||[];this.sigBytes=e!=k?e:4*d.length},toString:function(d){return(d||b).stringify(this)},concat:function(d){var e=this.words,h=d.words,k=this.sigBytes;d=d.sigBytes;this.clamp();if(k%4)for(var q=0;q<d;q++)e[k+q>>>2]|=(h[q>>>2]>>>24-q%4*8&255)<<24-(k+q)%4*8;else for(q=0;q<d;q+=4)e[k+q>>>2]=h[q>>>2];this.sigBytes+=d;return this},clamp:function(){var d=this.words,h=this.sigBytes;d[h>>>2]&=4294967295<<32-h%4*8;d.length=e.ceil(h/4)},clone:function(){var d=
q.clone.call(this);d.words=this.words.slice(0);return d},random:function(d){for(var h=[],k=0;k<d;k+=4)h.push(4294967296*e.random()|0);return new p.init(h,d)}}),a=h.enc={},b=a.Hex={stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++){var q=e[k>>>2]>>>24-k%4*8&255;h.push((q>>>4).toString(16));h.push((q&15).toString(16))}return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k+=2)h[k>>>3]|=parseInt(d.substr(k,2),16)<<24-k%8*4;return new p.init(h,e/2)}},c=a.Latin1=
{stringify:function(d){var e=d.words;d=d.sigBytes;for(var h=[],k=0;k<d;k++)h.push(String.fromCharCode(e[k>>>2]>>>24-k%4*8&255));return h.join("")},parse:function(d){for(var e=d.length,h=[],k=0;k<e;k++)h[k>>>2]|=(d.charCodeAt(k)&255)<<24-k%4*8;return new p.init(h,e)}},f=a.Utf8={stringify:function(d){try{return decodeURIComponent(escape(c.stringify(d)))}catch(e){throw Error("Malformed UTF-8 data");}},parse:function(d){return c.parse(unescape(encodeURIComponent(d)))}},g=d.BufferedBlockAlgorithm=q.extend({reset:function(){this._data=
new p.init;this._nDataBytes=0},_append:function(d){"string"==typeof d&&(d=f.parse(d));this._data.concat(d);this._nDataBytes+=d.sigBytes},_process:function(d){var h=this._data,k=h.words,q=h.sigBytes,a=this.blockSize,b=q/(4*a),b=d?e.ceil(b):e.max((b|0)-this._minBufferSize,0);d=b*a;q=e.min(4*d,q);if(d){for(var rd=0;rd<d;rd+=a)this._doProcessBlock(k,rd);rd=k.splice(0,d);h.sigBytes-=q}return new p.init(rd,q)},clone:function(){var d=q.clone.call(this);d._data=this._data.clone();return d},_minBufferSize:0});
d.Hasher=g.extend({cfg:q.extend(),init:function(d){this.cfg=this.cfg.extend(d);this.reset()},reset:function(){g.reset.call(this);this._doReset()},update:function(d){this._append(d);this._process();return this},finalize:function(d){d&&this._append(d);return this._doFinalize()},blockSize:16,_createHelper:function(d){return function(e,h){return(new d.init(h)).finalize(e)}},_createHmacHelper:function(d){return function(e,h){return(new l.HMAC.init(d,h)).finalize(e)}}});var l=h.algo={};return h}(Math);
r.CryptoJS=Zb;var Kd=a.CryptoJS;(function(e){var k=Kd.lib,h=k.WordArray,d=k.Hasher,k=Kd.algo,q=[],p=[];(function(){function d(h){for(var k=e.sqrt(h),q=2;q<=k;q++)if(!(h%q))return!1;return!0}function h(d){return 4294967296*(d-(d|0))|0}for(var k=2,a=0;64>a;)d(k)&&(8>a&&(q[a]=h(e.pow(k,0.5))),p[a]=h(e.pow(k,1/3)),a++),k++})();var a=[],k=k.SHA256=d.extend({_doReset:function(){this._hash=new h.init(q.slice(0))},_doProcessBlock:function(d,e){for(var h=this._hash.words,k=h[0],q=h[1],b=h[2],c=h[3],f=h[4],
g=h[5],l=h[6],n=h[7],m=0;64>m;m++){if(16>m)a[m]=d[e+m]|0;else{var s=a[m-15],r=a[m-2];a[m]=((s<<25|s>>>7)^(s<<14|s>>>18)^s>>>3)+a[m-7]+((r<<15|r>>>17)^(r<<13|r>>>19)^r>>>10)+a[m-16]}s=n+((f<<26|f>>>6)^(f<<21|f>>>11)^(f<<7|f>>>25))+(f&g^~f&l)+p[m]+a[m];r=((k<<30|k>>>2)^(k<<19|k>>>13)^(k<<10|k>>>22))+(k&q^k&b^q&b);n=l;l=g;g=f;f=c+s|0;c=b;b=q;q=k;k=s+r|0}h[0]=h[0]+k|0;h[1]=h[1]+q|0;h[2]=h[2]+b|0;h[3]=h[3]+c|0;h[4]=h[4]+f|0;h[5]=h[5]+g|0;h[6]=h[6]+l|0;h[7]=h[7]+n|0},_doFinalize:function(){var d=this._data,
h=d.words,k=8*this._nDataBytes,q=8*d.sigBytes;h[q>>>5]|=128<<24-q%32;h[(q+64>>>9<<4)+14]=e.floor(k/4294967296);h[(q+64>>>9<<4)+15]=k;d.sigBytes=4*h.length;this._process();return this._hash},clone:function(){var e=d.clone.call(this);e._hash=this._hash.clone();return e}});Kd.SHA256=d._createHelper(k);Kd.HmacSHA256=d._createHmacHelper(k)})(Math);r.CryptoJS=Kd;(function(){var e=Zb,k=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,d){e=this._hasher=new e.init;"string"==typeof d&&(d=k.parse(d));
var q=e.blockSize,p=4*q;d.sigBytes>p&&(d=e.finalize(d));d.clamp();for(var a=this._oKey=d.clone(),b=this._iKey=d.clone(),c=a.words,f=b.words,g=0;g<q;g++)c[g]^=1549556828,f[g]^=909522486;a.sigBytes=b.sigBytes=p;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var d=this._hasher;e=d.finalize(e);d.reset();return d.finalize(this._oKey.clone().concat(e))}})})();var Xb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
Fd="=";r.b64tohex=u;r.b64toBA=function(e){e=u(e);var k,h=[];for(k=0;2*k<e.length;++k)h[k]=parseInt(e.substring(2*k,2*k+2),16);return h};r.hex2b64=function(e){var k,h,d="";for(k=0;k+3<=e.length;k+=3)h=parseInt(e.substring(k,k+3),16),d+=Xb.charAt(h>>6)+Xb.charAt(h&63);k+1==e.length?(h=parseInt(e.substring(k,k+1),16),d+=Xb.charAt(h<<2)):k+2==e.length&&(h=parseInt(e.substring(k,k+2),16),d+=Xb.charAt(h>>2)+Xb.charAt((h&3)<<4));if(Fd)for(;0<(d.length&3);)d+=Fd;return d};J.prototype.init=function(e){var k,
h,d;for(k=0;256>k;++k)this.S[k]=k;for(k=h=0;256>k;++k)h=h+this.S[k]+e[k%e.length]&255,d=this.S[k],this.S[k]=this.S[h],this.S[h]=d;this.j=this.i=0};J.prototype.next=function(){var e;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;e=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=e;return this.S[e+this.S[this.i]&255]};var Gd=256,Ac,Cb,Pa;if(null==Cb){Cb=[];Pa=0;var bd;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var Nc=window.crypto.random(32);for(bd=0;bd<
Nc.length;++bd)Cb[Pa++]=Nc.charCodeAt(bd)&255}for(;Pa<Gd;)bd=Math.floor(65536*Math.random()),Cb[Pa++]=bd>>>8,Cb[Pa++]=bd&255;Pa=0;T()}U.prototype.nextBytes=function(e){var k;for(k=0;k<e.length;++k){var h=e,d=k,q;if(null==Ac){T();Ac=new J;Ac.init(Cb);for(Pa=0;Pa<Cb.length;++Pa)Cb[Pa]=0;Pa=0}q=Ac.next();h[d]=q}};var kc=a,Qb=20;A.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)};A.prototype.setPublic=function(e,k){this.isPublic=!0;"string"!==typeof e?(this.n=e,this.e=k):null!=e&&null!=
k&&0<e.length&&0<k.length?(this.n=X(e,16),this.e=parseInt(k,16)):alert("Invalid RSA public key")};A.prototype.encrypt=function(e){var k;k=this.n.bitLength()+7>>3;if(k<e.length+11)alert("Message too long for RSA"),k=null;else{for(var h=[],d=e.length-1;0<=d&&0<k;){var q=e.charCodeAt(d--);128>q?h[--k]=q:127<q&&2048>q?(h[--k]=q&63|128,h[--k]=q>>6|192):(h[--k]=q&63|128,h[--k]=q>>6&63|128,h[--k]=q>>12|224)}h[--k]=0;e=new U;for(d=[];2<k;){for(d[0]=0;0==d[0];)e.nextBytes(d);h[--k]=d[0]}h[--k]=2;h[--k]=0;
k=new z(h)}if(null==k)return null;k=this.doPublic(k);if(null==k)return null;k=k.toString(16);return 0==(k.length&1)?k:"0"+k};A.prototype.encryptOAEP=function(e,k){var h,d=this.n.bitLength()+7>>3;if(e.length+2*Qb+2>d)throw"Message too long for RSA";var q="";for(h=0;h<d-e.length-2*Qb-2;h+=1)q+="\x00";var p=rstr_sha1("")+q+"\u0001"+e,d=Array(Qb);(new U).nextBytes(d);var a=K(d,p.length,k||rstr_sha1),q=[];for(h=0;h<p.length;h+=1)q[h]=p.charCodeAt(h)^a.charCodeAt(h);p=K(q,d.length,rstr_sha1);a=[0];for(h=
0;h<d.length;h+=1)a[h+1]=d[h]^p.charCodeAt(h);h=new z(a.concat(q));if(null==h)return null;h=this.doPublic(h);if(null==h)return null;h=h.toString(16);return 0==(h.length&1)?h:"0"+h};A.prototype.type="RSA";r.RSAKey=A;var kc=a,z=kc.BigInteger?kc.BigInteger:kc,A=a.RSAKey,Qb=20;A.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);var k=e.mod(this.p).modPow(this.dmp1,this.p);for(e=e.mod(this.q).modPow(this.dmq1,this.q);0>k.compareTo(e);)k=k.add(this.p);return k.subtract(e).multiply(this.coeff).mod(this.p).multiply(this.q).add(e)};
A.prototype.setPrivate=function(e,k,h){this.isPrivate=!0;"string"!==typeof e?(this.n=e,this.e=k,this.d=h):null!=e&&null!=k&&0<e.length&&0<k.length?(this.n=X(e,16),this.e=parseInt(k,16),this.d=X(h,16)):alert("Invalid RSA private key")};A.prototype.setPrivateEx=function(e,k,h,d,q,p,a,b){this.isPrivate=!0;if(null==e)throw"RSASetPrivateEx N == null";if(null==k)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==k.length)throw"RSASetPrivateEx E.length == 0";null!=
e&&null!=k&&0<e.length&&0<k.length?(this.n=X(e,16),this.e=parseInt(k,16),this.d=X(h,16),this.p=X(d,16),this.q=X(q,16),this.dmp1=X(p,16),this.dmq1=X(a,16),this.coeff=X(b,16)):alert("Invalid RSA private key in RSASetPrivateEx")};A.prototype.generate=function(e,k){var h=new U,d=e>>1;this.e=parseInt(k,16);for(var q=new z(k,16);;){for(;this.p=new z(e-d,1,h),0!=this.p.subtract(z.ONE).gcd(q).compareTo(z.ONE)||!this.p.isProbablePrime(10););for(;this.q=new z(d,1,h),0!=this.q.subtract(z.ONE).gcd(q).compareTo(z.ONE)||
!this.q.isProbablePrime(10););if(0>=this.p.compareTo(this.q)){var p=this.p;this.p=this.q;this.q=p}var p=this.p.subtract(z.ONE),a=this.q.subtract(z.ONE),b=p.multiply(a);if(0==b.gcd(q).compareTo(z.ONE)){this.n=this.p.multiply(this.q);this.d=q.modInverse(b);this.dmp1=this.d.mod(p);this.dmq1=this.d.mod(a);this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0};A.prototype.decrypt=function(e){e=X(e,16);e=this.doPrivate(e);if(null==e)return null;a:{var k=this.n.bitLength()+7>>3;e=e.toByteArray();
for(var h=0;h<e.length&&0==e[h];)++h;if(e.length-h!=k-1||2!=e[h])e=null;else{for(++h;0!=e[h];)if(++h>=e.length){e=null;break a}for(k="";++h<e.length;){var d=e[h]&255;128>d?k+=String.fromCharCode(d):191<d&&224>d?(k+=String.fromCharCode((d&31)<<6|e[h+1]&63),++h):(k+=String.fromCharCode((d&15)<<12|(e[h+1]&63)<<6|e[h+2]&63),h+=2)}e=k}}return e};A.prototype.decryptOAEP=function(e,k){var h=X(e,16),h=this.doPrivate(h);if(null==h)return null;for(var d=h,q=this.n.bitLength()+7>>3,d=d.toByteArray(),h=0;h<d.length;h+=
1)d[h]&=255;for(;d.length<q;)d.unshift(0);d=String.fromCharCode.apply(String,d);if(d.length<2*Qb+2)throw"Cipher too short";for(var p=d.substr(1,Qb),q=d.substr(Qb+1),a=Sd(q,Qb,k||rstr_sha1),b=[],h=0;h<p.length;h+=1)b[h]=p.charCodeAt(h)^a.charCodeAt(h);p=Sd(String.fromCharCode.apply(String,b),d.length-Qb,rstr_sha1);d=[];for(h=0;h<q.length;h+=1)d[h]=q.charCodeAt(h)^p.charCodeAt(h);d=String.fromCharCode.apply(String,d);if(d.substr(0,Qb)!==rstr_sha1(""))throw"Hash mismatch";d=d.substr(Qb);h=d.indexOf("\u0001");
if((-1!=h?d.substr(0,h).lastIndexOf("\x00"):-1)+1!=h)throw"Malformed data";return d.substr(h+1)};r.RSAKey=A;Zb=a.CryptoJS;kc=a;"undefined"!=typeof O&&O||(O={});"undefined"!=typeof O.crypto&&O.crypto||(O.crypto={});O.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",
md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"};this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",
SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",
SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"};this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"};this.getDigestInfoHex=function(e,k){if("undefined"==typeof this.DIGESTINFOHEAD[k])throw"alg not supported in Util.DIGESTINFOHEAD: "+
k;return this.DIGESTINFOHEAD[k]+e};this.getPaddedDigestInfoHex=function(e,k,h){var d=this.getDigestInfoHex(e,k);e=h/4;if(d.length+22>e)throw"key is too short for SigAlg: keylen="+h+","+k;k="00"+d;h="";e=e-4-k.length;for(d=0;d<e;d+=2)h+="ff";return"0001"+h+k};this.hashString=function(e,k){return(new O.crypto.MessageDigest({alg:k})).digestString(e)};this.hashHex=function(e,k){return(new O.crypto.MessageDigest({alg:k})).digestHex(e)};this.sha1=function(e){return(new O.crypto.MessageDigest({alg:"sha1",
prov:"cryptojs"})).digestString(e)};this.sha256=function(e){return(new O.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestString(e)};this.sha256Hex=function(e){return(new O.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestHex(e)};this.sha512=function(e){return(new O.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestString(e)};this.sha512Hex=function(e){return(new O.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestHex(e)};this.md5=function(e){return(new O.crypto.MessageDigest({alg:"md5",
prov:"cryptojs"})).digestString(e)};this.ripemd160=function(e){return(new O.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"})).digestString(e)};this.getCryptoJSMDByName=function(e){}};O.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,h){null!=e&&void 0===h&&(h=O.crypto.Util.DEFAULTPROVIDER[e]);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==h){try{this.md=eval(O.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e]).create()}catch(d){throw"setAlgAndProvider hash alg set fail alg="+
e+"/"+d;}this.updateString=function(d){this.md.update(d)};this.updateHex=function(d){d=Zb.enc.Hex.parse(d);this.md.update(d)};this.digest=function(){return this.md.finalize().toString(Zb.enc.Hex)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==h){try{this.md=new sjcl.hash.sha256}catch(q){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+q;}this.updateString=function(d){this.md.update(d)};
this.updateHex=function(d){d=sjcl.codec.hex.toBits(d);this.md.update(d)};this.digest=function(){var d=this.md.finalize();return sjcl.codec.hex.fromBits(d)};this.digestString=function(d){this.updateString(d);return this.digest()};this.digestHex=function(d){this.updateHex(d);return this.digest()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+
this.algName+"/"+this.provName;};this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName;};void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=O.crypto.Util.DEFAULTPROVIDER[this.algName]),
this.setAlgAndProvider(this.algName,this.provName))};O.crypto.Mac=function(e){this.setAlgAndProvider=function(e,h){e=e.toLowerCase();null==e&&(e="hmacsha1");e=e.toLowerCase();if("hmac"!=e.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===h&&(h=O.crypto.Util.DEFAULTPROVIDER[e]);this.algProv=e+"/"+h;var d=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(d)&&"cryptojs"==h){try{var q=eval(O.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[d]);this.mac=Zb.algo.HMAC.create(q,
this.pass)}catch(p){throw"setAlgAndProvider hash alg set fail hashAlg="+d+"/"+p;}this.updateString=function(d){this.mac.update(d)};this.updateHex=function(d){d=Zb.enc.Hex.parse(d);this.mac.update(d)};this.doFinal=function(){return this.mac.finalize().toString(Zb.enc.Hex)};this.doFinalString=function(d){this.updateString(d);return this.doFinal()};this.doFinalHex=function(d){this.updateHex(d);return this.doFinal()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+
this.algProv;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv;};this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv;};this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv;};this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv;};this.setPassword=function(e){if("string"==typeof e){var h=e;1!=e.length%2&&e.match(/^[0-9A-Fa-f]+$/)||
(h=rstrtohex(e))}else{if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;h=null;if(void 0!==e.hex){if(0!=e.hex.length%2||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;h=e.hex}void 0!==e.utf8&&(h=utf8tohex(e.utf8));void 0!==e.rstr&&(h=rstrtohex(e.rstr));void 0!==e.b64&&(h=u(e.b64));void 0!==e.b64u&&(h=b64utohex(e.b64u));if(null==h)throw"KJUR.crypto.Mac unsupported password type: "+e;}this.pass=Zb.enc.Hex.parse(h)};void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),
void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=O.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))};O.crypto.Signature=function(e){var k=null;this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())};this._zeroPaddingOfSignature=function(d,e){for(var h="",k=e/4-d.length,a=0;a<k;a++)h+="0";return h+d};this.setAlgAndProvider=function(d,e){this._setAlgNames();
if("cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new O.crypto.MessageDigest({alg:this.mdAlgName})}catch(h){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+h;}this.init=function(d,e){var h=null;try{h=void 0===e?KEYUTIL.getKey(d):KEYUTIL.getKey(d,e)}catch(k){throw"init failed:"+k;}if(!0===h.isPrivate)this.prvKey=h,this.state="SIGN";else if(!0===h.isPublic)this.pubKey=h,this.state=
"VERIFY";else throw"init failed.:"+h;};this.initSign=function(d){"string"==typeof d.ecprvhex&&"string"==typeof d.eccurvename?(this.ecprvhex=d.ecprvhex,this.eccurvename=d.eccurvename):this.prvKey=d;this.state="SIGN"};this.initVerifyByPublicKey=function(d){"string"==typeof d.ecpubhex&&"string"==typeof d.eccurvename?(this.ecpubhex=d.ecpubhex,this.eccurvename=d.eccurvename):d instanceof O.crypto.ECDSA?this.pubKey=d:d instanceof A&&(this.pubKey=d);this.state="VERIFY"};this.initVerifyByCertificatePEM=function(d){var e=
new ga;e.readCertPEM(d);this.pubKey=e.subjectPublicKeyRSA;this.state="VERIFY"};this.updateString=function(d){this.md.updateString(d)};this.updateHex=function(d){this.md.updateHex(d)};this.sign=function(){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename)this.hSign=(new O.crypto.ECDSA({curve:this.eccurvename})).signHex(this.sHashHex,this.ecprvhex);else if(this.prvKey instanceof A&&"rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,
this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof A&&"rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof O.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof O.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;return this.hSign};this.signString=function(d){this.updateString(d);
return this.sign()};this.signHex=function(d){this.updateHex(d);return this.sign()};this.verify=function(d){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return(new O.crypto.ECDSA({curve:this.eccurvename})).verifyHex(this.sHashHex,d,this.ecpubhex);if(this.pubKey instanceof A&&"rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,d,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof A&&"rsa"==this.pubkeyAlgName||
this.pubKey instanceof O.crypto.ECDSA||this.pubKey instanceof O.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,d);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;}}};this.init=function(d,e){throw"init(key, pass) not supported for this alg:prov="+this.algProvName;};this.initVerifyByPublicKey=function(d){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName;};this.initVerifyByCertificatePEM=function(d){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+
this.algProvName;};this.initSign=function(d){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName;};this.updateString=function(d){throw"updateString(str) not supported for this alg:prov="+this.algProvName;};this.updateHex=function(d){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName;};this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName;};this.signString=function(d){throw"digestString(str) not supported for this alg:prov="+
this.algProvName;};this.signHex=function(d){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName;};this.verify=function(d){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName;};this.initParams=e;if(void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,this.provName=void 0===e.prov?O.crypto.Util.DEFAULTPROVIDER[this.algName]:e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&
(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{k=new A,k.readPrivateKeyFromPEMString(e.prvkeypem),this.initSign(k)}catch(h){throw"fatal error to load pem private key: "+h;}}};O.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1",
"2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}};r.KJUR=O;var H=a.ASN1HEX,u=a.b64tohex,A=a.RSAKey;A.prototype.readPrivateKeyFromPEMString=function(e){e=e.replace("-----BEGIN RSA PRIVATE KEY-----","");e=e.replace("-----END RSA PRIVATE KEY-----","");e=e.replace(/[ \n]+/g,"");e=u(e);e=qd(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};A.prototype.readPrivateKeyFromASN1HexString=
function(e){e=qd(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};r.RSAKey=A;var kc=a,z=kc.BigInteger?kc.BigInteger:kc,A=a.RSAKey,Ud=RegExp("");Ud.compile("[^0-9a-f]","gi");A.prototype.signWithMessageHash=function(e,k){var h=O.crypto.Util.getPaddedDigestInfoHex(e,k,this.n.bitLength()),h=X(h,16),h=this.doPrivate(h).toString(16);return Kb(h,this.n.bitLength())};A.prototype.signString=Td;A.prototype.signStringWithSHA1=se;A.prototype.signStringWithSHA256=te;A.prototype.sign=Td;A.prototype.signWithSHA1=
se;A.prototype.signWithSHA256=te;A.prototype.signWithMessageHashPSS=function(e,k,h){var d=hextorstr(e);e=d.length;var q=this.n.bitLength()-1,p=Math.ceil(q/8),a=function(d){return O.crypto.Util.hashHex(d,k)};if(-1===h||void 0===h)h=e;else if(-2===h)h=p-e-2;else if(-2>h)throw"invalid salt length";if(p<e+h+2)throw"data too long";var b="";0<h&&(b=Array(h),(new U).nextBytes(b),b=String.fromCharCode.apply(String,b));for(var c=hextorstr(a(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+d+b))),f=[],d=0;d<p-
h-e-2;d+=1)f[d]=0;h=String.fromCharCode.apply(String,f)+"\u0001"+b;a=ue(c,h.length,a);b=[];for(d=0;d<h.length;d+=1)b[d]=h.charCodeAt(d)^a.charCodeAt(d);b[0]&=~(65280>>8*p-q&255);for(d=0;d<e;d++)b.push(c.charCodeAt(d));b.push(188);return Kb(this.doPrivate(new z(b)).toString(16),this.n.bitLength())};A.prototype.signStringPSS=ve;A.prototype.signPSS=ve;A.SALT_LEN_HLEN=-1;A.SALT_LEN_MAX=-2;A.prototype.verifyWithMessageHash=function(e,k){k=k.replace(Ud,"");k=k.replace(/[ \n]+/g,"");var h=X(k,16);if(h.bitLength()>
this.n.bitLength())return 0;h=this.doPublic(h).toString(16).replace(/^1f+00/,"");h=ce(h);return 0==h.length?!1:h[1]==e};A.prototype.verifyString=Hd;A.prototype.verifyHexSignatureForMessage=sd;A.prototype.verify=Hd;A.prototype.verifyHexSignatureForByteArrayMessage=sd;A.prototype.verifyWithMessageHashPSS=function(e,k,h,d){var q=new z(k,16);if(q.bitLength()>this.n.bitLength())return!1;k=function(d){return O.crypto.Util.hashHex(d,h)};e=hextorstr(e);var p=e.length,a=this.n.bitLength()-1,b=Math.ceil(a/
8);if(-1===d||void 0===d)d=p;else if(-2===d)d=b-p-2;else if(-2>d)throw"invalid salt length";if(b<p+d+2)throw"data too long";for(var c=this.doPublic(q).toByteArray(),q=0;q<c.length;q+=1)c[q]&=255;for(;c.length<b;)c.unshift(0);if(188!==c[b-1])throw"encoded message does not end in 0xbc";var c=String.fromCharCode.apply(String,c),f=c.substr(0,b-p-1),c=c.substr(f.length,p),g=65280>>8*b-a&255;if(0!==(f.charCodeAt(0)&g))throw"bits beyond keysize not zero";for(var l=ue(c,f.length,k),a=[],q=0;q<f.length;q+=
1)a[q]=f.charCodeAt(q)^l.charCodeAt(q);a[0]&=~g;p=b-p-d-2;for(q=0;q<p;q+=1)if(0!==a[q])throw"leftmost octets not zero";if(1!==a[p])throw"0x01 marker not found";return c===hextorstr(k(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+e+String.fromCharCode.apply(String,a.slice(-d)))))};A.prototype.verifyStringPSS=de;A.prototype.verifyPSS=de;A.SALT_LEN_RECOVER=-2;r.RSAKey=A;"undefined"!=typeof O&&O||(O={});"undefined"!=typeof O.crypto&&O.crypto||(O.crypto={});O.crypto.ECDSA=function(e){var k=new U;this.type=
"EC";this.getBigRandom=function(e){return(new z(e.bitLength(),k)).mod(e.subtract(z.ONE)).add(z.ONE)};this.setNamedCurve=function(e){this.ecparams=O.crypto.ECParameterDB.getByName(e);this.pubKeyHex=this.prvKeyHex=null;this.curveName=e};this.setPrivateKeyHex=function(e){this.isPrivate=!0;this.prvKeyHex=e};this.setPublicKeyHex=function(e){this.isPublic=!0;this.pubKeyHex=e};this.generateKeyPairHex=function(){var e=this.getBigRandom(this.ecparams.n),d=this.ecparams.G.multiply(e),k=d.getX().toBigInteger(),
d=d.getY().toBigInteger(),p=this.ecparams.keylen/4,e=("0000000000"+e.toString(16)).slice(-p),k=("0000000000"+k.toString(16)).slice(-p),d=("0000000000"+d.toString(16)).slice(-p),k="04"+k+d;this.setPrivateKeyHex(e);this.setPublicKeyHex(k);return{ecprvhex:e,ecpubhex:k}};this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)};this.signHex=function(e,d){var k=new z(d,16),p=this.ecparams.n,a=new z(e,16);do var b=this.getBigRandom(p),c=this.ecparams.G.multiply(b).getX().toBigInteger().mod(p);
while(0>=c.compareTo(z.ZERO));k=b.modInverse(p).multiply(a.add(k.multiply(c))).mod(p);return O.crypto.ECDSA.biRSSigToASN1Sig(c,k)};this.sign=function(e,d){var k=this.ecparams.n,p=z.fromByteArrayUnsigned(e);do var a=this.getBigRandom(k),b=this.ecparams.G.multiply(a).getX().toBigInteger().mod(k);while(0>=b.compareTo(z.ZERO));k=a.modInverse(k).multiply(p.add(d.multiply(b))).mod(k);return this.serializeSig(b,k)};this.verifyWithMessageHash=function(e,d){return this.verifyHex(e,d,this.pubKeyHex)};this.verifyHex=
function(e,d,k){var p;p=O.crypto.ECDSA.parseSigHex(d);d=p.r;p=p.s;k=ECPointFp.decodeFromHex(this.ecparams.curve,k);e=new z(e,16);return this.verifyRaw(e,d,p,k)};this.verify=function(e,d,k){var p;if(Bitcoin.Util.isArray(d))d=this.parseSig(d),p=d.r,d=d.s;else if("object"===typeof d&&d.r&&d.s)p=d.r,d=d.s;else throw"Invalid value for signature";if(!(k instanceof ECPointFp))if(Bitcoin.Util.isArray(k))k=ECPointFp.decodeFrom(this.ecparams.curve,k);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";
e=z.fromByteArrayUnsigned(e);return this.verifyRaw(e,p,d,k)};this.verifyRaw=function(e,d,k,p){var a=this.ecparams.n,b=this.ecparams.G;if(0>d.compareTo(z.ONE)||0<=d.compareTo(a)||0>k.compareTo(z.ONE)||0<=k.compareTo(a))return!1;k=k.modInverse(a);e=e.multiply(k).mod(a);k=d.multiply(k).mod(a);return b.multiply(e).add(p.multiply(k)).getX().toBigInteger().mod(a).equals(d)};this.serializeSig=function(e,d){var k=e.toByteArraySigned(),p=d.toByteArraySigned(),a=[];a.push(2);a.push(k.length);a=a.concat(k);
a.push(2);a.push(p.length);a=a.concat(p);a.unshift(a.length);a.unshift(48);return a};this.parseSig=function(e){var d;if(48!=e[0])throw Error("Signature not a valid DERSequence");d=2;if(2!=e[d])throw Error("First element in signature must be a DERInteger");var k=e.slice(d+2,d+2+e[d+1]);d+=2+e[d+1];if(2!=e[d])throw Error("Second element in signature must be a DERInteger");e=e.slice(d+2,d+2+e[d+1]);k=z.fromByteArrayUnsigned(k);e=z.fromByteArrayUnsigned(e);return{r:k,s:e}};this.parseSigCompact=function(e){if(65!==
e.length)throw"Signature has the wrong length";var d=e[0]-27;if(0>d||7<d)throw"Invalid signature type";var k=this.ecparams.n,p=z.fromByteArrayUnsigned(e.slice(1,33)).mod(k);e=z.fromByteArrayUnsigned(e.slice(33,65)).mod(k);return{r:p,s:e,i:d}};void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve);void 0===this.curveName&&(this.curveName="secp256r1");this.setNamedCurve(this.curveName);void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))};O.crypto.ECDSA.parseSigHex=
function(e){var k=O.crypto.ECDSA.parseSigHexInHexRS(e);e=new z(k.r,16);k=new z(k.s,16);return{r:e,s:k}};O.crypto.ECDSA.parseSigHexInHexRS=function(e){if("30"!=e.substr(0,2))throw"signature is not a ASN.1 sequence";var k=H.getPosArrayOfChildren_AtObj(e,0);if(2!=k.length)throw"number of signature ASN.1 sequence elements seem wrong";var h=k[0],k=k[1];if("02"!=e.substr(h,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=e.substr(k,2))throw"2nd item of sequene of signature is not ASN.1 integer";
h=H.getHexOfV_AtObj(e,h);e=H.getHexOfV_AtObj(e,k);return{r:h,s:e}};O.crypto.ECDSA.asn1SigToConcatSig=function(e){var k=O.crypto.ECDSA.parseSigHexInHexRS(e);e=k.r;k=k.s;"00"==e.substr(0,2)&&8==e.length/2*8%128&&(e=e.substr(2));"00"==k.substr(0,2)&&8==k.length/2*8%128&&(k=k.substr(2));if(0!=e.length/2*8%128)throw"unknown ECDSA sig r length error";if(0!=k.length/2*8%128)throw"unknown ECDSA sig s length error";return e+k};O.crypto.ECDSA.concatSigToASN1Sig=function(e){if(0!=e.length/2*8%128)throw"unknown ECDSA concatinated r-s sig  length error";
var k=e.substr(0,e.length/2);e=e.substr(e.length/2);return O.crypto.ECDSA.hexRSSigToASN1Sig(k,e)};O.crypto.ECDSA.hexRSSigToASN1Sig=function(e,k){var h=new z(e,16),d=new z(k,16);return O.crypto.ECDSA.biRSSigToASN1Sig(h,d)};O.crypto.ECDSA.biRSSigToASN1Sig=function(e,k){var h=new O.asn1.DERInteger({bigint:e}),d=new O.asn1.DERInteger({bigint:k});return(new O.asn1.DERSequence({array:[h,d]})).getEncodedHex()};kc=a;H=new function(){this.getByteLengthOfL_AtObj=function(e,k){if("8"!=e.substring(k+2,k+3))return 1;
var h=parseInt(e.substring(k+3,k+4));return 0==h?-1:0<h&&10>h?h+1:-2};this.getHexOfL_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 1>h?"":e.substring(k+2,k+2+2*h)};this.getIntOfL_AtObj=function(e,k){var h=this.getHexOfL_AtObj(e,k);return""==h?-1:(8>parseInt(h.substring(0,1))?new z(h,16):new z(h.substring(2),16)).intValue()};this.getStartPosOfV_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 0>h?h:k+2*(h+1)};this.getHexOfV_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,
k),d=this.getIntOfL_AtObj(e,k);return e.substring(h,h+2*d)};this.getHexOfTLV_AtObj=function(e,k){var h=e.substr(k,2),d=this.getHexOfL_AtObj(e,k),q=this.getHexOfV_AtObj(e,k);return h+d+q};this.getPosOfNextSibling_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,k),d=this.getIntOfL_AtObj(e,k);return h+2*d};this.getPosArrayOfChildren_AtObj=function(e,k){var h=[],d=this.getStartPosOfV_AtObj(e,k);h.push(d);for(var q=this.getIntOfL_AtObj(e,k),p=d,a=0;;){p=this.getPosOfNextSibling_AtObj(e,p);if(null==
p||p-d>=2*q)break;if(200<=a)break;h.push(p);a++}return h};this.getNthChildIndex_AtObj=function(e,k,h){return this.getPosArrayOfChildren_AtObj(e,k)[h]};this.getDecendantIndexByNthList=function(e,k,h){if(0==h.length)return k;var d=h.shift();k=this.getPosArrayOfChildren_AtObj(e,k);return this.getDecendantIndexByNthList(e,k[d],h)};this.getDecendantHexTLVByNthList=function(e,k,h){k=this.getDecendantIndexByNthList(e,k,h);return this.getHexOfTLV_AtObj(e,k)};this.getDecendantHexVByNthList=function(e,k,h){k=
this.getDecendantIndexByNthList(e,k,h);return this.getHexOfV_AtObj(e,k)}};H.getVbyList=function(e,k,h,d){k=this.getDecendantIndexByNthList(e,k,h);if(void 0===k)throw"can't find nthList object";if(void 0!==d&&e.substr(k,2)!=d)throw"checking tag doesn't match: "+e.substr(k,2)+"!="+d;return this.getHexOfV_AtObj(e,k)};H.hextooidstr=function(e){var k=function(d,e){return d.length>=e?d:Array(e-d.length+1).join("0")+d},h=[],d=e.substr(0,2),d=parseInt(d,16);h[0]=new String(Math.floor(d/40));h[1]=new String(d%
40);var q=e.substr(2);e=[];for(d=0;d<q.length/2;d++)e.push(parseInt(q.substr(2*d,2),16));for(var q=[],p="",d=0;d<e.length;d++)e[d]&128?p+=k((e[d]&127).toString(2),7):(p+=k((e[d]&127).toString(2),7),q.push(new String(parseInt(p,2))),p="");k=h.join(".");0<q.length&&(k=k+"."+q.join("."));return k};H.dump=function(e,k,h,d){var q=function(d,e){return d.length<=2*e?d:d.substr(0,e)+"..(total "+d.length/2+"bytes).."+d.substr(d.length-e,e)};void 0===k&&(k={ommit_long_octet:32});void 0===h&&(h=0);void 0===
d&&(d="");var p=k.ommit_long_octet;if("01"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),"00"==e?d+"BOOLEAN FALSE\n":d+"BOOLEAN TRUE\n";if("02"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),d+"INTEGER "+q(e,p)+"\n";if("03"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),d+"BITSTRING "+q(e,p)+"\n";if("04"==e.substr(h,2))return e=H.getHexOfV_AtObj(e,h),H.isASN1HEX(e)?q=d+"OCTETSTRING, encapsulates\n"+H.dump(e,k,0,d+"  "):d+"OCTETSTRING "+q(e,p)+"\n";if("05"==e.substr(h,2))return d+"NULL\n";if("06"==
e.substr(h,2)){e=H.getHexOfV_AtObj(e,h);var a=O.asn1.ASN1Util.oidHexToInt(e),p=O.asn1.x509.OID.oid2name(a);e=a.replace(/\./g," ");return""!=p?d+"ObjectIdentifier "+p+" ("+e+")\n":d+"ObjectIdentifier ("+e+")\n"}if("0c"==e.substr(h,2))return d+"UTF8String '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("13"==e.substr(h,2))return d+"PrintableString '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("14"==e.substr(h,2))return d+"TeletexString '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("16"==e.substr(h,2))return d+
"IA5String '"+hextoutf8(H.getHexOfV_AtObj(e,h))+"'\n";if("17"==e.substr(h,2))return d+"UTCTime "+hextoutf8(H.getHexOfV_AtObj(e,h))+"\n";if("18"==e.substr(h,2))return d+"GeneralizedTime "+hextoutf8(H.getHexOfV_AtObj(e,h))+"\n";if("30"==e.substr(h,2)){if("3000"==e.substr(h,4))return d+"SEQUENCE {}\n";q=d+"SEQUENCE\n";h=H.getPosArrayOfChildren_AtObj(e,h);p=k;2!=h.length&&3!=h.length||"06"!=e.substr(h[0],2)||"04"!=e.substr(h[h.length-1],2)||(p=H.getHexOfV_AtObj(e,h[0]),a=O.asn1.ASN1Util.oidHexToInt(p),
p=O.asn1.x509.OID.oid2name(a),k=JSON.parse(JSON.stringify(k)),k.x509ExtName=p,p=k);for(a=0;a<h.length;a++)q+=H.dump(e,p,h[a],d+"  ");return q}if("31"==e.substr(h,2)){q=d+"SET\n";h=H.getPosArrayOfChildren_AtObj(e,h);for(a=0;a<h.length;a++)q+=H.dump(e,k,h[a],d+"  ");return q}p=parseInt(e.substr(h,2),16);if(0!=(p&128)){q=p&31;if(0!=(p&32))for(q=d+"["+q+"]\n",h=H.getPosArrayOfChildren_AtObj(e,h),a=0;a<h.length;a++)q+=H.dump(e,k,h[a],d+"  ");else e=H.getHexOfV_AtObj(e,h),"68747470"==e.substr(0,8)&&(e=
hextoutf8(e)),"subjectAltName"===k.x509ExtName&&2==q&&(e=hextoutf8(e)),q=d+"["+q+"] "+e+"\n";return q}return d+"UNKNOWN("+e.substr(h,2)+") "+H.getHexOfV_AtObj(e,h)+"\n"};H.isASN1HEX=function(e){if(1==e.length%2)return!1;var k=H.getIntOfL_AtObj(e,0),h=e.substr(0,2),d=H.getHexOfL_AtObj(e,0);return e.length-h.length-d.length==2*k?!0:!1};r.ASN1HEX=H;u=a.b64tohex;A=a.RSAKey;H=a.ASN1HEX;ga.pemToBase64=function(e){e=e.replace("-----BEGIN CERTIFICATE-----","");e=e.replace("-----END CERTIFICATE-----","");
return e=e.replace(/[ \n]+/g,"")};ga.pemToHex=function(e){e=ga.pemToBase64(e);return u(e)};ga.getSubjectPublicKeyPosFromCertHex=function(e){var k=ga.getSubjectPublicKeyInfoPosFromCertHex(e);if(-1==k)return-1;k=H.getPosArrayOfChildren_AtObj(e,k);if(2!=k.length)return-1;k=k[1];if("03"!=e.substring(k,k+2))return-1;k=H.getStartPosOfV_AtObj(e,k);return"00"!=e.substring(k,k+2)?-1:k+2};ga.getSubjectPublicKeyInfoPosFromCertHex=function(e){var k=H.getStartPosOfV_AtObj(e,0),k=H.getPosArrayOfChildren_AtObj(e,
k);return 1>k.length?-1:"a003020102"==e.substring(k[0],k[0]+10)?6>k.length?-1:k[6]:5>k.length?-1:k[5]};ga.getPublicKeyHexArrayFromCertHex=function(e){var k=ga.getSubjectPublicKeyPosFromCertHex(e),h=H.getPosArrayOfChildren_AtObj(e,k);if(2!=h.length)return[];k=H.getHexOfV_AtObj(e,h[0]);e=H.getHexOfV_AtObj(e,h[1]);return null!=k&&null!=e?[k,e]:[]};ga.getHexTbsCertificateFromCert=function(e){return H.getStartPosOfV_AtObj(e,0)};ga.getPublicKeyHexArrayFromCertPEM=function(e){e=ga.pemToHex(e);return ga.getPublicKeyHexArrayFromCertHex(e)};
ga.hex2dn=function(e){for(var k="",h=H.getPosArrayOfChildren_AtObj(e,0),d=0;d<h.length;d++)var q=H.getHexOfTLV_AtObj(e,h[d]),k=k+"/"+ga.hex2rdn(q);return k};ga.hex2rdn=function(e){var k=H.getDecendantHexTLVByNthList(e,0,[0,0]),h=H.getDecendantHexVByNthList(e,0,[0,1]);e="";try{e=ga.DN_ATTRHEX[k]}catch(d){e=k}h=h.replace(/(..)/g,"%$1");k=decodeURIComponent(h);return e+"="+k};ga.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"};
ga.getPublicKeyFromCertPEM=function(e){var k=ga.getPublicKeyInfoPropOfCertPEM(e);if("2a864886f70d010101"==k.algoid){var h=KEYUTIL.parsePublicRawRSAKeyHex(k.keyhex);e=new A;e.setPublic(h.n,h.e);return e}if("2a8648ce3d0201"==k.algoid)return e=new O.crypto.ECDSA({curve:O.crypto.OID.oidhex2name[k.algparam],info:k.keyhex}),e.setPublicKeyHex(k.keyhex),e;if("2a8648ce380401"==k.algoid){var h=H.getVbyList(k.algparam,0,[0],"02"),d=H.getVbyList(k.algparam,0,[1],"02"),q=H.getVbyList(k.algparam,0,[2],"02"),k=
H.getHexOfV_AtObj(k.keyhex,0),k=k.substr(2);e=new O.crypto.DSA;e.setPublic(new z(h,16),new z(d,16),new z(q,16),new z(k,16));return e}throw"unsupported key";};ga.getPublicKeyInfoPropOfCertPEM=function(e){var k={algparam:null};e=ga.pemToHex(e);var h=H.getPosArrayOfChildren_AtObj(e,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(h[0],2))throw"malformed X.509 certificate PEM (code:002)";h=H.getPosArrayOfChildren_AtObj(e,h[0]);if(7>h.length)throw"malformed X.509 certificate PEM (code:003)";
h=H.getPosArrayOfChildren_AtObj(e,h[6]);if(2!=h.length)throw"malformed X.509 certificate PEM (code:004)";var d=H.getPosArrayOfChildren_AtObj(e,h[0]);if(2!=d.length)throw"malformed X.509 certificate PEM (code:005)";k.algoid=H.getHexOfV_AtObj(e,d[0]);"06"==e.substr(d[1],2)?k.algparam=H.getHexOfV_AtObj(e,d[1]):"30"==e.substr(d[1],2)&&(k.algparam=H.getHexOfTLV_AtObj(e,d[1]));if("03"!=e.substr(h[1],2))throw"malformed X.509 certificate PEM (code:006)";e=H.getHexOfV_AtObj(e,h[1]);k.keyhex=e.substr(2);return k};
ga.getPublicKeyInfoPosOfCertHEX=function(e){var k=H.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:002)";e=H.getPosArrayOfChildren_AtObj(e,k[0]);if(7>e.length)throw"malformed X.509 certificate PEM (code:003)";return e[6]};ga.getV3ExtInfoListOfCertHex=function(e){var k=H.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],
2))throw"malformed X.509 certificate PEM (code:002)";k=H.getPosArrayOfChildren_AtObj(e,k[0]);if(8>k.length)throw"malformed X.509 certificate PEM (code:003)";if("a3"!=e.substr(k[7],2))throw"malformed X.509 certificate PEM (code:004)";k=H.getPosArrayOfChildren_AtObj(e,k[7]);if(1!=k.length)throw"malformed X.509 certificate PEM (code:005)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:006)";for(var k=H.getPosArrayOfChildren_AtObj(e,k[0]),h=k.length,d=Array(h),q=0;q<h;q++)d[q]=
ga.getV3ExtItemInfo_AtObj(e,k[q]);return d};ga.getV3ExtItemInfo_AtObj=function(e,k){var h={};h.posTLV=k;var d=H.getPosArrayOfChildren_AtObj(e,k);if(2!=d.length&&3!=d.length)throw"malformed X.509v3 Ext (code:001)";if("06"!=e.substr(d[0],2))throw"malformed X.509v3 Ext (code:002)";var q=H.getHexOfV_AtObj(e,d[0]);h.oid=H.hextooidstr(q);h.critical=!1;3==d.length&&(h.critical=!0);d=d[d.length-1];if("04"!=e.substr(d,2))throw"malformed X.509v3 Ext (code:003)";h.posV=H.getStartPosOfV_AtObj(e,d);return h};
ga.getHexOfTLV_V3ExtValue=function(e,k){var h=ga.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":H.getHexOfTLV_AtObj(e,h)};ga.getHexOfV_V3ExtValue=function(e,k){var h=ga.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":H.getHexOfV_AtObj(e,h)};ga.getPosOfTLV_V3ExtValue=function(e,k){var h=k;k.match(/^[0-9.]+$/)||(h=O.asn1.x509.OID.name2oid(k));if(""==h)return-1;for(var d=ga.getV3ExtInfoListOfCertHex(e),q=0;q<d.length;q++){var p=d[q];if(p.oid==h)return p.posV}return-1};ga.KEYUSAGE_NAME="digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign encipherOnly decipherOnly".split(" ");
ga.getExtKeyUsageBin=function(e){var k=ga.getHexOfV_V3ExtValue(e,"keyUsage");if(""==k)return"";if(0!=k.length%2||2>=k.length)throw"malformed key usage value";e=parseInt(k.substr(0,2));k=parseInt(k.substr(2),16).toString(2);return k.substr(0,k.length-e)};ga.getExtKeyUsageString=function(e){e=ga.getExtKeyUsageBin(e);for(var k=[],h=0;h<e.length;h++)"1"==e.substr(h,1)&&k.push(ga.KEYUSAGE_NAME[h]);return k.join(",")};ga.getExtAIAInfo=function(e){var k={ocsp:[],caissuer:[]},h=ga.getPosOfTLV_V3ExtValue(e,
"authorityInfoAccess");if(-1==h)return null;if("30"!=e.substr(h,2))throw"malformed AIA Extn Value";for(var h=H.getPosArrayOfChildren_AtObj(e,h),d=0;d<h.length;d++){var q=H.getPosArrayOfChildren_AtObj(e,h[d]);if(2!=q.length)throw"malformed AccessDescription of AIA Extn";var p=q[0],q=q[1];"2b06010505073001"==H.getHexOfV_AtObj(e,p)&&"86"==e.substr(q,2)&&k.ocsp.push(hextoutf8(H.getHexOfV_AtObj(e,q)));"2b06010505073002"==H.getHexOfV_AtObj(e,p)&&"86"==e.substr(q,2)&&k.caissuer.push(hextoutf8(H.getHexOfV_AtObj(e,
q)))}return k};r.X509=ga;var Bc,z=function(e,k,h){null!=e&&("number"==typeof e?this.fromNumber(e,k,h):null==k&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,k))};"Microsoft Internet Explorer"==navigator.appName?(z.prototype.am=we,Bc=30):"Netscape"!=navigator.appName?(z.prototype.am=Ob,Bc=26):(z.prototype.am=ee,Bc=28);z.prototype.DB=Bc;z.prototype.DM=(1<<Bc)-1;z.prototype.DV=1<<Bc;z.prototype.FV=Math.pow(2,52);z.prototype.F1=52-Bc;z.prototype.F2=2*Bc-52;var Yb="0123456789abcdefghijklmnopqrstuvwxyz",
xe=[],Oc,$b;Oc=48;for($b=0;9>=$b;++$b)xe[Oc++]=$b;Oc=97;for($b=10;36>$b;++$b)xe[Oc++]=$b;Oc=65;for($b=10;36>$b;++$b)xe[Oc++]=$b;zc.prototype.convert=function(e){return 0>e.s||0<=e.compareTo(this.m)?e.mod(this.m):e};zc.prototype.revert=function(e){return e};zc.prototype.reduce=function(e){e.divRemTo(this.m,null,e)};zc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};zc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};Qa.prototype.convert=function(e){var k=ja();e.abs().dlShiftTo(this.m.t,
k);k.divRemTo(this.m,null,k);0>e.s&&0<k.compareTo(z.ZERO)&&this.m.subTo(k,k);return k};Qa.prototype.revert=function(e){var k=ja();e.copyTo(k);this.reduce(k);return k};Qa.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var k=0;k<this.m.t;++k){var h=e[k]&32767,d=h*this.mpl+((h*this.mph+(e[k]>>15)*this.mpl&this.um)<<15)&e.DM,h=k+this.m.t;for(e[h]+=this.m.am(0,d,e,k,0,this.m.t);e[h]>=e.DV;)e[h]-=e.DV,e[++h]++}e.clamp();e.drShiftTo(this.m.t,e);0<=e.compareTo(this.m)&&e.subTo(this.m,e)};
Qa.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Qa.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};z.prototype.copyTo=function(e){for(var k=this.t-1;0<=k;--k)e[k]=this[k];e.t=this.t;e.s=this.s};z.prototype.fromInt=function(e){this.t=1;this.s=0>e?-1:0;0<e?this[0]=e:-1>e?this[0]=e+this.DV:this.t=0};z.prototype.fromString=function(e,k){var h;if(16==k)h=4;else if(8==k)h=3;else if(256==k)h=8;else if(2==k)h=1;else if(32==k)h=5;else if(4==k)h=2;else{this.fromRadix(e,k);return}this.s=
this.t=0;for(var d=e.length,q=!1,p=0;0<=--d;){var a=8==h?e[d]&255:Zc(e,d);0>a?"-"==e.charAt(d)&&(q=!0):(q=!1,0==p?this[this.t++]=a:p+h>this.DB?(this[this.t-1]|=(a&(1<<this.DB-p)-1)<<p,this[this.t++]=a>>this.DB-p):this[this.t-1]|=a<<p,p+=h,p>=this.DB&&(p-=this.DB))}8==h&&0!=(e[0]&128)&&(this.s=-1,0<p&&(this[this.t-1]|=(1<<this.DB-p)-1<<p));this.clamp();q&&z.ZERO.subTo(this,this)};z.prototype.clamp=function(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t};z.prototype.dlShiftTo=function(e,
k){var h;for(h=this.t-1;0<=h;--h)k[h+e]=this[h];for(h=e-1;0<=h;--h)k[h]=0;k.t=this.t+e;k.s=this.s};z.prototype.drShiftTo=function(e,k){for(var h=e;h<this.t;++h)k[h-e]=this[h];k.t=Math.max(this.t-e,0);k.s=this.s};z.prototype.lShiftTo=function(e,k){var h=e%this.DB,d=this.DB-h,q=(1<<d)-1,p=Math.floor(e/this.DB),a=this.s<<h&this.DM,b;for(b=this.t-1;0<=b;--b)k[b+p+1]=this[b]>>d|a,a=(this[b]&q)<<h;for(b=p-1;0<=b;--b)k[b]=0;k[p]=a;k.t=this.t+p+1;k.s=this.s;k.clamp()};z.prototype.rShiftTo=function(e,k){k.s=
this.s;var h=Math.floor(e/this.DB);if(h>=this.t)k.t=0;else{var d=e%this.DB,q=this.DB-d,p=(1<<d)-1;k[0]=this[h]>>d;for(var a=h+1;a<this.t;++a)k[a-h-1]|=(this[a]&p)<<q,k[a-h]=this[a]>>d;0<d&&(k[this.t-h-1]|=(this.s&p)<<q);k.t=this.t-h;k.clamp()}};z.prototype.subTo=function(e,k){for(var h=0,d=0,q=Math.min(e.t,this.t);h<q;)d+=this[h]-e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d-=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d-=e[h],k[h++]=d&this.DM,
d>>=this.DB;d-=e.s}k.s=0>d?-1:0;-1>d?k[h++]=this.DV+d:0<d&&(k[h++]=d);k.t=h;k.clamp()};z.prototype.multiplyTo=function(e,k){var h=this.abs(),d=e.abs(),q=h.t;for(k.t=q+d.t;0<=--q;)k[q]=0;for(q=0;q<d.t;++q)k[q+h.t]=h.am(0,d[q],k,q,0,h.t);k.s=0;k.clamp();this.s!=e.s&&z.ZERO.subTo(k,k)};z.prototype.squareTo=function(e){for(var k=this.abs(),h=e.t=2*k.t;0<=--h;)e[h]=0;for(h=0;h<k.t-1;++h){var d=k.am(h,k[h],e,2*h,0,1);(e[h+k.t]+=k.am(h+1,2*k[h],e,2*h+1,d,k.t-h-1))>=k.DV&&(e[h+k.t]-=k.DV,e[h+k.t+1]=1)}0<
e.t&&(e[e.t-1]+=k.am(h,k[h],e,2*h,0,1));e.s=0;e.clamp()};z.prototype.divRemTo=function(e,k,h){var d=e.abs();if(!(0>=d.t)){var q=this.abs();if(q.t<d.t)null!=k&&k.fromInt(0),null!=h&&this.copyTo(h);else{null==h&&(h=ja());var p=ja(),a=this.s;e=e.s;var b=this.DB-Id(d[d.t-1]);0<b?(d.lShiftTo(b,p),q.lShiftTo(b,h)):(d.copyTo(p),q.copyTo(h));d=p.t;q=p[d-1];if(0!=q){var c=q*(1<<this.F1)+(1<d?p[d-2]>>this.F2:0),f=this.FV/c,c=(1<<this.F1)/c,g=1<<this.F2,l=h.t,m=l-d,n=null==k?ja():k;p.dlShiftTo(m,n);0<=h.compareTo(n)&&
(h[h.t++]=1,h.subTo(n,h));z.ONE.dlShiftTo(d,n);for(n.subTo(p,p);p.t<d;)p[p.t++]=0;for(;0<=--m;){var s=h[--l]==q?this.DM:Math.floor(h[l]*f+(h[l-1]+g)*c);if((h[l]+=p.am(0,s,h,m,0,d))<s)for(p.dlShiftTo(m,n),h.subTo(n,h);h[l]<--s;)h.subTo(n,h)}null!=k&&(h.drShiftTo(d,k),a!=e&&z.ZERO.subTo(k,k));h.t=d;h.clamp();0<b&&h.rShiftTo(b,h);0>a&&z.ZERO.subTo(h,h)}}}};z.prototype.invDigit=function(){if(1>this.t)return 0;var e=this[0];if(0==(e&1))return 0;var k=e&3,k=k*(2-(e&15)*k)&15,k=k*(2-(e&255)*k)&255,k=k*(2-
((e&65535)*k&65535))&65535,k=k*(2-e*k%this.DV)%this.DV;return 0<k?this.DV-k:-k};z.prototype.isEven=function(){return 0==(0<this.t?this[0]&1:this.s)};z.prototype.exp=function(e,k){if(4294967295<e||1>e)return z.ONE;var h=ja(),d=ja(),q=k.convert(this),p=Id(e)-1;for(q.copyTo(h);0<=--p;)if(k.sqrTo(h,d),0<(e&1<<p))k.mulTo(d,q,h);else var a=h,h=d,d=a;return k.revert(h)};z.prototype.toString=function(e){if(0>this.s)return"-"+this.negate().toString(e);if(16==e)e=4;else if(8==e)e=3;else if(2==e)e=1;else if(32==
e)e=5;else if(4==e)e=2;else return this.toRadix(e);var k=(1<<e)-1,h,d=!1,q="",p=this.t,a=this.DB-p*this.DB%e;if(0<p--)for(a<this.DB&&0<(h=this[p]>>a)&&(d=!0,q=Yb.charAt(h));0<=p;)a<e?(h=(this[p]&(1<<a)-1)<<e-a,h|=this[--p]>>(a+=this.DB-e)):(h=this[p]>>(a-=e)&k,0>=a&&(a+=this.DB,--p)),0<h&&(d=!0),d&&(q+=Yb.charAt(h));return d?q:"0"};z.prototype.negate=function(){var e=ja();z.ZERO.subTo(this,e);return e};z.prototype.abs=function(){return 0>this.s?this.negate():this};z.prototype.compareTo=function(e){var k=
this.s-e.s;if(0!=k)return k;var h=this.t,k=h-e.t;if(0!=k)return 0>this.s?-k:k;for(;0<=--h;)if(0!=(k=this[h]-e[h]))return k;return 0};z.prototype.bitLength=function(){return 0>=this.t?0:this.DB*(this.t-1)+Id(this[this.t-1]^this.s&this.DM)};z.prototype.mod=function(e){var k=ja();this.abs().divRemTo(e,null,k);0>this.s&&0<k.compareTo(z.ZERO)&&e.subTo(k,k);return k};z.prototype.modPowInt=function(e,k){var h;h=256>e||k.isEven()?new zc(k):new Qa(k);return this.exp(e,h)};z.ZERO=Kc(0);z.ONE=Kc(1);ad.prototype.convert=
Jd;ad.prototype.revert=Jd;ad.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h)};ad.prototype.sqrTo=function(e,k){e.squareTo(k)};Lc.prototype.convert=function(e){if(0>e.s||e.t>2*this.m.t)return e.mod(this.m);if(0>e.compareTo(this.m))return e;var k=ja();e.copyTo(k);this.reduce(k);return k};Lc.prototype.revert=function(e){return e};Lc.prototype.reduce=function(e){e.drShiftTo(this.m.t-1,this.r2);e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,
this.m.t+1,this.r2);0>e.compareTo(this.r2);)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);0<=e.compareTo(this.m);)e.subTo(this.m,e)};Lc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};Lc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};var vb=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,
313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],ff=67108864/vb[vb.length-1];z.prototype.chunkSize=function(e){return Math.floor(Math.LN2*
this.DB/Math.log(e))};z.prototype.toRadix=function(e){null==e&&(e=10);if(0==this.signum()||2>e||36<e)return"0";var k=this.chunkSize(e),k=Math.pow(e,k),h=Kc(k),d=ja(),q=ja(),p="";for(this.divRemTo(h,d,q);0<d.signum();)p=(k+q.intValue()).toString(e).substr(1)+p,d.divRemTo(h,d,q);return q.intValue().toString(e)+p};z.prototype.fromRadix=function(e,k){this.fromInt(0);null==k&&(k=10);for(var h=this.chunkSize(k),d=Math.pow(k,h),q=!1,p=0,a=0,b=0;b<e.length;++b){var c=Zc(e,b);0>c?"-"==e.charAt(b)&&0==this.signum()&&
(q=!0):(a=k*a+c,++p>=h&&(this.dMultiply(d),this.dAddOffset(a,0),a=p=0))}0<p&&(this.dMultiply(Math.pow(k,p)),this.dAddOffset(a,0));q&&z.ZERO.subTo(this,this)};z.prototype.fromNumber=function(e,k,h){if("number"==typeof k)if(2>e)this.fromInt(1);else for(this.fromNumber(e,h),this.testBit(e-1)||this.bitwiseTo(z.ONE.shiftLeft(e-1),Vd,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(k);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(z.ONE.shiftLeft(e-1),this);else{h=[];var d=e&7;h.length=
(e>>3)+1;k.nextBytes(h);h[0]=0<d?h[0]&(1<<d)-1:0;this.fromString(h,256)}};z.prototype.bitwiseTo=function(e,k,h){var d,q,p=Math.min(e.t,this.t);for(d=0;d<p;++d)h[d]=k(this[d],e[d]);if(e.t<this.t){q=e.s&this.DM;for(d=p;d<this.t;++d)h[d]=k(this[d],q);h.t=this.t}else{q=this.s&this.DM;for(d=p;d<e.t;++d)h[d]=k(q,e[d]);h.t=e.t}h.s=k(this.s,e.s);h.clamp()};z.prototype.changeBit=function(e,k){var h=z.ONE.shiftLeft(e);this.bitwiseTo(h,k,h);return h};z.prototype.addTo=function(e,k){for(var h=0,d=0,q=Math.min(e.t,
this.t);h<q;)d+=this[h]+e[h],k[h++]=d&this.DM,d>>=this.DB;if(e.t<this.t){for(d+=e.s;h<this.t;)d+=this[h],k[h++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;h<e.t;)d+=e[h],k[h++]=d&this.DM,d>>=this.DB;d+=e.s}k.s=0>d?-1:0;0<d?k[h++]=d:-1>d&&(k[h++]=this.DV+d);k.t=h;k.clamp()};z.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t);++this.t;this.clamp()};z.prototype.dAddOffset=function(e,k){if(0!=e){for(;this.t<=k;)this[this.t++]=0;for(this[k]+=e;this[k]>=this.DV;)this[k]-=
this.DV,++k>=this.t&&(this[this.t++]=0),++this[k]}};z.prototype.multiplyLowerTo=function(e,k,h){var d=Math.min(this.t+e.t,k);h.s=0;for(h.t=d;0<d;)h[--d]=0;var q;for(q=h.t-this.t;d<q;++d)h[d+this.t]=this.am(0,e[d],h,d,0,this.t);for(q=Math.min(e.t,k);d<q;++d)this.am(0,e[d],h,d,0,k-d);h.clamp()};z.prototype.multiplyUpperTo=function(e,k,h){--k;var d=h.t=this.t+e.t-k;for(h.s=0;0<=--d;)h[d]=0;for(d=Math.max(k-this.t,0);d<e.t;++d)h[this.t+d-k]=this.am(k-d,e[d],h,0,0,this.t+d-k);h.clamp();h.drShiftTo(1,h)};
z.prototype.modInt=function(e){if(0>=e)return 0;var k=this.DV%e,h=0>this.s?e-1:0;if(0<this.t)if(0==k)h=this[0]%e;else for(var d=this.t-1;0<=d;--d)h=(k*h+this[d])%e;return h};z.prototype.millerRabin=function(e){var k=this.subtract(z.ONE),h=k.getLowestSetBit();if(0>=h)return!1;var d=k.shiftRight(h);e=e+1>>1;e>vb.length&&(e=vb.length);for(var q=ja(),p=0;p<e;++p){q.fromInt(vb[Math.floor(Math.random()*vb.length)]);var a=q.modPow(d,this);if(0!=a.compareTo(z.ONE)&&0!=a.compareTo(k)){for(var b=1;b++<h&&0!=
a.compareTo(k);)if(a=a.modPowInt(2,this),0==a.compareTo(z.ONE))return!1;if(0!=a.compareTo(k))return!1}}return!0};z.prototype.clone=function(){var e=ja();this.copyTo(e);return e};z.prototype.intValue=function(){if(0>this.s){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]};z.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24};z.prototype.shortValue=function(){return 0==
this.t?this.s:this[0]<<16>>16};z.prototype.signum=function(){return 0>this.s?-1:0>=this.t||1==this.t&&0>=this[0]?0:1};z.prototype.toByteArray=function(){var e=this.t,k=[];k[0]=this.s;var h=this.DB-e*this.DB%8,d,q=0;if(0<e--)for(h<this.DB&&(d=this[e]>>h)!=(this.s&this.DM)>>h&&(k[q++]=d|this.s<<this.DB-h);0<=e;)if(8>h?(d=(this[e]&(1<<h)-1)<<8-h,d|=this[--e]>>(h+=this.DB-8)):(d=this[e]>>(h-=8)&255,0>=h&&(h+=this.DB,--e)),0!=(d&128)&&(d|=-256),0==q&&(this.s&128)!=(d&128)&&++q,0<q||d!=this.s)k[q++]=d;
return k};z.prototype.equals=function(e){return 0==this.compareTo(e)};z.prototype.min=function(e){return 0>this.compareTo(e)?this:e};z.prototype.max=function(e){return 0<this.compareTo(e)?this:e};z.prototype.and=function(e){var k=ja();this.bitwiseTo(e,Le,k);return k};z.prototype.or=function(e){var k=ja();this.bitwiseTo(e,Vd,k);return k};z.prototype.xor=function(e){var k=ja();this.bitwiseTo(e,Wd,k);return k};z.prototype.andNot=function(e){var k=ja();this.bitwiseTo(e,$c,k);return k};z.prototype.not=
function(){for(var e=ja(),k=0;k<this.t;++k)e[k]=this.DM&~this[k];e.t=this.t;e.s=~this.s;return e};z.prototype.shiftLeft=function(e){var k=ja();0>e?this.rShiftTo(-e,k):this.lShiftTo(e,k);return k};z.prototype.shiftRight=function(e){var k=ja();0>e?this.lShiftTo(-e,k):this.rShiftTo(e,k);return k};z.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e]){var k=e*this.DB;e=this[e];if(0==e)e=-1;else{var h=0;0==(e&65535)&&(e>>=16,h+=16);0==(e&255)&&(e>>=8,h+=8);0==(e&15)&&(e>>=4,h+=
4);0==(e&3)&&(e>>=2,h+=2);0==(e&1)&&++h;e=h}return k+e}return 0>this.s?this.t*this.DB:-1};z.prototype.bitCount=function(){for(var e=0,k=this.s&this.DM,h=0;h<this.t;++h){for(var d=this[h]^k,q=0;0!=d;)d&=d-1,++q;e+=q}return e};z.prototype.testBit=function(e){var k=Math.floor(e/this.DB);return k>=this.t?0!=this.s:0!=(this[k]&1<<e%this.DB)};z.prototype.setBit=function(e){return this.changeBit(e,Vd)};z.prototype.clearBit=function(e){return this.changeBit(e,$c)};z.prototype.flipBit=function(e){return this.changeBit(e,
Wd)};z.prototype.add=function(e){var k=ja();this.addTo(e,k);return k};z.prototype.subtract=function(e){var k=ja();this.subTo(e,k);return k};z.prototype.multiply=function(e){var k=ja();this.multiplyTo(e,k);return k};z.prototype.divide=function(e){var k=ja();this.divRemTo(e,k,null);return k};z.prototype.remainder=function(e){var k=ja();this.divRemTo(e,null,k);return k};z.prototype.divideAndRemainder=function(e){var k=ja(),h=ja();this.divRemTo(e,k,h);return[k,h]};z.prototype.modPow=function(e,k){var h=
e.bitLength(),d,q=Kc(1),p;if(0>=h)return q;d=18>h?1:48>h?3:144>h?4:768>h?5:6;p=8>h?new zc(k):k.isEven()?new Lc(k):new Qa(k);var a=[],b=3,c=d-1,f=(1<<d)-1;a[1]=p.convert(this);if(1<d)for(h=ja(),p.sqrTo(a[1],h);b<=f;)a[b]=ja(),p.mulTo(h,a[b-2],a[b]),b+=2;for(var g=e.t-1,l,n=!0,m=ja(),h=Id(e[g])-1;0<=g;){h>=c?l=e[g]>>h-c&f:(l=(e[g]&(1<<h+1)-1)<<c-h,0<g&&(l|=e[g-1]>>this.DB+h-c));for(b=d;0==(l&1);)l>>=1,--b;0>(h-=b)&&(h+=this.DB,--g);if(n)a[l].copyTo(q),n=!1;else{for(;1<b;)p.sqrTo(q,m),p.sqrTo(m,q),b-=
2;0<b?p.sqrTo(q,m):(b=q,q=m,m=b);p.mulTo(m,a[l],q)}for(;0<=g&&0==(e[g]&1<<h);)p.sqrTo(q,m),b=q,q=m,m=b,0>--h&&(h=this.DB-1,--g)}return p.revert(q)};z.prototype.modInverse=function(e){var k=e.isEven();if(this.isEven()&&k||0==e.signum())return z.ZERO;for(var h=e.clone(),d=this.clone(),q=Kc(1),p=Kc(0),a=Kc(0),b=Kc(1);0!=h.signum();){for(;h.isEven();)h.rShiftTo(1,h),k?(q.isEven()&&p.isEven()||(q.addTo(this,q),p.subTo(e,p)),q.rShiftTo(1,q)):p.isEven()||p.subTo(e,p),p.rShiftTo(1,p);for(;d.isEven();)d.rShiftTo(1,
d),k?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(e,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(e,b),b.rShiftTo(1,b);0<=h.compareTo(d)?(h.subTo(d,h),k&&q.subTo(a,q),p.subTo(b,p)):(d.subTo(h,d),k&&a.subTo(q,a),b.subTo(p,b))}if(0!=d.compareTo(z.ONE))return z.ZERO;if(0<=b.compareTo(e))return b.subtract(e);if(0>b.signum())b.addTo(e,b);else return b;return 0>b.signum()?b.add(e):b};z.prototype.pow=function(e){return this.exp(e,new ad)};z.prototype.gcd=function(e){var k=0>this.s?this.negate():this.clone();
e=0>e.s?e.negate():e.clone();if(0>k.compareTo(e)){var h=k,k=e;e=h}var h=k.getLowestSetBit(),d=e.getLowestSetBit();if(0>d)return k;h<d&&(d=h);0<d&&(k.rShiftTo(d,k),e.rShiftTo(d,e));for(;0<k.signum();)0<(h=k.getLowestSetBit())&&k.rShiftTo(h,k),0<(h=e.getLowestSetBit())&&e.rShiftTo(h,e),0<=k.compareTo(e)?(k.subTo(e,k),k.rShiftTo(1,k)):(e.subTo(k,e),e.rShiftTo(1,e));0<d&&e.lShiftTo(d,e);return e};z.prototype.isProbablePrime=function(e){var k,h=this.abs();if(1==h.t&&h[0]<=vb[vb.length-1]){for(k=0;k<vb.length;++k)if(h[0]==
vb[k])return!0;return!1}if(h.isEven())return!1;for(k=1;k<vb.length;){for(var d=vb[k],q=k+1;q<vb.length&&d<ff;)d*=vb[q++];for(d=h.modInt(d);k<q;)if(0==d%vb[k++])return!1}return h.millerRabin(e)};z.prototype.square=function(){var e=ja();this.squareTo(e);return e};r.BigInteger=z;var H=a.ASN1HEX,O=a.KJUR,A=a.RSAKey,u=a.b64tohex,r=a=a||{};r.createHash=function(e){if("sha256"!=e)throw Error("createHash: unsupported algorithm.");e={};e.md=new O.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});e.update=
function(e){this.md.updateHex(e.toString("hex"))};e.digest=function(e){var h=this.md.digest();return"hex"==e?h:"base64"==e?(new g(h,"hex")).toString("base64"):new g(h,"hex")};return e};r.createHmac=function(e,k){if("sha256"!==e)throw Error("createHmac: unsupported algorithm.");var h={};h.md=new O.crypto.Mac({alg:"HmacSHA256",pass:{hex:k.toString("hex")}});h.update=function(d){this.md.updateHex(d.toString("hex"))};h.digest=function(d){var e=this.md.doFinal();return"hex"==d?e:"base64"==d?(new g(e,"hex")).toString("base64"):
new g(e,"hex")};return h};r.createSign=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");return{arr:[],update:function(e){this.arr.push(e)},sign:function(e){var h=new A;h.readPrivateKeyFromPEMString(e);e=new O.crypto.Signature({alg:"SHA256withRSA",prov:"cryptojs/jsrsa"});e.initSign(h);for(h=0;h<this.arr.length;++h)e.updateHex(this.arr[h].toString("hex"));return new g(e.sign(),"hex")}}};r.createVerify=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");
return{arr:[],update:function(e){this.arr.push(e)},verify:function(e,h){for(var d=e.split("\n"),q="",p=1;p<d.length-1;p++)q+=d[p];d=(new g(q,"base64")).toString("hex");q=H.getPosArrayOfChildren_AtObj(d,0);2!=q.length?q=-1:(q=q[1],"03"!=d.substring(q,q+2)?q=-1:(q=H.getStartPosOfV_AtObj(d,q),q="00"!=d.substring(q,q+2)?-1:q+2));p=H.getPosArrayOfChildren_AtObj(d,q);2!=p.length?q=null:(q=H.getHexOfV_AtObj(d,p[0]),d=H.getHexOfV_AtObj(d,p[1]),p=new A,p.setPublic(q,d),q=p);d=new O.crypto.Signature({alg:"SHA256withRSA",
prov:"cryptojs/jsrsa"});d.initVerifyByPublicKey(q);for(q=0;q<this.arr.length;q++)d.updateHex(this.arr[q].toString("hex"));q=h.toString("hex");return d.verify(q)}}};r.randomBytes=function(e){for(var k=new g(e),h=0;h<e;++h)k[h]=Math.floor(256*Math.random());return k};r.toByteArray=function(e){var k=[];u(e).replace(/(..)/g,function(e){k.push(parseInt(e,16))});return k};var cd={};(function(e){function k(e){e=e.charCodeAt(0);if(e===d)return 62;if(e===q)return 63;if(e<p)return-1;if(e<p+10)return e-p+52;
if(e<b+26)return e-b;if(e<a+26)return e-a+26}var h="undefined"!==typeof Uint8Array?Uint8Array:Array,d=43,q=47,p=48,a=97,b=65;e.toByteArray=function(d){function e(d){c[f++]=d}var q,p,a,b,c;if(0<d.length%4)throw Error("Invalid string. Length must be a multiple of 4");q=d.length;b="="===d.charAt(q-2)?2:"="===d.charAt(q-1)?1:0;c=new h(3*d.length/4-b);p=0<b?d.length-4:d.length;var f=0;for(q=0;q<p;q+=4)a=k(d.charAt(q))<<18|k(d.charAt(q+1))<<12|k(d.charAt(q+2))<<6|k(d.charAt(q+3)),e((a&16711680)>>16),e((a&
65280)>>8),e(a&255);2===b?(a=k(d.charAt(q))<<2|k(d.charAt(q+1))>>4,e(a&255)):1===b&&(a=k(d.charAt(q))<<10|k(d.charAt(q+1))<<4|k(d.charAt(q+2))>>2,e(a>>8&255),e(a&255));return c};e.fromByteArray=function(d){var e,h=d.length%3,k="",q,p;e=0;for(p=d.length-h;e<p;e+=3)q=(d[e]<<16)+(d[e+1]<<8)+d[e+2],q="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>18&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>
6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q&63),k+=q;switch(h){case 1:q=d[d.length-1];k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>2);k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q<<4&63);k+="==";break;case 2:q=(d[d.length-2]<<8)+d[d.length-1],k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>10),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q>>
4&63),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(q<<2&63),k+="="}return k}})(cd);r.ieee={read:function(e,k,h,d,q){var p;p=8*q-d-1;var a=(1<<p)-1,b=a>>1,c=-7;q=h?q-1:0;var f=h?-1:1,g=e[k+q];q+=f;h=g&(1<<-c)-1;g>>=-c;for(c+=p;0<c;h=256*h+e[k+q],q+=f,c-=8);p=h&(1<<-c)-1;h>>=-c;for(c+=d;0<c;p=256*p+e[k+q],q+=f,c-=8);if(0===h)h=1-b;else{if(h===a)return p?NaN:Infinity*(g?-1:1);p+=Math.pow(2,d);h-=b}return(g?-1:1)*p*Math.pow(2,h-d)},write:function(e,k,h,d,q,p){var a,b=8*
p-q-1,c=(1<<b)-1,f=c>>1,g=23===q?Math.pow(2,-24)-Math.pow(2,-77):0;p=d?0:p-1;var l=d?1:-1,m=0>k||0===k&&0>1/k?1:0;k=Math.abs(k);isNaN(k)||Infinity===k?(k=isNaN(k)?1:0,d=c):(d=Math.floor(Math.log(k)/Math.LN2),1>k*(a=Math.pow(2,-d))&&(d--,a*=2),k=1<=d+f?k+g/a:k+g*Math.pow(2,1-f),2<=k*a&&(d++,a/=2),d+f>=c?(k=0,d=c):1<=d+f?(k=(k*a-1)*Math.pow(2,q),d+=f):(k=k*Math.pow(2,f-1)*Math.pow(2,q),d=0));for(;8<=q;e[h+p]=k&255,p+=l,k/=256,q-=8);d=d<<q|k;for(b+=q;0<b;e[h+p]=d&255,p+=l,d/=256,b-=8);e[h+p-l]|=128*
m}};var Ma=a.ieee;r.Buffer=g;r.SlowBuffer=g;r.INSPECT_MAX_BYTES=50;g.poolSize=8192;g._useTypedArrays=function(){try{var e=new ArrayBuffer(0),k=new Uint8Array(e);k.foo=function(){return 42};return 42===k.foo()&&"function"===typeof k.subarray}catch(h){return!1}}();g.isEncoding=function(e){switch(String(e).toLowerCase()){case "hex":case "utf8":case "utf-8":case "ascii":case "binary":case "base64":case "raw":case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":return!0;default:return!1}};g.isBuffer=
function(e){return!(null===e||void 0===e||!e._isBuffer)};g.byteLength=function(e,k){var h;e=e.toString();switch(k||"utf8"){case "hex":h=e.length/2;break;case "utf8":case "utf-8":h=g.utf8ToBytes(e).length;break;case "ascii":case "binary":case "raw":h=e.length;break;case "base64":h=g.base64ToBytes(e).length;break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":h=2*e.length;break;default:throw Error("Unknown encoding");}return h};g.concat=function(e,k){g.assert(g.isArray(e),"Usage: Buffer.concat(list[, length])");
if(0===e.length)return new g(0);if(1===e.length)return e[0];var h;if(void 0===k)for(h=k=0;h<e.length;h++)k+=e[h].length;var d=new g(k),q=0;for(h=0;h<e.length;h++){var p=e[h];p.copy(d,q);q+=p.length}return d};g.compare=function(e,k){g.assert(g.isBuffer(e)&&g.isBuffer(k),"Arguments must be Buffers");for(var h=e.length,d=k.length,q=0,p=Math.min(h,d);q<p&&e[q]===k[q];q++);q!==p&&(h=e[q],d=k[q]);return h<d?-1:d<h?1:0};g.hexWrite=function(e,k,h,d){h=Number(h)||0;var q=e.length-h;d?(d=Number(d),d>q&&(d=
q)):d=q;q=k.length;g.assert(0===q%2,"Invalid hex string");d>q/2&&(d=q/2);for(q=0;q<d;q++){var p=parseInt(k.substr(2*q,2),16);g.assert(!isNaN(p),"Invalid hex string");e[h+q]=p}return q};g.utf8Write=function(e,k,h,d){return g.blitBuffer(g.utf8ToBytes(k),e,h,d)};g.asciiWrite=function(e,k,h,d){return g.blitBuffer(g.asciiToBytes(k),e,h,d)};g.binaryWrite=function(e,k,h,d){return g.asciiWrite(e,k,h,d)};g.base64Write=function(e,k,h,d){return g.blitBuffer(g.base64ToBytes(k),e,h,d)};g.utf16leWrite=function(e,
k,h,d){return g.blitBuffer(g.utf16leToBytes(k),e,h,d)};g.prototype.write=function(e,k,h,d){if(isFinite(k))isFinite(h)||(d=h,h=void 0);else{var q=d;d=k;k=h;h=q}k=Number(k)||0;q=this.length-k;h?(h=Number(h),h>q&&(h=q)):h=q;d=String(d||"utf8").toLowerCase();switch(d){case "hex":e=g.hexWrite(this,e,k,h);break;case "utf8":case "utf-8":e=g.utf8Write(this,e,k,h);break;case "ascii":e=g.asciiWrite(this,e,k,h);break;case "binary":e=g.binaryWrite(this,e,k,h);break;case "base64":e=g.base64Write(this,e,k,h);break;
case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=g.utf16leWrite(this,e,k,h);break;default:throw Error("Unknown encoding");}return e};g.prototype.toString=function(e,k,h){e=String(e||"utf8").toLowerCase();k=Number(k)||0;h=void 0===h?this.length:Number(h);if(h===k)return"";switch(e){case "hex":e=g.hexSlice(this,k,h);break;case "utf8":case "utf-8":e=g.utf8Slice(this,k,h);break;case "ascii":e=g.asciiSlice(this,k,h);break;case "binary":e=g.binarySlice(this,k,h);break;case "base64":e=g.base64Slice(this,
k,h);break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=this.slice(k,h);k="";for(h=0;h<e.length;h+=2)k+=String.fromCharCode(e[h]+256*e[h+1]);e=k;break;default:throw Error("Unknown encoding");}return e};g.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};g.prototype.equals=function(e){g.assert(g.isBuffer(e),"Argument must be a Buffer");return 0===g.compare(this,e)};g.prototype.compare=function(e){g.assert(g.isBuffer(e),"Argument must be a Buffer");
return g.compare(this,e)};g.prototype.copy=function(e,k,h,d){h||(h=0);d||0===d||(d=this.length);k||(k=0);if(d!==h&&0!==e.length&&0!==this.length)if(g.assert(d>=h,"sourceEnd < sourceStart"),g.assert(0<=k&&k<e.length,"targetStart out of bounds"),g.assert(0<=h&&h<this.length,"sourceStart out of bounds"),g.assert(0<=d&&d<=this.length,"sourceEnd out of bounds"),d>this.length&&(d=this.length),e.length-k<d-h&&(d=e.length-k+h),d-=h,100>d||!g._useTypedArrays)for(var q=0;q<d;q++)e[q+k]=this[q+h];else e._set(this.subarray(h,
h+d),k)};g.base64Slice=function(e,k,h){return 0===k&&h===e.length?cd.fromByteArray(e):cd.fromByteArray(e.slice(k,h))};g.utf8Slice=function(e,k,h){var d="",q="";for(h=Math.min(e.length,h);k<h;k++)127>=e[k]?(d+=g.decodeUtf8Char(q)+String.fromCharCode(e[k]),q=""):q+="%"+e[k].toString(16);return d+g.decodeUtf8Char(q)};g.asciiSlice=function(e,k,h){var d="";for(h=Math.min(e.length,h);k<h;k++)d+=String.fromCharCode(e[k]);return d};g.binarySlice=function(e,k,h){return g.asciiSlice(e,k,h)};g.hexSlice=function(e,
k,h){var d=e.length;if(!k||0>k)k=0;if(!h||0>h||h>d)h=d;for(d="";k<h;k++)d+=g.toHex(e[k]);return d};g.prototype.slice=function(e,k){var h=this.length;e=g.clamp(e,h,0);k=g.clamp(k,h,h);if(g._useTypedArrays)return g._augment(this.subarray(e,k));for(var h=k-e,d=new g(h,void 0,!0),q=0;q<h;q++)d[q]=this[q+e];return d};g.prototype.get=function(e){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(e)};g.prototype.set=function(e,k){console.log(".set() is deprecated. Access using array indexes instead.");
return this.writeUInt8(e,k)};g.prototype.readUInt8=function(e,k){k||(g.assert(void 0!==e&&null!==e,"missing offset"),g.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]};g.readUInt16=function(e,k,h,d){d||(g.assert("boolean"===typeof h,"missing or invalid endian"),g.assert(void 0!==k&&null!==k,"missing offset"),g.assert(k+1<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d))return h?(h=e[k],k+1<d&&(h|=e[k+1]<<8)):(h=e[k]<<8,k+1<d&&
(h|=e[k+1])),h};g.prototype.readUInt16LE=function(e,k){return g.readUInt16(this,e,!0,k)};g.prototype.readUInt16BE=function(e,k){return g.readUInt16(this,e,!1,k)};g.readUInt32=function(e,k,h,d){d||(g.assert("boolean"===typeof h,"missing or invalid endian"),g.assert(void 0!==k&&null!==k,"missing offset"),g.assert(k+3<e.length,"Trying to read beyond buffer length"));d=e.length;if(!(k>=d)){var q;h?(k+2<d&&(q=e[k+2]<<16),k+1<d&&(q|=e[k+1]<<8),q|=e[k],k+3<d&&(q+=e[k+3]<<24>>>0)):(k+1<d&&(q=e[k+1]<<16),
k+2<d&&(q|=e[k+2]<<8),k+3<d&&(q|=e[k+3]),q+=e[k]<<24>>>0);return q}};g.prototype.readUInt32LE=function(e,k){return g.readUInt32(this,e,!0,k)};g.prototype.readUInt32BE=function(e,k){return g.readUInt32(this,e,!1,k)};g.prototype.readInt8=function(e,k){k||(g.assert(void 0!==e&&null!==e,"missing offset"),g.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]&128?-1*(255-this[e]+1):this[e]};g.readInt16=function(e,k,h,d){d||(g.assert("boolean"===typeof h,"missing or invalid endian"),
g.assert(void 0!==k&&null!==k,"missing offset"),g.assert(k+1<e.length,"Trying to read beyond buffer length"));if(!(k>=e.length))return e=g.readUInt16(e,k,h,!0),e&32768?-1*(65535-e+1):e};g.prototype.readInt16LE=function(e,k){return g.readInt16(this,e,!0,k)};g.prototype.readInt16BE=function(e,k){return g.readInt16(this,e,!1,k)};g.readInt32=function(e,k,h,d){d||(g.assert("boolean"===typeof h,"missing or invalid endian"),g.assert(void 0!==k&&null!==k,"missing offset"),g.assert(k+3<e.length,"Trying to read beyond buffer length"));
if(!(k>=e.length))return e=g.readUInt32(e,k,h,!0),e&2147483648?-1*(4294967295-e+1):e};g.prototype.readInt32LE=function(e,k){return g.readInt32(this,e,!0,k)};g.prototype.readInt32BE=function(e,k){return g.readInt32(this,e,!1,k)};g.readFloat=function(e,k,h,d){d||(g.assert("boolean"===typeof h,"missing or invalid endian"),g.assert(k+3<e.length,"Trying to read beyond buffer length"));return Ma.read(e,k,h,23,4)};g.prototype.readFloatLE=function(e,k){return g.readFloat(this,e,!0,k)};g.prototype.readFloatBE=
function(e,k){return g.readFloat(this,e,!1,k)};g.readDouble=function(e,k,h,d){d||(g.assert("boolean"===typeof h,"missing or invalid endian"),g.assert(k+7<e.length,"Trying to read beyond buffer length"));return Ma.read(e,k,h,52,8)};g.prototype.readDoubleLE=function(e,k){return g.readDouble(this,e,!0,k)};g.prototype.readDoubleBE=function(e,k){return g.readDouble(this,e,!1,k)};g.prototype.writeUInt8=function(e,k,h){h||(g.assert(void 0!==e&&null!==e,"missing value"),g.assert(void 0!==k&&null!==k,"missing offset"),
g.assert(k<this.length,"trying to write beyond buffer length"),g.verifuint(e,255));if(!(k>=this.length))return this[k]=e,k+1};g.writeUInt16=function(e,k,h,d,q){q||(g.assert(void 0!==k&&null!==k,"missing value"),g.assert("boolean"===typeof d,"missing or invalid endian"),g.assert(void 0!==h&&null!==h,"missing offset"),g.assert(h+1<e.length,"trying to write beyond buffer length"),g.verifuint(k,65535));var p=e.length;if(!(h>=p)){q=0;for(p=Math.min(p-h,2);q<p;q++)e[h+q]=(k&255<<8*(d?q:1-q))>>>8*(d?q:1-
q);return h+2}};g.prototype.writeUInt16LE=function(e,k,h){return g.writeUInt16(this,e,k,!0,h)};g.prototype.writeUInt16BE=function(e,k,h){return g.writeUInt16(this,e,k,!1,h)};g.writeUInt32=function(e,k,h,d,q){q||(g.assert(void 0!==k&&null!==k,"missing value"),g.assert("boolean"===typeof d,"missing or invalid endian"),g.assert(void 0!==h&&null!==h,"missing offset"),g.assert(h+3<e.length,"trying to write beyond buffer length"),g.verifuint(k,4294967295));var p=e.length;if(!(h>=p)){q=0;for(p=Math.min(p-
h,4);q<p;q++)e[h+q]=k>>>8*(d?q:3-q)&255;return h+4}};g.prototype.writeUInt32LE=function(e,k,h){return g.writeUInt32(this,e,k,!0,h)};g.prototype.writeUInt32BE=function(e,k,h){return g.writeUInt32(this,e,k,!1,h)};g.prototype.writeInt8=function(e,k,h){h||(g.assert(void 0!==e&&null!==e,"missing value"),g.assert(void 0!==k&&null!==k,"missing offset"),g.assert(k<this.length,"Trying to write beyond buffer length"),g.verifsint(e,127,-128));if(!(k>=this.length))return 0<=e?this.writeUInt8(e,k,h):this.writeUInt8(255+
e+1,k,h),k+1};g.writeInt16=function(e,k,h,d,q){q||(g.assert(void 0!==k&&null!==k,"missing value"),g.assert("boolean"===typeof d,"missing or invalid endian"),g.assert(void 0!==h&&null!==h,"missing offset"),g.assert(h+1<e.length,"Trying to write beyond buffer length"),g.verifsint(k,32767,-32768));if(!(h>=e.length))return 0<=k?g.writeUInt16(e,k,h,d,q):g.writeUInt16(e,65535+k+1,h,d,q),h+2};g.prototype.writeInt16LE=function(e,k,h){return g.writeInt16(this,e,k,!0,h)};g.prototype.writeInt16BE=function(e,
k,h){return g.writeInt16(this,e,k,!1,h)};g.writeInt32=function(e,k,h,d,q){q||(g.assert(void 0!==k&&null!==k,"missing value"),g.assert("boolean"===typeof d,"missing or invalid endian"),g.assert(void 0!==h&&null!==h,"missing offset"),g.assert(h+3<e.length,"Trying to write beyond buffer length"),g.verifsint(k,2147483647,-2147483648));if(!(h>=e.length))return 0<=k?g.writeUInt32(e,k,h,d,q):g.writeUInt32(e,4294967295+k+1,h,d,q),h+4};g.prototype.writeInt32LE=function(e,k,h){return g.writeInt32(this,e,k,
!0,h)};g.prototype.writeInt32BE=function(e,k,h){return g.writeInt32(this,e,k,!1,h)};g.writeFloat=function(e,k,h,d,q){q||(g.assert(void 0!==k&&null!==k,"missing value"),g.assert("boolean"===typeof d,"missing or invalid endian"),g.assert(void 0!==h&&null!==h,"missing offset"),g.assert(h+3<e.length,"Trying to write beyond buffer length"),g.verifIEEE754(k,3.4028234663852886E38,-3.4028234663852886E38));if(!(h>=e.length))return Ma.write(e,k,h,d,23,4),h+4};g.prototype.writeFloatLE=function(e,k,h){return g.writeFloat(this,
e,k,!0,h)};g.prototype.writeFloatBE=function(e,k,h){return g.writeFloat(this,e,k,!1,h)};g.writeDouble=function(e,k,h,d,q){q||(g.assert(void 0!==k&&null!==k,"missing value"),g.assert("boolean"===typeof d,"missing or invalid endian"),g.assert(void 0!==h&&null!==h,"missing offset"),g.assert(h+7<e.length,"Trying to write beyond buffer length"),g.verifIEEE754(k,1.7976931348623157E308,-1.7976931348623157E308));if(!(h>=e.length))return Ma.write(e,k,h,d,52,8),h+8};g.prototype.writeDoubleLE=function(e,k,h){return g.writeDouble(this,
e,k,!0,h)};g.prototype.writeDoubleBE=function(e,k,h){return g.writeDouble(this,e,k,!1,h)};g.prototype.fill=function(e,k,h){e||(e=0);k||(k=0);h||(h=this.length);g.assert(h>=k,"end < start");if(h!==k&&0!==this.length){g.assert(0<=k&&k<this.length,"start out of bounds");g.assert(0<=h&&h<=this.length,"end out of bounds");if("number"===typeof e)for(;k<h;k++)this[k]=e;else{e=g.utf8ToBytes(e.toString());for(var d=e.length;k<h;k++)this[k]=e[k%d]}return this}};g.prototype.inspect=function(){for(var e=[],k=
this.length,h=0;h<k;h++)if(e[h]=g.toHex(this[h]),h===r.INSPECT_MAX_BYTES){e[h+1]="...";break}return"<Buffer "+e.join(" ")+">"};g.prototype.toArrayBuffer=function(){if("undefined"!==typeof Uint8Array){if(g._useTypedArrays)return(new g(this)).buffer;for(var e=new Uint8Array(this.length),k=0,h=e.length;k<h;k+=1)e[k]=this[k];return e.buffer}throw Error("Buffer.toArrayBuffer not supported in this browser");};var da=g.prototype;g._augment=function(e){e._isBuffer=!0;e._get=e.get;e._set=e.set;e.get=da.get;
e.set=da.set;e.write=da.write;e.toString=da.toString;e.toLocaleString=da.toString;e.toJSON=da.toJSON;e.equals=da.equals;e.compare=da.compare;e.copy=da.copy;e.slice=da.slice;e.readUInt8=da.readUInt8;e.readUInt16LE=da.readUInt16LE;e.readUInt16BE=da.readUInt16BE;e.readUInt32LE=da.readUInt32LE;e.readUInt32BE=da.readUInt32BE;e.readInt8=da.readInt8;e.readInt16LE=da.readInt16LE;e.readInt16BE=da.readInt16BE;e.readInt32LE=da.readInt32LE;e.readInt32BE=da.readInt32BE;e.readFloatLE=da.readFloatLE;e.readFloatBE=
da.readFloatBE;e.readDoubleLE=da.readDoubleLE;e.readDoubleBE=da.readDoubleBE;e.writeUInt8=da.writeUInt8;e.writeUInt16LE=da.writeUInt16LE;e.writeUInt16BE=da.writeUInt16BE;e.writeUInt32LE=da.writeUInt32LE;e.writeUInt32BE=da.writeUInt32BE;e.writeInt8=da.writeInt8;e.writeInt16LE=da.writeInt16LE;e.writeInt16BE=da.writeInt16BE;e.writeInt32LE=da.writeInt32LE;e.writeInt32BE=da.writeInt32BE;e.writeFloatLE=da.writeFloatLE;e.writeFloatBE=da.writeFloatBE;e.writeDoubleLE=da.writeDoubleLE;e.writeDoubleBE=da.writeDoubleBE;
e.fill=da.fill;e.inspect=da.inspect;e.toArrayBuffer=da.toArrayBuffer;return e};g.stringtrim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")};g.clamp=function(e,k,h){if("number"!==typeof e)return h;e=~~e;if(e>=k)return k;if(0<=e)return e;e+=k;return 0<=e?e:0};g.coerce=function(e){e=~~Math.ceil(+e);return 0>e?0:e};g.isArray=function(e){return(Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)})(e)};g.isArrayish=function(e){return g.isArray(e)||g.isBuffer(e)||
e&&"object"===typeof e&&"number"===typeof e.length};g.toHex=function(e){return 16>e?"0"+e.toString(16):e.toString(16)};g.utf8ToBytes=function(e){for(var k=[],h=0;h<e.length;h++){var d=e.charCodeAt(h);if(127>=d)k.push(d);else{var q=h;55296<=d&&57343>=d&&h++;d=encodeURIComponent(e.slice(q,h+1)).substr(1).split("%");for(q=0;q<d.length;q++)k.push(parseInt(d[q],16))}}return k};g.asciiToBytes=function(e){for(var k=[],h=0;h<e.length;h++)k.push(e.charCodeAt(h)&255);return k};g.utf16leToBytes=function(e){for(var k,
h,d=[],q=0;q<e.length;q++)k=e.charCodeAt(q),h=k>>8,k%=256,d.push(k),d.push(h);return d};g.base64ToBytes=function(e){return cd.toByteArray(e)};g.blitBuffer=function(e,k,h,d){for(var q=0;q<d&&!(q+h>=k.length||q>=e.length);q++)k[q+h]=e[q];return q};g.decodeUtf8Char=function(e){try{return decodeURIComponent(e)}catch(k){return String.fromCharCode(65533)}};g.verifuint=function(e,k){g.assert("number"===typeof e,"cannot write a non-number as a number");g.assert(0<=e,"specified a negative value for writing an unsigned value");
g.assert(e<=k,"value is larger than maximum value for type");g.assert(Math.floor(e)===e,"value has a fractional component")};g.verifsint=function(e,k,h){g.assert("number"===typeof e,"cannot write a non-number as a number");g.assert(e<=k,"value larger than maximum allowed value");g.assert(e>=h,"value smaller than minimum allowed value");g.assert(Math.floor(e)===e,"value has a fractional component")};g.verifIEEE754=function(e,k,h){g.assert("number"===typeof e,"cannot write a non-number as a number");
g.assert(e<=k,"value larger than maximum allowed value");g.assert(e>=h,"value smaller than minimum allowed value")};g.assert=function(e,k){if(!e)throw Error(k||"Failed assertion");};var Db=function(){};r.Log=Db;Db.LOG=0;var dd=a.printStackTrace,M={};r.NdnCommon=M;M.MAX_NDN_PACKET_SIZE=8800;M.getErrorWithStackTrace=function(e){return e+"\n"+dd({e:e}).join("\n")};M.checkIndexedDb=function(e){try{var k=new Dexie("test-Dexie-support");k.version(1).stores({});k.open();setTimeout(function(){try{e(k.isOpen())}catch(d){e(!1)}},
200)}catch(h){e(!1)}};var M=a.NdnCommon,td=function(e,k,h,d){d=d||{};this.face=e;this.callerOnData=k;this.callerOnTimeout=h;this.maxInterestLifetime=d.maxInterestLifetime||16E3};r.ExponentialReExpress=td;td.makeOnTimeout=function(e,k,h,d){var q=new td(e,k,h,d);return function(d){q.onTimeout(d)}};td.prototype.onTimeout=function(e){var k=e.getInterestLifetimeMilliseconds();if(null==k){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(h){console.log("Error in onTimeout: "+M.getErrorWithStackTrace(h))}}else if(k*=
2,k>this.maxInterestLifetime){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(d){console.log("Error in onTimeout: "+M.getErrorWithStackTrace(d))}}else{e=e.clone();e.setInterestLifetimeMilliseconds(k);var q=this;this.face.expressInterest(e,this.callerOnData,function(d){q.onTimeout(d)})}};var m=function k(h,d){null==d&&(d=!0);null==h?this.buffer=null:"object"===typeof h&&h instanceof k?this.buffer=h.buffer:"string"===typeof h?this.buffer=new g(h,"utf8"):d?this.buffer=new g(h):g.isBuffer(h)?
this.buffer=h:this.buffer=new g(h);this.length=null!=this.buffer?this.buffer.length:0};r.Blob=m;m.prototype.size=function(){return null!=this.buffer?this.buffer.length:0};m.prototype.buf=function(){return this.buffer};m.prototype.isNull=function(){return null==this.buffer};m.prototype.toHex=function(){return null==this.buffer?"":this.buffer.toString("hex")};m.prototype.toString=function(){return null==this.buffer?"":this.buffer.toString("utf8")};m.prototype.equals=function(k){if(this.isNull())return k.isNull();
if(k.isNull())return!1;if(this.buffer!==k.buffer){if(this.buffer.length!=k.buffer.length)return!1;for(var h=0;h<this.buffer.length;++h)if(this.buffer[h]!=k.buffer[h])return!1}return!0};var m=a.Blob,bb=function h(d,q,p){m.call(this,d);null==this.buffer?this.signedPortionEndOffset=this.signedPortionBeginOffset=0:"object"===typeof d&&d instanceof h?(this.signedPortionBeginOffset=null==q?d.signedPortionBeginOffset:q,this.signedPortionEndOffset=null==p?d.signedPortionEndOffset:p):(this.signedPortionBeginOffset=
q||0,this.signedPortionEndOffset=p||0);this.signedBuffer=null==this.buffer?null:this.buffer.slice(this.signedPortionBeginOffset,this.signedPortionEndOffset)};bb.prototype=new m;bb.prototype.name="SignedBlob";r.SignedBlob=bb;bb.prototype.signedSize=function(){return null!=this.signedBuffer?this.signedBuffer.length:0};bb.prototype.signedBuf=function(){return this.signedBuffer};bb.prototype.getSignedPortionBeginOffset=function(){return this.signedPortionBeginOffset};bb.prototype.getSignedPortionEndOffset=
function(){return this.signedPortionEndOffset};var eb=function(h){h||(h=16);this.array=new g(h)};r.DynamicBuffer=eb;eb.prototype.ensureLength=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;h>d&&(d=h);h=new g(d);this.array.copy(h);this.array=h}};eb.prototype.copy=function(h,d){this.ensureLength(h.length+d);g.isBuffer(h)?h.copy(this.array,d):(new g(h)).copy(this.array,d);return d+h.length};eb.prototype.ensureLengthFromBack=function(h){if(!(this.array.length>=h)){var d=2*this.array.length;
h>d&&(d=h);h=new g(d);this.array.copy(h,h.length-this.array.length);this.array=h}};eb.prototype.copyFromBack=function(h,d){this.ensureLengthFromBack(d);g.isBuffer(h)?h.copy(this.array,this.array.length-d):(new g(h)).copy(this.array,this.array.length-d)};eb.prototype.slice=function(h,d){return void 0==d?this.array.slice(h):this.array.slice(h,d)};var pa=function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};r.ChangeCounter=pa;pa.prototype.get=function(){return this.target};pa.prototype.set=
function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};pa.prototype.checkChanged=function(){if(null==this.target)return!1;var h=this.target.getChangeCount();return this.changeCount!=h?(this.changeCount=h,!0):!1};var M=a.NdnCommon,b=function(h,d){this.value=h;this.isRejected=d};r.SyncPromise=b;b.prototype.then=function(h,d){if(this.isRejected)if(d)try{return d(this.value)}catch(q){return new b(q,!0)}else return this;else if(h)try{return h(this.value)}catch(p){return new b(p,!0)}else return this};
b.prototype.catch=function(h){return this.then(void 0,h)};b.resolve=function(h){return new b(h,!1)};b.reject=function(h){return new b(h,!0)};b.getValue=function(h){if(h instanceof b){if(h.isRejected)throw h.value;return h.value}throw Error("Cannot return immediately because promise is not a SyncPromise");};b.complete=function(h,d,q){var p;q?p=d:(q=d,p=null);if(h)q.then(function(d){try{h(d)}catch(q){console.log("Error in onComplete: "+M.getErrorWithStackTrace(q))}},function(d){if(p)try{p(d)}catch(h){console.log("Error in onError: "+
M.getErrorWithStackTrace(h))}else{if(q instanceof b)throw d;console.log("Uncaught exception from a Promise: "+M.getErrorWithStackTrace(d))}});else return b.getValue(q)};var L={};r.DataUtils=L;L.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";L.stringtoBase64=function(h){var d="",q,p,a="",b,c,f="",g=0;do q=h.charCodeAt(g++),p=h.charCodeAt(g++),a=h.charCodeAt(g++),b=q>>2,q=(q&3)<<4|p>>4,c=(p&15)<<2|a>>6,f=a&63,isNaN(p)?c=f=64:isNaN(a)&&(f=64),d=d+L.keyStr.charAt(b)+L.keyStr.charAt(q)+
L.keyStr.charAt(c)+L.keyStr.charAt(f);while(g<h.length);return d};L.base64toString=function(h){var d="",q,a,b="",c,f="",g=0;/[^A-Za-z0-9\+\/\=]/g.exec(h)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.");h=h.replace(/[^A-Za-z0-9\+\/\=]/g,"");do q=L.keyStr.indexOf(h.charAt(g++)),a=L.keyStr.indexOf(h.charAt(g++)),c=L.keyStr.indexOf(h.charAt(g++)),f=L.keyStr.indexOf(h.charAt(g++)),q=q<<2|a>>4,a=(a&
15)<<4|c>>2,b=(c&3)<<6|f,d+=String.fromCharCode(q),64!=c&&(d+=String.fromCharCode(a)),64!=f&&(d+=String.fromCharCode(b));while(g<h.length);return d};L.toHex=function(h){return h.toString("hex")};L.stringToHex=function(h){for(var d="",q=0;q<h.length;++q)var a=h.charCodeAt(q),d=d+((16>a?"0":"")+a.toString(16));return d};L.toString=function(h){return h.toString("binary")};L.toNumbers=function(h){return new g(h,"hex")};L.hexToRawString=function(h){if("string"==typeof h){var d="";h.replace(/(..)/g,function(h){d+=
String.fromCharCode(parseInt(h,16))});return d}};L.toNumbersFromString=function(h){return new g(h,"binary")};L.toNumbersIfString=function(h){return"string"===typeof h?new g(h,"binary"):h};L.stringToUtf8Array=function(h){return new g(h,"utf8")};L.concatArrays=function(h){return g.concat(h)};L.decodeUtf8=function(h){for(var d="",q=0,a=0,b=0;q<h.length;)if(a=h.charCodeAt(q),128>a)d+=String.fromCharCode(a),q++;else if(191<a&&224>a)b=h.charCodeAt(q+1),d+=String.fromCharCode((a&31)<<6|b&63),q+=2;else var b=
h.charCodeAt(q+1),c=h.charCodeAt(q+2),d=d+String.fromCharCode((a&15)<<12|(b&63)<<6|c&63),q=q+3;return d};L.arraysEqual=function(h,d){if(!h.slice)throw Error("DataUtils.arraysEqual: a1 is not an array");if(!d.slice)throw Error("DataUtils.arraysEqual: a2 is not an array");if(h.length!=d.length)return!1;for(var q=0;q<h.length;++q)if(h[q]!=d[q])return!1;return!0};L.bigEndianToUnsignedInt=function(h){for(var d=0,q=0;q<h.length;++q)d*=256,d+=h[q];return d};L.nonNegativeIntToBigEndian=function(h){h=Math.round(h);
if(0>=h)return new g(0);for(var d=new g(8),q=0;0!=h;)++q,d[8-q]=h&255,h=Math.floor(h/256);return d.slice(8-q,8)};L.shuffle=function(h){for(var d=h.length-1;1<=d;--d){var q=Math.floor(Math.random()*(d+1)),a=h[d];h[d]=h[q];h[q]=a}};L.privateKeyPemToDer=function(h){h=h.split("\n");for(var d="",q=1;q<h.length-1;q++)d+=h[q];return new g(d,"base64")};S.prototype=Error();S.prototype.name="DecodingException";r.DecodingException=S;var n=function(){};r.Tlv=n;n.Interest=5;n.Data=6;n.Name=7;n.ImplicitSha256DigestComponent=
1;n.ParametersSha256DigestComponent=2;n.NameComponent=8;n.Selectors=9;n.Nonce=10;n.InterestLifetime=12;n.MinSuffixComponents=13;n.MaxSuffixComponents=14;n.PublisherPublicKeyLocator=15;n.Exclude=16;n.ChildSelector=17;n.MustBeFresh=18;n.Any=19;n.MetaInfo=20;n.Content=21;n.SignatureInfo=22;n.SignatureValue=23;n.ContentType=24;n.FreshnessPeriod=25;n.FinalBlockId=26;n.SignatureType=27;n.KeyLocator=28;n.KeyLocatorDigest=29;n.ForwardingHint=30;n.SelectedDelegation=32;n.CanBePrefix=33;n.HopLimit=34;n.ApplicationParameters=
36;n.SignatureType_DigestSha256=0;n.SignatureType_SignatureSha256WithRsa=1;n.SignatureType_SignatureSha256WithEcdsa=3;n.SignatureType_SignatureHmacWithSha256=4;n.ContentType_Default=0;n.ContentType_Link=1;n.ContentType_Key=2;n.NfdCommand_ControlResponse=101;n.NfdCommand_StatusCode=102;n.NfdCommand_StatusText=103;n.ControlParameters_ControlParameters=104;n.ControlParameters_FaceId=105;n.ControlParameters_Uri=114;n.ControlParameters_LocalUri=129;n.ControlParameters_LocalControlFeature=110;n.ControlParameters_Origin=
111;n.ControlParameters_Cost=106;n.ControlParameters_Capacity=131;n.ControlParameters_Count=132;n.ControlParameters_BaseCongestionMarkingInterval=135;n.ControlParameters_DefaultCongestionThreshold=136;n.ControlParameters_Mtu=137;n.ControlParameters_Flags=108;n.ControlParameters_Mask=112;n.ControlParameters_Strategy=107;n.ControlParameters_ExpirationPeriod=109;n.LpPacket_LpPacket=100;n.LpPacket_Fragment=80;n.LpPacket_Sequence=81;n.LpPacket_FragIndex=82;n.LpPacket_FragCount=83;n.LpPacket_Nack=800;n.LpPacket_NackReason=
801;n.LpPacket_NextHopFaceId=816;n.LpPacket_IncomingFaceId=817;n.LpPacket_CachePolicy=820;n.LpPacket_CachePolicyType=821;n.LpPacket_CongestionMark=832;n.LpPacket_IGNORE_MIN=800;n.LpPacket_IGNORE_MAX=959;n.Link_Preference=30;n.Link_Delegation=31;n.Encrypt_EncryptedContent=130;n.Encrypt_EncryptionAlgorithm=131;n.Encrypt_EncryptedPayload=132;n.Encrypt_InitialVector=133;n.Encrypt_EncryptedPayloadKey=134;n.SafeBag_SafeBag=128;n.SafeBag_EncryptedKeyBag=129;n.Encrypt_StartDate=134;n.Encrypt_EndDate=135;
n.Encrypt_IntervalStartHour=136;n.Encrypt_IntervalEndHour=137;n.Encrypt_NRepeats=138;n.Encrypt_RepeatUnit=139;n.Encrypt_RepetitiveInterval=140;n.Encrypt_WhiteIntervalList=141;n.Encrypt_BlackIntervalList=142;n.Encrypt_Schedule=143;n.ValidityPeriod_ValidityPeriod=253;n.ValidityPeriod_NotBefore=254;n.ValidityPeriod_NotAfter=255;n.getHighBytes=function(h){return(h-h%4294967296)/4294967296};var eb=a.DynamicBuffer,n=a.Tlv,ra=function(h){this.output=new eb(h||16);this.length=0};r.TlvEncoder=ra;ra.prototype.getLength=
function(){return this.length};ra.prototype.writeVarNumber=function(h){if(253>h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=3;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length;this.output.array[d]=253;this.output.array[d+1]=h>>8&255;this.output.array[d+2]=h&255}else if(4294967295>=h)this.length+=5,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-
this.length,this.output.array[d]=254,this.output.array[d+1]=h>>24&255,this.output.array[d+2]=h>>16&255,this.output.array[d+3]=h>>8&255,this.output.array[d+4]=h&255;else{this.length+=9;this.output.ensureLengthFromBack(this.length);d=this.output.array.length-this.length;this.output.array[d]=255;var q=n.getHighBytes(h);this.output.array[d+1]=q>>24&255;this.output.array[d+2]=q>>16&255;this.output.array[d+3]=q>>8&255;this.output.array[d+4]=q&255;this.output.array[d+5]=h>>24&255;this.output.array[d+6]=
h>>16&255;this.output.array[d+7]=h>>8&255;this.output.array[d+8]=h&255}};ra.prototype.writeTypeAndLength=function(h,d){this.writeVarNumber(d);this.writeVarNumber(h)};ra.prototype.writeNonNegativeInteger=function(h){if(0>h)throw Error("TLV integer value may not be negative");h=Math.round(h);if(255>=h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=2;this.output.ensureLengthFromBack(this.length);
var d=this.output.array.length-this.length;this.output.array[d]=h>>8&255;this.output.array[d+1]=h&255}else if(4294967295>=h)this.length+=4,this.output.ensureLengthFromBack(this.length),d=this.output.array.length-this.length,this.output.array[d]=h>>24&255,this.output.array[d+1]=h>>16&255,this.output.array[d+2]=h>>8&255,this.output.array[d+3]=h&255;else{this.length+=8;this.output.ensureLengthFromBack(this.length);var d=this.output.array.length-this.length,q=n.getHighBytes(h);this.output.array[d]=q>>
24&255;this.output.array[d+1]=q>>16&255;this.output.array[d+2]=q>>8&255;this.output.array[d+3]=q&255;this.output.array[d+4]=h>>24&255;this.output.array[d+5]=h>>16&255;this.output.array[d+6]=h>>8&255;this.output.array[d+7]=h&255}};ra.prototype.writeNonNegativeIntegerTlv=function(h,d){var q=this.length;this.writeNonNegativeInteger(d);this.writeTypeAndLength(h,this.length-q)};ra.prototype.writeOptionalNonNegativeIntegerTlv=function(h,d){null!=d&&0<=d&&this.writeNonNegativeIntegerTlv(h,d)};ra.prototype.writeBuffer=
function(h){null!=h&&(this.length+=h.length,this.output.copyFromBack(h,this.length))};ra.prototype.writeBlobTlv=function(h,d){null==d?this.writeTypeAndLength(h,0):(this.writeBuffer(d),this.writeTypeAndLength(h,d.length))};ra.prototype.writeOptionalBlobTlv=function(h,d){null!=d&&0<d.length&&this.writeBlobTlv(h,d)};ra.prototype.getOutput=function(){return this.output.array.slice(this.output.array.length-this.length)};var S=a.DecodingException,oa=function(h){this.input=h;this.offset=0};r.TlvDecoder=
oa;oa.prototype.readVarNumber=function(){var h=this.input[this.offset];this.offset+=1;return 253>h?h:this.readExtendedVarNumber(h)};oa.prototype.readExtendedVarNumber=function(h){253==h?(h=(this.input[this.offset]<<8)+this.input[this.offset+1],this.offset+=2):254==h?(h=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3],this.offset+=4):(h=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+
2]<<8)+this.input[this.offset+3])+(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7],this.offset+=8);return h};oa.prototype.readTypeAndLength=function(h){if(this.readVarNumber()!=h)throw new S(Error("Did not get the expected TLV type"));h=this.readVarNumber();if(this.offset+h>this.input.length)throw new S(Error("TLV length exceeds the buffer length"));return h};oa.prototype.readNestedTlvsStart=function(h){return this.readTypeAndLength(h)+
this.offset};oa.prototype.finishNestedTlvs=function(h,d){if(this.offset!=h){for(void 0==d&&(d=!1);this.offset<h;){var q=this.readVarNumber();if((31>=q||1==(q&1))&&!d)throw new S(Error("Unrecognized critical type code "+q));q=this.readVarNumber();this.offset+=q;if(this.offset>this.input.length)throw new S(Error("TLV length exceeds the buffer length"));}if(this.offset!=h)throw new S(Error("TLV length does not equal the total length of the nested TLVs"));}};oa.prototype.peekType=function(h,d){if(this.offset>=
d)return!1;var q=this.offset,a=this.readVarNumber();this.offset=q;return a==h};oa.prototype.readNonNegativeInteger=function(h){var d;if(1==h)d=this.input[this.offset];else if(2==h)d=(this.input[this.offset]<<8)+this.input[this.offset+1];else if(4==h)d=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3];else if(8==h)d=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<
8)+this.input[this.offset+3])+Math.abs(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7];else throw new S(Error("Invalid length for a TLV nonNegativeInteger"));this.offset+=h;return d};oa.prototype.readNonNegativeIntegerTlv=function(h){h=this.readTypeAndLength(h);return this.readNonNegativeInteger(h)};oa.prototype.readOptionalNonNegativeIntegerTlv=function(h,d){return this.peekType(h,d)?this.readNonNegativeIntegerTlv(h):null};oa.prototype.readBlobTlv=
function(h){h=this.readTypeAndLength(h);var d=this.input.slice(this.offset,this.offset+h);this.offset+=h;return d};oa.prototype.readOptionalBlobTlv=function(h,d){return this.peekType(h,d)?this.readBlobTlv(h):null};oa.prototype.readBooleanTlv=function(h,d){if(this.peekType(h,d)){var q=this.readTypeAndLength(h);this.offset+=q;return!0}return!1};oa.prototype.skipTlv=function(h){h=this.readTypeAndLength(h);this.offset+=h};oa.prototype.skipOptionalTlv=function(h,d){this.peekType(h,d)&&this.skipTlv(h)};
oa.prototype.getOffset=function(){return this.offset};oa.prototype.seek=function(h){this.offset=h};oa.prototype.getSlice=function(h,d){return this.input.slice(h,d)};var oa=a.TlvDecoder,F=function d(){this.gotElementEnd_=!1;this.offset_=0;this.state_=d.READ_TYPE;this.headerLength_=0;this.useHeaderBuffer_=!1;this.headerBuffer_=new g(8);this.nBytesToRead_=0};r.TlvStructureDecoder=F;F.READ_TYPE=0;F.READ_TYPE_BYTES=1;F.READ_LENGTH=2;F.READ_LENGTH_BYTES=3;F.READ_VALUE_BYTES=4;F.prototype.findElementEnd=
function(d){if(this.gotElementEnd_)return!0;for(var q=new oa(d);;){if(this.offset_>=d.length)return!1;if(this.state_==F.READ_TYPE){var a=d[this.offset_];this.offset_+=1;253>a?this.state_=F.READ_LENGTH:(this.nBytesToRead_=253==a?2:254==a?4:8,this.state_=F.READ_TYPE_BYTES)}else if(this.state_==F.READ_TYPE_BYTES){a=d.length-this.offset_;if(a<this.nBytesToRead_)return this.offset_+=a,this.nBytesToRead_-=a,!1;this.offset_+=this.nBytesToRead_;this.state_=F.READ_LENGTH}else if(this.state_==F.READ_LENGTH)if(a=
d[this.offset_],this.offset_+=1,253>a){this.nBytesToRead_=a;if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=F.READ_VALUE_BYTES}else this.nBytesToRead_=253==a?2:254==a?4:8,this.firstOctet_=a,this.state_=F.READ_LENGTH_BYTES;else if(this.state_==F.READ_LENGTH_BYTES){a=d.length-this.offset_;if(!this.useHeaderBuffer_&&a>=this.nBytesToRead_)q.seek(this.offset_),this.nBytesToRead_=q.readExtendedVarNumber(this.firstOctet_),this.offset_=q.getOffset();else{this.useHeaderBuffer_=!0;var b=
this.nBytesToRead_-this.headerLength_;if(b>a){if(this.headerLength_+a>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+a).copy(this.headerBuffer_,this.headerLength_);this.offset_+=a;this.headerLength_+=a;return!1}if(this.headerLength_+b>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");d.slice(this.offset_,this.offset_+b).copy(this.headerBuffer_,this.headerLength_);
this.offset_+=b;this.nBytesToRead_=(new oa(this.headerBuffer_)).readExtendedVarNumber(this.firstOctet_)}if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=F.READ_VALUE_BYTES}else{if(this.state_==F.READ_VALUE_BYTES){a=d.length-this.offset_;if(a<this.nBytesToRead_)return this.offset_+=a,this.nBytesToRead_-=a,!1;this.offset_+=this.nBytesToRead_;return this.gotElementEnd_=!0}throw Error("findElementEnd: unrecognized state");}}};F.prototype.getOffset=function(){return this.offset_};F.prototype.seek=
function(d){this.offset_=d};var ra=a.TlvEncoder,oa=a.TlvDecoder,m=a.Blob,c=a.Name,kb=function(){};r.ProtobufTlv=kb;kb._Field=null;kb.establishField=function(){if(null===kb._Field)try{kb._Field=dcodeIO.ProtoBuf.Reflect.Message.Field}catch(d){kb._Field=a.Reflect.Message.Field}};kb.encode=function(d,q){kb.establishField();d.encodeAB();var a=new ra;kb._encodeMessageValue(d,q,a);return new m(a.getOutput(),!1)};kb.decode=function(d,q,a){kb.establishField();a="object"===typeof a&&a instanceof m?a.buf():
a;var b=new oa(a);kb._decodeMessageValue(d,q,b,a.length)};kb._encodeMessageValue=function(d,q,a){q=q.getChildren(kb._Field);for(var b=q.length-1;0<=b;--b){var c=q[b],f=c.id,l;if(c.repeated)l=d[c.name];else if(null!=d[c.name])l=[d[c.name]];else continue;for(var n=l.length-1;0<=n;--n){var s=l[n];if("message"==c.type.name){var r=a.getLength();kb._encodeMessageValue(s,c.resolvedType,a);a.writeTypeAndLength(f,a.getLength()-r)}else if("uint32"==c.type.name||"uint64"==c.type.name)a.writeNonNegativeIntegerTlv(f,
s);else if("enum"==c.type.name){if(0>s)throw Error("ProtobufTlv.encode: ENUM value may not be negative");a.writeNonNegativeIntegerTlv(f,s)}else if("bytes"==c.type.name)r=s.toBuffer(),void 0==r.length&&(r=new Uint8Array(s.toArrayBuffer())),a.writeBlobTlv(f,r);else if("string"==c.type.name)a.writeBlobTlv(f,(new m(s,!1)).buf());else if("bool"==c.type.name)s&&a.writeTypeAndLength(f,0);else if("double"==c.type.name)r=new g(8),r.writeDoubleLE(s,0),a.writeBlobTlv(f,r);else throw Error("ProtobufTlv.encode: Unknown field type");
}}};kb._decodeMessageValue=function(d,q,a,b){q=q.getChildren(kb._Field);for(var c=0;c<q.length;++c){var f=q[c],g=f.id;if(f.required||a.peekType(g,b))if(f.repeated)for(;a.peekType(g,b);)if("message"==f.type.name){var l=a.readNestedTlvsStart(g),m=new (f.resolvedType.build());d.add(f.name,m);kb._decodeMessageValue(m,f.resolvedType,a,l);a.finishNestedTlvs(l)}else d.add(f.name,kb._decodeFieldValue(f,g,a,b));else"message"==f.type.name?(l=a.readNestedTlvsStart(g),m=new (f.resolvedType.build()),d.set(f.name,
m),kb._decodeMessageValue(m,f.resolvedType,a,l),a.finishNestedTlvs(l)):d.set(f.name,kb._decodeFieldValue(f,g,a,b))}};kb._decodeFieldValue=function(d,a,p,b){if("uint32"==d.type.name||"uint64"==d.type.name||"enum"==d.type.name)return p.readNonNegativeIntegerTlv(a);if("bytes"==d.type.name)return p.readBlobTlv(a);if("string"==d.type.name)return p.readBlobTlv(a).toString();if("bool"==d.type.name)return p.readBooleanTlv(a,b);if("double"==d.type.name)return p.readBlobTlv(a).readDoubleLE(0);throw Error("ProtobufTlv.decode: Unknown field type");
};kb.toName=function(d){for(var a=new c,p=0;p<d.length;++p)a.append(new m(new g(d[p].toBinary(),"binary"),!1));return a};var lb=function(d){if("string"===typeof d){d=d.split(".");this.oid=[];for(var a=0;a<d.length;++a)this.oid.push(parseInt(d[a]))}else this.oid=d.slice(0,d.length)};r.OID=lb;lb.prototype.getIntegerList=function(){return this.oid};lb.prototype.setIntegerList=function(d){this.oid=d.slice(0,d.length)};lb.prototype.toString=function(){for(var d="",a=0;a<this.oid.length;++a)0!==a&&(d+=
"."),d+=this.oid[a];return d};lb.prototype.equals=function(d){if(!(d instanceof lb)||this.oid.length!==d.oid.length)return!1;for(var a=0;a<this.oid.length;++a)if(this.oid[a]!=d.oid[a])return!1;return!0};var s=function(){};r.WireFormat=s;s.prototype.encodeName=function(d){throw Error("encodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeName=function(d,a,p){throw Error("decodeName is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.encodeInterest=function(d){throw Error("encodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeInterest=function(d,a,p){throw Error("decodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeData=function(d){throw Error("encodeData is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeData=function(d,a,p){throw Error("decodeData is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.encodeControlParameters=function(d){throw Error("encodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeControlParameters=function(d,a,p){throw Error("decodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeControlResponse=function(d){throw Error("encodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.decodeControlResponse=function(d,a,p){throw Error("decodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.encodeSignatureInfo=function(d){throw Error("encodeSignatureInfo is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeSignatureInfoAndValue=function(d,a,p){throw Error("decodeSignatureInfoAndValue is unimplemented in the base WireFormat class.  You should use a derived class.");
};s.prototype.encodeSignatureValue=function(d){throw Error("encodeSignatureValue is unimplemented in the base WireFormat class.  You should use a derived class.");};s.prototype.decodeLpPacket=function(d,a,p){throw Error("decodeLpPacket is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeDelegationSet=function(d){throw Error("encodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.decodeDelegationSet=
function(d,a,p){throw Error("decodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeEncryptedContent=function(d){throw Error("encodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.decodeEncryptedContent=function(d,a,p){throw Error("decodeEncryptedContent is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.encodeEncryptedContentV2=
function(d){throw Error("encodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};s.prototype.decodeEncryptedContentV2=function(d,a,p){throw Error("decodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};s.setDefaultWireFormat=function(d){s.defaultWireFormat=d};s.getDefaultWireFormat=function(){return s.defaultWireFormat};var fb=a.TlvWireFormat,L=a.DataUtils,n=a.Tlv,F=a.TlvStructureDecoder,S=a.DecodingException,
M=a.NdnCommon,f=a.Log.LOG,Xd=function(d){this.elementListener_=d;this.dataParts_=[];this.tlvStructureDecoder_=new F};r.ElementReader=Xd;Xd.prototype.onReceivedData=function(d){for(;;){var a,p;try{if(0===this.dataParts_.length&&0>=d.length)break;this.tlvStructureDecoder_.seek(0);a=this.tlvStructureDecoder_.findElementEnd(d);p=this.tlvStructureDecoder_.getOffset()}catch(b){throw this.dataParts_=[],this.tlvStructureDecoder_=new F,b;}if(a){var c;0===this.dataParts_.length?c=d.slice(0,p):(this.dataParts_.push(d.slice(0,
p)),c=L.concatArrays(this.dataParts_),this.dataParts_=[]);d=d.slice(p,d.length);this.tlvStructureDecoder_=new F;this.elementListener_.onReceivedElement(c);if(0==d.length)break}else{a=d.length;for(p=0;p<this.dataParts_.length;++p)a+=this.dataParts_[p].length;if(a>M.MAX_NDN_PACKET_SIZE)throw this.dataParts_=[],this.tlvStructureDecoder_=new F,new S(Error("The incoming packet exceeds the maximum limit Face.getMaxNdnPacketSize()"));this.dataParts_.push(new g(d));3<f&&console.log("Incomplete packet received. Length "+
d.length+". Wait for more input.");break}}};va.prototype=Error();va.prototype.name="DerDecodingException";r.DerDecodingException=va;Pb.prototype=Error();Pb.prototype.name="DerEncodingException";r.DerEncodingException=Pb;var P=function(){};r.DerNodeType=P;P.Eoc=0;P.Boolean=1;P.Integer=2;P.BitString=3;P.OctetString=4;P.Null=5;P.ObjectIdentifier=6;P.ObjectDescriptor=7;P.External=40;P.Real=9;P.Enumerated=10;P.EmbeddedPdv=43;P.Utf8String=12;P.RelativeOid=13;P.Sequence=48;P.Set=49;P.NumericString=18;P.PrintableString=
19;P.T61String=20;P.VideoTexString=21;P.Ia5String=22;P.UtcTime=23;P.GeneralizedTime=24;P.GraphicString=25;P.VisibleString=26;P.GeneralString=27;P.UniversalString=28;P.CharacterString=29;P.BmpString=30;var eb=a.DynamicBuffer,m=a.Blob,va=a.DerDecodingException,Pb=a.DerEncodingException,P=a.DerNodeType,l=function(d){this.nodeType_=d;this.parent_=null;this.header_=new g(0);this.payload_=new eb(0);this.payloadPosition_=0};r.DerNode=l;l.prototype.getSize=function(){return this.header_.length+this.payloadPosition_};
l.prototype.encodeHeader=function(d){var a=new eb(10),p=0;a.array[p++]=this.nodeType_;if(0>d)throw Error("encodeHeader: DER object has negative length");if(127>=d)a.array[p++]=d&255;else{var b=new eb(10),c=d;for(d=0;0!=c;)++d,b.ensureLengthFromBack(d),b.array[b.array.length-d]=c&255,c>>=8;c=d+1;b.ensureLengthFromBack(c);b.array[b.array.length-c]=(128|d)&255;a.copy(b.slice(b.array.length-c),p);p+=c}this.header_=a.slice(0,p)};l.prototype.decodeHeader=function(d,a){var p=a,b=d[p]&255,p=p+1;this.nodeType_=
b;var c=d[p]&255,p=p+1,f=new eb(10),g=0;f.array[g++]=b;b=f.array[g++]=c;if(0!=(c&128))for(c&=127,b=0;0<c;){if(d.length<=p)throw new va("DerNode.decodeHeader: The input length is too small");var l=d[p],p=p+1;f.ensureLength(g+1);f.array[g++]=l;b=256*b+(l&255);c-=1}this.header_=f.slice(0,g);return b};l.prototype.encode=function(){var d=new g(this.getSize());this.header_.copy(d);this.payload_.slice(0,this.payloadPosition_).copy(d,this.header_.length);return new m(d,!1)};l.prototype.decode=function(d,
a){var p=a,b=this.decodeHeader(d,p),c=this.header_.length;0<b&&(p+=c,this.payloadAppend(d.slice(p,p+b)))};l.prototype.payloadAppend=function(d){this.payloadPosition_=this.payload_.copy(d,this.payloadPosition_)};l.parse=function(d,a){void 0==a&&(a=0);if(d.length<=a)throw new va("DerNode.parse: The input length is too small");var p=d[a]&255;if(p===P.Boolean)p=new l.DerBoolean;else if(p===P.Integer)p=new l.DerInteger;else if(p===P.BitString)p=new l.DerBitString;else if(p===P.OctetString)p=new l.DerOctetString;
else if(p===P.Null)p=new l.DerNull;else if(p===P.ObjectIdentifier)p=new l.DerOid;else if(p===P.Sequence)p=new l.DerSequence;else if(p===P.PrintableString)p=new l.DerPrintableString;else if(p===P.GeneralizedTime)p=new l.DerGeneralizedTime;else throw new va(Error("Unimplemented DER type "+p));p.decode(d,a);return p};l.prototype.toVal=function(){return this.encode()};l.prototype.getPayload=function(){return new m(this.payload_.slice(0,this.payloadPosition_),!0)};l.prototype.getChildren=function(){throw new va(Error("getChildren: This DerNode is not DerSequence"));
};l.getSequence=function(d,a){if(0>a||a>=d.length)throw new va(Error("getSequence: Child index is out of bounds"));if(!(d[a]instanceof l.DerSequence))throw new va(Error("getSequence: Child DerNode is not a DerSequence"));return d[a]};l.DerStructure=function(d){l.call(this,d);this.childChanged_=!1;this.nodeList_=[];this.size_=0};l.DerStructure.prototype=new l;l.DerStructure.prototype.name="DerStructure";l.DerStructure.prototype.getSize=function(){this.childChanged_&&(this.updateSize(),this.childChanged_=
!1);this.encodeHeader(this.size_);return this.size_+this.header_.length};l.DerStructure.prototype.getChildren=function(){return this.nodeList_};l.DerStructure.prototype.updateSize=function(){for(var d=0,a=0;a<this.nodeList_.length;++a)d+=this.nodeList_[a].getSize();this.size_=d;this.childChanged_=!1};l.DerStructure.prototype.addChild=function(d,a){d.parent_=this;this.nodeList_.push(d);a&&null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};l.DerStructure.prototype.setChildChanged=
function(){null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};l.DerStructure.prototype.encode=function(){var d=new eb(10),a=0;this.updateSize();this.encodeHeader(this.size_);for(var a=d.copy(this.header_,a),p=0;p<this.nodeList_.length;++p)var b=this.nodeList_[p].encode(),a=d.copy(b.buf(),a);return new m(d.slice(0,a),!1)};l.DerStructure.prototype.decode=function(d,a){var p=a;this.size_=this.decodeHeader(d,p);for(var p=p+this.header_.length,b=0;b<this.size_;){var c=l.parse(d,
p),f=c.getSize(),p=p+f,b=b+f;this.addChild(c,!1)}};l.DerByteString=function(d,a){l.call(this,a);null!=d&&(this.payloadAppend(d),this.encodeHeader(d.length))};l.DerByteString.prototype=new l;l.DerByteString.prototype.name="DerByteString";l.DerByteString.prototype.toVal=function(){return this.getPayload()};l.DerBoolean=function(d){l.call(this,P.Boolean);void 0!=d&&(d=d?255:0,this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=d,this.encodeHeader(1))};l.DerBoolean.prototype=
new l;l.DerBoolean.prototype.name="DerBoolean";l.DerBoolean.prototype.toVal=function(){return 0!=this.payload_.array[0]};l.DerInteger=function(d){l.call(this,P.Integer);if(void 0!=d){if(g.isBuffer(d)){if(0<d.length&&128<=d[0])throw new Pb(Error("DerInteger: Negative integers are not currently supported"));0==d.length?this.payloadAppend(new g([0])):this.payloadAppend(d)}else{d=Math.round(d);if(0>d)throw new Pb(Error("DerInteger: Negative integers are not currently supported"));for(var a=new eb(10),
p=0;!(++p,a.ensureLengthFromBack(p),a.array[a.array.length-p]=d&255,d>>=8,0>=d););128<=a.array[a.array.length-p]&&(++p,a.ensureLengthFromBack(p),a.array[a.array.length-p]=0);this.payloadAppend(a.slice(a.array.length-p))}this.encodeHeader(this.payloadPosition_)}};l.DerInteger.prototype=new l;l.DerInteger.prototype.name="DerInteger";l.DerInteger.prototype.toVal=function(){if(0<this.payloadPosition_&&128<=this.payload_.array[0])throw new va(Error("DerInteger: Negative integers are not currently supported"));
for(var d=0,a=0;a<this.payloadPosition_;++a)d<<=8,d+=this.payload_.array[a];return d};l.DerBitString=function(d,a){l.call(this,P.BitString);void 0!=d&&(this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=a&255,this.payloadAppend(d),this.encodeHeader(this.payloadPosition_))};l.DerBitString.prototype=new l;l.DerBitString.prototype.name="DerBitString";l.DerOctetString=function(d){l.DerByteString.call(this,d,P.OctetString)};l.DerOctetString.prototype=new l.DerByteString;
l.DerOctetString.prototype.name="DerOctetString";l.DerNull=function(){l.call(this,P.Null);this.encodeHeader(0)};l.DerNull.prototype=new l;l.DerNull.prototype.name="DerNull";l.DerOid=function(d){l.call(this,P.ObjectIdentifier);if(void 0!=d)if("string"===typeof d){d=d.split(".");for(var a=[],p=0;p<d.length;++p)a.push(parseInt(d[p]));this.prepareEncoding(a)}else this.prepareEncoding(d.getIntegerList())};l.DerOid.prototype=new l;l.DerOid.prototype.name="DerOid";l.DerOid.prototype.prepareEncoding=function(d){var a;
if(0==d.length)throw new Pb(Error("No integer in OID"));if(0<=d[0]&&2>=d[0])a=40*d[0];else throw new Pb(Error("First integer in OID is out of range"));if(2<=d.length)if(0<=d[1]&&39>=d[1])a+=d[1];else throw new Pb(Error("Second integer in OID is out of range"));var p=new eb(10),b=0,b=p.copy(l.DerOid.encode128(a),b);if(2<d.length)for(a=2;a<d.length;++a)b=p.copy(l.DerOid.encode128(d[a]),b);this.encodeHeader(b);this.payloadAppend(p.slice(0,b))};l.DerOid.encode128=function(d){var a=new eb(10),p=0;if(128>
d)++p,a.array[a.array.length-p]=d&127;else for(++p,a.array[a.array.length-p]=d&127,d>>=7;0!=d;)++p,a.ensureLengthFromBack(p),a.array[a.array.length-p]=d&127|128,d>>=7;return a.slice(a.array.length-p)};l.DerOid.prototype.decode128=function(d,a){for(var p=0,b=d;0!=(this.payload_.array[d]&128);)p=128*p+(this.payload_.array[d]&255)-128,d+=1;p=128*p+(this.payload_.array[d]&255);a[0]=d-b+1;return p};l.DerOid.prototype.toVal=function(){for(var d=0,a=[];d<this.payloadPosition_;){var p=[0],b=this.decode128(d,
p),d=d+p[0];a.push(b)}d=a[0];d=Math.floor(d/40)+"."+d%40;for(p=1;p<a.length;++p)d+="."+a[p];return d};l.DerSequence=function(){l.DerStructure.call(this,P.Sequence)};l.DerSequence.prototype=new l.DerStructure;l.DerSequence.prototype.name="DerSequence";l.DerPrintableString=function(d){l.DerByteString.call(this,d,P.PrintableString)};l.DerPrintableString.prototype=new l.DerByteString;l.DerPrintableString.prototype.name="DerPrintableString";l.DerGeneralizedTime=function(d){l.call(this,P.GeneralizedTime);
void 0!=d&&(d=l.DerGeneralizedTime.toDerTimeString(d),this.payloadAppend((new m(d)).buf()),this.encodeHeader(this.payloadPosition_))};l.DerGeneralizedTime.prototype=new l;l.DerGeneralizedTime.prototype.name="DerGeneralizedTime";l.DerGeneralizedTime.toDerTimeString=function(d){d=new Date(Math.round(d));return d.getUTCFullYear()+l.DerGeneralizedTime.to2DigitString(d.getUTCMonth()+1)+l.DerGeneralizedTime.to2DigitString(d.getUTCDate())+l.DerGeneralizedTime.to2DigitString(d.getUTCHours())+l.DerGeneralizedTime.to2DigitString(d.getUTCMinutes())+
l.DerGeneralizedTime.to2DigitString(d.getUTCSeconds())+"Z"};l.DerGeneralizedTime.to2DigitString=function(d){d=d.toString();return 1===d.length?"0"+d:d};l.DerGeneralizedTime.prototype.toVal=function(){var d=this.payload_.slice(0,this.payloadPosition_).toString();return Date.UTC(parseInt(d.substr(0,4)),parseInt(d.substr(4,2)-1),parseInt(d.substr(6,2)),parseInt(d.substr(8,2)),parseInt(d.substr(10,2)),parseInt(d.substr(12,2)))};var Rb=a,gc=function(d,a){this.subtrees=[];this.value=d;this.parent=a;this.lastChild=
null};gc.prototype.addSubtree=function(d,a){var p=this.find(d);null!==p?p.push(a):this.subtrees.push({key:d,value:[a]});a.parent=this;this.lastChild=a};gc.prototype.createSubtree=function(d,a){var p=new gc(a,this);this.addSubtree(d,p);return p};gc.prototype.get=function(d){d=d.replace(/^\/+/,"");if(0===d.length)return[this];var a=d.split("/");d=this.find(a[0]);if(null===d)return[];if(1==a.length)return d.slice(0);for(var a=a.slice(1).join("/"),p=[],b=0;b<d.length;++b)var c=d[b].get(a),p=p.concat(c);
return p};gc.prototype.getFirstValue=function(d){d=this.get(d);return 1<=d.length?d[0].value:null};gc.prototype.getValue=function(){return this.value};gc.prototype.getParent=function(){return this.parent};gc.prototype.getLastChild=function(){return this.lastChild};gc.prototype.prettyPrint=function(d){d=d||1;var a=Array(d+1).join(" "),p="";null!=this.parent&&(this.value&&0<this.value.length&&(p+='"'+this.value+'"'),p+="\n");if(0<this.subtrees.length){this.parent&&(p+=a+"{\n");for(var b=Array(d+2+1).join(" "),
c=0;c<this.subtrees.length;++c)for(var f=0;f<this.subtrees[c].value.length;++f)p+=b+this.subtrees[c].key+" "+this.subtrees[c].value[f].prettyPrint(d+2);this.parent&&(p+=a+"}\n")}return p};gc.prototype.toString=function(){return this.prettyPrint()};gc.prototype.find=function(d){for(var a=0;a<this.subtrees.length;++a)if(this.subtrees[a].key==d)return this.subtrees[a].value;return null};var lc=function(){this.root=new gc};r.BoostInfoParser=lc;r.BoostInfoTree=gc;lc.prototype.read=function(d,a){var p;
"string"==typeof a?p=d:(a=d,p=Rb.readFileSync(d).toString());var b=this.root,c=this;p.split(/\r?\n/).forEach(function(d){b=c.parseLine(d.trim(),b)})};lc.prototype.write=function(d){Rb.writeFileSync(d,""+this.root)};lc.prototype.getRoot=function(){return this.root};lc.shlex_split=function(d){var a=[];if(""==d)return a;for(var p=0;;){for(;0<=" \t\n\r".indexOf(d[p]);)if(p+=1,p>=d.length)return a;for(var b=p,c=!1,f="";;){if("\\"==d[b]){if(f+=d.substring(p,b),b=p=b+1,b>=d.length)break}else if(c)'"'==d[b]&&
(f+=d.substring(p,b),p=b+1,c=!1);else if('"'==d[b])f+=d.substring(p,b),p=b+1,c=!0;else if(0<=" \t\n\r".indexOf(d[b]))break;b+=1;if(b>=d.length)break}f+=d.substring(p,b);a.push(f);if(b>=d.length)return a;p=b}};lc.prototype.parseLine=function(d,a){var p=d.indexOf(";");0<=p&&(d=d.substring(0,p).trim());if(0==d.length)return a;for(var p=lc.shlex_split(d),b=!1,c=!1,f=0;f<p.length;++f)b=b||"{"==p[f],c=c||"}"==p[f];if(!b&&!c){var b=p[0],g;1<p.length&&(g=p[1]);a.createSubtree(b,g);return a}p=d.indexOf("{");
if(0<p)return g=d.substring(0,p),p=d.substring(p),g=this.parseLine(g,a),this.parseLine(p,g);if("{"==d[0])return a=a.getLastChild();if("}"==d[0])return a=a.getParent();throw runtime_error("BoostInfoParser: input line is malformed");};var c=a.Name,Cc=a.InterestFilter,wa=a.RegistrationOptions,s=a.WireFormat,f=a.Log.LOG,Ra=function(d,a){a=a||1E3;this.face=d;this.cleanupIntervalMilliseconds=a;this.nextCleanupTime=(new Date).getTime()+a;this.onDataNotFoundForPrefix={};this.interestFilterIdList=[];this.registeredPrefixIdList=
[];this.noStaleTimeCache=[];this.staleTimeCache=[];this.emptyComponent=new c.Component;this.pendingInterestTable=[];this.minimumCacheLifetime_=0;var p=this;this.storePendingInterestCallback=function(d,a,q,b,c){p.storePendingInterest(a,q)}};r.MemoryContentCache=Ra;Ra.prototype.registerPrefix=function(d,a,p,b,c,f){var g=p,l=b,m=c;p="object"===typeof g&&1===g.length&&"function"===typeof g[0]?g[0]:null;b="function"===typeof g?g:"function"===typeof l?l:null;c=g instanceof wa?g:l instanceof wa?l:m instanceof
wa?m:new wa;f=g instanceof s?g:l instanceof s?l:m instanceof s?m:f instanceof s?f:s.getDefaultWireFormat();b&&(this.onDataNotFoundForPrefix[d.toUri()]=b);d=this.face.registerPrefix(d,this.onInterest.bind(this),a,p,c,f);this.registeredPrefixIdList.push(d)};Ra.prototype.setInterestFilter=function(d,a){if(a){var p;p="object"===typeof d&&d instanceof Cc?d.getPrefix():d;this.onDataNotFoundForPrefix[p.toUri()]=a}p=this.face.setInterestFilter(d,this.onInterest.bind(this));this.interestFilterIdList.push(p)};
Ra.prototype.unregisterAll=function(){for(var d=0;d<this.interestFilterIdList.length;++d)this.face.unsetInterestFilter(this.interestFilterIdList[d]);this.interestFilterIdList=[];for(d=0;d<this.registeredPrefixIdList.length;++d)this.face.removeRegisteredPrefix(this.registeredPrefixIdList[d]);this.registeredPrefixIdList=[];this.onDataNotFoundForPrefix={}};Ra.prototype.add=function(d){var a=(new Date).getTime();this.doCleanup(a);if(null!=d.getMetaInfo().getFreshnessPeriod()&&0<=d.getMetaInfo().getFreshnessPeriod()){for(var p=
new Ra.StaleTimeContent(d,a,this.minimumCacheLifetime_),b=this.staleTimeCache.length-1;0<=b&&!(this.staleTimeCache[b].cacheRemovalTimeMilliseconds_<=p.cacheRemovalTimeMilliseconds_);)--b;this.staleTimeCache.splice(b+1,0,p)}else this.noStaleTimeCache.push(new Ra.Content(d));for(b=this.pendingInterestTable.length-1;0<=b;--b)if(this.pendingInterestTable[b].isTimedOut(a))this.pendingInterestTable.splice(b,1);else if(this.pendingInterestTable[b].getInterest().matchesName(d.getName())){try{3<f&&console.log("MemoryContentCache:  Reply w/ add Data "+
d.getName().toUri()),this.pendingInterestTable[b].getFace().send(d.wireEncode().buf())}catch(c){0<f&&console.log(""+c);break}this.pendingInterestTable.splice(b,1)}};Ra.prototype.storePendingInterest=function(d,a){this.pendingInterestTable.push(new Ra.PendingInterest(d,a))};Ra.prototype.getStorePendingInterest=function(){return this.storePendingInterestCallback};Ra.prototype.getMinimumCacheLifetime=function(){return this.minimumCacheLifetime_};Ra.prototype.setMinimumCacheLifetime=function(d){this.minimumCacheLifetime_=
d};Ra.prototype.onInterest=function(d,a,p,b,c){3<f&&console.log("MemoryContentCache:  Received Interest "+a.toUri());var g=(new Date).getTime();this.doCleanup(g);for(var l=null,m=null,n=this.staleTimeCache.length+this.noStaleTimeCache.length,s=0;s<n;++s){var r,x=!0;s<this.staleTimeCache.length?(r=this.staleTimeCache[s],x=r.isFresh(g)):r=this.noStaleTimeCache[s-this.staleTimeCache.length];if(a.matchesName(r.getName())&&(!a.getMustBeFresh()||x)){if(null==a.getChildSelector()){3<f&&console.log("MemoryContentCache:         Reply Data "+
r.getName().toUri());p.send(r.getDataEncoding());return}var x=r.getName().size()>a.getName().size()?r.getName().get(a.getName().size()):this.emptyComponent,F=!1;null===m?F=!0:0==a.getChildSelector()?0>x.compare(l)&&(F=!0):0<x.compare(l)&&(F=!0);F&&(l=x,m=r.getDataEncoding())}}null!==m?(3<f&&console.log("MemoryContentCache: Reply Data to Interest "+a.toUri()),p.send(m)):(3<f&&console.log("MemoryContentCache: onDataNotFound for "+a.toUri()),(g=this.onDataNotFoundForPrefix[d.toUri()])&&g(d,a,p,b,c))};
Ra.prototype.doCleanup=function(d){if(d>=this.nextCleanupTime){for(;0<this.staleTimeCache.length&&this.staleTimeCache[0].isPastRemovalTime(d);)this.staleTimeCache.shift();this.nextCleanupTime=d+this.cleanupIntervalMilliseconds}};Ra.Content=function(d){d&&(this.name=new c(d.getName()),this.dataEncoding=d.wireEncode().buf())};Ra.Content.prototype.getName=function(){return this.name};Ra.Content.prototype.getDataEncoding=function(){return this.dataEncoding};Ra.StaleTimeContent=function(d,a,p){Ra.Content.call(this,
d);this.cacheRemovalTimeMilliseconds_=a+Math.max(d.getMetaInfo().getFreshnessPeriod(),p);this.freshnessExpiryTimeMilliseconds_=a+d.getMetaInfo().getFreshnessPeriod()};Ra.StaleTimeContent.prototype=new Ra.Content;Ra.StaleTimeContent.prototype.name="StaleTimeContent";Ra.StaleTimeContent.prototype.isPastRemovalTime=function(d){return this.cacheRemovalTimeMilliseconds_<=d};Ra.StaleTimeContent.prototype.isFresh=function(d){return this.freshnessExpiryTimeMilliseconds_>d};Ra.PendingInterest=function(d,a){this.interest=
d;this.face=a;var p=this.interest.getInterestLifetimeMilliseconds();if(null==p||0>p)p=4E3;this.timeoutMilliseconds=(new Date).getTime()+p};Ra.PendingInterest.prototype.getInterest=function(){return this.interest};Ra.PendingInterest.prototype.getFace=function(){return this.face};Ra.PendingInterest.prototype.isTimedOut=function(d){return d>=this.timeoutTimeMilliseconds};var D=a.Interest,C=a.KeyChain,mc=a.PipelineFixed,Va=a.PipelineCubic,Ld=function(){};r.SegmentFetcher=Ld;Ld.ErrorCode={INTEREST_TIMEOUT:1,
DATA_HAS_NO_SEGMENT:2,SEGMENT_VERIFICATION_FAILED:3,INVALID_KEYCHAIN:4,INVALID_PIPELINE:5};Ld.DontVerifySegment=function(d){return!0};Ld.fetch=function(d,a,p,b,c,f,g){null==f||void 0===f.pipeline||"cubic"===f.pipeline?null==p||p instanceof C?(new Va(a,d,f,p,b,c,g)).run():c(Ld.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null."):"fixed"===f.pipeline?null==p||p instanceof C?(new mc(a,d,f,p,b,c,g)).run():c(Ld.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null."):
c(Ld.ErrorCode.INVALID_PIPELINE,f.pipeline+" is not a valid pipeline type")};var D=a.Interest,M=a.NdnCommon,Y=function(d){this.baseInterest=d;this.numberOfSatisfiedSegments=this.nextSegmentNo=0;this.finalBlockId=Number.MAX_SAFE_INTEGER;this.versionNo=NaN;this.versionIsProvided=!1;0<d.getName().components.length&&d.getName().get(-1).isVersion()&&(this.versionNo=d.getName().get(-1).toVersion(),this.versionIsProvided=!0);this.hasFinalBlockId=this.hasFailure=this.isStopped=!1;this.failedSegNo=0;this.failureReason;
this.failureErrorCode;this.contentParts=[]};r.Pipeline=Y;Y.ErrorCode={INTEREST_TIMEOUT:1,INTEREST_LIFETIME_EXPIRATION:2,DATA_HAS_NO_VERSION:3,DATA_HAS_NO_SEGMENT:4,SEGMENT_VERIFICATION_FAILED:5,NACK_RECEIVED:6,NO_FINALBLOCK:7,MAX_NACK_TIMEOUT_RETRIES:8,MISC:9};Y.prototype.cancel=function(){this.isStopped||(this.isStopped=!0)};Y.prototype.makeInterest=function(d){var a=new D(this.baseInterest);Number.isNaN(this.versionNo)||(!1===this.versionIsProvided?a.setName((new c(this.baseInterest.getName())).appendVersion(this.versionNo).appendSegment(d)):
a.setName((new c(this.baseInterest.getName())).appendSegment(d)));return a};Y.prototype.getNextSegmentNo=function(){return this.nextSegmentNo++};Y.op=function(d,a,p){return null!=p&&p.hasOwnProperty(d)?p[d]:a};Y.reportWarning=function(d,a){console.log("Warning "+d+" : "+a)};Y.reportError=function(d,a,p){try{d(a,p)}catch(b){console.log("Error in onError: "+M.getErrorWithStackTrace(b))}};Y.prototype.onFailure=function(d,a,p,b){null==b?this.cancel():b();Y.reportError(p,d,a)};var D=a.Interest,m=a.Blob,
C=a.KeyChain,M=a.NdnCommon,ac=a.RttEstimator,ud=a.DataFetcher,Y=a.Pipeline,mc=function(d,a,p,b,c,f,g){this.face=a;this.validatorKeyChain=b;this.onComplete=c;this.onError=f;this.pipeline=new Y(d);this.nInFlight=0;this.windowSize=Y.op("windowSize",10,p);this.maxRetriesOnTimeoutOrNack=Y.op("maxRetriesOnTimeoutOrNack",3,p);this.segmentInfo=[];this.dataFetchersContainer=[];this.rttEstimator=new ac(p);this.stats=null!=g?g:{};this.stats.nTimeouts=0;this.stats.nNacks=0;this.stats.nRetransmitted=0};r.PipelineFixed=
mc;mc.prototype.run=function(){this.stats.pipelineStartTime=Date.now();var d=this.pipeline.makeInterest(0);Number.isNaN(this.pipeline.versionNo)?d.setMustBeFresh(!0):d.setMustBeFresh(!1);this.sendInterest(d)};mc.prototype.sendInterest=function(d){if(!this.pipeline.isStopped&&!this.pipeline.hasFailure){var a=0;0<d.getName().components.length&&d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment());this.dataFetchersContainer[a]=new ud(this.face,d,this.maxRetriesOnTimeoutOrNack,this.handleData.bind(this),
this.handleFailure.bind(this),this.segmentInfo,this.stats);this.dataFetchersContainer[a].fetch()}};mc.prototype.sendNextInterests=function(){if(!this.pipeline.isStopped)for(;this.pipeline.nextSegmentNo<=this.pipeline.finalBlockId&&this.nInFlight<=this.windowSize;)if(void 0!==this.pipeline.contentParts[this.pipeline.nextSegmentNo])this.pipeline.getNextSegmentNo();else{var d=this.pipeline.makeInterest(this.pipeline.getNextSegmentNo());d.setMustBeFresh(!1);d.refreshNonce();this.sendInterest(d);this.nInFlight++}};
mc.prototype.cancelInFlightSegmentsGreaterThan=function(d){var a=this.dataFetchersContainer.length;for(d+=1;d<a;++d)null!==this.dataFetchersContainer[d]&&this.face.removePendingInterest(this.dataFetchersContainer[d].getPendingInterestId())};mc.prototype.handleData=function(d,a){if(null!==this.validatorKeyChain)try{var p=this;this.validatorKeyChain.verifyData(a,function(d){p.onData(d)},this.onValidationFailed.bind(this))}catch(b){Y.reportError(this.onError,Y.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Error in KeyChain.verifyData: "+
b)}else this.onData(a)};mc.prototype.onData=function(d){if(!this.pipeline.isStopped){var a=0;try{a=d.getName().get(-1).toSegment()}catch(p){this.handleFailure(a,Y.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding the segment number "+d.getName().get(-1).toEscapedString()+": "+p);return}if(Number.isNaN(this.pipeline.versionNo))try{this.pipeline.versionNo=d.getName().get(-2).toVersion()}catch(b){this.handleFailure(a,Y.ErrorCode.DATA_HAS_NO_VERSION,"Error while decoding the version number "+d.getName().get(-2).toEscapedString()+
": "+b);return}if(0<d.getMetaInfo().getFinalBlockId().getValue().size()){try{this.pipeline.finalBlockId=d.getMetaInfo().getFinalBlockId().toSegment(),this.cancelInFlightSegmentsGreaterThan(this.pipeline.finalBlockId)}catch(c){Y.reportError(this.onError,Y.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding the FinalBlockId field "+d.getMetaInfo().getFinalBlockId().toEscapedString()+": "+c);return}this.pipeline.hasFinalBlockId=!0}this.pipeline.contentParts[a]=d.getContent().buf();if(this.pipeline.hasFailure&&
this.pipeline.hasFinalBlockId){if(this.pipeline.finalBlockId>=this.pipeline.failedSegNo)return this.pipeline.onFailure(this.pipeline.failureErrorCode,this.pipeline.failureReason,this.onError);this.pipeline.hasFailure=!1}var f=this.segmentInfo[a];if(void 0!==f){d=Date.now()-f.timeSent;f=Date.now()-f.initTimeSent;1<Db.LOG&&console.log("Received segment #"+a+", rtt="+d+"ms");if("normal"===this.segmentInfo[a].stat){var l=Math.max(this.nInFlight+1>>1,1);0>=l&&this.handleFailure(-1,Y.ErrorCode.MISC,"nExpectedSamples is less than or equal to ZERO.");
this.rttEstimator.addMeasurement(a,d,l)}this.rttEstimator.addDelayMeasurement(a,Math.max(d,f));this.pipeline.numberOfSatisfiedSegments++;if(this.pipeline.hasFinalBlockId&&this.pipeline.numberOfSatisfiedSegments>this.pipeline.finalBlockId){a=g.concat(this.pipeline.contentParts);this.cancelInFlightSegmentsGreaterThan(this.pipeline.finalBlockId);this.stats.avgRtt=this.rttEstimator.getAvgRtt().toPrecision(3);this.stats.avgJitter=this.rttEstimator.getAvgJitter().toPrecision(3);this.stats.nSegments=this.pipeline.numberOfSatisfiedSegments;
this.stats.completionTime=Date.now()-this.stats.pipelineStartTime;try{this.pipeline.cancel(),this.printSummary(),this.onComplete(new m(a,!1))}catch(n){console.log("Error in onComplete: "+M.getErrorWithStackTrace(n))}}else this.nInFlight=Math.max(this.nInFlight-1,0),this.sendNextInterests()}}};mc.prototype.handleFailure=function(d,a,p){if(!this.pipeline.isStopped)if(-1===d)this.pipeline.onFailure(a,p,this.onError);else{if(0===d||this.pipeline.hasFinalBlockId&&d<=this.pipeline.finalBlockId)return this.pipeline.onFailure(a,
p,this.onError);if(!this.pipeline.hasFinalBlockId)if(this.nInFlight--,0>=this.nInFlight)this.pipeline.onFailure(Y.ErrorCode.NO_FINALBLOCK,"Fetching terminated at segment "+d+" but no finalBlockId has been found",this.onError);else this.cancelInFlightSegmentsGreaterThan(d),this.pipeline.hasFailure=!0,this.pipeline.failedSegNo=d,this.pipeline.failureErrorCode=a,this.pipeline.failureReason=p}};mc.prototype.onValidationFailed=function(d,a){Y.reportError(this.onError,Y.ErrorCode.SEGMENT_VERIFICATION_FAILED,
"Segment verification failed for "+d.getName().toUri()+" . Reason: "+a)};mc.prototype.printSummary=function(){if(!(2>Db.LOG)){var d="",d=this.rttEstimator.getMinRtt()===Number.MAX_VALUE||this.rttEstimator.getMaxRtt()===Number.NEGATIVE_INFINITY?"stats unavailable":"min/avg/max = "+this.rttEstimator.getMinRtt().toPrecision(3)+"/"+this.rttEstimator.getAvgRtt().toPrecision(3)+"/"+this.rttEstimator.getMaxRtt().toPrecision(3)+" ms";console.log("Timeouts: "+this.stats.nTimeouts+" Nacks: "+this.stats.nNacks+
"\nRetransmitted segments: "+this.stats.nRetransmitted+"\nRTT "+d+"\nAverage jitter: "+this.rttEstimator.getAvgJitter().toPrecision(3)+" ms\nCompletion time: "+this.stats.completionTime+"ms")}};D=a.Interest;c=a.Name;m=a.Blob;C=a.KeyChain;M=a.NdnCommon;ac=a.RttEstimator;Y=a.Pipeline;Va=function(d,a,p,b,c,f,g){console.log(Db.LOG);this.pipeline=new Y(d);this.face=a;this.validatorKeyChain=b;this.onComplete=c;this.onError=f;this.initCwnd=Y.op("initCwnd",1,p);this.cwnd=Y.op("cwnd",this.initCwnd,p);this.ssthresh=
Y.op("ssthresh",Number.MAX_VALUE,p);this.rtoCheckInterval=Y.op("rtoCheckInterval",10,p);this.disableCwa=Y.op("disableCwa",!1,p);this.maxRetriesOnTimeoutOrNack=Y.op("maxRetriesOnTimeoutOrNack",3,p);this.enableFastConv=Y.op("enableFastConv",!1,p);this.cubicBeta=Y.op("cubicBeta",0.7,p);this.wmax=Y.op("wmax",0,p);this.lastWmax=Y.op("lastWmax",0,p);this.lastDecrease=Date.now();this.cubic_c=0.4;this.nSent=this.nRetransmitted=this.nSkippedRetx=this.nNacks=this.nTimeouts=this.nLossDecr=this.nInFlight=this.recPoint=
this.highInterest=this.highData=0;this.segmentInfo=[];this.retxQueue=[];this.retxCount=[];this.rttEstimator=new ac(p);this.stats=null!=g?g:{}};r.PipelineCubic=Va;Va.SegmentState={FirstTimeSent:1,InRetxQueue:2,Retransmitted:3};Va.prototype.increaseWindow=function(){if(this.cwnd<this.ssthresh)this.cwnd+=1;else{this.wmax<this.initCwnd&&(this.wmax=this.cwnd);var d=(Date.now()-this.lastDecrease)/1E3,a=Math.cbrt(this.wmax*(1-this.cubicBeta)/this.cubic_c),d=this.cubic_c*Math.pow(d-a,3)+this.wmax,d=Math.max(d,
0)-this.cwnd,d=Math.max(0,d);this.cwnd+=d/this.cwnd}};Va.prototype.decreaseWindow=function(){this.enableFastConv&&this.cwnd<this.lastWmax?(this.lastWmax=this.cwnd,this.wmax=this.cwnd*(1+this.cubicBeta)/2):this.wmax=this.lastWmax=this.cwnd;this.cwnd=this.ssthresh=Math.max(this.initCwnd,this.cwnd*this.cubicBeta);this.lastDecrease=Date.now()};Va.prototype.run=function(){this.stats.pipelineStartTime=Date.now();setTimeout(this.checkRto.bind(this),this.rtoCheckInterval);this.sendInterest(this.pipeline.getNextSegmentNo(),
!1)};Va.prototype.cancel=function(){this.pipeline.cancel();this.segmentInfo.length=0};Va.prototype.sendInterest=function(d,a){if(!(this.pipeline.isStopped||this.pipeline.hasFinalBlockId&&d>this.pipeline.finalBlockId||!a&&this.pipeline.hasFailure)){if(a){if(void 0===this.retxCount[d])this.retxCount[d]=1;else if(this.retxCount[d]++,this.retxCount[d]>this.maxRetriesOnTimeoutOrNack)return this.handleFailure(d,Y.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+
") while retrieving segment #"+d);1<Db.LOG&&console.log("Retransmitting segment #"+d+" ("+this.retxCount[d]+")")}1<Db.LOG&&!a&&console.log("Requesting segment #"+d);var p=this.pipeline.makeInterest(d);Number.isNaN(this.pipeline.versionNo)?p.setMustBeFresh(!0):p.setMustBeFresh(!1);var b={};b.pendingInterestId=this.face.expressInterest(p,this.handleData.bind(this),this.handleLifetimeExpiration.bind(this),this.handleNack.bind(this));a&&void 0===b.initTimeSent&&(b.initTimeSent=b.timeSent);b.timeSent=
Date.now();b.rto=this.rttEstimator.getEstimatedRto();this.nInFlight++;this.nSent++;a?(b.state=Va.SegmentState.Retransmitted,this.nRetransmitted++):(this.highInterest=d,b.state=Va.SegmentState.FirstTimeSent);this.segmentInfo[d]=b}};Va.prototype.schedulePackets=function(){if(0>this.nInFlight)this.handleFailure(-1,Y.ErrorCode.MISC,"Number of in flight Interests is negative.");else for(var d=this.cwnd-this.nInFlight;0<d;){if(0!=this.retxQueue.length){var a=this.retxQueue.shift();if(void 0===this.segmentInfo[a]){this.nSkippedRetx++;
continue}this.sendInterest(a,!0)}else this.sendInterest(this.pipeline.getNextSegmentNo(),!1);d--}};Va.prototype.handleData=function(d,a){if(null!==this.validatorKeyChain)try{var p=this;this.validatorKeyChain.verifyData(a,function(d){p.onData(d)},this.onValidationFailed.bind(this))}catch(b){Y.reportError(this.onError,Y.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Error in KeyChain.verifyData: "+b)}else this.onData(a)};Va.prototype.onData=function(d){if(!this.pipeline.isStopped){var a=0;try{a=d.getName().get(-1).toSegment()}catch(p){this.handleFailure(a,
Y.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding the segment number "+d.getName().get(-1).toEscapedString()+": "+p);return}if(Number.isNaN(this.pipeline.versionNo))try{this.pipeline.versionNo=d.getName().get(-2).toVersion()}catch(b){this.handleFailure(a,Y.ErrorCode.DATA_HAS_NO_VERSION,"Error while decoding the version number "+d.getName().get(-2).toEscapedString()+": "+b);return}if(!this.pipeline.hasFinalBlockId&&0<d.getMetaInfo().getFinalBlockId().getValue().size()){try{this.pipeline.finalBlockId=
d.getMetaInfo().getFinalBlockId().toSegment()}catch(c){this.handleFailure(a,Y.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding FinalBlockId field "+d.getName().get(-1).toEscapedString()+": "+c);return}this.pipeline.hasFinalBlockId=!0}this.pipeline.contentParts[a]=d.getContent().buf();if(this.pipeline.hasFailure&&this.pipeline.hasFinalBlockId){if(this.pipeline.finalBlockId>=this.pipeline.failedSegNo)return this.pipeline.onFailure(this.pipeline.failureErrorCode,this.pipeline.failureReason,this.onError,
this.cancel.bind(this));this.pipeline.hasFailure=!1}var f=this.segmentInfo[a];if(void 0!==f){d=Date.now()-f.timeSent;var l=0;void 0!==f.initTimeSent&&(l=Date.now()-f.initTimeSent);1<Db.LOG&&console.log("Received segment #"+a+", rtt="+d+"ms, rto="+f.rto+"ms");this.highData<a&&(this.highData=a);f.state!==Va.SegmentState.InRetxQueue&&this.nInFlight--;f.state!==Va.SegmentState.FirstTimeSent&&f.state!==Va.SegmentState.InRetxQueue||void 0!==this.retxCount[a]||(f=Math.max(this.nInFlight+1>>1,1),0>=f&&this.handleFailure(-1,
Y.ErrorCode.MISC,"nExpectedSamples is less than or equal to ZERO."),this.rttEstimator.addMeasurement(a,d,f));this.rttEstimator.addDelayMeasurement(a,Math.max(d,l));this.segmentInfo[a]=void 0;this.pipeline.numberOfSatisfiedSegments++;if(this.pipeline.hasFinalBlockId&&this.pipeline.numberOfSatisfiedSegments>this.pipeline.finalBlockId){a=g.concat(this.pipeline.contentParts);this.cancelInFlightSegmentsGreaterThan(this.pipeline.finalBlockId);this.stats.nTimeouts=this.nTimeouts;this.stats.nNacks=this.nNacks;
this.stats.nRetransmitted=this.nRetransmitted;this.stats.avgRtt=this.rttEstimator.getAvgRtt().toPrecision(3);this.stats.avgJitter=this.rttEstimator.getAvgJitter().toPrecision(3);this.stats.nSegments=this.pipeline.numberOfSatisfiedSegments;this.stats.completionTime=Date.now()-this.stats.pipelineStartTime;try{this.cancel(),this.printSummary(),this.onComplete(new m(a,!1))}catch(n){this.handleFailure(-1,Y.ErrorCode.MISC,"Error in onComplete: "+M.getErrorWithStackTrace(n))}}else this.increaseWindow(),
this.schedulePackets()}}};Va.prototype.checkRto=function(){if(!this.pipeline.isStopped){for(var d=!1,a=0;a<this.segmentInfo.length;++a)if(void 0!==this.segmentInfo[a]){var p=this.segmentInfo[a];p.state!==Va.SegmentState.InRetxQueue&&Date.now()-p.timeSent>p.rto&&(this.nTimeouts++,d=!0,this.onWarning(Y.ErrorCode.INTEREST_TIMEOUT,"handle timeout for segment "+a),this.enqueueForRetransmission(a))}d&&(this.recordTimeout(),this.schedulePackets());setTimeout(this.checkRto.bind(this),this.rtoCheckInterval)}};
Va.prototype.enqueueForRetransmission=function(d){0>=this.nInFlight?this.handleFailure(-1,Y.ErrorCode.MISC,"Number of in flight Interests <= 0."):(this.nInFlight--,this.retxQueue.push(d),this.segmentInfo[d].state=Va.SegmentState.InRetxQueue)};Va.prototype.recordTimeout=function(){if(this.disableCwa||this.highData>this.recPoint)this.recPoint=this.highInterest,this.decreaseWindow(),this.rttEstimator.backoffRto(),this.nLossDecr++,1<Db.LOG&&console.log("Packet loss event, new cwnd = "+this.cwnd+", ssthresh = "+
this.ssthresh)};Va.prototype.cancelInFlightSegmentsGreaterThan=function(d){for(d+=1;d<this.segmentInfo.length;++d)void 0!==this.segmentInfo[d]&&this.face.removePendingInterest(this.segmentInfo[d].pendingInterestId),this.segmentInfo[d]=void 0,this.nInFlight--};Va.prototype.handleFailure=function(d,a,p){if(!this.pipeline.isStopped)if(-1===d)this.pipeline.onFailure(a,p,this.onError,this.cancel.bind(this));else{if(0===d||this.pipeline.hasFinalBlockId&&d<=this.pipeline.finalBlockId)return this.pipeline.onFailure(a,
p,this.onError,this.cancel.bind(this));if(!this.pipeline.hasFinalBlockId){this.segmentInfo[d]=void 0;this.nInFlight--;for(var b=!0,c=0;c<this.segmentInfo.length;++c)if(void 0!==this.segmentInfo[c]){b=!1;break}if(b)this.pipeline.onFailure(Y.ErrorCode.NO_FINALBLOCK,"Fetching terminated at segment "+d+" but no finalBlockId has been found",this.onError,this.cancel.bind(this));else this.cancelInFlightSegmentsGreaterThan(d),this.pipeline.hasFailure=!0,this.pipeline.failedSegNo=d,this.pipeline.failureErrorCode=
a,this.pipeline.failureReason=p}}};Va.prototype.handleLifetimeExpiration=function(d){if(!this.pipeline.isStopped){this.nTimeouts++;var a=0;0<d.getName().components.length&&d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment());this.enqueueForRetransmission(a);this.onWarning(Y.ErrorCode.INTEREST_LIFETIME_EXPIRATION,"handle interest lifetime expiration for segment "+a);this.recordTimeout();this.schedulePackets()}};Va.prototype.handleNack=function(d){if(!this.pipeline.isStopped){this.nNacks++;
var a=0;0<d.getName().components.length&&d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment());this.enqueueForRetransmission(a);this.onWarning(Y.ErrorCode.NACK_RECEIVED,"handle nack for segment "+a);this.recordTimeout();this.schedulePackets()}};Va.prototype.onValidationFailed=function(d,a){Y.reportError(this.onError,Y.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+d.getName().toUri()+" . Reason: "+a)};Va.prototype.onWarning=function(d,a){2<Db.LOG&&Y.reportWarning(d,
a)};Va.prototype.printSummary=function(){if(!(2>Db.LOG)){var d="",d=this.rttEstimator.getMinRtt()===Number.MAX_VALUE||this.rttEstimator.getMaxRtt()===Number.NEGATIVE_INFINITY?"stats unavailable":"min/avg/max = "+this.rttEstimator.getMinRtt().toPrecision(3)+"/"+this.rttEstimator.getAvgRtt().toPrecision(3)+"/"+this.rttEstimator.getMaxRtt().toPrecision(3)+" ms";console.log("Timeouts: "+this.nTimeouts+" (caused "+this.nLossDecr+" window decreases)\nNacks: "+this.nNacks+"\nRetransmitted segments: "+this.nRetransmitted+
" ("+(0==this.nSent?0:this.nRetransmitted/this.nSent*100)+"%), skipped: "+this.nSkippedRetx+"\nRTT "+d+"\nAverage jitter: "+this.rttEstimator.getAvgJitter().toPrecision(3)+" ms\nCompletion time: "+this.stats.completionTime+"ms")}};Y=a.Pipeline;ac=function(d){this.alpha=Y.op("alpha",0.125,d);this.beta=Y.op("beta",0.25,d);this.k=Y.op("k",8,d);this.initialRto=Y.op("initialRto",1E3,d);this.minRto=Y.op("minRto",200,d);this.maxRto=Y.op("maxRto",2E4,d);this.rtoBackoffMultiplier=Y.op("rtoBackoffMultiplier",
2,d);this.delayArr=[];this.rttVar=this.sRtt=NaN;this.rto=this.initialRto;this.rttMin=Number.MAX_VALUE;this.rttMax=Number.NEGATIVE_INFINITY;this.nRttSamples=this.rttAvg=0};r.RttEstimator=ac;ac.prototype.clamp=function(d,a,p){if(a<d&&d<p)return d;if(d<a)return a;if(p<d)return p};ac.prototype.addMeasurement=function(d,a,p){0>=p&&console.log("ERROR: nExpectedSamples is less than or equal to ZERO");0===this.nRttSamples?(this.sRtt=a,this.rttVar=this.sRtt/2):(d=this.alpha/p,p=this.beta/p,this.rttVar=(1-
p)*this.rttVar+p*Math.abs(this.sRtt-a),this.sRtt=(1-d)*this.sRtt+d*a);this.rto=this.sRtt+this.k*this.rttVar;this.rto=this.clamp(this.rto,this.minRto,this.maxRto);this.rttAvg=(this.nRttSamples*this.rttAvg+a)/(this.nRttSamples+1);this.rttMax=Math.max(a,this.rttMax);this.rttMin=Math.min(a,this.rttMin);this.nRttSamples++};ac.prototype.addDelayMeasurement=function(d,a){this.delayArr[d]=a};ac.prototype.getAvgJitter=function(){for(var d=0,a=0,p=0,b=0;b<this.delayArr.length;++b)void 0!==this.delayArr[b]&&
(0<d&&(a=(a*d+Math.abs(p-this.delayArr[b]))/(d+1)),p=this.delayArr[b],d++);return a};ac.prototype.backoffRto=function(){this.rto=this.clamp(this.rto*this.rtobackoffmultiplier,this.minrto,this.maxrto)};ac.prototype.getEstimatedRto=function(){return this.rto};ac.prototype.getMinRtt=function(){return this.rttMin};ac.prototype.getMaxRtt=function(){return this.rttMax};ac.prototype.getAvgRtt=function(){return this.rttAvg};D=a.Interest;f=a.Log.LOG;Y=a.Pipeline;ud=function(d,a,p,b,c,f,g){this.face=d;this.interest=
a;this.maxRetriesOnTimeoutOrNack=p;this.onData=b;this.handleFailure=c;this.segmentInfo=f;this.stats=g;this.segmentNo=0;0<a.getName().components.length&&a.getName().get(-1).isSegment()&&(this.segmentNo=a.getName().get(-1).toSegment());this.nNackRetries=this.nTimeoutRetries=0;this.segmentInfo[this.segmentNo]={};this.segmentInfo[this.segmentNo].stat="normal";this.segmentInfo[this.segmentNo].initTimeSent=Date.now();this.pendingInterestId=null};r.DataFetcher=ud;ud.prototype.fetch=function(){this.segmentInfo[this.segmentNo].timeSent=
Date.now();this.pendingInterestId=this.face.expressInterest(this.interest,this.handleData.bind(this),this.handleLifetimeExpiration.bind(this),this.handleNack.bind(this))};ud.prototype.getPendingInterestId=function(){return this.pendingInterestId};ud.prototype.handleData=function(d,a){this.stats.nTimeouts+=this.nTimeoutRetries;this.stats.nNacks+=this.nNackRetries;this.stats.nRetransmitted+=this.nNackRetries+this.nTimeoutRetries;this.onData(d,a)};ud.prototype.handleLifetimeExpiration=function(d){this.nTimeoutRetries++;
this.segmentInfo[this.segmentNo].stat="retx";if(this.nTimeoutRetries<=this.maxRetriesOnTimeoutOrNack){var a=new D(d);a.refreshNonce();this.interest=a;3<f&&console.log("handle lifetime expiration for interest "+d.getName());this.fetch()}else a=0,0<d.getName().components.length&&d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment()),this.handleFailure(this.segmentNo,Y.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+") while retrieving segment #"+
a)};ud.prototype.handleNack=function(d){this.nNackRetries+=1;this.segmentInfo[this.segmentNo].stat="retx";if(this.nNackRetries<=this.maxRetriesOnTimeoutOrNack){var a=new D(d);a.refreshNonce();this.interest=a;3<f&&console.log("handle nack for interest "+d.getName());setTimeout(this.fetch.bind(this),40+20*Math.random())}else a=0,0<d.getName().components.length&&d.getName().get(-1).isSegment()&&(a=d.getName().get(-1).toSegment()),this.handleFailure(this.segmentNo,Y.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,
"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+") while retrieving segment #"+a)};var Pc=function(){this.backrefs_=[]};r.NdnRegexBackrefManager=Pc;Pc.prototype.pushRef=function(d){last=this.backrefs_.length;this.backrefs_.push(d);return last};Pc.prototype.popRef=function(){this.backrefs_.pop()};Pc.prototype.size=function(){return this.backrefs_.length};Pc.prototype.getBackref=function(d){return this.backrefs_[d]};var Pc=a.NdnRegexBackrefManager,$=function(d,a,p){this.matchers_=
[];this.matchResult_=[];this.expr_=d;this.type_=a;void 0==p&&(p=new Pc);this.backrefManager_=p};r.NdnRegexMatcherBase=$;$.Error=function(d){if(d)return d.__proto__=$.Error.prototype,d};$.Error.prototype=Error();$.Error.prototype.name="NdnRegexMatcherBaseError";$.NdnRegexExprType={TOP:0,PATTERN_LIST:1,REPEAT_PATTERN:2,BACKREF:3,COMPONENT_SET:4,COMPONENT:5,PSEUDO:6};$.prototype.match=function(d,a,p){var b=!1;this.matchResult_=[];if(this.recursiveMatch_(0,d,a,p)){for(b=a;b<a+p;)this.matchResult_.push(d.get(b)),
++b;b=!0}else b=!1;return b};$.prototype.getMatchResult=function(){return this.matchResult_};$.prototype.getExpr=function(){return this.expr_};$.prototype.compile_=function(){throw Error("NdnRegexMatcherBase.compile is not implemented");};$.prototype.recursiveMatch_=function(d,a,p,b){var c=b;if(d>=this.matchers_.length)return 0==b;for(var f=this.matchers_[d];0<=c;){if(f.match(a,p,c)&&this.recursiveMatch_(d+1,a,p+c,b-c))return!0;--c}return!1};var $=a.NdnRegexMatcherBase,ed=function(d,a){$.call(this,
d,$.NdnRegexExprType.BACKREF,a)};ed.prototype=new $;ed.prototype.name="NdnRegexBackrefMatcher";r.NdnRegexBackrefMatcher=ed;ed.prototype.lateCompile=function(){this.compile_()};ed.prototype.compile_=function(){if(2>this.expr_.length)throw new $.Error(Error("Unrecognized format: "+this.expr_));var d=this.expr_.length-1;if("("===this.expr_[0]&&")"===this.expr_[d])d=new nc(this.expr_.substring(1,d),this.backrefManager_),this.matchers_.push(d);else throw new $.Error(Error("Unrecognized format: "+this.expr_));
};var nc=a.NdnRegexPatternListMatcher,$=a.NdnRegexMatcherBase,fd=a.NdnRegexPseudoMatcher,vd=function(d,a,p){$.call(this,d,$.NdnRegexExprType.COMPONENT,a);void 0===p&&(p=!0);this.componentRegex_=null;this.pseudoMatchers_=[];this.isExactMatch_=p;this.compile_()};vd.prototype=new $;vd.prototype.name="NdnRegexComponentMatcher";r.NdnRegexComponentMatcher=vd;vd.prototype.match=function(d,a,p){this.matchResult_=[];if(""==this.expr_)return this.matchResult_.push(d.get(a)),!0;if(this.isExactMatch_){if(p=d.get(a).toEscapedString().match(this.componentRegex_),
null!==p){for(var b=1;b<p.length;++b)this.pseudoMatchers_[b].resetMatchResult(),this.pseudoMatchers_[b].setMatchResult(p[b]);this.matchResult_.push(d.get(a));return!0}}else throw new $.Error(Error("Non-exact component search is not supported yet"));return!1};vd.prototype.compile_=function(){this.componentRegex_=new RegExp(this.expr_);this.pseudoMatchers_=[];this.pseudoMatchers_.push(new fd);if(0<=this.expr_.indexOf("\\("))throw new $.Error(Error("Can't count subexpressions in regex with escaped parentheses: "+
expr_));for(var d=0,a=0;a<this.expr_.length;++a)"("===this.expr_[a]&&++d;for(a=1;a<=d;++a){var p=new fd;this.pseudoMatchers_.push(p);this.backrefManager_.pushRef(p)}};var $=a.NdnRegexMatcherBase,Qc=function(d,a){$.call(this,d,$.NdnRegexExprType.COMPONENT_SET,a);this.components_=[];this.isInclusion_=!0;this.compile_()};Qc.prototype=new $;Qc.prototype.name="NdnRegexComponentSetMatcher";r.NdnRegexComponentSetMatcher=Qc;Qc.prototype.match=function(d,a,p){isMatched=!1;if(1!==p)return!1;for(var b=0;b<this.components_.length;++b)if(this.components_[b].match(d,
a,p)){isMatched=!0;break}this.matchResult_=[];return(this.isInclusion_?isMatched:!isMatched)?(this.matchResult_.push(d.get(a)),!0):!1};Qc.prototype.compile_=function(){if(2>this.expr_.length)throw new $.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));if("<"===this.expr_[0])this.compileSingleComponent_();else if("["===this.expr_[0]){var d=this.expr_.length-1;if("]"!==this.expr_[d])throw new $.Error(Error("Regexp compile error (no matching ']' in "+this.expr_+")"));"^"===this.expr_[1]?
(this.isInclusion_=!1,this.compileMultipleComponents_(2,d)):this.compileMultipleComponents_(1,d)}else throw new $.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));};Qc.prototype.extractComponent_=function(d){for(var a=1,p=0;a>p;){if(d>=this.expr_.length)throw new $.Error(Error("Error: angle brackets mismatch"));"<"===this.expr_[d]?a+=1:">"===this.expr_[d]&&(p+=1);d+=1}return d};Qc.prototype.compileSingleComponent_=function(){var d=this.extractComponent_(1);if(this.expr_.length!==
d)throw new $.Error(Error("Component expr error "+this.expr_));component=new vd(this.expr_.substring(1,d-1),this.backrefManager_);this.components_.push(component)};Qc.prototype.compileMultipleComponents_=function(d,a){for(var p=d,b=d;p<a;){if("<"!==this.expr_[p])throw new $.Error(Error("Component expr error "+this.expr_));b=p+1;p=this.extractComponent_(b);component=new vd(this.expr_.substring(b,p-1),this.backrefManager_);this.components_.push(component)}if(p!=a)throw new $.Error(Error("Not sufficient expr to parse "+
this.expr_));};vd=a.NdnRegexComponentMatcher;$=a.NdnRegexMatcherBase;nc=function(d,a){$.call(this,d,$.NdnRegexExprType.PATTERN_LIST,a);this.compile_()};nc.prototype=new $;nc.prototype.name="NdnRegexPatternListMatcher";r.NdnRegexPatternListMatcher=nc;nc.prototype.compile_=function(){for(var d=this.expr_.length,a=[0],p=a[0];a[0]<d;)if(p=a[0],!this.extractPattern_(p,a))throw new $.Error(Error("Compile error"));};nc.prototype.extractPattern_=function(d,a){var p=d,b=d,c=d;if("("===this.expr_[d])c=d=this.extractSubPattern_("(",
")",d+1),b=this.extractRepetition_(d),c===b?(p=new ed(this.expr_.substring(p,b),this.backrefManager_),this.backrefManager_.pushRef(p),p.lateCompile(),this.matchers_.push(p)):this.matchers_.push(new Dc(this.expr_.substring(p,b),this.backrefManager_,c-p));else if("<"===this.expr_[d])d+=1,c=d=this.extractSubPattern_("<",">",d),b=this.extractRepetition_(d),this.matchers_.push(new Dc(this.expr_.substring(p,b),this.backrefManager_,c-p));else if("["===this.expr_[d])d+=1,c=d=this.extractSubPattern_("[","]",
d),b=this.extractRepetition_(d),this.matchers_.push(new Dc(this.expr_.substring(p,b),this.backrefManager_,c-p));else throw new $.Error(Error("Unexpected syntax"));a[0]=b;return!0};nc.prototype.extractSubPattern_=function(d,a,p){for(var b=1,c=0;b>c;){if(p>=this.expr_.length)throw new $.Error(Error("Parenthesis mismatch"));d==this.expr_[p]&&(b+=1);a==this.expr_[p]&&(c+=1);p+=1}return p};nc.prototype.extractRepetition_=function(d){var a=this.expr_.length;if(d===a)return d;if("+"==this.expr_[d]||"?"==
this.expr_[d]||"*"==this.expr_[d])return++d,d;if("{"==this.expr_[d]){for(;"}"!=this.expr_[d]&&(++d,d!==a););if(d===a)throw new $.Error(Error("Missing right brace bracket"));++d}return d};var ed=a.NdnRegexBackrefMatcher,Dc=a.NdnRegexRepeatMatcher,c=a.Name,$=a.NdnRegexMatcherBase,fd=function(){$.call(this,"",$.NdnRegexExprType.PSEUDO)};fd.prototype=new $;fd.prototype.name="NdnRegexPseudoMatcher";r.NdnRegexPseudoMatcher=fd;fd.prototype.compile_=function(){};fd.prototype.setMatchResult=function(d){this.matchResult_.push(new c.Component(d))};
fd.prototype.resetMatchResult=function(){this.matchResult_=[]};$=a.NdnRegexMatcherBase;Dc=function(d,a,p){$.call(this,d,$.NdnRegexExprType.REPEAT_PATTERN,a);this.repeatMax_=this.repeatMin_=0;this.indicator_=p;this.compile_()};Dc.prototype=new $;Dc.prototype.name="NdnRegexRepeatMatcher";r.NdnRegexRepeatMatcher=Dc;Dc.prototype.match=function(d,a,p){this.matchResult_=[];if(0===this.repeatMin_&&0===p)return!0;if(this.recursiveMatch2_(0,d,a,p)){for(var b=a;b<a+p;++b)this.matchResult_.push(d.get(b));return!0}return!1};
Dc.prototype.compile_=function(){var d;"("==this.expr_[0]?(d=new ed(this.expr_.substring(0,this.indicator_),this.backrefManager_),this.backrefManager_.pushRef(d),d.lateCompile()):d=new Qc(this.expr_.substring(0,this.indicator_),this.backrefManager_);this.matchers_.push(d);this.parseRepetition_()};Dc.prototype.parseRepetition_=function(){var d=this.expr_.length;if(d===this.indicator_)return this.repeatMax_=this.repeatMin_=1,!0;if(d===this.indicator_+1){if("?"==this.expr_[this.indicator_])return this.repeatMin_=
0,this.repeatMax_=1,!0;if("+"==this.expr_[this.indicator_])return this.repeatMin_=1,this.repeatMax_=32767,!0;if("*"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=32767,!0}else{var d=this.expr_.substring(this.indicator_,d),a=d.length,b=0,c=0;if(null!=d.match(/\{[0-9]+,[0-9]+\}/))separator=d.indexOf(","),b=parseInt(d.substring(1,separator)),c=parseInt(d.substring(separator+1,a-1));else if(null!=d.match(/\{,[0-9]+\}/))separator=d.indexOf(","),b=0,c=parseInt(d.substring(separator+
1,a-1));else if(null!=d.match(/\{[0-9]+,\}/))separator=d.indexOf(","),b=parseInt(d.substring(1,separator)),c=32767;else if(null!=d.match(/\{[0-9]+\}/))c=b=parseInt(d.substring(1,a-1));else throw new $.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Unrecognized format "+this.expr_));if(32767<b||32767<c||b>c)throw new $.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Wrong number "+this.expr_));this.repeatMin_=b;this.repeatMax_=c;return!0}return!1};Dc.prototype.recursiveMatch2_=
function(d,a,b,c){var f=c,g=this.matchers_[0];if(0<c&&d>=this.repeatMax_||0===c&&d<this.repeatMin_)return!1;if(0==c&&d>=this.repeatMin_)return!0;for(;0<=f;){if(g.match(a,b,f)&&this.recursiveMatch2_(d+1,a,b+f,c-f))return!0;--f}return!1};var ed=a.NdnRegexBackrefMatcher,Qc=a.NdnRegexComponentSetMatcher,c=a.Name,$=a.NdnRegexMatcherBase,Pc=a.NdnRegexBackrefManager,nc=a.NdnRegexPatternListMatcher,Za=function(d,a){$.call(this,d,$.NdnRegexExprType.TOP);void 0==a&&(a="");this.secondaryMatcher_=this.primaryMatcher_=
null;this.primaryBackrefManager_=new Pc;this.secondaryBackrefManager_=new Pc;this.isSecondaryUsed_=!1;this.expand_=a;this.compile_()};Za.prototype=new $;Za.prototype.name="NdnRegexTopMatcher";r.NdnRegexTopMatcher=Za;Za.prototype.match=function(d,a,b){this.isSecondaryUsed_=!1;this.matchResult_=[];if(this.primaryMatcher_.match(d,0,d.size())){this.matchResult_=[];d=this.primaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return!0}if(null!=this.secondaryMatcher_&&this.secondaryMatcher_.match(d,
0,d.size())){this.matchResult_=[];d=this.secondaryMatcher_.getMatchResult();for(a=0;a<d.length;++a)this.matchResult_.push(d[a]);return this.isSecondaryUsed_=!0}return!1};Za.prototype.expand=function(d){void 0==d&&(d="");var a=new c,b=this.isSecondaryUsed_?this.secondaryBackrefManager_:this.primaryBackrefManager_,f=b.size();d=""!=d?d:this.expand_;for(var g=[0];g[0]<d.length;){var l=Za.getItemFromExpand_(d,g);"<"==l[0]&&a.append(l.substring(1,l.length-1));if("\\"==l[0])if(l=parseInt(l.substring(1,l.length)),
0===l)for(l=0;l<this.matchResult_.length;++l)a.append(this.matchResult_[l]);else if(l<=f)for(var m=b.getBackref(l-1).getMatchResult(),l=0;l<m.length;++l)a.append(m[l]);else throw new $.Error(Error("Exceeded the range of back reference"));}return a};Za.fromName=function(d,a){void 0==a&&(a=!1);for(var b="^",c=0;c<d.size();++c)b+="<",b+=Za.convertSpecialChar_(d.get(c).toEscapedString()),b+=">";a&&(b+="$");return new Za(b)};Za.prototype.compile_=function(){var d=this.expr_,d="$"!=d[d.length-1]?d+"<.*>*":
d.substring(0,d.length-1);"^"!=d[0]?this.secondaryMatcher_=new nc("<.*>*"+d,this.secondaryBackrefManager_):d=d.substring(1);this.primaryMatcher_=new nc(d,this.primaryBackrefManager_)};Za.getItemFromExpand_=function(d,a){var b=a[0];if("\\"==d[a[0]]){++a[0];if(a[0]>=d.length)throw new $.Error(Error("Wrong format of expand string!"));for(;a[0]<d.length&&"9">=d[a[0]]&&"0"<=d[a[0]];)if(++a[0],a[0]>d.length)throw new $.Error(Error("Wrong format of expand string!"));if(a[0]>b+1)return d.substring(b,a[0])}else if("<"==
d[a[0]]){++a[0];if(a[0]>=d.length)throw new $.Error(Error("Wrong format of expand string!"));for(var c=1,f=0;f<c;)if("<"==d[a[0]]&&++c,">"==d[a[0]]&&++f,++a[0],a[0]>=d.length)throw new $.Error(Error("Wrong format of expand string!"));return d.substring(b,a[0])}throw new $.Error(Error("Wrong format of expand string!"));};Za.convertSpecialChar_=function(d){newStr="";for(var a=0;a<d.length;++a){var b=d[a];if("."==b||"["==b||"{"==b||"}"==b||"("==b||")"==b||"\\"==b||"*"==b||"+"==b||"?"==b||"|"==b||"^"==
b||"$"==b)newStr+="\\";newStr+=b}return newStr};var wb=function(){};r.Transport=wb;wb.ConnectionInfo=function(){};wb.prototype.isLocal=function(d,a,b){b("Transport.isLocal is not implemented")};var oc=function(){wb.call(this);this.onReceivedObject=this.connectionInfo=this.elementReader=null;var d=this;window.addEventListener("message",function(a){if(a.source==window&&a.data.type&&"FromMicroForwarderStub"==a.data.type)if(a=a.data.object,a.type&&"Buffer"==a.type){if(null!=d.elementReader)d.elementReader.onReceivedData(new g(a.data))}else if(d.onReceivedObject)d.onReceivedObject(a)},
!1)};oc.prototype=new wb;oc.prototype.name="MicroForwarderTransport";oc.ConnectionInfo=function(){wb.ConnectionInfo.call(this)};oc.ConnectionInfo.prototype=new wb.ConnectionInfo;oc.ConnectionInfo.prototype.name="MicroForwarderTransport.ConnectionInfo";oc.ConnectionInfo.prototype.equals=function(d){return null==d?!1:!0};oc.ConnectionInfo.prototype.toString=function(){return"{}"};oc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};oc.prototype.isLocal=function(d,a,b){a(!0)};oc.prototype.connect=
function(d,a,b,c){this.elementReader=new Xd(a);this.connectionInfo=d;b()};oc.prototype.sendObject=function(d){window.postMessage({type:"FromMicroForwarderTransport",object:d},"*")};oc.prototype.send=function(d){null==this.connectionInfo?console.log("MicroForwarderTransport connection is not established."):this.sendObject(d.toJSON())};var pc=function(d){wb.call(this);this.connectionInfo=this.elementReader=null;this.onReceivedObject=d;this.port=null};pc.prototype=new wb;pc.prototype.name="RuntimePortTransport";
pc.ConnectionInfo=function(d){wb.ConnectionInfo.call(this);this.port=d};pc.ConnectionInfo.prototype=new wb.ConnectionInfo;pc.ConnectionInfo.prototype.name="RuntimePortTransport.ConnectionInfo";pc.ConnectionInfo.prototype.equals=function(d){return null==d||void 0==d.port?!1:this.port==d.port};pc.ConnectionInfo.prototype.toString=function(){return"{}"};pc.prototype.setOnReceivedObject=function(d){this.onReceivedObject=d};pc.prototype.isLocal=function(d,a,b){a(!0)};pc.prototype.connect=function(d,a,
b,c){this.elementReader=new Xd(a);this.connectionInfo=d;this.port=this.connectionInfo.port;var f=this;this.port.onMessage.addListener(function(d){if("Buffer"==d.type)f.elementReader.onReceivedData(g.isBuffer(d.data)?d.data:new g(d.data));else if(null!=f.onReceivedObject)f.onReceivedObject(d)});this.port.onDisconnect.addListener(function(){f.port=null;null!=c&&c()});b()};pc.prototype.sendObject=function(d){null==this.port?console.log("RuntimePortTransport connection is not established."):this.port.postMessage(d)};
pc.prototype.send=function(d){this.sendObject(d.toJSON())};var Xd=a.ElementReader,f=a.Log.LOG,wb=a.Transport,aa,Lb=function q(){wb.call(this);if(!WebSocket)throw Error("WebSocket support is not available on this platform.");this.elementReader=this.connectionInfo=this.ws=null;this.defaultGetConnectionInfo=aa.makeShuffledHostGetConnectionInfo("A.ws.ndn.ucla.edu B.ws.ndn.ucla.edu C.ws.ndn.ucla.edu D.ws.ndn.ucla.edu E.ws.ndn.ucla.edu F.ws.ndn.ucla.edu G.ws.ndn.ucla.edu H.ws.ndn.ucla.edu I.ws.ndn.ucla.edu J.ws.ndn.ucla.edu K.ws.ndn.ucla.edu L.ws.ndn.ucla.edu M.ws.ndn.ucla.edu N.ws.ndn.ucla.edu".split(" "),
9696,function(a,b){return new q.ConnectionInfo(a,b)})};Lb.prototype=new wb;Lb.prototype.name="WebSocketTransport";Lb.importFace=function(a){aa=a};r.WebSocketTransport=Lb;Lb.ConnectionInfo=function(a,b){wb.ConnectionInfo.call(this);this.host=a;this.port=void 0!==b?b:9696};Lb.ConnectionInfo.prototype=new wb.ConnectionInfo;Lb.ConnectionInfo.prototype.name="WebSocketTransport.ConnectionInfo";Lb.ConnectionInfo.prototype.equals=function(a){return null==a||void 0==a.host||void 0==a.port?!1:this.host==a.host&&
this.port==a.port};Lb.ConnectionInfo.prototype.toString=function(){return this.hostIsUri()?"{ uri: "+this.host+" }":"{ host: "+this.host+", port: "+this.port+" }"};Lb.ConnectionInfo.prototype.hostIsUri=function(){return"ws:"==this.host.substr(0,3)||"wss:"==this.host.substr(0,4)};Lb.prototype.isLocal=function(a,b,c){b(!1)};Lb.prototype.connect=function(a,b,c,l){this.close();var m=a.hostIsUri()?a.host:"ws://"+a.host+":"+a.port;this.ws=new WebSocket(m);0<f&&console.log("ws connection created.");this.connectionInfo=
a;this.ws.binaryType="arraybuffer";this.elementReader=new Xd(b);var n=this;this.ws.onmessage=function(a){a=a.data;if(null==a||void 0==a||""==a)console.log("INVALID ANSWER");else if(a instanceof ArrayBuffer){a=new g(new Uint8Array(a));3<f&&console.log("BINARY RESPONSE IS "+a.toString("hex"));try{n.elementReader.onReceivedData(a)}catch(b){console.log("NDN.ws.onmessage exception: "+b)}}};this.ws.onopen=function(a){3<f&&console.log(a);3<f&&console.log("ws.onopen: WebSocket connection opened.");3<f&&console.log("ws.onopen: ReadyState: "+
this.readyState);c()};this.ws.onerror=function(a){console.log("ws.onerror: ReadyState: "+this.readyState);console.log(a);console.log("ws.onerror: WebSocket error: "+a.data)};this.ws.onclose=function(a){console.log("ws.onclose: WebSocket connection closed.");n.ws=null;null!=l&&l()}};Lb.prototype.connectByFace=function(a,b){this.connect(a.connectionInfo,a,b,function(){a.closeByTransport()})};Lb.prototype.send=function(a){if(null!=this.ws){var b=new Uint8Array(a.length);b.set(a);this.ws.send(b.buffer);
3<f&&console.log("ws.send() returned.")}else console.log("WebSocket connection is not established.")};Lb.prototype.close=function(){null!=this.ws&&delete this.ws};r.TcpTransport=a.WebSocketTransport;var m=a.Blob,L=a.DataUtils,f=a.Log.LOG,S=a.DecodingException,c=function p(a){if("string"==typeof a)3<f&&console.log("Content Name String "+a),this.components=p.createNameArray(a);else if("object"===typeof a)if(this.components=[],a instanceof p)this.append(a);else for(var b=0;b<a.length;++b)this.append(a[b]);
else null==a?this.components=[]:1<f&&console.log("NO CONTENT NAME GIVEN");this.changeCount=0},ib={IMPLICIT_SHA256_DIGEST:1,PARAMETERS_SHA256_DIGEST:2,GENERIC:8,OTHER_CODE:32767};r.Name=c;r.ComponentType=ib;c.Component=function(a,b,f){if("object"===typeof a&&a instanceof c.Component)this.value_=a.value_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_;else{this.value_=a?"object"===typeof a&&"undefined"!==typeof ArrayBuffer&&a instanceof ArrayBuffer?new m(new g(new Uint8Array(a)),!1):"object"===
typeof a&&a instanceof m?a:new m(a):new m([]);if(b===ib.OTHER_CODE){if(void 0==f)throw Error("To use an other code, call Name.Component(value, ComponentType.OTHER_CODE, otherTypeCode)");if(0>f)throw Error("Name.Component other type code must be non-negative");this.otherTypeCode_=f}else this.otherTypeCode_=-1;this.type_=void 0==b?ib.GENERIC:b}};c.Component.prototype.getValue=function(){return this.value_};c.Component.prototype.getValueAsBuffer=function(){return this.value_.buf()};c.Component.prototype.getType=
function(){return this.type_};c.Component.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Object.defineProperty(c.Component.prototype,"value",{get:function(){return this.getValueAsBuffer()}});c.Component.prototype.toEscapedString=function(){return this.type_===ib.IMPLICIT_SHA256_DIGEST?"sha256digest="+this.value_.toHex():this.type_===ib.PARAMETERS_SHA256_DIGEST?"params-sha256="+this.value_.toHex():(this.type_===ib.GENERIC?"":(this.type_===ib.OTHER_CODE?this.otherTypeCode_:this.type_)+
"=")+c.toEscapedString(this.value_.buf())};c.Component.prototype.isSegment=function(){return 1<=this.value_.size()&&0==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isSegmentOffset=function(){return 1<=this.value_.size()&&251==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isVersion=function(){return 1<=this.value_.size()&&253==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isTimestamp=function(){return 1<=this.value_.size()&&252==this.value_.buf()[0]&&
this.isGeneric()};c.Component.prototype.isSequenceNumber=function(){return 1<=this.value_.size()&&254==this.value_.buf()[0]&&this.isGeneric()};c.Component.prototype.isGeneric=function(){return this.type_===ib.GENERIC};c.Component.prototype.isImplicitSha256Digest=function(){return this.type_===ib.IMPLICIT_SHA256_DIGEST};c.Component.prototype.isParametersSha256Digest=function(){return this.type_===ib.PARAMETERS_SHA256_DIGEST};c.Component.prototype.toNumber=function(){return L.bigEndianToUnsignedInt(this.value_.buf())};
c.Component.prototype.toNumberWithMarker=function(a){if(0==this.value_.size()||this.value_.buf()[0]!=a)throw Error("Name component does not begin with the expected marker");return L.bigEndianToUnsignedInt(this.value_.buf().slice(1))};c.Component.prototype.toSegment=function(){return this.toNumberWithMarker(0)};c.Component.prototype.toSegmentOffset=function(){return this.toNumberWithMarker(251)};c.Component.prototype.toVersion=function(){return this.toNumberWithMarker(253)};c.Component.prototype.toTimestamp=
function(){return this.toNumberWithMarker(252)};c.Component.prototype.toSequenceNumber=function(){return this.toNumberWithMarker(254)};c.Component.fromNumber=function(a,b,f){var g=new ra(8);g.writeNonNegativeInteger(a);return new c.Component(new m(g.getOutput(),!1),b,f)};c.Component.fromNumberWithMarker=function(a,b){var f=new ra(9);f.writeNonNegativeInteger(a);f.writeNonNegativeInteger(b);return new c.Component(new m(f.getOutput(),!1))};c.Component.fromSegment=function(a){return c.Component.fromNumberWithMarker(a,
0)};c.Component.fromSegmentOffset=function(a){return c.Component.fromNumberWithMarker(a,251)};c.Component.fromVersion=function(a){return c.Component.fromNumberWithMarker(a,253)};c.Component.fromTimestamp=function(a){return c.Component.fromNumberWithMarker(a,252)};c.Component.fromSequenceNumber=function(a){return c.Component.fromNumberWithMarker(a,254)};c.Component.fromImplicitSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof m?a:new m(a,!0);if(32!==digestBlob.size())throw new S("Name.Component.fromImplicitSha256Digest: The digest length must be 32 bytes");
a=new c.Component(digestBlob);a.type_=ib.IMPLICIT_SHA256_DIGEST;return a};c.Component.fromParametersSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof m?a:new m(a,!0);if(32!==digestBlob.size())throw new S("Name.Component.fromParametersSha256Digest: The digest length must be 32 bytes");a=new c.Component(digestBlob);a.type_=ib.PARAMETERS_SHA256_DIGEST;return a};c.Component.prototype.getSuccessor=function(){for(var a=new g(this.value_.size()+1),b=!0,f=this.value_.size()-1;0<=f;--f)b?
(a[f]=this.value_.buf()[f]+1&255,b=0===a[f]):a[f]=this.value_.buf()[f];b?a[a.length-1]=0:a=a.slice(0,this.value_.size());return new c.Component(new m(a,!1),this.type_,this.otherTypeCode_)};c.Component.prototype.equals=function(a){return"object"===typeof a&&a instanceof c.Component?this.type_===ib.OTHER_CODE?this.value_.equals(a.value_)&&a.type_===ib.OTHER_CODE&&this.otherTypeCode_==a.otherTypeCode_:this.value_.equals(a.value_)&&this.type_===a.type_:!1};c.Component.prototype.compare=function(a){var b=
this.type_===ib.OTHER_CODE?this.otherTypeCode_:this.type_,f=a.type_===ib.OTHER_CODE?a.otherTypeCode_:a.type_;return b<f?-1:b>f?1:c.Component.compareBuffers(this.value_.buf(),a.value_.buf())};c.Component.compareBuffers=function(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;for(var c=0;c<a.length;++c){if(a[c]<b[c])return-1;if(a[c]>b[c])return 1}return 0};c.prototype.getName=function(){return this.toUri()};c.createNameArray=function(a){a=a.trim();if(0>=a.length)return[];var b=a.indexOf(":");
if(0<=b){var f=a.indexOf("/");if(0>f||b<f)a=a.substr(b+1,a.length-b-1).trim()}if("/"==a[0])if(2<=a.length&&"/"==a[1]){b=a.indexOf("/",2);if(0>b)return[];a=a.substr(b+1,a.length-b-1).trim()}else a=a.substr(1,a.length-1).trim();b=a.split("/");for(f=0;f<b.length;++f){var l=b[f];if("sha256digest="==l.substr(0,13))l=l.substr(13).trim(),l=c.Component.fromImplicitSha256Digest(new m(new g(l,"hex")),!1);else if("params-sha256="==l.substr(0,14))l=l.substr(14).trim(),l=c.Component.fromParametersSha256Digest(new m(new g(l,
"hex")),!1);else{var n=ib.GENERIC,s=-1,r=l.indexOf("=");if(0<=r){n=l.substring(0,r);s=parseInt(n);if(isNaN(s))throw Error("Can't parse decimal Name Component type: "+n+" in URI "+a);n=s==ib.GENERIC||s==ib.IMPLICIT_SHA256_DIGEST||s==ib.PARAMETERS_SHA256_DIGEST?s:ib.OTHER_CODE;l=l.substring(r+1)}l=new c.Component(c.fromEscapedString(l),n,s)}l.getValue().isNull()?(b.splice(f,1),--f):b[f]=l}return b};c.prototype.set=function(a){this.components=c.createNameArray(a);++this.changeCount};c.prototype.append=
function(a,b,f){if("object"==typeof a&&a instanceof c)for(a=a==this?this.components.slice(0,this.components.length):a.components,b=0;b<a.length;++b)this.components.push(new c.Component(a[b]));else"object"===typeof a&&a instanceof c.Component?this.components.push(a):this.components.push(new c.Component(a,b,f));++this.changeCount;return this};c.prototype.add=function(a){return this.append(a)};c.prototype.clear=function(){this.components=[];++this.changeCount};c.prototype.toUri=function(a){if(0==this.size())return a?
"ndn:/":"/";a=a?"ndn:":"";for(var b=0;b<this.size();++b)a+="/"+this.components[b].toEscapedString();return a};c.prototype.to_uri=function(){return this.toUri()};c.prototype.toString=function(){return this.toUri()};c.prototype.appendSegment=function(a){return this.append(c.Component.fromSegment(a))};c.prototype.appendSegmentOffset=function(a){return this.append(c.Component.fromSegmentOffset(a))};c.prototype.appendVersion=function(a){return this.append(c.Component.fromVersion(a))};c.prototype.appendTimestamp=
function(a){return this.append(c.Component.fromTimestamp(a))};c.prototype.appendSequenceNumber=function(a){return this.append(c.Component.fromSequenceNumber(a))};c.prototype.appendImplicitSha256Digest=function(a){return this.append(c.Component.fromImplicitSha256Digest(a))};c.prototype.appendParametersSha256Digest=function(a){return this.append(c.Component.fromParametersSha256Digest(a))};c.prototype.addSegment=function(a){return this.appendSegment(a)};c.prototype.getSubName=function(a,b){0>a&&(a=this.components.length-
-a);void 0==b&&(b=this.components.length-a);for(var f=new c,g=a+b,l=a;l<g&&l<this.components.length;++l)f.components.push(this.components[l]);return f};c.prototype.getPrefix=function(a){return 0>a?this.getSubName(0,this.components.length+a):this.getSubName(0,a)};c.prototype.cut=function(a){return new c(this.components.slice(0,this.components.length-a))};c.prototype.size=function(){return this.components.length};c.prototype.get=function(a){if(0<=a){if(a>=this.components.length)throw Error("Name.get: Index is out of bounds");
return this.components[a]}if(a<-this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[this.components.length- -a]};c.prototype.getComponentCount=function(){return this.components.length};c.prototype.getComponent=function(a){return new g(this.components[a].getValue().buf())};c.prototype.indexOfFileName=function(){for(var a=this.size()-1;0<=a;--a){var b=this.components[a].getValue().buf();if(!(0>=b.length||0==b[0]||192==b[0]||193==b[0]||245<=b[0]&&255>=b[0]))return a}return-1};
c.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeName(this)};c.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeName(this,a.buf(),!1):b.decodeName(this,a,!0)};c.prototype.compare=function(a,b,f,g,l){a instanceof c&&(f=a,a=0,b=this.size());void 0==g&&(g=0);void 0==l&&(l=f.size());0>a&&(a=this.size()- -a);0>g&&(g=f.size()- -g);b=Math.min(b,this.size()-a);l=Math.min(l,f.size()-g);for(var m=Math.min(b,l),n=0;n<
m;++n){var s=this.components[a+n].compare(f.components[g+n]);if(0!=s)return s}return b<l?-1:b>l?1:0};c.prototype.equals=function(a){if(this.components.length!=a.components.length)return!1;for(var b=this.components.length-1;0<=b;--b)if(!this.components[b].equals(a.components[b]))return!1;return!0};c.prototype.equalsName=function(a){return this.equals(a)};c.prototype.getContentDigestValue=function(){for(var a=this.size()-1;0<=a;--a){var b=c.getComponentContentDigestValue(this.components[a]);if(null!=
b)return b}return null};c.getComponentContentDigestValue=function(a){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());return a.length==c.ContentDigestPrefix.length+32+c.ContentDigestSuffix.length&&L.arraysEqual(a.slice(0,c.ContentDigestPrefix.length),c.ContentDigestPrefix)&&L.arraysEqual(a.slice(a.length-c.ContentDigestSuffix.length,a.length),c.ContentDigestSuffix)?a.slice(c.ContentDigestPrefix.length,c.ContentDigestPrefix.length+32):null};c.ContentDigestPrefix=new g([193,46,77,
46,71,193,1,170,2,133]);c.ContentDigestSuffix=new g([0]);c.toEscapedString=function(a){"object"==typeof a&&a instanceof c.Component?a=a.getValue().buf():"object"===typeof a&&a instanceof m&&(a=a.buf());for(var b="",f=!1,g=0;g<a.length;++g)if(46!=a[g]){f=!0;break}if(f)for(g=0;g<a.length;++g)f=a[g],b=48<=f&&57>=f||65<=f&&90>=f||97<=f&&122>=f||43==f||45==f||46==f||95==f?b+String.fromCharCode(f):b+("%"+(16>f?"0":"")+f.toString(16).toUpperCase());else for(b="...",g=0;g<a.length;++g)b+=".";return b};c.fromEscapedString=
function(a){a=unescape(a.trim());return null==a.match(/[^.]/)?2>=a.length?new m:new m(L.toNumbersFromString(a.substr(3,a.length-3)),!1):new m(L.toNumbersFromString(a),!1)};c.fromEscapedStringAsBuffer=function(a){return c.fromEscapedString(a).buf()};c.prototype.getSuccessor=function(){return 0==this.size()?new c("/sha256digest=0000000000000000000000000000000000000000000000000000000000000000"):this.getPrefix(-1).append(this.get(-1).getSuccessor())};c.prototype.match=function(a){var b=this.components;
a=a.components;if(b.length>a.length)return!1;for(var c=b.length-1;0<=c;--c)if(!b[c].equals(a[c]))return!1;return!0};c.prototype.isPrefixOf=function(a){return this.match(a)};c.prototype.getChangeCount=function(){return this.changeCount};var ra=a.TlvEncoder,s=a.WireFormat,m=a.Blob,pa=a.ChangeCounter,c=a.Name,ua={KEYNAME:1,KEY_LOCATOR_DIGEST:2};r.KeyLocatorType=ua;var V=function rd(a,b){"object"===typeof a&&a instanceof rd?(this.type_=a.type_,this.keyName_=new pa(new c(a.getKeyName())),this.keyData_=
a.keyData_):(this.type_=b,this.keyName_=new pa(new c),this.keyData_=new m,b==ua.KEYNAME?this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c):b==ua.KEY_LOCATOR_DIGEST&&(this.keyData_=new m(a)));this.changeCount_=0};r.KeyLocator=V;V.prototype.getType=function(){return this.type_};V.prototype.getKeyName=function(){return this.keyName_.get()};V.prototype.getKeyData=function(){return this.keyData_};V.prototype.getKeyDataAsBuffer=function(){return this.getKeyData().buf()};V.prototype.setType=
function(a){this.type_=a;++this.changeCount_};V.prototype.setKeyName=function(a){this.keyName_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_};V.prototype.setKeyData=function(a){this.keyData_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};V.prototype.clear=function(){this.type_=null;this.keyName_.set(new c);this.keyData_=new m;++this.changeCount_};V.prototype.equals=function(a){if(this.type_!=a.type_)return!1;if(this.type_==ua.KEYNAME){if(!this.getKeyName().equals(a.getKeyName()))return!1}else if(this.type_==
ua.KEY_LOCATOR_DIGEST&&!this.getKeyData().equals(a.getKeyData()))return!1;return!0};V.canGetFromSignature=function(a){return a instanceof Ja||a instanceof Xa||a instanceof pb};V.getFromSignature=function(a){if(a instanceof Ja||a instanceof Xa||a instanceof pb)return a.getKeyLocator();throw Error("KeyLocator.getFromSignature: Signature type does not have a KeyLocator");};V.prototype.getChangeCount=function(){this.keyName_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(V.prototype,
"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(V.prototype,"keyData",{get:function(){return this.getKeyDataAsBuffer()},set:function(a){this.setKeyData(a)}});var Ja=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,pb=a.HmacWithSha256Signature,c=a.Name,Da={BLOB:0,LINK:1,KEY:2,NACK:3,OTHER_CODE:32767};r.ContentType=Da;var cb=function Xe(a,b,c,f,g,l){if(b)throw Error("MetaInfo constructor: timestamp support has been removed.");if(f)throw Error("MetaInfo constructor: locator support has been removed.");
if("object"===typeof a&&a instanceof Xe)this.publisher_=a.publisher_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_,this.freshnessPeriod_=a.freshnessPeriod_,this.finalBlockId_=a.finalBlockId_;else{if(a)throw Error("MetaInfo constructor: publisher support has been removed.");this.type=null==c||0>c?Da.BLOB:c;this.otherTypeCode_=-1;this.freshnessSeconds=g;this.setFinalBlockId(l)}this.changeCount_=0};r.MetaInfo=cb;cb.prototype.getType=function(){return this.type_};cb.prototype.getOtherTypeCode=
function(){return this.otherTypeCode_};cb.prototype.getFreshnessPeriod=function(){return this.freshnessPeriod_};cb.prototype.getFinalBlockId=function(){return this.finalBlockId_};cb.prototype.getFinalBlockID=function(){return this.getFinalBlockId()};cb.prototype.getFinalBlockIDAsBuffer=function(){return this.finalBlockId_.getValue().buf()};cb.prototype.setType=function(a){this.type_=null==a||0>a?Da.BLOB:a;++this.changeCount_};cb.prototype.setOtherTypeCode=function(a){if(0>a)throw Error("MetaInfo other type code must be non-negative");
this.otherTypeCode_=a;++this.changeCount_};cb.prototype.setFreshnessPeriod=function(a){this.freshnessPeriod_=null==a||0>a?null:a;++this.changeCount_};cb.prototype.setFinalBlockId=function(a){this.finalBlockId_="object"===typeof a&&a instanceof c.Component?a:new c.Component(a);++this.changeCount_};cb.prototype.setFinalBlockID=function(a){this.setFinalBlockId(a)};cb.prototype.clear=function(){this.type=Da.BLOB;this.otherTypeCode_=-1;this.freshnessSeconds=null;this.finalBlockId_=new c.Component;++this.changeCount_};
cb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(cb.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(cb.prototype,"freshnessSeconds",{get:function(){return null==this.freshnessPeriod_||0>this.freshnessPeriod_?null:this.freshnessPeriod_/1E3},set:function(a){this.freshnessPeriod_=null==a||0>a?null:1E3*a;++this.changeCount_}});Object.defineProperty(cb.prototype,"finalBlockID",{get:function(){return this.getFinalBlockIDAsBuffer()},
set:function(a){this.setFinalBlockId(a)}});var m=a.Blob,pa=a.ChangeCounter,V=a.KeyLocator,Ea=a.ValidityPeriod,Xa=function Ye(a){"object"===typeof a&&a instanceof Ye?(this.keyLocator_=new pa(new V(a.getKeyLocator())),this.validityPeriod_=new pa(new Ea(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new pa(new V),this.validityPeriod_=new pa(new Ea),this.signature_=new m);this.changeCount_=0};r.Sha256WithEcdsaSignature=Xa;Xa.prototype.clone=function(){return new Xa(this)};Xa.prototype.getKeyLocator=
function(){return this.keyLocator_.get()};Xa.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Xa.prototype.getSignature=function(){return this.signature_};Xa.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof V?new V(a):new V);++this.changeCount_};Xa.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof Ea?new Ea(a):new Ea);++this.changeCount_};Xa.prototype.setSignature=function(a){this.signature_=
"object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};Xa.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};m=a.Blob;pa=a.ChangeCounter;V=a.KeyLocator;Ea=a.ValidityPeriod;Ja=function Ze(a){"object"===typeof a&&a instanceof Ze?(this.keyLocator_=new pa(new V(a.getKeyLocator())),this.validityPeriod_=new pa(new Ea(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=
new pa(new V),this.validityPeriod_=new pa(new Ea),this.signature_=new m);this.changeCount_=0};r.Sha256WithRsaSignature=Ja;Ja.prototype.clone=function(){return new Ja(this)};Ja.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Ja.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Ja.prototype.getSignature=function(){return this.signature_};Ja.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Ja.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===
typeof a&&a instanceof V?new V(a):new V);++this.changeCount_};Ja.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof Ea?new Ea(a):new Ea);++this.changeCount_};Ja.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};Ja.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Object.defineProperty(Ja.prototype,
"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(Ja.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var m=a.Blob,bc=function $e(a){"object"===typeof a&&a instanceof $e?(this.signature_=a.signature_,this.signatureInfoEncoding_=a.signatureInfoEncoding_,this.typeCode_=a.typeCode_):(this.signature_=new m,this.signatureInfoEncoding_=new m,this.typeCode_=null);this.changeCount_=
0};r.GenericSignature=bc;bc.prototype.clone=function(){return new bc(this)};bc.prototype.getSignature=function(){return this.signature_};bc.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};bc.prototype.getSignatureInfoEncoding=function(){return this.signatureInfoEncoding_};bc.prototype.getTypeCode=function(){return this.typeCode_};bc.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};bc.prototype.setSignatureInfoEncoding=
function(a,b){this.signatureInfoEncoding_="object"===typeof a&&a instanceof m?a:new m(a);this.typeCode_=b;++this.changeCount_};bc.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(bc.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});m=a.Blob;pa=a.ChangeCounter;V=a.KeyLocator;pb=function df(a){"object"===typeof a&&a instanceof df?(this.keyLocator_=new pa(new V(a.getKeyLocator())),this.signature_=a.signature_):
(this.keyLocator_=new pa(new V),this.signature_=new m);this.changeCount_=0};r.HmacWithSha256Signature=pb;pb.prototype.clone=function(){return new pb(this)};pb.prototype.getKeyLocator=function(){return this.keyLocator_.get()};pb.prototype.getSignature=function(){return this.signature_};pb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};pb.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof V?new V(a):new V);++this.changeCount_};pb.prototype.setSignature=
function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};pb.prototype.getChangeCount=function(){this.keyLocator_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(pb.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(pb.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var m=a.Blob,xb=
function af(a){this.signature_="object"===typeof a&&a instanceof af?a.signature_:new m;this.changeCount_=0};r.DigestSha256Signature=xb;xb.prototype.clone=function(){return new xb(this)};xb.prototype.getSignature=function(){return this.signature_};xb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof m?a:new m(a);++this.changeCount_};xb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(xb.prototype,"signature",{get:function(){return this.getSignature()},
set:function(a){this.setSignature(a)}});var m=a.Blob,bb=a.SignedBlob,pa=a.ChangeCounter,c=a.Name,Ja=a.Sha256WithRsaSignature,cb=a.MetaInfo,Ec=a.IncomingFaceId,gd=a.CongestionMark,s=a.WireFormat,W=a,R=function bf(a,b,f){a instanceof bf?(this.name_=new pa(new c(a.getName())),this.metaInfo_=new pa(new cb(a.getMetaInfo())),this.signature_=new pa(a.getSignature().clone()),this.content_=a.content_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultFullName_=new c(a.defaultFullName_),this.defaultWireEncodingFormat_=
a.defaultWireEncodingFormat_):(this.name_="string"===typeof a?new pa(new c(a)):new pa("object"===typeof a&&a instanceof c?new c(a):new c),"object"===typeof b&&b instanceof cb?(a=b,b=f):a=null,this.metaInfo_=new pa("object"===typeof a&&a instanceof cb?new cb(a):new cb),this.content_="object"===typeof b&&b instanceof m?b:new m(b,!0),this.signature_=new pa(new Ja),this.defaultWireEncoding_=new bb,this.defaultFullName_=new c,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=
0;this.lpPacket_=null};r.Data=R;R.prototype.getName=function(){return this.name_.get()};R.prototype.getMetaInfo=function(){return this.metaInfo_.get()};R.prototype.getSignature=function(){return this.signature_.get()};R.prototype.getContent=function(){return this.content_};R.prototype.getContentAsBuffer=function(){return this.content_.buf()};R.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new bb,this.defaultWireEncodingFormat_=
null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};R.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};R.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:Ec.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};R.prototype.getCongestionMark=function(){var a=null===this.lpPacket_?null:gd.getFirstHeader(this.lpPacket_);return null===a?0:a.getCongestionMark()};R.prototype.getFullName=
function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&0<this.defaultFullName_.size()&&this.getDefaultWireEncodingFormat()==a)return this.defaultFullName_;var b=new c(this.getName()),f=W.createHash("sha256");f.update(this.wireEncode(a).buf());b.appendImplicitSha256Digest(new m(f.digest(),!1));a==s.getDefaultWireFormat()&&(this.defaultFullName_=b);return b};R.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;
return this};R.prototype.setMetaInfo=function(a){this.metaInfo_.set("object"===typeof a&&a instanceof cb?new cb(a):new cb);++this.changeCount_;return this};R.prototype.setSignature=function(a){this.signature_.set(null==a?new Ja:a.clone());++this.changeCount_;return this};R.prototype.setContent=function(a){this.content_="object"===typeof a&&a instanceof m?a:new m(a,!0);++this.changeCount_;return this};R.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&
this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeData(this),b=new bb(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==s.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,s.getDefaultWireFormat());return b};R.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof m?b.decodeData(this,a.buf(),!1):b.decodeData(this,a,!0);b==s.getDefaultWireFormat()?this.setDefaultWireEncoding(new bb(new m(a,
!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),s.getDefaultWireFormat()):this.setDefaultWireEncoding(new bb,null)};R.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};R.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.metaInfo_.checkChanged()||a;(a=this.signature_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};R.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=
this.getChangeCount()};Object.defineProperty(R.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(R.prototype,"metaInfo",{get:function(){return this.getMetaInfo()},set:function(a){this.setMetaInfo(a)}});Object.defineProperty(R.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});Object.defineProperty(R.prototype,"content",{get:function(){return this.getContentAsBuffer()},set:function(a){this.setContent(a)}});
x.prototype=Error();x.prototype.name="SecurityException";r.SecurityException=x;Mc.prototype=new x;Mc.prototype.name="UnrecognizedKeyFormatException";r.UnrecognizedKeyFormatException=Mc;E.prototype=new x;E.prototype.name="UnrecognizedDigestAlgorithmException";r.UnrecognizedDigestAlgorithmException=E;fc.prototype=Error();fc.prototype.name="InvalidArgumentException";r.InvalidArgumentException=fc;var ea=function(){};r.KeyType=ea;ea.RSA=0;ea.EC=1;ea.ECDSA=1;ea.AES=128;var hd=function(){};r.KeyClass=hd;
hd.PUBLIC=1;hd.PRIVATE=2;hd.SYMMETRIC=3;var Ga=function(){};r.DigestAlgorithm=Ga;Ga.SHA256=1;var W=a,D=a.Interest,s=a.WireFormat,ra=a.TlvEncoder,m=a.Blob,id=function(){this.lastUsedTimestamp_=Math.round((new Date).getTime());this.nowOffsetMilliseconds_=0};r.CommandInterestPreparer=id;id.prototype.prepareCommandInterestName=function(a,b){void 0==b&&s.getDefaultWireFormat();for(var c=(new Date).getTime()+this.nowOffsetMilliseconds_,c=Math.round(c);c<=this.lastUsedTimestamp_;)c+=1;this.lastUsedTimestamp_=
c;var f=new ra(8);f.writeNonNegativeInteger(c);a.getName().append(new m(f.getOutput(),!1));a.getName().append(new m(W.randomBytes(8),!1))};id.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};var D=a.Interest,s=a.WireFormat,Z=a.SigningInfo,id=a.CommandInterestPreparer,qc=function(a){id.call(this);this.keyChain_=a};qc.prototype=new id;qc.prototype.name="CommandInterestSigner";r.CommandInterestSigner=qc;qc.POS_SIGNATURE_VALUE=-1;qc.POS_SIGNATURE_INFO=-2;qc.POS_NONCE=-3;
qc.POS_TIMESTAMP=-4;qc.MINIMUM_SIZE=4;qc.prototype.makeCommandInterest=function(a,b,c,f,g){var l=b,m=c,n=f;b=l instanceof Z?l:void 0;c=l instanceof s?l:m instanceof s?m:void 0;"function"===typeof l?(f=l,g=m):"function"===typeof m?(f=m,g=n):"function"===typeof n?f=n:g=f=void 0;void 0==b&&(b=new Z);void 0==c&&(c=s.getDefaultWireFormat());a=new D(a);this.prepareCommandInterestName(a,c);return this.keyChain_.sign(a,b,c,f,g)};var yb=function(){};r.KeyIdType=yb;yb.USER_SPECIFIED=0;yb.SHA256=1;yb.RANDOM=
2;var c=a.Name,yb=a.KeyIdType,ea=a.KeyType,Mb=function(a,b){this.keyType_=a;if(b instanceof c.Component){if(0==b.getValue().size())throw Error("KeyParams: keyId is empty");this.keyIdType_=yb.USER_SPECIFIED;this.keyId_=b}else{if(b==yb.USER_SPECIFIED)throw Error("KeyParams: KeyIdType is USER_SPECIFIED");this.keyIdType_=b;this.keyId_=new c.Component}};r.KeyParams=Mb;Mb.prototype.getKeyType=function(){return this.keyType_};Mb.prototype.getKeyIdType=function(){return this.keyIdType_};Mb.prototype.getKeyId=
function(){return this.keyId_};Mb.prototype.setKeyId=function(a){this.keyId_=a};var cc=function fe(a,b){if(a instanceof c.Component)Mb.call(this,fe.getType(),a),this.size_=void 0==b?fe.getDefaultSize():b;else if(void 0!=a){var f=void 0!=b?b:yb.RANDOM;Mb.call(this,fe.getType(),f);this.size_=a}else Mb.call(this,fe.getType(),yb.RANDOM),this.size_=fe.getDefaultSize()};cc.prototype=new Mb;cc.prototype.name="RsaKeyParams";r.RsaKeyParams=cc;cc.prototype.getKeySize=function(){return this.size_};cc.getDefaultSize=
function(){return 2048};cc.getType=function(){return ea.RSA};var Rc=function ge(a,b){if(a instanceof c.Component)Mb.call(this,ge.getType(),a),this.size_=void 0==b?ge.getDefaultSize():b;else if(void 0!=a){var f=void 0!=b?b:yb.RANDOM;Mb.call(this,ge.getType(),f);this.size_=a}else Mb.call(this,ge.getType(),yb.RANDOM),this.size_=ge.getDefaultSize()};Rc.prototype=new Mb;Rc.prototype.name="EcKeyParams";r.EcKeyParams=Rc;Rc.prototype.getKeySize=function(){return this.size_};Rc.getDefaultSize=function(){return 256};
Rc.getType=function(){return ea.EC};var ie=function(a,b){Rc.call(this,a,b)};ie.prototype=new Rc;ie.prototype.name="EcdsaKeyParams";r.EcdsaKeyParams=ie;ie.getDefaultSize=function(){return Rc.getDefaultSize()};ie.getType=function(){return Rc.getType()};var wd=function he(a,b){if(a instanceof c.Component)Mb.call(this,he.getType(),a),this.size_=void 0==b?he.getDefaultSize():b;else if(void 0!=a){var f=void 0!=b?b:yb.RANDOM;Mb.call(this,he.getType(),f);this.size_=a}else Mb.call(this,he.getType(),yb.RANDOM),
this.size_=he.getDefaultSize()};wd.prototype=new Mb;wd.prototype.name="AesKeyParams";r.AesKeyParams=wd;wd.prototype.getKeySize=function(){return this.size_};wd.getDefaultSize=function(){return 64};wd.getType=function(){return ea.AES};var c=a.Name,R=a.Data,Da=a.ContentType,Ja=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,V=a.KeyLocator,ua=a.KeyLocatorType,s=a.WireFormat,Ga=a.DigestAlgorithm,ea=a.KeyType,Ea=a.ValidityPeriod,N=a.CertificateV2,b=a.SyncPromise,db=a.Tpm,dc=a.TpmBackEndMemory,m=
a.Blob,n=a.Tlv,ra=a.TlvEncoder,oa=a.TlvDecoder,fb=a.TlvWireFormat,Aa=a.PublicKey,Sc=function cf(a,b,f,g,B,v){a instanceof c?(void 0==B&&(B=Ga.SHA256),void 0==v&&(v=s.getDefaultWireFormat()),this.certificate_=cf.makeSelfSignedCertificate_(a,b,f,g,B,v),this.privateKeyBag_=b):a instanceof R?(this.certificate_=new R(a),this.privateKeyBag_=b):this.wireDecode(a)};r.SafeBag=Sc;Sc.prototype.getCertificate=function(){return this.certificate_};Sc.prototype.getPrivateKeyBag=function(){return this.privateKeyBag_};
Sc.prototype.wireDecode=function(a){"object"===typeof a&&a instanceof m&&(a=a.buf());a=new oa(a);var b=a.readNestedTlvsStart(n.SafeBag_SafeBag),c=a.getOffset(),f=a.readNestedTlvsStart(n.Data);a.seek(f);this.certificate_=new R;this.certificate_.wireDecode(a.getSlice(c,f),fb.get());this.privateKeyBag_=new m(a.readBlobTlv(n.SafeBag_EncryptedKeyBag),!0);a.finishNestedTlvs(b)};Sc.prototype.wireEncode=function(){var a=new ra(256),b=a.getLength();a.writeBlobTlv(n.SafeBag_EncryptedKeyBag,this.privateKeyBag_.buf());
a.writeBuffer(this.certificate_.wireEncode(fb.get()).buf());a.writeTypeAndLength(n.SafeBag_SafeBag,a.getLength()-b);return new m(a.getOutput(),!1)};Sc.makeSelfSignedCertificate_=function(a,f,g,l,m,B){var v=new N,w=(new Date).getTime(),nb=new c(a);nb.append("self").appendVersion(w);v.setName(nb);v.getMetaInfo().setType(Da.KEY);v.getMetaInfo().setFreshnessPeriod(36E5);nb=new Aa(g);v.setContent(nb.getKeyDer());g=new db("","",new dc);b.complete(null,g.importPrivateKeyPromise_(a,f.buf(),l,!0));if(nb.getKeyType()==
ea.RSA)v.setSignature(new Ja);else if(nb.getKeyType()==ea.EC)v.setSignature(new Xa);else throw Error("Unsupported key type");f=v.getSignature();V.getFromSignature(f).setType(ua.KEYNAME);V.getFromSignature(f).setKeyName(a);Ea.getFromSignature(f).setPeriod(w,w+63072E7);w=v.wireEncode(B);a=b.complete(null,g.signPromise(w.signedBuf(),a,m,!0));f.setSignature(a);v.wireEncode(B);return v};var c=a.Name,Sb=a.PibIdentity,qa=a.PibKey,Ga=a.DigestAlgorithm,Ea=a.ValidityPeriod,Z=function ye(a,b){this.validityPeriod_=
new Ea;if(void 0==a)this.reset(ye.SignerType.NULL),this.digestAlgorithm_=Ga.SHA256;else if(a instanceof ye)this.type_=a.type_,this.name_=new c(a.name_),this.identity_=a.identity_,this.key_=a.key_,this.digestAlgorithm_=a.digestAlgorithm_,this.validityPeriod_=new Ea(a.validityPeriod_);else if("number"===typeof a)this.reset(a),void 0!=b&&(this.name_=new c(b)),this.digestAlgorithm_=Ga.SHA256;else if(a instanceof Sb)this.digestAlgorithm_=Ga.SHA256,this.setPibIdentity(a);else if(a instanceof qa)this.digestAlgorithm_=
Ga.SHA256,this.setPibKey(a);else if("string"===typeof a){if(signingString=a,this.reset(ye.SignerType.NULL),this.digestAlgorithm_=Ga.SHA256,""!=signingString){var f=signingString.indexOf(":");if(0>f)throw Error("Invalid signing string cannot represent SigningInfo");var B=signingString.substring(0,f),f=signingString.substring(f+1);if("id"==B)f==ye.getDigestSha256Identity().toUri()?this.setSha256Signing():this.setSigningIdentity(new c(f));else if("key"==B)this.setSigningKeyName(new c(f));else if("cert"==
B)this.setSigningCertificateName(new c(f));else throw Error("Invalid signing string scheme");}}else throw Error("SigningInfo: Unrecognized type");};r.SigningInfo=Z;Z.SignerType=function(){};Z.SignerType.NULL=0;Z.SignerType.ID=1;Z.SignerType.KEY=2;Z.SignerType.CERT=3;Z.SignerType.SHA256=4;Z.prototype.setSigningIdentity=function(a){this.reset(Z.SignerType.ID);this.name_=new c(a);return this};Z.prototype.setSigningKeyName=function(a){this.reset(Z.SignerType.KEY);this.name_=new c(a);return this};Z.prototype.setSigningCertificateName=
function(a){this.reset(Z.SignerType.CERT);this.name_=new c(a);return this};Z.prototype.setSha256Signing=function(){this.reset(Z.SignerType.SHA256);this.digestAlgorithm_=Ga.SHA256;return this};Z.prototype.setPibIdentity=function(a){this.reset(Z.SignerType.ID);null!=a&&(this.name_=a.getName());this.identity_=a;return this};Z.prototype.setPibKey=function(a){this.reset(Z.SignerType.KEY);null!=a&&(this.name_=a.getName());this.key_=a;return this};Z.prototype.getSignerType=function(){return this.type_};
Z.prototype.getSignerName=function(){return this.name_};Z.prototype.getPibIdentity=function(){if(this.type_!=Z.SignerType.ID)throw Error("getPibIdentity: The signer type is not SignerType.ID");return this.identity_};Z.prototype.getPibKey=function(){if(this.type_!=Z.SignerType.KEY)throw Error("getPibKey: The signer type is not SignerType.KEY");return this.key_};Z.prototype.setDigestAlgorithm=function(a){this.digestAlgorithm_=a;return this};Z.prototype.getDigestAlgorithm=function(){return this.digestAlgorithm_};
Z.prototype.setValidityPeriod=function(a){this.validityPeriod_=new Ea(a);return this};Z.prototype.getValidityPeriod=function(){return this.validityPeriod_};Z.prototype.toString=function(){if(this.type_==Z.SignerType.NULL)return"";if(this.type_==Z.SignerType.ID)return"id:"+this.getSignerName().toUri();if(this.type_==Z.SignerType.KEY)return"key:"+this.getSignerName().toUri();if(this.type_==Z.SignerType.CERT)return"cert:"+this.getSignerName().toUri();if(this.type_==Z.SignerType.SHA256)return"id:"+Z.getDigestSha256Identity().toUri();
throw Error("Unknown signer type");};Z.getDigestSha256Identity=function(){return new c("/localhost/identity/digest-sha256")};Z.prototype.reset=function(a){if(a!=Z.SignerType.NULL&&a!=Z.SignerType.ID&&a!=Z.SignerType.KEY&&a!=Z.SignerType.CERT&&a!=Z.SignerType.SHA256)throw Error("SigningInfo: The signerType is not valid");this.type_=a;this.name_=new c;this.key_=this.identity_=null;this.validityPeriod_=new Ea};Ea=function ef(a,b){this.changeCount_=0;"object"===typeof a&&a instanceof ef?(validityPeriod=
a,this.notBefore_=validityPeriod.notBefore_,this.notAfter_=validityPeriod.notAfter_):void 0!=b?(notBefore=a,this.setPeriod(notBefore,b)):this.clear()};r.ValidityPeriod=Ea;Ea.prototype.hasPeriod=function(){return!(this.notBefore_===Number.MAX_VALUE&&this.notAfter_===-Number.MAX_VALUE)};Ea.prototype.getNotBefore=function(){return this.notBefore_};Ea.prototype.getNotAfter=function(){return this.notAfter_};Ea.prototype.clear=function(){this.notBefore_=Number.MAX_VALUE;this.notAfter_=-Number.MAX_VALUE;
++this.changeCount_};Ea.prototype.setPeriod=function(a,b){this.notBefore_=Math.round(1E3*Math.ceil(Math.round(a)/1E3));this.notAfter_=Math.round(1E3*Math.floor(Math.round(b)/1E3));++this.changeCount_;return this};Ea.prototype.isValid=function(a){void 0==a&&(a=Math.round(1E3*Math.ceil(Math.round((new Date).getTime())/1E3)));return this.notBefore_<=a&&a<=this.notAfter_};Ea.canGetFromSignature=function(a){return void 0!=a.constructor&&("Sha256WithRsaSignature"===a.constructor.name||"Sha256WithEcdsaSignature"===
a.constructor.name)};Ea.getFromSignature=function(a){if(void 0==a.constructor||"Sha256WithRsaSignature"!==a.constructor.name&&"Sha256WithEcdsaSignature"!==a.constructor.name)throw Error("ValidityPeriod.getFromSignature: Signature type does not have a ValidityPeriod");return a.getValidityPeriod()};Ea.prototype.getChangeCount=function(){return this.changeCount_};var W=a,b=a.SyncPromise,m=a.Blob,s=a.WireFormat,ea=a.KeyType,Ga=a.DigestAlgorithm,Hb=a.UseSubtleCrypto,N=a.CertificateV2,Aa=a.PublicKey,Sa=
function(){};r.VerificationHelpers=Sa;Sa.verifySignaturePromise=function(a,c,f,B,v){"boolean"===typeof B&&(v=B,B=void 0);a instanceof m&&(a=a.buf());c instanceof m&&(c=c.buf());if(!(f instanceof Aa))try{f instanceof m||(f=new m(f)),f=new Aa(f)}catch(w){return b.reject(Error("verifySignaturePromise: Error decoding public key DER: "+w))}void 0==B&&(B=Ga.SHA256);if(B==Ga.SHA256)if(f.getKeyType()==ea.RSA){if(Hb()&&!v){var nb={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};return crypto.subtle.importKey("spki",
f.getKeyDer().buf().buffer,nb,!0,["verify"]).then(function(B){return crypto.subtle.verify(nb,B,c,a)})}try{null===Sa.verifyUsesString_&&Sa.setVerifyUsesString_();for(var t=f.getKeyDer().buf().toString("base64"),y="-----BEGIN PUBLIC KEY-----\n",g=0;g<t.length;g+=64)y+=t.substr(g,64)+"\n";var y=y+"-----END PUBLIC KEY-----",ha=W.createVerify("RSA-SHA256");ha.update(a);var l=Sa.verifyUsesString_?c.toString("binary"):c;return b.resolve(ha.verify(y,l))}catch(n){return b.reject(Error("verifySignaturePromise: Error is RSA verify: "+
n))}}else if(f.getKeyType()==ea.EC)try{null===Sa.verifyUsesString_&&Sa.setVerifyUsesString_();t=f.getKeyDer().buf().toString("base64");y="-----BEGIN PUBLIC KEY-----\n";for(g=0;g<t.length;g+=64)y+=t.substr(g,64)+"\n";y+="-----END PUBLIC KEY-----";ha=W.createVerify("sha256");ha.update(a);l=Sa.verifyUsesString_?c.toString("binary"):c;return b.resolve(ha.verify(y,l))}catch(s){return b.reject(Error("verifySignaturePromise: Error is ECDSA verify: "+s))}else return b.reject(Error("verifySignaturePromise: Invalid key type"));
else return b.reject(Error("verifySignaturePromise: Invalid digest algorithm"))};Sa.verifySignature=function(a,c,f,B,v,w){"function"===typeof B&&(w=v,v=B,B=void 0);return b.complete(v,w,this.verifySignaturePromise(a,c,f,B,!v))};Sa.verifyDataSignaturePromise=function(a,c,f,B,v){var w=f,nb=B;f="number"===typeof w?w:void 0;B=w instanceof s?w:nb instanceof s?nb:void 0;v="boolean"===typeof w?w:"boolean"===typeof nb?nb:"boolean"===typeof v?v:!1;var t;if(c instanceof N)try{t=c.getPublicKey()}catch(y){return b.resolve(!1)}else t=
c;c=a.wireEncode(B);return Sa.verifySignaturePromise(c.signedBuf(),a.getSignature().getSignature(),t,f,v)};Sa.verifyInterestSignaturePromise=function(a,c,f,B,v){var w=f,nb=B;f="number"===typeof w?w:void 0;B=w instanceof s?w:nb instanceof s?nb:void 0;v="boolean"===typeof w?w:"boolean"===typeof nb?nb:"boolean"===typeof v?v:!1;var t;if(c instanceof N)try{t=c.getPublicKey()}catch(y){return b.resolve(!1)}else t=c;void 0==B&&(B=s.getDefaultWireFormat());c=Sa.extractSignature_(a,B);if(null==c)return b.resolve(!1);
a=a.wireEncode(B);return Sa.verifySignaturePromise(a.signedBuf(),c.getSignature(),t,f,v)};Sa.verifyDigest=function(a,b,c){a instanceof m&&(a=a.buf());b instanceof m&&(b=b.buf());if(c==Ga.SHA256){c=W.createHash("sha256");c.update(a);a=c.digest();if(b.length!=a.length)return!1;for(c=0;c<b.length;++c)if(b[c]!=a[c])return!1;return!0}throw Error("verifyDigest: Invalid digest algorithm");};Sa.extractSignature_=function(a,b){if(2>a.getName().size())return null;try{return b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf(),!1)}catch(c){return null}};Sa.verifyUsesString_=null;Sa.setVerifyUsesString_=function(){var a=W.createHash("sha256").digest();Sa.verifyUsesString_="string"===typeof a};var xd=a.constants,W=a,m=a.Blob,l=a.DerNode,x=a.SecurityException,Mc=a.UnrecognizedKeyFormatException,ea=a.KeyType,fa=a.EncryptAlgorithmType,b=a.SyncPromise,Hb=a.UseSubtleCrypto,Ga=a.DigestAlgorithm,Aa=function Se(a){if(a){this.keyDer=a;var B=null;try{var b=l.parse(a.buf(),0).getChildren(),B=l.getSequence(b,
0).getChildren()[0].toVal()}catch(w){throw new Mc(Error("PublicKey.decodeKeyType: Error decoding the public key: "+w.message));}B==Se.RSA_ENCRYPTION_OID?this.keyType=ea.RSA:B==Se.EC_ENCRYPTION_OID&&(this.keyType=ea.EC)}else this.keyDer=new m,this.keyType=null};r.PublicKey=Aa;Aa.prototype.toDer=function(){return l.parse(this.keyDer.buf())};Aa.prototype.getKeyType=function(){return this.keyType};Aa.prototype.getDigest=function(a){void 0==a&&(a=Ga.SHA256);if(a==Ga.SHA256)return a=W.createHash("sha256"),
a.update(this.keyDer.buf()),new m(a.digest(),!1);throw new x(Error("Wrong format!"));};Aa.prototype.getKeyDer=function(){return this.keyDer};Aa.prototype.encryptPromise=function(a,c,B){"object"===typeof a&&a instanceof m&&(a=a.buf());if(Hb()&&!B&&c!=fa.RsaPkcs)return c==fa.RsaOaep?this.keyType!=ea.RSA?Promise.reject(Error("The key type must be RSA")):crypto.subtle.importKey("spki",this.keyDer.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["encrypt"]).then(function(B){return crypto.subtle.encrypt({name:"RSA-OAEP"},
B,a)}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));var v=this.keyDer.buf().toString("base64");B="-----BEGIN PUBLIC KEY-----\n";for(var w=0;w<v.length;w+=64)B+=v.substr(w,64)+"\n";B+="-----END PUBLIC KEY-----";if(c==fa.RsaPkcs){if(this.keyType!=ea.RSA)return b.reject(Error("The key type must be RSA"));c=xd.RSA_PKCS1_PADDING}else if(c==fa.RsaOaep){if(this.keyType!=ea.RSA)return b.reject(Error("The key type must be RSA"));
c=xd.RSA_PKCS1_OAEP_PADDING}else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new m(W.publicEncrypt({key:B,padding:c},a),!1))}catch(f){return b.reject(f)}};Aa.prototype.encrypt=function(a,c){return b.getValue(this.encryptPromise(a,c,!0))};Aa.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Aa.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var l=a.DerNode,lb=a.OID,yd=function(a,b,B){this.extensionId="string"===typeof a?new lb(a):a;this.isCritical=b;this.extensionValue=B};r.CertificateExtension=
yd;yd.prototype.toDer=function(){var a=new l.DerSequence,b=new l.DerOid(this.extensionId),B=new l.DerBoolean(this.isCritical),v=new l.DerOctetString(this.extensionValue.buf());a.addChild(b);a.addChild(B);a.addChild(v);a.getSize();return a};yd.prototype.toDerBlob=function(){return this.toDer().encode()};yd.prototype.getOid=function(){return this.extensionId};yd.prototype.getIsCritical=function(){return this.isCritical};yd.prototype.getValue=function(){return this.extensionValue};var m=a.Blob,lb=a.OID,
l=a.DerNode,jd=function(a,b){this.oid="string"===typeof a?new lb(a):a;this.value=b};r.CertificateSubjectDescription=jd;jd.prototype.toDer=function(){var a=new l.DerSequence,b=new l.DerOid(this.oid),B=new l.DerPrintableString((new m(this.value)).buf());a.addChild(b);a.addChild(B);return a};jd.prototype.getOidString=function(){return this.oid.toString()};jd.prototype.getValue=function(){return this.value};var R=a.Data,Da=a.ContentType,s=a.WireFormat,l=a.DerNode,ea=a.KeyType,Aa=a.PublicKey,jd=a.CertificateSubjectDescription,
yd=a.CertificateExtension,Ba=function(a){void 0!=a?R.call(this,a):R.call(this);this.subjectDescriptionList=[];this.extensionList=[];this.notBefore=Number.MAX_VALUE;this.notAfter=-Number.MAX_VALUE;this.key=new Aa;void 0!=a&&this.decode()};Ba.prototype=new R;Ba.prototype.name="Certificate";r.Certificate=Ba;Ba.prototype.encode=function(){var a=this.toDer();this.setContent(a.encode());this.getMetaInfo().setType(Da.KEY)};Ba.prototype.addSubjectDescription=function(a){this.subjectDescriptionList.push(a)};
Ba.prototype.getSubjectDescriptionList=function(){return this.subjectDescriptionList};Ba.prototype.addExtension=function(a){this.extensionList.push(a)};Ba.prototype.getExtensionList=function(){return this.extensionList};Ba.prototype.setNotBefore=function(a){this.notBefore=a};Ba.prototype.getNotBefore=function(){return this.notBefore};Ba.prototype.setNotAfter=function(a){this.notAfter=a};Ba.prototype.getNotAfter=function(){return this.notAfter};Ba.prototype.setPublicKeyInfo=function(a){this.key=a};
Ba.prototype.getPublicKeyInfo=function(){return this.key};Ba.prototype.getPublicKeyDer=function(){if(this.key.getKeyDer().isNull())throw Error("The public key is not set");return this.key.getKeyDer()};Ba.prototype.isTooEarly=function(){return(new Date).getTime()<this.getNotBefore()};Ba.prototype.isTooLate=function(){return(new Date).getTime()>this.getNotAfter()};Ba.prototype.isInValidityPeriod=function(a){return this.getSignature().getValidityPeriod().isValid(a)};Ba.prototype.toDer=function(){var a=
new l.DerSequence,b=new l.DerSequence,B=new l.DerGeneralizedTime(this.getNotBefore()),v=new l.DerGeneralizedTime(this.getNotAfter());b.addChild(B);b.addChild(v);a.addChild(b);B=new l.DerSequence;for(b=0;b<this.subjectDescriptionList.length;++b)B.addChild(this.subjectDescriptionList[b].toDer());a.addChild(B);a.addChild(this.key.toDer());if(0<this.extensionList.length){B=new l.DerSequence;for(b=0;b<this.extensionList.length;++b)B.addChild(this.extensionList[b].toDer());a.addChild(B)}return a};Ba.prototype.decode=
function(){var a=l.parse(this.getContent().buf()).getChildren(),b=l.getSequence(a,0).getChildren();this.notBefore=b[0].toVal();this.notAfter=b[1].toVal();for(var B=l.getSequence(a,1).getChildren(),b=0;b<B.length;++b){var v=l.getSequence(B,b).getChildren(),w=v[0].toVal(),v=v[1].toVal().buf().toString("binary");this.addSubjectDescription(new jd(w,v))}b=a[2].encode();this.key=new Aa(b);if(3<a.length)for(a=l.getSequence(a,3).getChildren(),b=0;b<a.length;++b)v=l.getSequence(a,b).getChildren(),w=v[0].toVal(),
B=v[1].toVal(),v=v[2].toVal(),this.addExtension(new yd(w,B,v))};Ba.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();R.prototype.wireDecode.call(this,a,b);this.decode()};Ba.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";var b=Ba.toIsoString(Math.round(this.getNotBefore())),B=Ba.toIsoString(Math.round(this.getNotAfter()));a=a+("  NotBefore: "+b+"\n")+("  NotAfter: "+B+"\n");for(b=0;b<this.subjectDescriptionList.length;++b)B=
this.subjectDescriptionList[b],a+="Subject Description:\n",a+="  "+B.getOidString()+": "+B.getValue()+"\n";a+="Public key bits:\n";B=this.getPublicKeyDer().buf().toString("base64");for(b=0;b<B.length;b+=64)a+=B.substring(b,Math.min(b+64,B.length))+"\n";if(0<this.extensionList.length)for(a+="Extensions:\n",b=0;b<this.extensionList.length;++b)B=this.extensionList[b],a+="  OID: "+B.getOid()+"\n",a+="  Is critical: "+(B.getIsCritical()?"Y":"N")+"\n",a+="  Value: "+B.getValue().toHex()+"\n";return a};
Ba.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+Ba.to2DigitString(a.getUTCMonth()+1)+Ba.to2DigitString(a.getUTCDate())+"T"+Ba.to2DigitString(a.getUTCHours())+Ba.to2DigitString(a.getUTCMinutes())+Ba.to2DigitString(a.getUTCSeconds())};Ba.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};var R=a.Data,c=a.Name,x=a.SecurityException,Ba=a.Certificate,s=a.WireFormat,Na=function Te(a){void 0!=a?Ba.call(this,a):Ba.call(this);this.publicKeyName=new c;if(a instanceof
Te)this.publicKeyName=new c(a.publicKeyName);else if(a instanceof R){if(!Te.isCorrectName(a.getName()))throw new x(Error("Wrong Identity Certificate Name!"));this.setPublicKeyName()}};Na.prototype=new Ba;Na.prototype.name="IdentityCertificate";r.IdentityCertificate=Na;Na.prototype.setName=function(a){if(!Na.isCorrectName(a))throw new x(Error("Wrong Identity Certificate Name!"));Ba.prototype.setName.call(this,a);this.setPublicKeyName();return this};Na.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();
Ba.prototype.wireDecode.call(this,a,b);this.setPublicKeyName()};Na.prototype.getPublicKeyName=function(){return this.publicKeyName};Na.isIdentityCertificate=function(a){return Na.isCorrectName(a.getName())};Na.certificateNameToPublicKeyName=function(a){for(var b=!1,v=a.size()-1;0<v+1;--v)if("ID-CERT"==a.get(v).toEscapedString()){b=!0;break}if(!b)throw Error("Incorrect identity certificate name "+a.toUri());for(var b=a.getSubName(0,v),v=!1,w=0;w<b.size();w++)if("KEY"==b.get(w).toEscapedString()){v=
!0;break}if(!v)throw Error("Incorrect identity certificate name "+a.toUri());return b.getSubName(0,w).append(b.getSubName(w+1,b.size()-w-1))};Na.isCorrectName=function(a){for(var b=a.size()-1;0<=b&&"ID-CERT"!=a.get(b).toEscapedString();b--);if(0>b)return!1;for(b=0;b<a.size()&&"KEY"!=a.get(b).toEscapedString();b++);return b>=a.size()?!1:!0};Na.prototype.setPublicKeyName=function(){this.publicKeyName=Na.certificateNameToPublicKeyName(this.getName())};var c=a.Name,x=a.SecurityException,b=a.SyncPromise,
ba=function(){};r.IdentityStorage=ba;ba.prototype.doesIdentityExistPromise=function(a,B){return b.reject(Error("IdentityStorage.doesIdentityExistPromise is not implemented"))};ba.prototype.doesIdentityExist=function(a){return b.getValue(this.doesIdentityExistPromise(a,!0))};ba.prototype.addIdentityPromise=function(a,B){return b.reject(Error("IdentityStorage.addIdentityPromise is not implemented"))};ba.prototype.addIdentity=function(a){return b.getValue(this.addIdentityPromise(a,!0))};ba.prototype.revokeIdentity=
function(){return b.reject(Error("IdentityStorage.revokeIdentity is not implemented"))};ba.prototype.getNewKeyNamePromise=function(a,B,v){for(var w=Math.floor((new Date).getTime()/1E3);w<=ba.lastTimestamp;)w+=1;ba.lastTimestamp=w;w=""+w;B=B?"ksk-"+w:"dsk-"+w;var f=(new c(a)).append(B);return this.doesKeyExistPromise(f,v).then(function(a){if(a)throw new x(Error("Key name already exists"));return b.resolve(f)})};ba.prototype.getNewKeyName=function(a,B){return b.getValue(this.getNewKeyNamePromise(a,
B,!0))};ba.prototype.doesKeyExistPromise=function(a,B){return b.reject(Error("IdentityStorage.doesKeyExistPromise is not implemented"))};ba.prototype.doesKeyExist=function(a){return b.getValue(this.doesKeyExistPromise(a,!0))};ba.prototype.addKeyPromise=function(a,B,v,w){return b.reject(Error("IdentityStorage.addKeyPromise is not implemented"))};ba.prototype.addKey=function(a,B,v){return b.getValue(this.addKeyPromise(a,B,v,!0))};ba.prototype.getKeyPromise=function(a,B){return b.reject(Error("IdentityStorage.getKeyPromise is not implemented"))};
ba.prototype.getKey=function(a){return b.getValue(this.getKeyPromise(a,!0))};ba.prototype.activateKey=function(a){throw Error("IdentityStorage.activateKey is not implemented");};ba.prototype.deactivateKey=function(a){throw Error("IdentityStorage.deactivateKey is not implemented");};ba.prototype.doesCertificateExistPromise=function(a,B){return b.reject(Error("IdentityStorage.doesCertificateExistPromise is not implemented"))};ba.prototype.doesCertificateExist=function(a){return b.getValue(this.doesCertificateExistPromise(a,
!0))};ba.prototype.addCertificatePromise=function(a,B){return b.reject(Error("IdentityStorage.addCertificatePromise is not implemented"))};ba.prototype.addCertificate=function(a){return b.getValue(this.addCertificatePromise(a,!0))};ba.prototype.getCertificatePromise=function(a,B){return b.reject(Error("IdentityStorage.getCertificatePromise is not implemented"))};ba.prototype.getCertificate=function(a){return b.getValue(this.getValuePromise(a,!0))};ba.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("IdentityStorage.getTpmLocatorPromise is not implemented"))};
ba.prototype.getTpmLocator=function(){return b.getValue(this.getTpmLocatorPromise(!0))};ba.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("IdentityStorage.getDefaultIdentityPromise is not implemented"))};ba.prototype.getDefaultIdentity=function(){return b.getValue(this.getDefaultIdentityPromise(!0))};ba.prototype.getDefaultKeyNameForIdentityPromise=function(a,B){return b.reject(Error("IdentityStorage.getDefaultKeyNameForIdentityPromise is not implemented"))};ba.prototype.getDefaultKeyNameForIdentity=
function(a){return b.getValue(this.getDefaultKeyNameForIdentityPromise(a,!0))};ba.prototype.getDefaultCertificateNameForIdentityPromise=function(a,b){var v=this;return this.getDefaultKeyNameForIdentityPromise(a).then(function(a){return v.getDefaultCertificateNameForKeyPromise(a)})};ba.prototype.getDefaultCertificateNameForIdentity=function(a){return b.getValue(this.getDefaultCertificateNameForIdentityPromise(a,!0))};ba.prototype.getDefaultCertificateNameForKeyPromise=function(a,B){return b.reject(Error("IdentityStorage.getDefaultCertificateNameForKeyPromise is not implemented"))};
ba.prototype.getDefaultCertificateNameForKey=function(a){return b.getValue(this.getDefaultCertificateNameForKeyPromise(a,!0))};ba.prototype.getAllIdentitiesPromise=function(a,B,v){return b.reject(Error("IdentityStorage.getAllIdentitiesPromise is not implemented"))};ba.prototype.getAllKeyNamesOfIdentityPromise=function(a,B,v,w){return b.reject(Error("IdentityStorage.getAllKeyNamesOfIdentityPromise is not implemented"))};ba.prototype.getAllCertificateNamesOfKeyPromise=function(a,B,v,w){return b.reject(Error("IdentityStorage.getAllCertificateNamesOfKeyPromise is not implemented"))};
ba.prototype.getAllKeyNamesOfIdentity=function(a,B,v){return b.getValue(this.getAllKeyNamesOfIdentityPromise(a,B,v,!0))};ba.prototype.setDefaultIdentityPromise=function(a,B){return b.reject(Error("IdentityStorage.setDefaultIdentityPromise is not implemented"))};ba.prototype.setDefaultIdentity=function(a){return b.getValue(this.setDefaultIdentityPromise(a,!0))};ba.prototype.setDefaultKeyNameForIdentityPromise=function(a,B,v){return b.reject(Error("IdentityStorage.setDefaultKeyNameForIdentityPromise is not implemented"))};
ba.prototype.setDefaultKeyNameForIdentity=function(a,B){return b.getValue(this.setDefaultKeyNameForIdentityPromise(a,B,!0))};ba.prototype.setDefaultCertificateNameForKeyPromise=function(a,B,v){return b.reject(Error("IdentityStorage.setDefaultCertificateNameForKeyPromise is not implemented"))};ba.prototype.setDefaultCertificateNameForKey=function(a,B){return b.getValue(this.setDefaultCertificateNameForKeyPromise(a,B,!0))};ba.prototype.getDefaultCertificatePromise=function(a){var B=this;return this.getDefaultIdentityPromise(a).then(function(b){return B.getDefaultCertificateNameForIdentityPromise(b,
a)},function(a){return b.resolve(null)}).then(function(v){return null==v?b.resolve(null):B.getCertificatePromise(v,a)})};ba.prototype.getDefaultCertificate=function(){return b.getValue(this.getDefaultCertificatePromise(!0))};ba.prototype.deleteCertificateInfoPromise=function(a,B){return b.reject(Error("IdentityStorage.deleteCertificateInfoPromise is not implemented"))};ba.prototype.deleteCertificateInfo=function(a){return b.getValue(this.deleteCertificateInfoPromise(a,!0))};ba.prototype.deletePublicKeyInfoPromise=
function(a,B){return b.reject(Error("IdentityStorage.deletePublicKeyInfoPromise is not implemented"))};ba.prototype.deletePublicKeyInfo=function(a){return b.getValue(this.deletePublicKeyInfoPromise(a,!0))};ba.prototype.deleteIdentityInfoPromise=function(a,B){return b.reject(Error("IdentityStorage.deleteIdentityInfoPromise is not implemented"))};ba.prototype.deleteIdentityInfo=function(a){return b.getValue(this.deleteIdentityInfoPromise(a,!0))};ba.lastTimestamp=Math.floor((new Date).getTime()/1E3);
new ba;var c=a.Name,m=a.Blob,x=a.SecurityException,Na=a.IdentityCertificate,b=a.SyncPromise,ba=a.IdentityStorage,zb=function(){ba.call(this);this.identityStore={};this.defaultIdentity="";this.keyStore={};this.certificateStore={}};zb.prototype=new ba;zb.prototype.name="MemoryIdentityStorage";r.MemoryIdentityStorage=zb;zb.prototype.doesIdentityExistPromise=function(a){return b.resolve(void 0!==this.identityStore[a.toUri()])};zb.prototype.addIdentityPromise=function(a){a=a.toUri();void 0===this.identityStore[a]&&
(this.identityStore[a]={defaultKey:null});return b.resolve()};zb.prototype.doesKeyExistPromise=function(a){return b.resolve(void 0!==this.keyStore[a.toUri()])};zb.prototype.addKeyPromise=function(a,B,v){if(0===a.size()||this.doesKeyExist(a))return b.resolve();var w=a.getSubName(0,a.size()-1);this.addIdentity(w);this.keyStore[a.toUri()]={keyType:B,keyDer:new m(v),defaultCertificate:null};return b.resolve()};zb.prototype.getKeyPromise=function(a){if(0===a.size())return b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: Empty keyName")));
a=a.toUri();a=this.keyStore[a];return void 0===a?b.reject(new x(Error("MemoryIdentityStorage.getKeyPromise: The key does not exist"))):b.resolve(a.keyDer)};zb.prototype.doesCertificateExistPromise=function(a){return b.resolve(void 0!==this.certificateStore[a.toUri()])};zb.prototype.addCertificatePromise=function(a){var B=a.getName(),v=a.getPublicKeyName();this.addKey(v,a.getPublicKeyInfo().getKeyType(),a.getPublicKeyInfo().getKeyDer());if(this.doesCertificateExist(B))return b.resolve();this.certificateStore[B.toUri()]=
a.wireEncode();return b.resolve()};zb.prototype.getCertificatePromise=function(a){a=a.toUri();if(void 0===this.certificateStore[a])return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate does not exist")));var B=new Na;try{B.wireDecode(this.certificateStore[a])}catch(v){return b.reject(new x(Error("MemoryIdentityStorage.getCertificatePromise: The certificate cannot be decoded")))}return b.resolve(B)};ba.prototype.getTpmLocatorPromise=function(a){return b.resolve("tpm-memory:")};
zb.prototype.getDefaultIdentityPromise=function(){return 0===this.defaultIdentity.length?b.reject(new x(Error("MemoryIdentityStorage.getDefaultIdentity: The default identity is not defined"))):b.resolve(new c(this.defaultIdentity))};zb.prototype.getDefaultKeyNameForIdentityPromise=function(a){a=a.toUri();return void 0!==this.identityStore[a]?null!=this.identityStore[a].defaultKey?b.resolve(this.identityStore[a].defaultKey):b.reject(new x(Error("No default key set."))):b.reject(new x(Error("Identity not found.")))};
zb.prototype.getDefaultCertificateNameForKeyPromise=function(a){a=a.toUri();return void 0!==this.keyStore[a]?null!=this.keyStore[a].defaultCertificate?b.resolve(this.keyStore[a].defaultCertificate):b.reject(new x(Error("No default certificate set."))):b.reject(new x(Error("Key not found.")))};zb.prototype.setDefaultIdentityPromise=function(a){a=a.toUri();this.defaultIdentity=void 0!==this.identityStore[a]?a:"";return b.resolve()};zb.prototype.setDefaultKeyNameForIdentityPromise=function(a,B){B=B instanceof
c?B:null;var v=a.getPrefix(-1);if(null!=B&&0<B.size()&&!B.equals(v))return b.reject(new x(Error("The specified identity name does not match the key name")));v=v.toUri();void 0!==this.identityStore[v]&&(this.identityStore[v].defaultKey=new c(a));return b.resolve()};zb.prototype.setDefaultCertificateNameForKeyPromise=function(a,B){var v=a.toUri();void 0!==this.keyStore[v]&&(this.keyStore[v].defaultCertificate=new c(B));return b.resolve()};zb.prototype.deleteCertificateInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteCertificateInfoPromise is not implemented"))};
zb.prototype.deletePublicKeyInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deletePublicKeyInfoPromise is not implemented"))};zb.prototype.deleteIdentityInfoPromise=function(a){return b.reject(Error("MemoryIdentityStorage.deleteIdentityInfoPromise is not implemented"))};var b=a.SyncPromise,l=a.DerNode,sa=function(){};r.PrivateKeyStorage=sa;sa.prototype.generateKeyPairPromise=function(a,B,v){return b.reject(Error("PrivateKeyStorage.generateKeyPairPromise is not implemented"))};
sa.prototype.generateKeyPair=function(a,B){b.getValue(this.generateKeyPairPromise(a,B,!0))};sa.prototype.deleteKeyPairPromise=function(a,B){return b.reject(Error("PrivateKeyStorage.deleteKeyPairPromise is not implemented"))};sa.prototype.deleteKeyPair=function(a){b.getValue(this.deleteKeyPairPromise(a,!0))};sa.prototype.getPublicKeyPromise=function(a,B){return b.reject(Error("PrivateKeyStorage.getPublicKeyPromise is not implemented"))};sa.prototype.getPublicKey=function(a){return b.getValue(this.getPublicKeyPromise(a,
!0))};sa.prototype.signPromise=function(a,B,v,w){return b.reject(Error("PrivateKeyStorage.sign is not implemented"))};sa.prototype.sign=function(a,B,v){return b.getValue(this.signPromise(a,B,v,!0))};sa.prototype.decrypt=function(a,b,v){throw Error("PrivateKeyStorage.decrypt is not implemented");};sa.prototype.encrypt=function(a,b,v){throw Error("PrivateKeyStorage.encrypt is not implemented");};sa.prototype.generateKey=function(a,b){throw Error("PrivateKeyStorage.generateKey is not implemented");};
sa.prototype.doesKeyExistPromise=function(a,B,v){return b.reject(Error("PrivateKeyStorage.doesKeyExist is not implemented"))};sa.prototype.doesKeyExist=function(a,B){return b.getValue(this.doesKeyExistPromise(a,B,!0))};sa.encodePkcs8PrivateKey=function(a,b,v){var w=new l.DerSequence;w.addChild(new l.DerOid(b));w.addChild(v);b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(w);b.addChild(new l.DerOctetString(a));return b.encode()};sa.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new l.DerSequence;
b.addChild(new l.DerInteger(0));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.d)));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.p)));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.q)));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.dmp1)));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.dmq1)));b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.coeff)));return b.encode()};sa.encodePublicKeyFromRSAKey=
function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(sa.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));a=new l.DerSequence;a.addChild(new l.DerOid(new lb(sa.RSA_ENCRYPTION_OID)));a.addChild(new l.DerNull);var v=new l.DerSequence;v.addChild(a);v.addChild(new l.DerBitString(b.encode().buf(),0));return v.encode()};sa.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("PrivateKeyStorage.bigIntegerToBuffer: Negative integers are not currently supported");
1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new g(a,"hex")};sa.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";sa.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var W=a,m=a.Blob,x=a.SecurityException,Aa=a.PublicKey,hd=a.KeyClass,ea=a.KeyType,Ga=a.DigestAlgorithm,L=a.DataUtils,sa=a.PrivateKeyStorage,l=a.DerNode,lb=a.OID,b=a.SyncPromise,Hb=a.UseSubtleCrypto,Fc=null;try{Fc=a}catch(lf){}var Gc=function(){sa.call(this);this.publicKeyStore={};this.privateKeyStore={}};Gc.prototype=new sa;Gc.prototype.name=
"MemoryPrivateKeyStorage";r.MemoryPrivateKeyStorage=Gc;Gc.prototype.setPublicKeyForKeyName=function(a,b,v){this.publicKeyStore[a.toUri()]=new Aa(new m(v,!0))};Gc.prototype.setPrivateKeyForKeyName=function(a,b,v){v=v.toString("base64");var w;if(b===ea.RSA){w="-----BEGIN RSA PRIVATE KEY-----\n";for(var c=0;c<v.length;c+=64)w+=v.substr(c,64)+"\n";w+="-----END RSA PRIVATE KEY-----"}else if(b===ea.EC){w="-----BEGIN EC PRIVATE KEY-----\n";for(c=0;c<v.length;c+=64)w+=v.substr(c,64)+"\n";w+="-----END EC PRIVATE KEY-----"}else throw new x(Error("MemoryPrivateKeyStorage: KeyType is not supported"));
this.privateKeyStore[a.toUri()]={keyType:b,privateKey:w}};Gc.prototype.setKeyPairForKeyName=function(a,b,v,w){this.setPublicKeyForKeyName(a,b,v);this.setPrivateKeyForKeyName(a,b,w)};Gc.prototype.generateKeyPairPromise=function(a,B,v){if(this.doesKeyExist(a,hd.PUBLIC))return b.reject(new x(Error("Public key already exists")));if(this.doesKeyExist(a,hd.PRIVATE))return b.reject(new x(Error("Private key already exists")));var w=this;if(Hb()&&!v){if(B.getKeyType()===ea.RSA){var c=null,t=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",
modulusLength:B.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){c=a.privateKey;return crypto.subtle.exportKey("spki",a.publicKey)}).then(function(a){t=(new m(new Uint8Array(a),!1)).buf();return crypto.subtle.exportKey("pkcs8",c)}).then(function(b){b=l.parse((new m(new Uint8Array(b),!1)).buf()).getChildren()[2].toVal();w.setKeyPairForKeyName(a,B.getKeyType(),t,b.buf());w.privateKeyStore[a.toUri()].subtleKey=c;return Promise.resolve()})}return b.reject(new x(Error("Only RSA key generation currently supported")))}return b.resolve().then(function(){if("undefined"!==
typeof A)if(B.getKeyType()===ea.RSA){var v=new A;v.generate(B.getKeySize(),"010001");w.setKeyPairForKeyName(a,B.getKeyType(),sa.encodePublicKeyFromRSAKey(v).buf(),sa.encodePkcs1PrivateKeyFromRSAKey(v).buf())}else return b.reject(new x(Error("Only RSA key generation currently supported")));else{var c;if(B.getKeyType()===ea.RSA){if(!Fc)return b.reject(new x(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));c=Fc.generate(B.getKeySize());v=c.publicKey.toString().replace("-----BEGIN PUBLIC KEY-----",
"").replace("-----END PUBLIC KEY-----","");v=new g(v,"base64");c=c.privateKey.toString()}else return b.reject(new x(Error("Only RSA key generation currently supported")));w.setPublicKeyForKeyName(a,B.getKeyType(),v);w.privateKeyStore[a.toUri()]={keyType:B.getKeyType(),privateKey:c}}return b.resolve()})};Gc.prototype.deleteKeyPairPromise=function(a){a=a.toUri();delete this.publicKeyStore[a];delete this.privateKeyStore[a];return b.resolve()};Gc.prototype.getPublicKeyPromise=function(a){var B=a.toUri(),
B=this.publicKeyStore[B];return void 0===B?b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find public key "+a.toUri()))):b.resolve(B)};Gc.prototype.signPromise=function(a,B,v,w){w="boolean"===typeof v?v:w;v="boolean"!==typeof v&&v?v:Ga.SHA256;if(v!=Ga.SHA256)return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unsupported digest algorithm")));B=B.toUri();var c=this.privateKeyStore[B];if(void 0===c)return b.reject(new x(Error("MemoryPrivateKeyStorage: Cannot find private key "+B)));if(Hb()&&
!w){var t={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};c.subtleKey?w=crypto.subtle.sign(t,c.subtleKey,a):(w=L.privateKeyPemToDer(c.privateKey),w=sa.encodePkcs8PrivateKey(w,new lb(sa.RSA_ENCRYPTION_OID),new l.DerNull).buf(),w=crypto.subtle.importKey("pkcs8",w.buffer,t,!0,["sign"]).then(function(b){c.subtleKey=b;return crypto.subtle.sign(t,b,a)}));return w.then(function(a){a=new m(new Uint8Array(a),!0);return Promise.resolve(a)})}if(c.keyType===ea.RSA)w=W.createSign("RSA-SHA256");else if(c.keyType===
ea.EC)w=W.createSign("sha256");else return b.reject(new x(Error("MemoryPrivateKeyStorage.sign: Unrecognized private key type")));w.update(a);w=new g(L.toNumbersIfString(w.sign(c.privateKey)));w=new m(w,!1);return b.resolve(w)};Gc.prototype.doesKeyExistPromise=function(a,B){var v=a.toUri(),w=!1;B==hd.PUBLIC?w=void 0!==this.publicKeyStore[v]:B==hd.PRIVATE&&(w=void 0!==this.privateKeyStore[v]);return b.resolve(w)};W=a;new sa;var W=a,c=a.Name,R=a.Data,m=a.Blob,zd=a.ConfigFile,xb=a.DigestSha256Signature,
Ja=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,ua=a.KeyLocatorType,s=a.WireFormat,x=a.SecurityException,Ga=a.DigestAlgorithm,ea=a.KeyType,cc=a.RsaKeyParams,Na=a.IdentityCertificate,Aa=a.PublicKey,jd=a.CertificateSubjectDescription,b=a.SyncPromise,Me=a.BasicIdentityStorage,We=a.FilePrivateKeyStorage,ka=function B(a,b){if(b){if(!a)throw Error("IdentityManager: A custom privateKeyStorage is supplied with a null identityStorage");this.identityStorage=a;this.privateKeyStorage=b}else{if(!zd)throw new x(Error("IdentityManager: If not in Node.js then you must supply identityStorage and privateKeyStorage."));
var c=new zd,t=[null],f=this;this.identityStorage=a?a:B.getDefaultIdentityStorage_(c,function(){return f.checkTpmPromise_(t[0])});this.privateKeyStorage=B.getDefaultPrivateKeyStorage_(c,t)}};r.IdentityManager=ka;ka.prototype.createIdentityAndCertificatePromise=function(a,v,w){var c=this,t=!0,f=null;return this.identityStorage.addIdentityPromise(a,w).then(function(){return c.identityStorage.getDefaultKeyNameForIdentityPromise(a,w).then(function(a){f=a;return c.identityStorage.getKeyPromise(f,w).then(function(a){(new Aa(a)).getKeyType()==
v.getKeyType()&&(t=!1);return b.resolve()})},function(a){if(!(a instanceof x))throw a;return b.resolve()})}).then(function(){return t?c.generateKeyPairPromise(a,!0,v,w).then(function(a){f=a;return c.identityStorage.setDefaultKeyNameForIdentityPromise(f,w)}):b.resolve()}).then(function(){return c.identityStorage.getDefaultCertificateNameForKeyPromise(f,w).then(function(a){return b.resolve(a)},function(a){if(!(a instanceof x))throw a;var B;return c.selfSignPromise(f,w).then(function(a){B=a.getName();
return c.addCertificateAsIdentityDefaultPromise(a,w)}).then(function(){return b.resolve(B)})})})};ka.prototype.createIdentityAndCertificate=function(a,v,w,c){return b.complete(w,c,this.createIdentityAndCertificatePromise(a,v,!w))};ka.prototype.createIdentity=function(a,b){return Na.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,b))};ka.prototype.deleteIdentity=function(a,v,w){var c=this,t=!0,f=this.identityStorage.getDefaultIdentityPromise(!v).then(function(v){v.equals(a)&&(t=
!1);return b.resolve()},function(a){return b.resolve()}).then(function(){if(!t)return b.resolve();var v=[];return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,v,!0).then(function(){return c.identityStorage.getAllKeyNamesOfIdentityPromise(a,v,!1)}).then(function(){return c.identityStorage.deleteIdentityInfoPromise(a)}).then(function(){function a(B){return B>=v.length?b.resolve():c.privateKeyStorage.deleteKeyPairPromise(v[B]).then(function(){return a(B+1)})}return a(0)})});return b.complete(v,
w,f)};ka.prototype.setDefaultIdentityPromise=function(a,b){return this.identityStorage.setDefaultIdentityPromise(a,b)};ka.prototype.setDefaultIdentity=function(a,v,w){return b.complete(v,w,this.identityStorage.setDefaultIdentityPromise(a,!v))};ka.prototype.getDefaultIdentityPromise=function(a){return this.identityStorage.getDefaultIdentityPromise(a)};ka.prototype.getDefaultIdentity=function(a,v){return b.complete(a,v,this.identityStorage.getDefaultIdentityPromise(!a))};ka.prototype.getDefaultCertificatePromise=
function(a){return this.identityStorage.getDefaultCertificatePromise(a)};ka.prototype.generateRSAKeyPair=function(a,v,w){return b.getValue(this.generateKeyPairPromise(a,v,new cc(w),!0))};ka.prototype.setDefaultKeyForIdentity=function(a,v,w,f){f="function"===typeof v?w:f;w="function"===typeof v?v:w;v="function"!==typeof v&&v?v:new c;return b.complete(w,f,this.identityStorage.setDefaultKeyNameForIdentityPromise(a,v,!w))};ka.prototype.getDefaultKeyNameForIdentity=function(a,v,w){return b.complete(v,
w,this.identityStorage.getDefaultKeyNameForIdentityPromise(a,!v))};ka.prototype.generateRSAKeyPairAsDefaultPromise=function(a,v,w,c){var t,f=this;return this.generateKeyPairPromise(a,v,new cc(w)).then(function(a){t=a;return f.identityStorage.setDefaultKeyNameForIdentityPromise(t)}).then(function(){return b.resolve(t)})};ka.prototype.generateRSAKeyPairAsDefault=function(a,v,w){return b.getValue(this.generateRSAKeyPairAsDefaultPromise(a,v,w,!0))};ka.prototype.getPublicKey=function(a,v,w){return b.complete(v,
w,this.identityStorage.getKeyPromise(a,!v).then(function(a){return b.resolve(new Aa(a))}))};ka.prototype.prepareUnsignedIdentityCertificate=function(a,v,w,f,t,y,g,ha,l){v instanceof Aa||(l=ha,ha=g,g=y,y=t,t=f,f=w,w=v,v=null);var m=g,n=ha;g=m instanceof c?m:null;"function"===typeof m?(ha=m,l=n):"function"===typeof n?ha=n:l=ha=null;a=null==v?this.prepareUnsignedIdentityCertificatePromise(a,w,f,t,y,g,!ha):this.prepareUnsignedIdentityCertificatePromise(a,v,w,f,t,y,g,!ha);return b.complete(ha,l,a)};ka.prototype.prepareUnsignedIdentityCertificatePromise=
function(a,v,w,f,t,y,g,ha){v instanceof Aa||(ha=g,g=y,y=t,t=f,f=w,w=v,v=null);var l=g;g=l instanceof c?l:null;return(null==v?this.identityStorage.getKeyPromise(a,"boolean"===typeof l?l:"boolean"===typeof ha?ha:!1).then(function(a){v=new Aa(a);return b.resolve()}):b.resolve()).then(function(){return b.resolve(ka.prepareUnsignedIdentityCertificateHelper_(a,v,w,f,t,y,g))})};ka.prepareUnsignedIdentityCertificateHelper_=function(a,b,w,f,t,y,g){if(1>a.size())return null;var ha=a.get(-1).toEscapedString();
if(4>ha.length)return null;keyIdPrefix=ha.substr(0,4);if("ksk-"!=keyIdPrefix&&"dsk-"!=keyIdPrefix)return null;var ha=new Na,l=new c;if(null==g)w.match(a)?l.append(w).append("KEY").append(a.getSubName(w.size())).append("ID-CERT").appendVersion((new Date).getTime()):l.append(a.getPrefix(-1)).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion((new Date).getTime());else if(g.match(a)&&!g.equals(a))l.append(g).append("KEY").append(a.getSubName(g.size())).append("ID-CERT").appendVersion((new Date).getTime());
else return null;ha.setName(l);ha.setNotBefore(f);ha.setNotAfter(t);ha.setPublicKeyInfo(b);if(null==y||0===y.length)ha.addSubjectDescription(new jd("2.5.4.41",a.getPrefix(-1).toUri()));else for(a=0;a<y.length;++a)ha.addSubjectDescription(y[a]);try{ha.encode()}catch(m){throw x(Error("DerEncodingException: "+m));}return ha};ka.prototype.addCertificate=function(a,v,w){return b.complete(v,w,this.identityStorage.addCertificatePromise(a,!v))};ka.prototype.setDefaultCertificateForKeyPromise=function(a,b){var w=
this,c=a.getPublicKeyName();return this.identityStorage.doesKeyExistPromise(c,b).then(function(t){if(!t)throw new x(Error("No corresponding Key record for certificate!"));return w.identityStorage.setDefaultCertificateNameForKeyPromise(c,a.getName(),b)})};ka.prototype.setDefaultCertificateForKey=function(a,v,w){return b.complete(v,w,this.setDefaultCertificateForKeyPromise(a,!v))};ka.prototype.addCertificateAsIdentityDefaultPromise=function(a,b){var w=this;return this.identityStorage.addCertificatePromise(a,
b).then(function(){var c=a.getPublicKeyName();return w.identityStorage.setDefaultKeyNameForIdentityPromise(c,b)}).then(function(){return w.setDefaultCertificateForKeyPromise(a,b)})};ka.prototype.addCertificateAsDefault=function(a,v,c){var f=!v,t=this;return b.complete(v,c,this.identityStorage.addCertificatePromise(a,f).then(function(){return t.setDefaultCertificateForKeyPromise(a,f)}))};ka.prototype.getCertificate=function(a,v,c){return b.complete(v,c,this.identityStorage.getCertificatePromise(a,
!1,!v))};ka.prototype.getDefaultCertificateNameForIdentityPromise=function(a,b){return this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,b)};ka.prototype.getDefaultCertificateNameForIdentity=function(a,v,c){return b.complete(v,c,this.identityStorage.getDefaultCertificateNameForIdentityPromise(a,!v))};ka.prototype.getDefaultCertificateName=function(a,v){var c=!a,f=this;return b.complete(a,v,this.identityStorage.getDefaultIdentityPromise(c).then(function(a){return f.identityStorage.getDefaultCertificateNameForIdentityPromise(a,
c)}))};ka.prototype.getAllIdentities=function(a,v,c,f){return b.complete(c,f,this.identityStorage.getAllIdentitiesPromise(a,v,!c))};ka.prototype.getAllKeyNamesOfIdentity=function(a,v,c,f,t){return b.complete(f,t,this.identityStorage.getAllKeyNamesOfIdentityPromise(a,v,c,!f))};ka.prototype.getAllCertificateNamesOfKey=function(a,v,c,f,t){return b.complete(f,t,this.identityStorage.getAllCertificateNamesOfKeyPromise(a,v,c,!f))};ka.prototype.signByCertificatePromise=function(a,v,c,f){f="boolean"===typeof c?
c:f;c="boolean"!==typeof c&&c?c:s.getDefaultWireFormat();var t=ka.certificateNameToPublicKeyName(v),y=this;if(a instanceof R){var g=[0];return this.makeSignatureByCertificatePromise(v,g,f).then(function(b){a.setSignature(b);b=a.wireEncode(c);return y.privateKeyStorage.signPromise(b.signedBuf(),t,g[0],f)}).then(function(v){a.getSignature().setSignature(v);a.wireEncode(c);return b.resolve(a)})}g=[0];return this.makeSignatureByCertificatePromise(v,g,f).then(function(b){return y.privateKeyStorage.signPromise(a,
t,g[0],f)}).then(function(a){signature.setSignature(a);return b.resolve(signature)})};ka.prototype.signByCertificate=function(a,v,c,f,t){t="function"===typeof c?f:t;f="function"===typeof c?c:f;c="function"!==typeof c&&c?c:s.getDefaultWireFormat();return b.complete(f,t,this.signByCertificatePromise(a,v,c,!f))};ka.prototype.signInterestByCertificatePromise=function(a,v,w,f){f="boolean"===typeof w?w:f;w="boolean"!==typeof w&&w?w:s.getDefaultWireFormat();var t=this,y,g=[0];return this.makeSignatureByCertificatePromise(v,
g,f).then(function(b){y=b;a.getName().append(w.encodeSignatureInfo(y));a.getName().append(new c.Component);b=a.wireEncode(w);var l=ka.certificateNameToPublicKeyName(v);return t.privateKeyStorage.signPromise(b.signedBuf(),l,g[0],f)}).then(function(v){y.setSignature(v);a.setName(a.getName().getPrefix(-1).append(w.encodeSignatureValue(y)));return b.resolve(a)})};ka.prototype.signInterestByCertificate=function(a,v,c,f,t){t="function"===typeof c?f:t;f="function"===typeof c?c:f;c="function"!==typeof c&&
c?c:s.getDefaultWireFormat();return b.complete(f,t,this.signInterestByCertificatePromise(a,v,c,!f))};ka.prototype.signWithSha256=function(a,b){b=b||s.getDefaultWireFormat();a.setSignature(new xb);var c=a.wireEncode(b),f=W.createHash("sha256");f.update(c.signedBuf());a.getSignature().setSignature(new m(f.digest(),!1));a.wireEncode(b)};ka.prototype.signInterestWithSha256=function(a,b){b=b||s.getDefaultWireFormat();var w=new xb;a.getName().append(b.encodeSignatureInfo(w));a.getName().append(new c.Component);
var f=a.wireEncode(b),t=W.createHash("sha256");t.update(f.signedBuf());w.setSignature(new m(t.digest(),!1));a.setName(a.getName().getPrefix(-1).append(b.encodeSignatureValue(w)))};ka.prototype.selfSignPromise=function(a,b){var c=new Na,f=this;return this.identityStorage.getKeyPromise(a,b).then(function(t){t=new Aa(t);var y=(new Date).getTime(),g=y+63072E6;c.setNotBefore(y);c.setNotAfter(g);y=a.getPrefix(-1).append("KEY").append(a.get(-1)).append("ID-CERT").appendVersion(c.getNotBefore());c.setName(y);
c.setPublicKeyInfo(t);c.addSubjectDescription(new jd("2.5.4.41",a.toUri()));c.encode();return f.signByCertificatePromise(c,c.getName(),b)})};ka.prototype.selfSign=function(a,v,c){return b.complete(v,c,this.selfSignPromise(a,!v))};ka.certificateNameToPublicKeyName=function(a){for(var b=a.size()-1;0<=b&&"ID-CERT"!=a.get(b).toEscapedString();)--b;a=a.getSubName(0,b);for(b=0;b<a.size()&&"KEY"!=a.get(b).toEscapedString();)++b;return a.getSubName(0,b).append(a.getSubName(b+1,a.size()-b-1))};ka.prototype.makeSignatureByCertificatePromise=
function(a,v,c){var f=ka.certificateNameToPublicKeyName(a);return this.privateKeyStorage.getPublicKeyPromise(f,c).then(function(c){c=c.getKeyType();var w=null;if(c==ea.RSA)w=new Ja,v[0]=Ga.SHA256,w.getKeyLocator().setType(ua.KEYNAME),w.getKeyLocator().setKeyName(a.getPrefix(-1));else if(c==ea.EC)w=new Xa,v[0]=Ga.SHA256,w.getKeyLocator().setType(ua.KEYNAME),w.getKeyLocator().setKeyName(a.getPrefix(-1));else throw new x(Error("Key type is not recognized"));return b.resolve(w)})};ka.prototype.generateKeyPairPromise=
function(a,v,c,f){var t,y=this;return this.identityStorage.getNewKeyNamePromise(a,v,f).then(function(a){t=a;return y.privateKeyStorage.generateKeyPairPromise(t,c,f)}).then(function(){return y.privateKeyStorage.getPublicKeyPromise(t,f)}).then(function(a){return y.identityStorage.addKeyPromise(t,c.getKeyType(),a.getKeyDer())}).then(function(){return b.resolve(t)})};ka.getDefaultIdentityStorage_=function(a,b){var c=a.get("pib","");if(""!==c&&"pib-sqlite3"!==c)throw new x(Error("Invalid config file pib value: "+
c));return new Me(b)};ka.getDefaultPrivateKeyStorage_=function(a,b){var c=a.get("tpm","");if(""===c){if("darwin"===process.platform)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: OS X key chain storage is not yet implemented. You must supply a privateKeyStorage."));b[0]="tpm-file:";return new We}if("tpm-osxkeychain"===c)throw b[0]="tpm-osxkeychain:",new x(Error("IdentityManager: tpm-osxkeychain is not yet implemented."));if("tpm-file"===c)return b[0]="tpm-file:",new We;throw new x(Error("Invalid config file tpm value: "+
c));};ka.prototype.checkTpmPromise_=function(a){return this.identityStorage.getTpmLocatorPromise().then(function(b){return""!==b&&b!==a?Promise.reject(new x(Error("The TPM locator supplied does not match the TPM locator in the PIB: "+b+" != "+a))):Promise.resolve()},function(a){return Promise.resolve()})};var c=a.Name,b=a.SyncPromise,N=a.CertificateV2,Tc=function(a,b,w){this.certificates_={};this.keyName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.certificateNameUris_=
[];for(var f in w)this.certificateNameUris_.push(w[f].toUri())};r.PibCertificateContainer=Tc;Tc.makePromise=function(a,v,c){return null==v?b.reject(Error("The pibImpl is null")):v.getCertificatesOfKeyPromise(a,c).then(function(c){return b.resolve(new Tc(a,v,c))})};Tc.prototype.size=function(){return this.certificateNameUris_.length};Tc.prototype.addPromise=function(a,v){if(!this.keyName_.equals(a.getKeyName()))return b.reject(Error("The certificate name `"+a.getKeyName().toUri()+"` does not match the key name"));
var c=a.getName().toUri();0>this.certificateNameUris_.indexOf(c)&&this.certificateNameUris_.push(c);this.certificates_[c]=new N(a);return this.pibImpl_.addCertificatePromise(a,v)};Tc.prototype.removePromise=function(a,v){if(!N.isValidName(a)||!N.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var c=a.toUri(),f=this.certificateNameUris_.indexOf(c);0<=f&&this.certificateNameUris_.splice(f,1);delete this.certificates_[c];
return this.pibImpl_.removeCertificatePromise(a,v)};Tc.prototype.getPromise=function(a,v){var c=a.toUri(),f=this.certificates_[c];if(void 0!=f)return b.resolve(new N(f));if(!N.isValidName(a)||!N.extractKeyNameFromCertName(a).equals(this.keyName_))return b.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var t=this;return this.pibImpl_.getCertificatePromise(a,v).then(function(a){t.certificates_[c]=a;return b.resolve(new N(a))})};var c=a.Name,Sb=a.PibIdentity,
rc=a.PibIdentityImpl,b=a.SyncPromise,Hc=function(a,b){this.identities_={};this.pibImpl_=a;if(null==a)throw Error("The pibImpl is null");this.identityNameUris_=[];for(var c in b)this.identityNameUris_.push(b[c].toUri())};r.PibIdentityContainer=Hc;Hc.makePromise=function(a,v){return null==a?b.reject(Error("The pibImpl is null")):a.getIdentitiesPromise(v).then(function(v){return b.resolve(new Hc(a,v))})};Hc.prototype.size=function(){return this.identityNameUris_.length};Hc.prototype.addPromise=function(a,
b){var c=a.toUri();if(0>this.identityNameUris_.indexOf(c)){var f=this;this.identityNameUris_.push(c);return rc.makePromise(a,this.pibImpl_,!0,b).then(function(t){f.identities_[c]=t;return f.getPromise(a,b)})}return this.getPromise(a,b)};Hc.prototype.removePromise=function(a,b){var c=a.toUri(),f=this.identityNameUris_.indexOf(c);0<=f&&this.identityNameUris_.splice(f,1);delete this.identities_[c];return this.pibImpl_.removeIdentityPromise(a,b)};Hc.prototype.getPromise=function(a,c){var w=a.toUri(),
f=this.identities_[w];if(void 0==f){var t=this;return rc.makePromise(a,this.pibImpl_,!1,c).then(function(a){t.identities_[w]=a;return b.resolve(new Sb(a))})}return b.resolve(new Sb(f))};Hc.prototype.resetPromise=function(a){var c=this;this.identities_={};return this.pibImpl_.getIdentitiesPromise(a).then(function(a){c.identityNameUris_=[];for(var B in a)c.identityNameUris_.push(a[B].toUri());return b.resolve()})};b=a.SyncPromise;Sb=function(a){this.impl_=a};r.PibIdentity=Sb;Sb.prototype.getName=function(){return this.lock_().getName()};
Sb.prototype.getKeyPromise=function(a,c){try{return this.lock_().getKeyPromise(a,c)}catch(w){return b.reject(w)}};Sb.prototype.getKey=function(a,c,w){return b.complete(c,w,this.getKeyPromise(a,!c))};Sb.prototype.getDefaultKeyPromise=function(a){try{return this.lock_().getDefaultKeyPromise(a)}catch(c){return b.reject(c)}};Sb.prototype.getDefaultKey=function(a,c){return b.complete(a,c,this.getDefaultKeyPromise(!a))};Sb.prototype.addKeyPromise_=function(a,c,w){try{return this.lock_().addKeyPromise(a,
c,w)}catch(f){return b.reject(f)}};Sb.prototype.removeKeyPromise_=function(a,c){try{return this.lock_().removeKeyPromise(a,c)}catch(w){return b.reject(w)}};Sb.prototype.setDefaultKeyPromise_=function(a,c,w){try{return this.lock_().setDefaultKeyPromise(a,c,w)}catch(f){return b.reject(f)}};Sb.prototype.getKeys_=function(){return this.lock_().keys_};Sb.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var b=a.SyncPromise,ca=function(){};r.PibImpl=ca;
ca.Error=function(a){if(a)return a.__proto__=ca.Error.prototype,a};ca.Error.prototype=Error();ca.Error.prototype.name="PibImplError";ca.prototype.setTpmLocatorPromise=function(a,c){return b.reject(Error("PibImpl.setTpmLocatorPromise is not implemented"))};ca.prototype.getTpmLocatorPromise=function(a){return b.reject(Error("PibImpl.getTpmLocatorPromise is not implemented"))};ca.prototype.hasIdentityPromise=function(a,c){return b.reject(Error("PibImpl.hasIdentityPromise is not implemented"))};ca.prototype.addIdentityPromise=
function(a,c){return b.reject(Error("PibImpl.addIdentityPromise is not implemented"))};ca.prototype.removeIdentityPromise=function(a,c){return b.reject(Error("PibImpl.removeIdentityPromise is not implemented"))};ca.prototype.clearIdentitiesPromise=function(a){return b.reject(Error("PibImpl.clearIdentitiesPromise is not implemented"))};ca.prototype.getIdentitiesPromise=function(a){return b.reject(Error("PibImpl.getIdentitiesPromise is not implemented"))};ca.prototype.setDefaultIdentityPromise=function(a,
c){return b.reject(Error("PibImpl.setDefaultIdentityPromise is not implemented"))};ca.prototype.getDefaultIdentityPromise=function(a){return b.reject(Error("PibImpl.getDefaultIdentityPromise is not implemented"))};ca.prototype.hasKeyPromise=function(a,c){return b.reject(Error("PibImpl.hasKeyPromise is not implemented"))};ca.prototype.addKeyPromise=function(a,c,w,f){return b.reject(Error("PibImpl.addKeyPromise is not implemented"))};ca.prototype.removeKeyPromise=function(a,c){return b.reject(Error("PibImpl.removeKeyPromise is not implemented"))};
ca.prototype.getKeyBitsPromise=function(a,c){return b.reject(Error("PibImpl.getKeyBitsPromise is not implemented"))};ca.prototype.getKeysOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getKeysOfIdentityPromise is not implemented"))};ca.prototype.setDefaultKeyOfIdentityPromise=function(a,c,w){return b.reject(Error("PibImpl.setDefaultKeyOfIdentityPromise is not implemented"))};ca.prototype.getDefaultKeyOfIdentityPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultKeyOfIdentityPromise is not implemented"))};
ca.prototype.hasCertificatePromise=function(a,c){return b.reject(Error("PibImpl.hasCertificatePromise is not implemented"))};ca.prototype.addCertificatePromise=function(a,c){return b.reject(Error("PibImpl.addCertificatePromise is not implemented"))};ca.prototype.removeCertificatePromise=function(a,c){return b.reject(Error("PibImpl.removeCertificatePromise is not implemented"))};ca.prototype.getCertificatePromise=function(a,c){return b.reject(Error("PibImpl.getCertificatePromise is not implemented"))};
ca.prototype.getCertificatesOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getCertificatesOfKeyPromise is not implemented"))};ca.prototype.setDefaultCertificateOfKeyPromise=function(a,c,w){return b.reject(Error("PibImpl.setDefaultCertificateOfKeyPromise is not implemented"))};ca.prototype.getDefaultCertificateOfKeyPromise=function(a,c){return b.reject(Error("PibImpl.getDefaultCertificateOfKeyPromise is not implemented"))};var $a=function(){ca.call(this);this.database=new Dexie("pib");this.database.version(1).stores({globals:"key",
identities:"identityNameUri",keys:"keyNameUri",certificates:"certificateNameUri"});this.database.open()};$a.prototype=new ca;$a.prototype.name="PibIndexedDb";r.PibIndexedDb=$a;$a.getScheme=function(){return"pib-indexeddb"};$a.prototype.setTpmLocatorPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.setTpmLocatorPromise is only supported for async"))):this.database.globals.put({key:"tpmLocator",value:a})};$a.prototype.getTpmLocatorPromise=function(a){return a?Promise.reject(new ca.Error(Error("PibIndexedDb.getTpmLocatorPromise is only supported for async"))):
this.database.globals.get("tpmLocator").then(function(a){return a?Promise.resolve(a.value):Promise.resolve("")})};$a.prototype.hasIdentityPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.hasIdentityPromise is only supported for async"))):this.database.identities.where("identityNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};$a.prototype.addIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.addIdentityPromise is only supported for async")));
var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.get("defaultIdentityUri")}).then(function(b){return b?Promise.resolve():c.setDefaultIdentityPromise(a)})};$a.prototype.removeIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.removeIdentityPromise is only supported for async")));var w=a.toUri(),f=this;return this.database.certificates.each(function(b){N.extractIdentityFromCertName(new c(b.certificateNameUri)).equals(a)&&
f.database.certificates.delete(b.certificateNameUri)}).then(function(){return f.database.keys.each(function(b){qa.extractIdentityFromKeyName(new c(b.keyNameUri)).equals(a)&&f.database.keys.delete(b.keyNameUri)})}).then(function(){return f.database.identities.delete(w)}).then(function(){return f.database.globals.get("defaultIdentityUri")}).then(function(a){return a&&a.value==w?f.database.globals.delete("defaultIdentityUri"):Promise.resolve()})};$a.prototype.clearIdentitiesPromise=function(a){if(a)return Promise.reject(new ca.Error(Error("PibIndexedDb.clearIdentitiesPromise is only supported for async")));
var b=this;return this.database.globals.delete("defaultIdentityUri").then(function(){return b.database.certificates.clear()}).then(function(){return b.database.keys.clear()}).then(function(){return b.database.identities.clear()})};$a.prototype.getIdentitiesPromise=function(a){if(a)return Promise.reject(new ca.Error(Error("PibIndexedDb.getIdentitiesPromise is only supported for async")));var b=[];return this.database.identities.each(function(a){b.push(new c(a.identityNameUri))}).then(function(){return Promise.resolve(b)})};
$a.prototype.setDefaultIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.setDefaultIdentityPromise is only supported for async")));var c=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():c.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return c.database.globals.put({key:"defaultIdentityUri",value:a.toUri()})})};$a.prototype.getDefaultIdentityPromise=function(a){return a?Promise.reject(new ca.Error(Error("PibIndexedDb.getDefaultIdentityPromise is only supported for async"))):
this.database.globals.get("defaultIdentityUri").then(function(a){return a?Promise.resolve(new c(a.value)):Promise.reject(new la.Error(Error("No default identity")))})};$a.prototype.hasKeyPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.hasKeyPromise is only supported for async"))):this.database.keys.where("keyNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};$a.prototype.addKeyPromise=function(a,b,w,f){if(f)return Promise.reject(new ca.Error(Error("PibIndexedDb.addKeyPromise is only supported for async")));
var t=this;return this.addIdentityPromise(a).then(function(){return t.hasKeyPromise(b)}).then(function(a){return a?t.database.keys.update(b.toUri(),{keyDer:w}):t.database.keys.put({keyNameUri:b.toUri(),keyDer:w,defaultCertificateUri:null})}).then(function(){return t.database.identities.get(a.toUri())}).then(function(a){return a&&null!=a.defaultKeyUri?t.hasKeyPromise(new c(a.defaultKeyUri)):Promise.resolve(!1)}).then(function(c){return c?Promise.resolve():t.setDefaultKeyOfIdentityPromise(a,b)})};$a.prototype.removeKeyPromise=
function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.removeKeyPromise is only supported for async")));var w=this;return this.database.certificates.each(function(b){N.extractKeyNameFromCertName(new c(b.certificateNameUri)).equals(a)&&w.database.certificates.delete(b.certificateNameUri)}).then(function(){return w.database.keys.delete(a.toUri())})};$a.prototype.getKeyBitsPromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.getKeyBitsPromise is only supported for async"))):
this.database.keys.get(a.toUri()).then(function(b){return b?Promise.resolve(new m(b.keyDer)):Promise.reject(new la.Error(Error("Key `"+a.toUri()+"` does not exist")))})};$a.prototype.getKeysOfIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getKeysOfIdentityPromise is only supported for async")));var w=[];return this.database.keys.each(function(b){b=new c(b.keyNameUri);qa.extractIdentityFromKeyName(b).equals(a)&&w.push(b)}).then(function(){return Promise.resolve(w)})};
$a.prototype.setDefaultKeyOfIdentityPromise=function(a,b,c){if(c)return Promise.reject(new ca.Error(Error("PibIndexedDb.setDefaultKeyOfIdentityPromise is only supported for async")));var f=this;return this.hasKeyPromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new la.Error(Error("Key `"+b.toUri()+"` does not exist")))}).then(function(){return f.database.identities.update(a.toUri(),{defaultKeyUri:b.toUri()})})};$a.prototype.getDefaultKeyOfIdentityPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getDefaultKeyOfIdentityPromise is only supported for async")));
var w=this;return this.database.identities.get(a.toUri()).then(function(b){if(b){if(null!=b.defaultKeyUri){var v=new c(b.defaultKeyUri);return w.hasKeyPromise(v).then(function(b){return b?Promise.resolve(v):Promise.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`")))})}return Promise.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`")))}return Promise.reject(new la.Error(Error("Identity `"+a.toUri()+"` does not exist")))})};$a.prototype.hasCertificatePromise=
function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.hasCertificatePromise is only supported for async"))):this.database.certificates.where("certificateNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};$a.prototype.addCertificatePromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.addCertificatePromise is only supported for async")));var w=a.getKeyName(),f=w.toUri(),t=this,y=a.getContent();return this.addKeyPromise(a.getIdentity(),
w,y.buf()).then(function(){return t.database.certificates.put({certificateNameUri:a.getName().toUri(),encoding:a.wireEncode().buf()})}).then(function(){return t.database.keys.get(f)}).then(function(a){return a&&null!=a.defaultCertificateUri?t.hasCertificatePromise(new c(a.defaultCertificateUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():t.setDefaultCertificateOfKeyPromise(w,a.getName())})};$a.prototype.removeCertificatePromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.removeCertificatePromise is only supported for async"))):
this.database.certificates.delete(a.toUri())};$a.prototype.getCertificatePromise=function(a,b){return b?Promise.reject(new ca.Error(Error("PibIndexedDb.getCertificatePromise is only supported for async"))):this.database.certificates.get(a.toUri()).then(function(b){if(b){var c=new N;c.wireDecode(b.encoding);return Promise.resolve(c)}return Promise.reject(new la.Error(Error("Certificate `"+a.toUri()+"` does not exit")))})};$a.prototype.getCertificatesOfKeyPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getCertificatesOfKeyPromise is only supported for async")));
var w=[];return this.database.certificates.each(function(b){b=new c(b.certificateNameUri);N.extractKeyNameFromCertName(b).equals(a)&&w.push(b)}).then(function(){return Promise.resolve(w)})};$a.prototype.setDefaultCertificateOfKeyPromise=function(a,b,c){if(c)return Promise.reject(new ca.Error(Error("PibIndexedDb.setDefaultCertificateOfKeyPromise is only supported for async")));var f=this;return this.hasCertificatePromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new la.Error(Error("Certificate `"+
b.toUri()+"` does not exist")))}).then(function(){return f.database.keys.update(a.toUri(),{defaultCertificateUri:b.toUri()})})};$a.prototype.getDefaultCertificateOfKeyPromise=function(a,b){if(b)return Promise.reject(new ca.Error(Error("PibIndexedDb.getDefaultCertificateOfKeyPromise is only supported for async")));var w=this;return this.database.keys.get(a.toUri()).then(function(b){return b&&null!=b.defaultCertificateUri?w.getCertificatePromise(new c(b.defaultCertificateUri)):Promise.reject(new la.Error(Error("No default certificate for key `"+
a.toUri()+"`")))})};var c=a.Name,qa=a.PibKey,Ub=a.PibKeyImpl,b=a.SyncPromise,Uc=function(a,b,w){this.keys_={};this.identityName_=new c(a);this.pibImpl_=b;if(null==b)throw Error("The pibImpl is null");this.keyNameUris_=[];for(var f in w)this.keyNameUris_.push(w[f].toUri())};r.PibKeyContainer=Uc;Uc.makePromise=function(a,c,w){return null==c?b.reject(Error("The pibImpl is null")):c.getKeysOfIdentityPromise(a,w).then(function(w){return b.resolve(new Uc(a,c,w))})};Uc.prototype.size=function(){return this.keyNameUris_.length};
Uc.prototype.addPromise=function(a,c,w){if(!this.identityName_.equals(qa.extractIdentityFromKeyName(c)))return b.reject(Error("The key name `"+c.toUri()+"` does not match the identity name `"+this.identityName_.toUri()+"`"));var f=c.toUri();0>this.keyNameUris_.indexOf(f)&&this.keyNameUris_.push(f);var t=this;return Ub.makePromise(c,a,this.pibImpl_,w).then(function(a){t.keys_[f]=a;return t.getPromise(c,w)})};Uc.prototype.removePromise=function(a,c){if(!this.identityName_.equals(qa.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+
a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var w=a.toUri(),f=this.keyNameUris_.indexOf(w);0<=f&&this.keyNameUris_.splice(f,1);delete this.keys_[w];return this.pibImpl_.removeKeyPromise(a,c)};Uc.prototype.getPromise=function(a,c){if(!this.identityName_.equals(qa.extractIdentityFromKeyName(a)))return b.reject(Error("Key name `"+a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var w=a.toUri(),f=this.keys_[w];if(void 0==f){var t=this;return Ub.makePromise(a,
this.pibImpl_,c).then(function(a){t.keys_[w]=a;return b.resolve(new qa(a))})}return b.resolve(new qa(f))};Uc.prototype.getKeyNames=function(){var a=[],b;for(b in this.keys_)a.push(new c(b));return a};c=a.Name;N=a.CertificateV2;b=a.SyncPromise;qa=function(a){this.impl_=a};r.PibKey=qa;qa.prototype.getName=function(){return this.lock_().getName()};qa.prototype.getIdentityName=function(){return this.lock_().getIdentityName()};qa.prototype.getKeyType=function(){return this.lock_().getKeyType()};qa.prototype.getPublicKey=
function(){return this.lock_().getPublicKey()};qa.prototype.getCertificatePromise=function(a,c){try{return this.lock_().getCertificatePromise(a,c)}catch(w){return b.reject(w)}};qa.prototype.getCertificate=function(a,c,w){return b.complete(c,w,this.getCertificatePromise(a,!c))};qa.prototype.getDefaultCertificatePromise=function(a){try{return this.lock_().getDefaultCertificatePromise(a)}catch(c){return b.reject(c)}};qa.prototype.getDefaultCertificate=function(a,c){return b.complete(a,c,this.getDefaultCertificatePromise(!a))};
qa.constructKeyName=function(a,b){var w=new c(a);w.append(N.KEY_COMPONENT).append(b);return w};qa.isValidKeyName=function(a){return a.size()>N.MIN_KEY_NAME_LENGTH&&a.get(-N.MIN_KEY_NAME_LENGTH).equals(N.KEY_COMPONENT)};qa.extractIdentityFromKeyName=function(a){if(!qa.isValidKeyName(a))throw Error("Key name `"+a.toUri()+"` does not follow the naming conventions");return a.getPrefix(-N.MIN_KEY_NAME_LENGTH)};qa.prototype.addCertificatePromise_=function(a,b){return this.lock_().addCertificatePromise(a,
b)};qa.prototype.removeCertificatePromise_=function(a,b){return this.lock_().removeCertificatePromise(a,b)};qa.prototype.setDefaultCertificatePromise_=function(a,b){return this.lock_().setDefaultCertificatePromise(a,b)};qa.prototype.getCertificates_=function(){return this.lock_().certificates_};qa.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var c=a.Name,m=a.Blob,N=a.CertificateV2,la=a.Pib,qa=a.PibKey,b=a.SyncPromise,ca=a.PibImpl,xa=function(){ca.call(this);
this.tpmLocator_="";this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={}};xa.prototype=new ca;xa.prototype.name="PibMemory";r.PibMemory=xa;xa.getScheme=function(){return"pib-memory"};xa.prototype.setTpmLocatorPromise=function(a){this.tpmLocator_=a;return b.resolve()};xa.prototype.getTpmLocatorPromise=function(){return b.resolve(this.tpmLocator_)};xa.prototype.hasIdentityPromise=function(a){return b.resolve(this.hasIdentity_(a))};
xa.prototype.hasIdentity_=function(a){for(var b in this.identityNames_)if(this.identityNames_[b].equals(a))return!0;return!1};xa.prototype.addIdentityPromise=function(a){this.addIdentity_(a);return b.resolve()};xa.prototype.addIdentity_=function(a){a=new c(a);this.hasIdentity_(a)||this.identityNames_.push(a);null===this.defaultIdentityName_&&(this.defaultIdentityName_=a)};xa.prototype.removeIdentityPromise=function(a){for(var c=this.identityNames_.length-1;0<=c;--c)this.identityNames_[c].equals(a)&&
this.identityNames_.splice(c,1);null!==this.defaultIdentityName_&&a.equals(this.defaultIdentityName_)&&(this.defaultIdentityName_=null);a=this.getKeysOfIdentity_(a);for(c in a)this.removeKey_(a[c]);return b.resolve()};xa.prototype.clearIdentitiesPromise=function(){this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={};return b.resolve()};xa.prototype.getIdentitiesPromise=function(){var a=[],v;for(v in this.identityNames_)a.push(new c(this.identityNames_[v]));
return b.resolve(a)};xa.prototype.setDefaultIdentityPromise=function(a){this.addIdentity_(a);this.defaultIdentityName_=new c(a);return b.resolve()};xa.prototype.getDefaultIdentityPromise=function(){return null!==this.defaultIdentityName_?b.resolve(new c(this.defaultIdentityName_)):b.reject(new la.Error(Error("No default identity")))};xa.prototype.hasKeyPromise=function(a){return b.resolve(this.hasKey_(a))};xa.prototype.hasKey_=function(a){return a.toUri()in this.keys_};xa.prototype.addKeyPromise=
function(a,c,w){this.addKey_(a,c,w);return b.resolve()};xa.prototype.addKey_=function(a,b,w){this.addIdentity_(a);b=new c(b);this.keys_[b.toUri()]=new m(w,!0);a=a.toUri();a in this.defaultKeyNames_||(this.defaultKeyNames_[a]=b)};xa.prototype.removeKeyPromise=function(a){this.removeKey_(a);return b.resolve()};xa.prototype.removeKey_=function(a){var b=qa.extractIdentityFromKeyName(a);delete this.keys_[a.toUri()];delete this.defaultKeyNames_[b.toUri()];a=this.getCertificatesOfKey_(a);for(var c in a)this.removeCertificate_(a[c])};
xa.prototype.getKeyBitsPromise=function(a){if(!this.hasKey_(a))return b.reject(new la.Error(Error("Key `"+a.toUri()+"` not found")));a=this.keys_[a.toUri()];return b.resolve(a)};xa.prototype.getKeysOfIdentityPromise=function(a){return b.resolve(this.getKeysOfIdentity_(a))};xa.prototype.getKeysOfIdentity_=function(a){var b=[],w;for(w in this.keys_){var f=new c(w);a.equals(qa.extractIdentityFromKeyName(f))&&b.push(f)}return b};xa.prototype.setDefaultKeyOfIdentityPromise=function(a,v){if(!this.hasKey_(v))return b.reject(new la.Error(Error("Key `"+
v.toUri()+"` not found")));this.defaultKeyNames_[a.toUri()]=new c(v);return b.resolve()};xa.prototype.getDefaultKeyOfIdentityPromise=function(a){var v=this.defaultKeyNames_[a.toUri()];return void 0==v?b.reject(new la.Error(Error("No default key for identity `"+a.toUri()+"`"))):b.resolve(new c(v))};xa.prototype.hasCertificatePromise=function(a){return b.resolve(this.hasCertificate_(a))};xa.prototype.hasCertificate_=function(a){return a.toUri()in this.certificates_};xa.prototype.addCertificatePromise=
function(a){var v=new c(a.getName()),w=a.getKeyName(),f=a.getIdentity();this.addKey_(f,w,a.getContent().buf());this.certificates_[v.toUri()]=new N(a);a=w.toUri();a in this.defaultCertificateNames_||(this.defaultCertificateNames_[a]=v);return b.resolve()};xa.prototype.removeCertificatePromise=function(a){this.removeCertificate_(a);return b.resolve()};xa.prototype.removeCertificate_=function(a){delete this.certificates_[a.toUri()];var b=N.extractKeyNameFromCertName(a).toUri(),c=this.defaultCertificateNames_[b];
void 0!=c&&c.equals(a)&&delete this.defaultCertificateNames_[b]};xa.prototype.getCertificatePromise=function(a){return this.hasCertificate_(a)?b.resolve(new N(this.certificates_[a.toUri()])):b.reject(new la.Error(Error("Certificate `"+a.toUri()+"` does not exist")))};xa.prototype.getCertificatesOfKeyPromise=function(a){return b.resolve(this.getCertificatesOfKey_(a))};xa.prototype.getCertificatesOfKey_=function(a){var b=[],w;for(w in this.certificates_)N.extractKeyNameFromCertName(this.certificates_[w].getName()).equals(a)&&
b.push(new c(w));return b};xa.prototype.setDefaultCertificateOfKeyPromise=function(a,v){if(!this.hasCertificate_(v))return b.reject(new la.Error(Error("Certificate `"+v.toUri()+"` does not exist")));this.defaultCertificateNames_[a.toUri()]=new c(v);return b.resolve()};xa.prototype.getDefaultCertificateOfKeyPromise=function(a){var c=this.defaultCertificateNames_[a.toUri()];if(void 0==c)return b.reject(new la.Error(Error("No default certificate for key `"+a.toUri()+"`")));a=this.certificates_[c.toUri()];
return b.resolve(new N(a))};zd=a.ConfigFile;b=a.SyncPromise;la=function(a,b,c){this.defaultIdentity_=null;this.scheme_=a;this.location_=b;this.identities_=null;this.pibImpl_=c;this.initializeTpmLocator_=this.initializePibLocator_=this.initializeTpm_=null;this.isInitialized_=this.initializeAllowReset_=!1;if(null==c)throw Error("The pibImpl is null");};r.Pib=la;la.Error=function(a){if(a)return a.__proto__=la.Error.prototype,a};la.Error.prototype=Error();la.Error.prototype.name="PibError";la.prototype.getScheme=
function(){return this.scheme_};la.prototype.getPibLocator=function(){return this.scheme_+":"+this.location_};la.prototype.setTpmLocatorPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.doSetTpmLocatorPromise_(a,b)})};la.prototype.doSetTpmLocatorPromise_=function(a,c){var w=this;return this.pibImpl_.getTpmLocatorPromise(c).then(function(f){return a==f?b.resolve():w.resetPromise_(c).then(function(){return w.pibImpl_.setTpmLocatorPromise(a,c)})})};la.prototype.getTpmLocatorPromise=
function(a){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getTpmLocatorPromise(a)}).then(function(a){return""==a?b.reject(new la.Error(Error("TPM info does not exist"))):b.resolve(a)})};la.prototype.getIdentityPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.getPromise(a,b)})};la.prototype.getIdentity=function(a,c,w){return b.complete(c,w,this.getIdentityPromise(a,!c))};la.prototype.getDefaultIdentityPromise=function(a){if(null==
this.defaultIdentity_){var c=this;return this.initializePromise_(a).then(function(){return c.pibImpl_.getDefaultIdentityPromise(a)}).then(function(b){return c.identities_.getPromise(b,a)}).then(function(a){c.defaultIdentity_=a;return b.resolve(c.defaultIdentity_)})}return b.resolve(this.defaultIdentity_)};la.prototype.getDefaultIdentity=function(a,c){return b.complete(a,c,this.getDefaultIdentityPromise(!a))};la.prototype.resetPromise_=function(a){var b=this;return this.pibImpl_.clearIdentitiesPromise(a).then(function(){return b.pibImpl_.setTpmLocatorPromise("",
a)}).then(function(){b.defaultIdentity_=null;return Hc.makePromise(b.pibImpl_,a)}).then(function(c){b.identities_=c;return b.identities_.resetPromise(a)})};la.prototype.addIdentityPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.identities_.addPromise(a,b)})};la.prototype.removeIdentityPromise_=function(a,b){null!=this.defaultIdentity_&&this.defaultIdentity_.getName().equals(a)&&(this.defaultIdentity_=null);var c=this;return this.initializePromise_(b).then(function(){return c.identities_.removePromise(a,
b)})};la.prototype.setDefaultIdentityPromise_=function(a,c){var w=this;return this.initializePromise_(c).then(function(){return w.identities_.addPromise(a,c)}).then(function(b){w.defaultIdentity_=b;return w.pibImpl_.setDefaultIdentityPromise(a)}).then(function(){return b.resolve(w.defaultIdentity_)})};la.prototype.initializePromise_=function(a){if(this.isInitialized_)return b.resolve();var c=this;return Hc.makePromise(this.pibImpl_,a).then(function(w){c.identities_=w;return null!=c.initializeTpm_?
c.initializeFromLocatorsPromise_(a):b.resolve()}).then(function(){c.isInitialized_=!0;return b.resolve()})};la.prototype.initializeFromLocatorsPromise_=function(a){var c=[null],w=[null];C.parseAndCheckPibLocator_(this.initializePibLocator_,c,w);var f=c[0]+":"+w[0],t,y=this;return this.pibImpl_.getTpmLocatorPromise(a).then(function(c){var v=[null],w=[null];C.parseAndCheckTpmLocator_(y.initializeTpmLocator_,v,w);t=v[0]+":"+w[0];var v=!1,g;zd&&(g=new zd);if(zd&&f==C.getDefaultPibLocator_(g))""!=c&&c!=
C.getDefaultTpmLocator_(g)&&(v=!0,t=C.getDefaultTpmLocator_(g));else if(""!=c&&c!=t)if(y.initializeAllowReset_)v=!0;else return b.reject(new je(Error("The supplied TPM locator does not match the TPM locator in the PIB: "+c+" != "+t)));return v?y.resetPromise_(a):b.resolve()}).then(function(){C.setUpTpm_(y.initializeTpm_,t);y.initializeTpm_.isInitialized_=!0;return y.doSetTpmLocatorPromise_(t,a)})};var C=a.KeyChain,je=a.LocatorMismatchError,Hc=a.PibIdentityContainer,c=a.Name,la=a.Pib,Uc=a.PibKeyContainer,
b=a.SyncPromise,rc=function(){};r.PibIdentityImpl=rc;rc.makePromise=function(a,v,w,f){var t=new rc;return Uc.makePromise(a,v,f).then(function(y){t.defaultKey_=null;t.identityName_=new c(a);t.keys_=y;t.pibImpl_=v;return null==v?b.reject(Error("The pibImpl is null")):w?v.addIdentityPromise(t.identityName_,f).then(function(){return b.resolve(t)}):v.hasIdentityPromise(t.identityName_,f).then(function(a){return a?b.resolve(t):b.reject(new la.Error(Error("Identity "+t.identityName_.toUri()+" does not exist")))})})};
rc.prototype.getName=function(){return this.identityName_};rc.prototype.addKeyPromise=function(a,b,c){return this.keys_.addPromise(a,b,c)};rc.prototype.removeKeyPromise=function(a,b){null!==this.defaultKey_&&this.defaultKey_.getName().equals(a)&&(this.defaultKey_=null);return this.keys_.removePromise(a,b)};rc.prototype.getKeyPromise=function(a,b){return this.keys_.getPromise(a,b)};rc.prototype.setDefaultKeyPromise=function(a,v,f){var g=this;if(a instanceof c){var t=a,y=v;return this.keys_.getPromise(t,
y).then(function(a){g.defaultKey_=a;return g.pibImpl_.setDefaultKeyOfIdentityPromise(g.identityName_,t,y)}).then(function(){return b.resolve(g.defaultKey_)})}t=v;y=f;return this.addKeyPromise(a,t,y).then(function(){return g.setDefaultKeyPromise(t,y)})};rc.prototype.getDefaultKeyPromise=function(a){var c=this;return null===this.defaultKey_?this.pibImpl_.getDefaultKeyOfIdentityPromise(this.identityName_,a).then(function(b){return c.keys_.getPromise(b,a)}).then(function(a){c.defaultKey_=a;return b.resolve(c.defaultKey_)}):
b.resolve(this.defaultKey_)};c=a.Name;Aa=a.PublicKey;m=a.Blob;la=a.Pib;qa=a.PibKey;ca=a.PibImpl;Tc=a.PibCertificateContainer;b=a.SyncPromise;Ub=function(){};r.PibKeyImpl=Ub;Ub.makePromise=function(a,v,f,g){var t=new Ub;t.defaultCertificate_=null;if(v instanceof ca){var y=v,l=f;return null==y?b.reject(Error("The pibImpl is null")):Tc.makePromise(a,y,l).then(function(b){t.identityName_=qa.extractIdentityFromKeyName(a);t.keyName_=new c(a);t.pibImpl_=y;t.certificates_=b;return t.pibImpl_.getKeyBitsPromise(t.keyName_,
l)}).then(function(a){t.keyEncoding_=a;try{publicKey=new Aa(t.keyEncoding_)}catch(c){return b.reject(new la.Error(Error("Error decoding public key")))}t.keyType_=publicKey.getKeyType();return b.resolve(t)})}y=f;l=g;return null==y?b.reject(Error("The pibImpl is null")):Tc.makePromise(a,y,l).then(function(f){t.identityName_=qa.extractIdentityFromKeyName(a);t.keyName_=new c(a);t.keyEncoding_=new m(v,!0);t.pibImpl_=y;t.certificates_=f;try{publicKey=new Aa(t.keyEncoding_),t.keyType_=publicKey.getKeyType()}catch(w){return b.reject(Error("Invalid key encoding"))}return t.pibImpl_.addKeyPromise(t.identityName_,
t.keyName_,v,l)}).then(function(){return b.resolve(t)})};Ub.prototype.getName=function(){return this.keyName_};Ub.prototype.getIdentityName=function(){return this.identityName_};Ub.prototype.getKeyType=function(){return this.keyType_};Ub.prototype.getPublicKey=function(){return this.keyEncoding_};Ub.prototype.addCertificatePromise=function(a,b){return this.certificates_.addPromise(a,b)};Ub.prototype.removeCertificatePromise=function(a,b){null!==this.defaultCertificate_&&this.defaultCertificate_.getName().equals(a)&&
(this.defaultCertificate_=null);return this.certificates_.removePromise(a,b)};Ub.prototype.getCertificatePromise=function(a,b){return this.certificates_.getPromise(a,b)};Ub.prototype.setDefaultCertificatePromise=function(a,f){var w=this,g;return b.resolve().then(function(){return a instanceof c?b.resolve(a):w.addCertificatePromise(a).then(function(){return b.resolve(a.getName())})}).then(function(a){g=a;return w.certificates_.getPromise(g,f)}).then(function(a){w.defaultCertificate_=a;return w.pibImpl_.setDefaultCertificateOfKeyPromise(w.keyName_,
g,f)}).then(function(){return b.resolve(w.defaultCertificate_)})};Ub.prototype.getDefaultCertificatePromise=function(a){var c=this;return null===this.defaultCertificate_?this.pibImpl_.getDefaultCertificateOfKeyPromise(this.keyName_,a).then(function(a){c.defaultCertificate_=a;return b.resolve(c.defaultCertificate_)}):b.resolve(c.defaultCertificate_)};var Ne=function(a,b,c,f,t){this.interest=a;this.onVerified=b;this.onValidationFailed=c;this.retry=f;this.stepCount=t};r.ValidationRequest=Ne;var W=a,
m=a.Blob,L=a.DataUtils,x=a.SecurityException,xb=a.DigestSha256Signature,Ja=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,Sa=a.VerificationHelpers,Ga=a.DigestAlgorithm,Aa=a.PublicKey,b=a.SyncPromise,ob=function(){};r.PolicyManager=ob;ob.prototype.skipVerifyAndTrust=function(a){throw Error("PolicyManager.skipVerifyAndTrust is not implemented");};ob.prototype.requireVerify=function(a){throw Error("PolicyManager.requireVerify is not implemented");};ob.prototype.checkVerificationPolicy=function(a,
b,c,f,t){throw Error("PolicyManager.checkVerificationPolicy is not implemented");};ob.prototype.checkSigningPolicy=function(a,b){throw Error("PolicyManager.checkSigningPolicy is not implemented");};ob.prototype.inferSigningIdentity=function(a){throw Error("PolicyManager.inferSigningIdentity is not implemented");};ob.verifyUsesString_=null;ob.setVerifyUsesString_=function(){var a=W.createHash("sha256").digest();ob.verifyUsesString_="string"===typeof a};ob.verifySignature=function(a,c,f,g){if(a instanceof
Ja||a instanceof Xa)if(f.isNull())g(!1);else{var t;try{t=new Aa(f)}catch(y){throw new x(Error("PolicyManager.verify: Error decoding public key: "+y));}b.complete(g,Sa.verifySignaturePromise(c.signedBuf(),a.getSignature(),t,Ga.SHA256,!g))}else if(a instanceof xb)g(Sa.verifyDigest(c.signedBuf(),a.getSignature(),Ga.SHA256));else throw new x(Error("PolicyManager.verify: Signature type is unknown"));};var Na=a.IdentityCertificate,kd=function(){this.cache={}};r.CertificateCache=kd;kd.prototype.insertCertificate=
function(a){var b=a.getName().getPrefix(-1);this.cache[b.toUri()]=a.wireEncode()};kd.prototype.deleteCertificate=function(a){delete this.cache[a.toUri()]};kd.prototype.getCertificate=function(a){a=this.cache[a.toUri()];if(void 0===a)return null;var b=new Na;b.wireDecode(a);return b};kd.prototype.reset=function(){this.cache={}};var ke=Rb=a,c=a.Name,R=a.Data,D=a.Interest,V=a.KeyLocator,ua=a.KeyLocatorType,m=a.Blob,Na=a.IdentityCertificate,N=a.CertificateV2,ec=a.CertificateCacheV2,lc=a.BoostInfoParser,
Za=a.NdnRegexTopMatcher,kd=a.CertificateCache,Ne=a.ValidationRequest,x=a.SecurityException,s=a.WireFormat,ob=a.PolicyManager,M=a.NdnCommon,za=function(a,b,c,f,t,y){ob.call(this);void 0==b&&(b=null);void 0==c&&(c=5);void 0==f&&(f=3E3);void 0==t&&(t=36E5);void 0==y&&(y=1E3);null==b&&(b=new kd);b instanceof kd?(this.isSecurityV1_=!0,this.certificateCache_=b,this.certificateCacheV2_=null):(this.isSecurityV1_=!1,this.certificateCache_=null,this.certificateCacheV2_=b);this.maxDepth=c;this.keyGraceInterval=
f;this.keyTimestampTtl=t;this.maxTrackedKeys=y;this.reset();null!=a&&""!=a&&this.load(a)};za.prototype=new ob;za.prototype.name="ConfigPolicyManager";r.ConfigPolicyManager=za;za.prototype.reset=function(){this.isSecurityV1_?this.certificateCache_.reset():this.certificateCacheV2_.clear();this.fixedCertificateCache={};this.keyTimestamps={};this.requiresVerification=!0;this.config=new lc;this.refreshManager=new za.TrustAnchorRefreshManager(this.isSecurityV1_)};za.prototype.load=function(a,b){this.reset();
this.config.read(a,b);this.loadTrustAnchorCertificates()};za.prototype.requireVerify=function(a){return this.requiresVerification};za.prototype.checkSigningPolicy=function(a,b){return!0};za.prototype.skipVerifyAndTrust=function(a){return!this.requiresVerification};za.prototype.checkVerificationPolicy=function(a,b,c,f,t){var y=a.getName(),g="data";a instanceof D&&(y=y.getPrefix(-4),g="interest");t=za.extractSignature(a,t);if(null==t){try{f(a,"Cannot extract the signature from "+a.getName().toUri())}catch(l){console.log("Error in onValidationFailed: "+
M.getErrorWithStackTrace(l))}return null}var m=["unknown"],y=this.getCertificateInterest_(b,g,y,t,m);if(null==y){try{f(a,m[0])}catch(n){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(n))}return null}if(0<y.getName().size()){var s=this;return new Ne(y,function(t){var y;if(s.isSecurityV1_){try{y=new Na(t)}catch(g){try{f(a,"Cannot decode certificate "+t.getName().toUri())}catch(Eb){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(Eb))}return null}s.certificateCache_.insertCertificate(y)}else{try{y=
new N(t)}catch(l){try{f(a,"Cannot decode certificate "+t.getName().toUri())}catch(ha){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(ha))}return null}s.certificateCacheV2_.insert(y)}s.checkVerificationPolicy(a,b+1,c,f)},f,2,b+1)}if(a instanceof D){var y=V.getFromSignature(t).getKeyName(),r;r=this.isSecurityV1_?Na.certificateNameToPublicKeyName(y):y;var x=a.getName().get(-4).toNumber();if(!this.interestTimestampIsFresh(r,x,m)){try{f(a,m[0])}catch(Eb){console.log("Error in onValidationFailed: "+
M.getErrorWithStackTrace(Eb))}return null}}s=this;this.verify(t,a.wireEncode(),function(b,v){if(b){try{c(a)}catch(t){console.log("Error in onVerified: "+M.getErrorWithStackTrace(t))}a instanceof D&&s.updateTimestampForKey(r,x)}else try{f(a,v)}catch(y){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(y))}})};za.prototype.getCertificateInterest_=function(a,b,c,f,t){if(a>this.maxDepth)return t[0]="The verification stepCount "+a+" exceeded the maxDepth "+this.maxDepth,null;var y;try{y=
this.findMatchingRule(c,b)}catch(g){return null}if(null==y)return t[0]="No matching rule found for "+c.toUri(),null;if(!V.canGetFromSignature(f))return t[0]="The signature type does not support a KeyLocator",null;a=a=V.getFromSignature(f);a=a.getKeyName();if(0==a.size())return t[0]="The signature KeyLocator doesn't have a key name",null;if(!this.checkSignatureMatch(a,c,y,t))return null;this.refreshManager.refreshAnchors();this.isSecurityV1_?(c=this.refreshManager.getCertificate(a),null==c&&(c=this.certificateCache_.getCertificate(a))):
(c=this.refreshManager.getCertificateV2(a),null==c&&(c=this.certificateCacheV2_.find(a)));return null==c?new D(a):new D};za.prototype.loadTrustAnchorCertificates=function(){for(var a=this.config.getRoot().get("validator/trust-anchor"),b=0;b<a.length;++b){var c=a[b],f=c.get("type")[0].getValue(),t=!1,y;if("file"==f)y=c.get("file-name")[0].getValue(),t=!0;else if("base64"==f)y=c.get("base64-string")[0].getValue(),t=!1;else if("dir"==f){f=c.get("dir")[0].getValue();t=0;c=c.get("refresh");1<=c.length&&
(c=c[0].getValue().match(/(\d+)([hms])/),null==c?t=0:(t=parseInt(c[1]),"s"!=c[2]&&(t*=60,"m"!=c[2]&&(t*=60))));this.refreshManager.addDirectory(f,1E3*t);continue}else if("any"==f){this.requiresVerification=!1;break}this.isSecurityV1_?this.lookupCertificate(y,t):this.lookupCertificateV2(y,t)}};za.prototype.checkSignatureMatch=function(a,b,f,g){f=f.get("checker")[0];var t=f.get("type")[0].getValue();if("fixed-signer"==t){b=f.get("signer")[0];f=b.get("type")[0].getValue();if("file"==f){if(f=this.isSecurityV1_?
this.lookupCertificate(b.get("file-name")[0].getValue(),!0):this.lookupCertificateV2(b.get("file-name")[0].getValue(),!0),null==f)return g[0]="Can't find fixed-signer certificate file: "+b.get("file-name")[0].getValue(),!1}else if("base64"==f){if(f=this.isSecurityV1_?this.lookupCertificate(b.get("base64-string")[0].getValue(),!1):this.lookupCertificateV2(b.get("base64-string")[0].getValue(),!1),null==f)return g[0]="Can't find fixed-signer certificate base64: "+b.get("base64-string")[0].getValue(),
!1}else return g[0]="Unrecognized fixed-signer signerType: "+f,!1;if(f.getName().equals(a))return!0;g[0]='fixed-signer cert name "'+f.getName().toUri()+'" does not equal signatureName "'+a.toUri()+'"';return!1}if("hierarchical"==t){f=new Za("^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>");if(f.match(a)){a=f.expand("\\1").append(f.expand("\\2"));if(za.matchesRelation(b,a,"is-prefix-of"))return!0;g[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}if(!this.isSecurityV1_&&
(f=new Za("^(<>*)<KEY><>$"),f.match(a))){a=f.expand("\\1");if(za.matchesRelation(b,a,"is-prefix-of"))return!0;g[0]='The hierarchical objectName "'+b.toUri()+'" is not a prefix of "'+a.toUri()+'"';return!1}g[0]='The hierarchical identityRegex "^([^<KEY>]*)<KEY>(<>*)<ksk-.+><ID-CERT>" does not match signatureName "'+a.toUri()+'"';return!1}if("customized"==t){var y=f.get("key-locator")[0];f=y.getFirstValue("relation");if(null!=f){b=new c(y.get("name")[0].getValue());if(za.matchesRelation(a,b,f))return!0;
g[0]='The custom signatureName "'+a.toUri()+'" does not match matchName "'+b.toUri()+'" using relation '+f;return!1}var l=y.getFirstValue("regex");if(null!=l){if((new Za(simpleKeyRegex)).match(a))return!0;g[0]='The custom signatureName "'+a.toUri()+'" does not regex match simpleKeyRegex "'+l+'"';return!1}f=y.get("hyper-relation");if(1<=f.length){f=f[0];var l=f.getFirstValue("k-regex"),ha=f.getFirstValue("k-expand"),y=f.getFirstValue("p-regex"),m=f.getFirstValue("p-expand");f=f.getFirstValue("h-relation");
if(null!=l&&null!=ha&&null!=y&&null!=m&&null!=f){t=new Za(l);if(!t.match(a))return g[0]='The custom hyper-relation signatureName "'+a.toUri()+'" does not match the keyRegex "'+l+'"',!1;a=t.expand(ha);t=new Za(y);if(!t.match(b))return g[0]='The custom hyper-relation objectName "'+b.toUri()+'" does not match the nameRegex "'+y+'"',!1;b=t.expand(m);if(za.matchesRelation(b,a,f))return!0;g[0]='The custom hyper-relation nameMatch "'+b.toUri()+'" does not match the keyMatchPrefix "'+a.toUri()+'" using relation '+
f;return!1}}}g[0]="Unrecognized checkerType: "+t;return!1};za.prototype.lookupCertificate=function(a,b){if(!this.isSecurityV1_)throw new x(Error("lookupCertificate: For security v2, use lookupCertificateV2()"));var f;f=this.fixedCertificateCache[a];if(void 0===f){if(b)f=za.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(a);else{var l=new g(a,"base64");f=new Na;f.wireDecode(l)}l=f.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=l;this.certificateCache_.insertCertificate(f)}else f=
this.certificateCache_.getCertificate(new c(f));return f};za.prototype.lookupCertificateV2=function(a,b){if(this.isSecurityV1_)throw new x(Error("lookupCertificateV2: For security v1, use lookupCertificate()"));var f;f=this.fixedCertificateCache[a];if(void 0===f){if(b)f=za.TrustAnchorRefreshManager.loadCertificateV2FromFile(a);else{var l=new g(a,"base64");f=new N;f.wireDecode(l)}l=f.getName().getPrefix(-1).toUri();this.fixedCertificateCache[a]=l;this.certificateCacheV2_.insert(f)}else f=this.certificateCacheV2_.find(new c(f));
return f};za.prototype.findMatchingRule=function(a,b){for(var f=this.config.getRoot().get("validator/rule"),g=0;g<f.length;++g){var t=f[g];if(t.get("for")[0].getValue()==b){var y=!0,l=t.get("filter");if(0==l.length)return t;for(var ha=0;ha<l.length;++ha){var m=l[ha],y=m.getFirstValue("regex");null===y?(y=m.get("relation")[0].getValue(),m=m.get("name")[0].getValue(),m=new c(m),y=za.matchesRelation(a,m,y)):y=(new Za(y)).match(a);if(!y)break}if(y)return t}}return null};za.matchesRelation=function(a,
b,c){var f=!1;"is-strict-prefix-of"==c?b.size()==a.size()?f=!1:b.match(a)&&(f=!0):"is-prefix-of"==c?b.match(a)&&(f=!0):"equal"==c&&b.equals(a)&&(f=!0);return f};za.extractSignature=function(a,b){if(a instanceof R)return a.getSignature();if(a instanceof D){b=b||s.getDefaultWireFormat();try{var c=b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(f){return null}return c}return null};za.prototype.interestTimestampIsFresh=function(a,b,c){a=
this.keyTimestamps[a.toUri()];if(void 0==a){a=(new Date).getTime();var f=a+this.keyGraceInterval;if(b>a-this.keyGraceInterval&&b<f)return!0;c[0]="The command interest timestamp is not within the first use grace period of "+this.keyGraceInterval+" milliseconds.";return!1}return b<=a?(c[0]="The command interest timestamp is not newer than the previous timestamp",!1):!0};za.prototype.updateTimestampForKey=function(a,b){this.keyTimestamps[a.toUri()]=b;var c=0,f=[],t=(new Date).getTime(),y=t,g=null,l;
for(l in this.keyTimestamps){++c;var m=this.keyTimestamps[l];t-m>this.keyTimestampTtl?f.push(l):m<y&&(y=m,g=l)}if(c>=this.maxTrackedKeys){for(t=0;t<f.length;++t)delete this.keyTimestamps[f[t]],--c;c>this.maxTrackedKeys&&delete this.keyTimestamps[g]}};za.prototype.verify=function(a,b,c){var f=V.getFromSignature(a);if(f.getType()==ua.KEYNAME){var f=f.getKeyName(),t;if(this.isSecurityV1_){var y=this.refreshManager.getCertificate(f);null==y&&(y=this.certificateCache_.getCertificate(f));if(null==y){c(!1,
"Cannot find a certificate with name "+f.toUri());return}t=y.getPublicKeyInfo().getKeyDer();if(t.isNull()){c(!1,"There is no public key in the certificate with name "+y.getName().toUri());return}}else{y=this.refreshManager.getCertificateV2(f);null==y&&(y=this.certificateCacheV2_.find(f));if(null==y){c(!1,"Cannot find a certificate with name "+f.toUri());return}try{t=y.getPublicKey()}catch(g){c(!1,"There is no public key in the certificate with name "+y.getName().toUri());return}}ob.verifySignature(a,
b,t,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}else c(!1,"The KeyLocator does not have a key name")};za.TrustAnchorRefreshManager=function(a){this.isSecurityV1_=a;this.certificateCache_=new kd;this.certificateCacheV2_=new ec;this.refreshDirectories={}};za.TrustAnchorRefreshManager.loadIdentityCertificateFromFile=function(a){a=Rb.readFileSync(a).toString();a=new g(a,"base64");var b=new Na;b.wireDecode(new m(a,!1));return b};za.TrustAnchorRefreshManager.loadCertificateV2FromFile=
function(a){a=Rb.readFileSync(a).toString();a=new g(a,"base64");var b=new N;b.wireDecode(new m(a,!1));return b};za.TrustAnchorRefreshManager.prototype.getCertificate=function(a){if(!this.isSecurityV1_)throw new x(Error("getCertificate: For security v2, use getCertificateV2()"));return this.certificateCache_.getCertificate(a)};za.TrustAnchorRefreshManager.prototype.getCertificateV2=function(a){if(this.isSecurityV1_)throw new x(Error("getCertificateV2: For security v1, use getCertificate()"));return this.certificateCacheV2_.find(a)};
za.TrustAnchorRefreshManager.prototype.addDirectory=function(a,b){var c;try{c=Rb.readdirSync(a)}catch(f){throw new x(Error("Cannot list files in directory "+a));}for(var t=[],y=0;y<c.length;++y){if(this.isSecurityV1_){var g;try{var l=ke.join(a,c[y]);g=za.TrustAnchorRefreshManager.loadIdentityCertificateFromFile(l)}catch(m){continue}var n=g.getName().getPrefix(-1).toUri();this.certificateCache_.insertCertificate(g)}else{try{l=ke.join(a,c[y]),g=za.TrustAnchorRefreshManager.loadCertificateV2FromFile(l)}catch(s){continue}n=
N.extractKeyNameFromCertName(g.getName()).toUri();this.certificateCacheV2_.insert(g)}t.push(n)}this.refreshDirectories[a]={certificates:t,nextRefresh:(new Date).getTime()+b,refreshPeriod:b}};za.TrustAnchorRefreshManager.prototype.refreshAnchors=function(){var a=(new Date).getTime(),b;for(b in this.refreshDirectories){var f=this.refreshDirectories[b];if(f.nextRefresh<=a){for(var g=f.certificates.slice(0),t=0;t<g.length;++t)try{if(this.isSecurityV1_)this.certificateCache_.deleteCertificate(new c(g[t]));
else{var y=this.certificateCacheV2_.find(new c(g[t]));null!=y&&this.certificateCacheV2_.deleteCertificate(y.getName())}}catch(l){}this.addDirectory(b,f.refreshPeriod)}}};var c=a.Name,ob=a.PolicyManager,M=a.NdnCommon,hc=function(){ob.call(this)};hc.prototype=new ob;hc.prototype.name="NoVerifyPolicyManager";r.NoVerifyPolicyManager=hc;hc.prototype.skipVerifyAndTrust=function(a){return!0};hc.prototype.requireVerify=function(a){return!1};hc.prototype.checkVerificationPolicy=function(a,b,c,f,t){try{c(a)}catch(y){console.log("Error in onVerified: "+
M.getErrorWithStackTrace(y))}return null};hc.prototype.checkSigningPolicy=function(a,b){return!0};hc.prototype.inferSigningIdentity=function(a){return new c};var c=a.Name,D=a.Interest,R=a.Data,m=a.Blob,Na=a.IdentityCertificate,V=a.KeyLocator,ua=a.KeyLocatorType,x=a.SecurityException,s=a.WireFormat,b=a.SyncPromise,ob=a.PolicyManager,ba=a.IdentityStorage,M=a.NdnCommon,Vc=function(a){ob.call(this);a instanceof ba?(this.identityStorage_=a,this.pibImpl_=null):(this.identityStorage_=null,this.pibImpl_=
a)};Vc.prototype=new ob;Vc.prototype.name="SelfVerifyPolicyManager";r.SelfVerifyPolicyManager=Vc;Vc.prototype.skipVerifyAndTrust=function(a){return!1};Vc.prototype.requireVerify=function(a){return!0};Vc.prototype.checkVerificationPolicy=function(a,b,c,f,t){t=t||s.getDefaultWireFormat();if(a instanceof R)this.verify(a.getSignature(),a.wireEncode(),function(b,t){if(b)try{c(a)}catch(v){console.log("Error in onVerified: "+M.getErrorWithStackTrace(v))}else try{f(a,t)}catch(y){console.log("Error in onValidationFailed: "+
M.getErrorWithStackTrace(y))}});else if(a instanceof D){if(2>a.getName().size()){try{f(a,"The signed interest has less than 2 components: "+a.getName().toUri())}catch(y){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(y))}return}var g;try{g=t.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(l){try{f(a,"Error decoding the signed interest signature: "+l)}catch(m){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(m))}return}this.verify(g,
a.wireEncode(),function(b,t){if(b)try{c(a)}catch(v){console.log("Error in onVerified: "+M.getErrorWithStackTrace(v))}else try{f(a,t)}catch(y){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(y))}})}else throw new x(Error("checkVerificationPolicy: unrecognized type for dataOrInterest"));return null};Vc.prototype.checkSigningPolicy=function(a,b){return!0};Vc.prototype.inferSigningIdentity=function(a){return new c};Vc.prototype.verify=function(a,b,c){if(V.canGetFromSignature(a))this.getPublicKeyDer(V.getFromSignature(a),
function(f,y){if(f.isNull())c(!1,y);else try{ob.verifySignature(a,b,f,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(g){c(!1,"Error in verifySignature: "+g)}});else try{ob.verifySignature(a,b,null,function(a){a?c(!0):c(!1,"The signature did not verify with the given public key")})}catch(f){c(!1,"Error in verifySignature: "+f)}};Vc.prototype.getPublicKeyDer=function(a,c){if(a.getType()==ua.KEYNAME&&null!=this.identityStorage_){var f;try{f=Na.certificateNameToPublicKeyName(a.getKeyName())}catch(g){c(new m,
"Cannot get a public key name from the certificate named: "+a.getKeyName().toUri());return}b.complete(c,function(a){c(new m,"The identityStorage doesn't have the key named "+f.toUri())},this.identityStorage_.getKeyPromise(f,!c))}else a.getType()==ua.KEYNAME&&null!=this.pibImpl_?b.complete(c,function(a){c(new m,"The identityStorage doesn't have the key named "+f.toUri())},this.pibImpl_.getKeyBitsPromise(a.getKeyName(),!c)):c(new m,"The signature KeyLocator doesn't have a key name")};var W=a,c=a.Name,
m=a.Blob,yb=a.KeyIdType,qa=a.PibKey,db=a.Tpm,b=a.SyncPromise,Ha=function(){};r.TpmBackEnd=Ha;Ha.Error=function(a){if(a)return a.__proto__=Ha.Error.prototype,a};Ha.Error.prototype=Error();Ha.Error.prototype.name="TpmBackEndError";Ha.prototype.hasKeyPromise=function(a,b){return this.doHasKeyPromise_(a,b)};Ha.prototype.getKeyHandlePromise=function(a,b){return this.doGetKeyHandlePromise_(a,b)};Ha.prototype.createKeyPromise=function(a,f,w){var g=this;return b.resolve().then(function(){if(f.getKeyIdType()==
yb.USER_SPECIFIED){var t=qa.constructKeyName(a,f.getKeyId());return g.hasKeyPromise(t,w).then(function(a){return a?b.reject(new db.Error(Error("Key `"+t.toUri()+"` already exists"))):b.resolve()})}if(f.getKeyIdType()==yb.SHA256)return b.resolve();if(f.getKeyIdType()==yb.RANDOM){var y,l=function(){var f=W.randomBytes(8);y=new c.Component(new m(f,!1));f=qa.constructKeyName(a,y);return g.hasKeyPromise(f,w).then(function(a){return a?l():b.resolve()})};return l().then(function(){f.setKeyId(y);return b.resolve()})}return b.reject(new db.Error(Error("Unsupported key id type")))}).then(function(){return g.doCreateKeyPromise_(a,
f,w)})};Ha.prototype.deleteKeyPromise=function(a,b){return this.doDeleteKeyPromise_(a,b)};Ha.prototype.exportKeyPromise=function(a,c,f){var g=this;return this.hasKeyPromise(a,f).then(function(t){return t?g.doExportKeyPromise_(a,c,f):b.reject(new Ha.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Ha.prototype.importKeyPromise=function(a,c,f,g){var t=this;return this.hasKeyPromise(a,g).then(function(y){return y?b.reject(new Ha.Error(Error("Key `"+a.toUri()+"` already exists"))):t.doImportKeyPromise_(a,
c,f,g)})};Ha.setKeyName=function(a,b,f){if(f.getKeyIdType()==yb.USER_SPECIFIED)f=f.getKeyId();else if(f.getKeyIdType()==yb.SHA256)f=W.createHash("sha256"),f.update(a.derivePublicKey().buf()),f=c.Component(new m(f.digest(),!1));else if(f.getKeyIdType()==yb.RANDOM){if(0==f.getKeyId().getValue().size())throw new Ha.Error(Error("setKeyName: The keyId is empty for type RANDOM"));f=f.getKeyId()}else throw new Ha.Error(Error("setKeyName: unrecognized params.getKeyIdType()"));a.setKeyName(qa.constructKeyName(b,
f))};Ha.prototype.doHasKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doHasKeyPromise_ is not implemented"))};Ha.prototype.doGetKeyHandlePromise_=function(a,c){return b.reject(Error("TpmBackEnd.doGetKeyHandlePromise_ is not implemented"))};Ha.prototype.doCreateKeyPromise_=function(a,c,f){return b.reject(Error("TpmBackEnd.doCreateKeyPromise_ is not implemented"))};Ha.prototype.doDeleteKeyPromise_=function(a,c){return b.reject(Error("TpmBackEnd.doDeleteKeyPromise_ is not implemented"))};
Ha.prototype.doExportKeyPromise_=function(a,c,f){return b.reject(Error("TpmBackEnd.doExportKeyPromise_ is not implemented"))};Ha.prototype.doImportKeyPromise_=function(a,c,f,g){return b.reject(Error("TpmBackEnd.doImportKeyPromise_ is not implemented"))};var b=a.SyncPromise,Q=a.TpmPrivateKey,Ad=a.TpmKeyHandleMemory,Ha=a.TpmBackEnd,dc=function(){Ha.call(this);this.keys_={}};dc.prototype=new Ha;dc.prototype.name="TpmBackEndMemory";r.TpmBackEndMemory=dc;dc.getScheme=function(){return"tpm-memory"};dc.prototype.doHasKeyPromise_=
function(a,c){return b.resolve(a.toUri()in this.keys_)};dc.prototype.doGetKeyHandlePromise_=function(a,c){var f=this.keys_[a.toUri()];return void 0==f?b.resolve(null):b.resolve(new Ad(f))};dc.prototype.doCreateKeyPromise_=function(a,c,f){var g=this;return Q.generatePrivateKeyPromise(c,f).then(function(f){var w=new Ad(f);Ha.setKeyName(w,a,c);g.keys_[w.getKeyName().toUri()]=f;return b.resolve(w)},function(a){return b.reject(new Ha.Error(Error("Error in TpmPrivateKey.generatePrivateKey: "+a)))})};dc.prototype.doDeleteKeyPromise_=
function(a,c){delete this.keys_[a.toUri()];return b.resolve()};Ha.prototype.doExportKeyPromise_=function(a,c,f){a=a.toUri();if(!(a in this.keys_))return b.reject(new Ha.Error(Error("exportKey: The key does not exist")));try{return null!=c?b.resolve(this.keys_[a].toEncryptedPkcs8(c)):b.resolve(this.keys_[a].toPkcs8())}catch(g){return b.reject(new Ha.Error(Error("Error in toPkcs8: "+g)))}};dc.prototype.doImportKeyPromise_=function(a,c,f,g){try{var t=new Q;null!=f?t.loadEncryptedPkcs8(c,f):t.loadPkcs8(c);
this.keys_[a.toUri()]=t;return b.resolve()}catch(y){return b.reject(new Ha.Error(Error("Cannot import private key: "+y)))}};var c=a.Name,b=a.SyncPromise,ic=function(){this.keyName_=new c};r.TpmKeyHandle=ic;ic.prototype.signPromise=function(a,b,c){return this.doSignPromise_(a,b,c)};ic.prototype.decryptPromise=function(a,b){return this.doDecryptPromise_(a,b)};ic.prototype.derivePublicKey=function(a){return this.doDerivePublicKey_(a)};ic.prototype.setKeyName=function(a){this.keyName_=new c(a)};ic.prototype.getKeyName=
function(){return this.keyName_};ic.prototype.doSignPromise_=function(a,c,f){return b.reject(Error("TpmKeyHandle.doSignPromise_ is not implemented"))};ic.prototype.doDecryptPromise_=function(a,c){return b.reject(Error("TpmKeyHandle.doDecryptPromise_ is not implemented"))};ic.prototype.doDerivePublicKey_=function(a){return b.reject(Error("TpmKeyHandle.doDerivePublicKey_ is not implemented"))};m=a.Blob;b=a.SyncPromise;Ga=a.DigestAlgorithm;Q=a.TpmPrivateKey;Ha=a.TpmBackEnd;ic=a.TpmKeyHandle;Ad=function(a){ic.call(this);
if(null==a)throw Error("The key is null");this.key_=a};Ad.prototype=new ic;Ad.prototype.name="TpmKeyHandleMemory";r.TpmKeyHandleMemory=Ad;Ad.prototype.doSignPromise_=function(a,c,f){return a==Ga.SHA256?this.key_.signPromise(c,a,f).catch(function(a){return b.reject(new Ha.Error(Error("Error in TpmPrivateKey.sign: "+a)))}):b.resolve(new m)};Ad.prototype.doDecryptPromise_=function(a,c){return this.key_.decryptPromise(a,c).catch(function(a){return b.reject(new Ha.Error(Error("Error in TpmPrivateKey.decrypt: "+
a)))})};ic.prototype.doDerivePublicKey_=function(){try{return this.key_.derivePublicKey()}catch(a){throw new Ha.Error(Error("Error in TpmPrivateKey.derivePublicKey: "+a));}};var xd=a.constants,W=a,ea=a.KeyType,fa=a.EncryptAlgorithmType,Ga=a.DigestAlgorithm,L=a.DataUtils,b=a.SyncPromise,l=a.DerNode,Yd=a.DerNode.DerSequence,ld=a.DerNode.DerInteger,lb=a.OID,m=a.Blob,Hb=a.UseSubtleCrypto,Fc=null;try{Fc=a}catch(mf){}Q=function(){this.decryptSubtleKey_=this.subtleKey_=this.privateKey_=this.keyType_=null};
r.TpmPrivateKey=Q;Q.Error=function(a){if(a)return a.__proto__=Q.Error.prototype,a};Q.Error.prototype=Error();Q.Error.prototype.name="TpmPrivateKeyError";Q.prototype.loadPkcs1=function(a,b){a instanceof m&&(a=a.buf());if(void 0==b)try{var c=l.parse(a).getChildren();b=9==c.length&&c[0]instanceof ld&&0==c[0].toVal()&&c[1]instanceof ld&&c[2]instanceof ld&&c[3]instanceof ld&&c[4]instanceof ld&&c[5]instanceof ld&&c[6]instanceof ld&&c[7]instanceof ld&&c[8]instanceof ld?ea.RSA:ea.EC}catch(f){b=ea.EC}if(b==
ea.EC){for(var c=a.toString("base64"),t="-----BEGIN EC PRIVATE KEY-----\n",g=0;g<c.length;g+=64)t+=c.substr(g,64)+"\n";this.privateKey_=t+"-----END EC PRIVATE KEY-----"}else if(b==ea.RSA){c=a.toString("base64");t="-----BEGIN RSA PRIVATE KEY-----\n";for(g=0;g<c.length;g+=64)t+=c.substr(g,64)+"\n";this.privateKey_=t+="-----END RSA PRIVATE KEY-----"}else throw new Q.Error(Error("loadPkcs1: Unrecognized keyType: "+b));this.keyType_=b;this.decryptSubtleKey_=this.subtleKey_=null};Q.prototype.loadPkcs8=
function(a,b){a instanceof m&&(a=a.buf());var c;if(void 0==b){var f;try{var t=l.parse(a),g=t.getChildren();f=l.getSequence(g,1).getChildren()[0].toVal();c=g[2].toVal()}catch(n){try{this.loadPkcs1(a);return}catch(ha){throw new Q.Error(Error("loadPkcs8: Error decoding private key: "+ha));}}if(f==Q.EC_ENCRYPTION_OID)b=ea.EC;else if(f==Q.RSA_ENCRYPTION_OID)b=ea.RSA;else throw new Q.Error(Error("loadPkcs8: Unrecognized private key OID: "+f));}else t=l.parse(a),c=t.getChildren()[2].toVal();this.loadPkcs1(c,
b)};Q.prototype.loadEncryptedPkcs8=function(a,b){a instanceof m&&(a=a.buf());b instanceof m&&(b=b.buf());var c,f,t;try{var y=l.parse(a,0).getChildren(),n=l.getSequence(y,0).getChildren();c=n[0].toVal();f=n[1];t=y[1].toVal()}catch(ha){throw new Q.Error(Error("Cannot decode the PKCS #8 EncryptedPrivateKeyInfo: "+ha));}var s;if(c==Q.PBES2_OID){var r,x,F,P;try{var Eb=f.getChildren(),mb=l.getSequence(Eb,0).getChildren();r=mb[0].toVal();x=mb[1];var ze=l.getSequence(Eb,1).getChildren();F=ze[0].toVal();P=
ze[1]}catch(Oe){throw new Q.Error(Error("Cannot decode the PBES2 parameters: "+Oe));}c=null;if(r==Q.PBKDF2_OID){var Ae,Be;try{var Ce=x.getChildren();Ae=Ce[0].toVal();Be=Ce[1].toVal()}catch(De){throw new Q.Error(Error("Cannot decode the PBES2 parameters: "+De));}if(F==Q.DES_EDE3_CBC_OID)r=Q.DES_EDE3_KEY_LENGTH;else throw new Q.Error(Error("Unrecognized PBES2 encryption scheme OID: "+F));try{c=W.pbkdf2Sync(b,Ae.buf(),Be,r,"sha1")}catch(Bd){throw new Q.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
Bd));}}else throw new Q.Error(Error("Unrecognized PBES2 key derivation OID: "+r));if(F==Q.DES_EDE3_CBC_OID){var Md;try{Md=P.toVal()}catch(sc){throw new Q.Error(Error("Cannot decode the DES-EDE3-CBC parameters: "+sc));}try{var Ab=W.createDecipheriv("des-ede3-cbc",c,Md.buf());s=g.concat([Ab.update(t.buf()),Ab.final()])}catch(Pe){throw new Q.Error(Error("Error decrypting PKCS #8 key with DES-EDE3-CBC: "+Pe));}}else throw new Q.Error(Error("Unrecognized PBES2 encryption scheme OID: "+F));}else throw new Q.Error(Error("Unrecognized PKCS #8 EncryptedPrivateKeyInfo OID: "+
c));this.loadPkcs8(s)};Q.prototype.derivePublicKey=function(){if(this.keyType_!=ea.RSA)throw new Q.Error(Error("derivePublicKey: The private key is not loaded"));try{var a=L.privateKeyPemToDer(this.privateKey_),b=l.parse(a,0).getChildren(),c=b[1],f=b[2],t=new l.DerSequence;t.addChild(c);t.addChild(f);var g=t.encode(),m=new l.DerSequence;m.addChild(new l.DerOid(new lb(Q.RSA_ENCRYPTION_OID)));m.addChild(new l.DerNull);var ha=new l.DerSequence;ha.addChild(m);ha.addChild(new l.DerBitString(g.buf(),0));
return ha.encode()}catch(n){throw new Q.Error(Error("derivePublicKey: Error decoding private key "+n));}};Q.prototype.decryptPromise=function(a,c,f){"boolean"===typeof c&&(f=c,c=void 0);void 0==c&&(c=fa.RsaOaep);if(null==this.keyType_)return b.reject(new Q.Error(Error("decrypt: The private key is not loaded")));if(Hb()&&!f&&c!=fa.RsaPkcs)return c==fa.RsaOaep?this.getDecryptSubtleKeyPromise_().then(function(b){return crypto.subtle.decrypt({name:"RSA-OAEP"},b,a)}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),
!1))}):Promise.reject(Error("Unsupported padding scheme"));if(c==fa.RsaPkcs)c=xd.RSA_PKCS1_PADDING;else if(c==fa.RsaOaep)c=xd.RSA_PKCS1_OAEP_PADDING;else return b.reject(new Q.Error(Error("Unsupported padding scheme")));try{return b.resolve(new m(W.privateDecrypt({key:this.privateKey_,padding:c},a),!1))}catch(g){return b.reject(new Q.Error(g))}};Q.prototype.signPromise=function(a,c,f){if(null==this.keyType_)return b.resolve(new m);if(c!=Ga.SHA256)return b.reject(new Q.Error(Error("TpmPrivateKey.sign: Unsupported digest algorithm")));
if(Hb()&&!f){var l;if(this.keyType_===ea.RSA)l={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};else return b.reject(new Q.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));return this.getSubtleKeyPromise_().then(function(b){return crypto.subtle.sign(l,b,a)}).then(function(a){a=new m(new Uint8Array(a),!0);return Promise.resolve(a)})}if(this.keyType_===ea.RSA)c=W.createSign("RSA-SHA256");else if(this.keyType===ea.EC)c=W.createSign("sha256");else return b.reject(new Q.Error(Error("signPromise: Unrecognized key type "+
this.keyType_)));c.update(a);c=new g(L.toNumbersIfString(c.sign(this.privateKey_)));c=new m(c,!1);return b.resolve(c)};Q.prototype.toPkcs1=function(){if(null==this.keyType_)throw new Q.Error(Error("toPkcs1: The private key is not loaded"));return new m(L.privateKeyPemToDer(this.privateKey_),!1)};Q.prototype.toPkcs8=function(){if(null==this.keyType_)throw new Q.Error(Error("toPkcs8: The private key is not loaded"));var a;if(this.keyType_===ea.RSA)a=new lb(Q.RSA_ENCRYPTION_OID);else if(this.keyType===
ea.EC)a=new lb(Q.EC_ENCRYPTION_OID);else throw new Q.Error(Error("toPkcs8: Unrecognized key type "+this.keyType_));return Q.encodePkcs8PrivateKey(this.toPkcs1().buf(),a,new l.DerNull)};Q.prototype.toEncryptedPkcs8=function(a){if(null==this.keyType_)throw new Q.Error(Error("toPkcs8: The private key is not loaded"));a instanceof m&&(a=a.buf());var b=W.randomBytes(8),c;try{c=W.pbkdf2Sync(a,b,2048,Q.DES_EDE3_KEY_LENGTH,"sha1")}catch(f){throw new Q.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
f));}var t;a=W.randomBytes(8);try{var y=W.createCipheriv("des-ede3-cbc",c,a);t=g.concat([y.update(this.toPkcs8().buf()),y.final()])}catch(n){throw new Q.Error(Error("Error encrypting PKCS #8 key with DES-EDE3-CBC: "+n));}try{var ha=new Yd;ha.addChild(new l.DerOctetString(b));ha.addChild(new l.DerInteger(2048));var s=new Yd;s.addChild(new l.DerOid(Q.PBKDF2_OID));s.addChild(ha);var r=new Yd;r.addChild(new l.DerOid(Q.DES_EDE3_CBC_OID));r.addChild(new l.DerOctetString(a));var x=new Yd;x.addChild(s);x.addChild(r);
var F=new Yd;F.addChild(new l.DerOid(Q.PBES2_OID));F.addChild(x);var P=new Yd;P.addChild(F);P.addChild(new l.DerOctetString(t));return P.encode()}catch(Eb){throw new Q.Error(Error("Error encoding the encryped PKCS #8 private key: "+Eb));}};Q.generatePrivateKeyPromise=function(a,c){if(Hb()&&!c){if(a.getKeyType()===ea.RSA){var f=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){f=
a.privateKey;return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){var c=new Q;c.loadPkcs8(new m(new Uint8Array(a),!1),ea.RSA);c.subtleKey_=f;return b.resolve(c)})}return Promise.reject(Error("Cannot generate a key pair of type "+a.getKeyType()))}var g;if(a.getKeyType()===ea.RSA){if(!Fc)return b.reject(new Q.Error(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));g=Fc.generate(a.getKeySize()).privateKey.toString()}else return b.reject(Error("Cannot generate a key pair of type "+
a.getKeyType()));var t=new Q;t.privateKey_=g;t.keyType_=a.getKeyType();return b.resolve(t)};Q.encodePkcs8PrivateKey=function(a,b,c){var f=new l.DerSequence;f.addChild(new l.DerOid(b));f.addChild(c);b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(f);b.addChild(new l.DerOctetString(a));return b.encode()};Q.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(0));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));
b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.d)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.p)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.q)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.dmp1)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.dmq1)));b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.coeff)));return b.encode()};Q.encodePublicKeyFromRSAKey=function(a){var b=new l.DerSequence;b.addChild(new l.DerInteger(Q.bigIntegerToBuffer(a.n)));b.addChild(new l.DerInteger(a.e));
a=new l.DerSequence;a.addChild(new l.DerOid(new lb(Q.RSA_ENCRYPTION_OID)));a.addChild(new l.DerNull);var c=new l.DerSequence;c.addChild(a);c.addChild(new l.DerBitString(b.encode().buf(),0));return c.encode()};Q.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("TpmPrivateKey.bigIntegerToBuffer: Negative integers are not currently supported");1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new g(a,"hex")};Q.prototype.getSubtleKeyPromise_=function(){if(this.subtleKey_)return Promise.resolve(this.subtleKey_);
if(this.keyType_===ea.RSA){var a=L.privateKeyPemToDer(this.privateKey_),a=Q.encodePkcs8PrivateKey(a,new lb(Q.RSA_ENCRYPTION_OID),new l.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){c.subtleKey_=a;return Promise.resolve(c.subtleKey_)})}return b.reject(new Q.Error(Error("Unrecognized key type "+this.keyType_)))};Q.prototype.getDecryptSubtleKeyPromise_=function(){if(this.decryptSubtleKey_)return Promise.resolve(this.decryptSubtleKey_);
if(this.keyType_===ea.RSA){var a=L.privateKeyPemToDer(this.privateKey_),a=Q.encodePkcs8PrivateKey(a,new lb(Q.RSA_ENCRYPTION_OID),new l.DerNull).buf(),c=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){c.decryptSubtleKey_=a;return Promise.resolve(c.decryptSubtleKey_)})}return b.reject(new Q.Error(Error("Unrecognized key type "+this.keyType_)))};Q.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Q.EC_ENCRYPTION_OID="1.2.840.10045.2.1";Q.PBES2_OID=
"1.2.840.113549.1.5.13";Q.PBKDF2_OID="1.2.840.113549.1.5.12";Q.DES_EDE3_CBC_OID="1.2.840.113549.3.7";Q.DES_EDE3_KEY_LENGTH=24;ea=a.KeyType;b=a.SyncPromise;db=function(a,b,c){this.keys_={};this.scheme_=a;this.location_=b;this.backEnd_=c;this.initializePib_=null;this.isInitialized_=!1};r.Tpm=db;db.Error=function(a){if(a)return a.__proto__=db.Error.prototype,a};db.Error.prototype=Error();db.Error.prototype.name="TpmError";db.prototype.getTpmLocator=function(){if(!this.isInitialized_)throw new db.Error(Error("getTpmLocator: The Tpm is not initialized"));
return this.scheme_+":"+this.location_};db.prototype.hasKeyPromise=function(a,b){var c=this;return this.initializePromise_(b).then(function(){return c.backEnd_.hasKeyPromise(a,b)})};db.prototype.getPublicKeyPromise=function(a,c){var f=this;return this.initializePromise_(c).then(function(){return f.findKeyPromise_(a,c)}).then(function(a){return null==a?b.resolve(new m):b.resolve(a.derivePublicKey())})};db.prototype.signPromise=function(a,c,f,g){var t=this;return this.initializePromise_(g).then(function(){return t.findKeyPromise_(c,
g)}).then(function(c){return null==c?b.resolve(new m):c.signPromise(f,a,g)})};db.prototype.decryptPromise=function(a,c,f){var g=this;return this.initializePromise_(f).then(function(){return g.findKeyPromise_(c,f)}).then(function(c){return null==c?b.resolve(new m):c.decryptPromise(a,f)})};db.prototype.createKeyPromise_=function(a,c,f){var g=this;return this.initializePromise_(f).then(function(){return c.getKeyType()==ea.RSA||c.getKeyType()==ea.EC?g.backEnd_.createKeyPromise(a,c,f).then(function(a){var c=
a.getKeyName();g.keys_[c.toUri()]=a;return b.resolve(c)}):b.resolve(new db.Error(Error("createKey: Unsupported key type")))})};db.prototype.deleteKeyPromise_=function(a,b){var c=this;return this.initializePromise_(b).then(function(){delete c.keys_[a.toUri()];return c.backEnd_.deleteKeyPromise(a,b)})};db.prototype.exportPrivateKeyPromise_=function(a,b,c){var f=this;return this.initializePromise_(c).then(function(){return f.backEnd_.exportKeyPromise(a,b,c)})};db.prototype.importPrivateKeyPromise_=function(a,
b,c,f){var t=this;return this.initializePromise_(f).then(function(){return t.backEnd_.importKeyPromise(a,b,c,f)})};db.prototype.findKeyPromise_=function(a,c){var f=this;return this.initializePromise_(c).then(function(){var g=a.toUri(),t=f.keys_[g];return void 0!=t?b.resolve(t):f.backEnd_.getKeyHandlePromise(a,c).then(function(a){return null!=a?(f.keys_[g]=a,b.resolve(a)):b.resolve(null)})})};db.prototype.initializePromise_=function(a){return this.isInitialized_?b.resolve():null==this.initializePib_?
(this.isInitialized_=!0,b.resolve()):this.initializePib_.initializePromise_(a)};var c=a.Name,qa=a.PibKey,I=a.ValidationError,Ya=a.ConfigNameRelation,Za=a.NdnRegexTopMatcher,ta=a.ValidatorConfigError,Bb=function(){};r.ConfigChecker=Bb;Bb.prototype.check=function(a,b,c,f){return a?2>b.size()?!1:this.checkNames(b.getPrefix(-2),c,f):this.checkNames(b,c,f)};Bb.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ta(Error("Expected <checker.type>"));if("customized"==b.toLowerCase())return Bb.createCustomizedChecker_(a);
if("hierarchical"==b.toLowerCase())return Bb.createHierarchicalChecker_(a);throw new ta(Error("Unsupported checker type: "+b));};Bb.prototype.checkNames=function(a,b,c){throw Error("ConfigChecker.checkNames is not implemented");};Bb.createCustomizedChecker_=function(a){keyLocatorSection=a.get("key-locator");if(1!=keyLocatorSection.length)throw new ta(Error("Expected one <checker.key-locator>"));return Bb.createKeyLocatorChecker_(keyLocatorSection[0])};Bb.createHierarchicalChecker_=function(a){return new Zd("^(<>*)$",
"\\1","^(<>*)<KEY><>$","\\1",Ya.Relation.IS_PREFIX_OF)};Bb.createKeyLocatorChecker_=function(a){var b=a.getFirstValue("type");if(null==b)throw new ta(Error("Expected <checker.key-locator.type>"));if("name"==b.toLowerCase())return Bb.createKeyLocatorNameChecker_(a);throw new ta(Error("Unsupported checker.key-locator.type: "+b));};Bb.createKeyLocatorNameChecker_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ta(Error("Expected <checker.key-locator.relation>"));
y=Ya.getNameRelationFromString(a);return new le(b,y)}b=a.getFirstValue("regex");if(null!=b)try{return new me(b)}catch(f){throw new ta(Error("Invalid checker.key-locator.regex: "+b));}a=a.get("hyper-relation");if(1==a.length){var g=a[0];a=g.getFirstValue("k-regex");if(null==a)throw new ta(Error("Expected <checker.key-locator.hyper-relation.k-regex>"));b=g.getFirstValue("k-expand");if(null==b)throw new ta(Error("Expected <checker.key-locator.hyper-relation.k-expand"));y=g.getFirstValue("h-relation");
if(null==y)throw new ta(Error("Expected <checker.key-locator.hyper-relation.h-relation>"));var t=g.getFirstValue("p-regex");if(null==t)throw new ta(Error("Expected <checker.key-locator.hyper-relation.p-regex>"));g=g.getFirstValue("p-expand");if(null==g)throw new ta(Error("Expected <checker.key-locator.hyper-relation.p-expand>"));var y=Ya.getNameRelationFromString(y);try{return new Zd(t,g,a,b,y)}catch(l){throw new ta(Error("Invalid regex for key-locator.hyper-relation"));}}throw new ta(Error("Unsupported checker.key-locator"));
};var le=function(a,b){Bb.call(this);this.name_=a;this.relation_=b};le.prototype=new Bb;le.prototype.name="ConfigNameRelationChecker";r.ConfigNameRelationChecker=le;le.prototype.checkNames=function(a,b,c){var f=qa.extractIdentityFromKeyName(b),t=Ya.checkNameRelation(this.relation_,this.name_,f);t||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: name relation "+this.name_.toUri()+" "+Ya.toString(this.relation_)+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+", identity="+f.toUri()+
")"));return t};var me=function(a){Bb.call(this);this.regex_=new Za(a)};me.prototype=new Bb;me.prototype.name="ConfigRegexChecker";r.ConfigRegexChecker=me;me.prototype.checkNames=function(a,b,c){var f=this.regex_.match(b);f||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: regex "+this.regex_.getExpr()+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+")"));return f};var Zd=function(a,b,c,f,t){Bb.call(this);this.packetNameRegex_=new Za(a);this.packetNameExpansion_=b;this.keyNameRegex_=
new Za(c);this.keyNameExpansion_=f;this.hyperRelation_=t};Zd.prototype=new Bb;Zd.prototype.name="ConfigHyperRelationChecker";r.ConfigHyperRelationChecker=Zd;Zd.prototype.checkNames=function(a,b,c){if(!this.packetNameRegex_.match(a))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation packet name regex "+this.packetNameRegex_.getExpr())),!1;if(!this.keyNameRegex_.match(b))return c.fail(new I(I.POLICY_ERROR,"The packet "+a.toUri()+
" (KeyLocator="+b.toUri()+") does not match the hyper relation key name regex "+this.keyNameRegex_.getExpr())),!1;var f=this.keyNameRegex_.expand(this.keyNameExpansion_),t=this.packetNameRegex_.expand(this.packetNameExpansion_),g=Ya.checkNameRelation(this.hyperRelation_,f,t);g||c.fail(new I(I.POLICY_ERROR,"KeyLocator check failed: hyper relation "+Ya.toString(this.hyperRelation_)+" packet name match="+t.toUri()+", key name match="+f.toUri()+" of packet "+a.toUri()+" (KeyLocator="+b.toUri()+") is invalid"));
return g};var c=a.Name,Ya=a.ConfigNameRelation,Za=a.NdnRegexTopMatcher,ta=a.ValidatorConfigError,tc=function(){};r.ConfigFilter=tc;tc.prototype.match=function(a,b){return a?2>b.size()?!1:this.matchName(b.getPrefix(-2)):this.matchName(b)};tc.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ta(Error("Expected <filter.type>"));if("name"==b.toLowerCase())return tc.createNameFilter_(a);throw new ta(Error("Unsupported filter.type: "+b));};tc.prototype.matchName=function(a){throw Error("ConfigFilter.matchName is not implemented");
};tc.createNameFilter_=function(a){var b=a.getFirstValue("name");if(null!=b){b=new c(b);a=a.getFirstValue("relation");if(null==a)throw new ta(Error("Expected <filter.relation>"));a=Ya.getNameRelationFromString(a);return new ne(b,a)}b=a.getFirstValue("regex");if(null!=b)try{return new oe(b)}catch(f){throw new ta(Error("Wrong filter.regex: "+b));}throw new ta(Error("Wrong filter(name) properties"));};var ne=function(a,b){tc.call(this);this.name_=new c(a);this.relation_=b};ne.prototype=new tc;ne.prototype.name=
"ConfigRelationNameFilter";r.ConfigRelationNameFilter=ne;ne.prototype.matchName=function(a){return Ya.checkNameRelation(this.relation_,this.name_,a)};var oe=function(a){tc.call(this);this.regex_=new Za(a)};oe.prototype=new tc;oe.prototype.name="ConfigRegexNameFilter";r.ConfigRegexNameFilter=oe;oe.prototype.matchName=function(a){return this.regex_.match(a)};ta=a.ValidatorConfigError;Ya=function(){};r.ConfigNameRelation=Ya;Ya.Relation=function(){};Ya.Relation.EQUAL=0;Ya.Relation.IS_PREFIX_OF=1;Ya.Relation.IS_STRICT_PREFIX_OF=
2;Ya.toString=function(a){return a==Ya.Relation.EQUAL?"equal":a==Ya.Relation.IS_PREFIX_OF?"is-prefix-of":a==Ya.Relation.IS_STRICT_PREFIX_OF?"is-strict-prefix-of":""};Ya.checkNameRelation=function(a,b,c){return a==Ya.Relation.EQUAL?b.equals(c):a==Ya.Relation.IS_PREFIX_OF?b.isPrefixOf(c):a==Ya.Relation.IS_STRICT_PREFIX_OF?b.isPrefixOf(c)&&b.size()<c.size():!1};Ya.getNameRelationFromString=function(a){if("equal"==a.toLowerCase())return Ya.Relation.EQUAL;if("is-prefix-of"==a.toLowerCase())return Ya.Relation.IS_PREFIX_OF;
if("is-strict-prefix-of"==a.toLowerCase())return Ya.Relation.IS_STRICT_PREFIX_OF;throw new ta(Error("Unsupported relation: "+a));};var Bb=a.ConfigChecker,tc=a.ConfigFilter,ta=a.ValidatorConfigError,f=a.Log.LOG,Ic=function(a,b){this.id_=a;this.isForInterest_=b;this.filters_=[];this.checkers_=[]};r.ConfigRule=Ic;Ic.prototype.getId=function(){return this.id_};Ic.prototype.getIsForInterest=function(){return this.isForInterest_};Ic.prototype.addFilter=function(a){this.filters_.push(a)};Ic.prototype.addChecker=
function(a){this.checkers_.push(a)};Ic.prototype.match=function(a,b){3<f&&console.log("Trying to match "+b.toUri());if(a!=this.isForInterest_)throw new ta(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));if(0==this.filters_.length)return!0;for(var c=!1,g=0;g<this.filters_.length&&!(c=c||this.filters_[g].match(a,b));++g);return c};Ic.prototype.check=function(a,b,c,g){3<f&&console.log("Trying to check "+b.toUri()+" with keyLocator "+
c.toUri());if(a!=this.isForInterest_)throw new ta(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));for(var t=!1,y=0;y<this.checkers_.length;++y){t=this.checkers_[y].check(a,b,c,g);if(!t)break;t=!0}return t};Ic.create=function(a){var b=a.getFirstValue("id");if(null==b)throw new ta(Error("Expecting <rule.id>"));var c=a.getFirstValue("for");if(null==c)throw new ta(Error("Expecting <rule.for> in rule: "+b));if("data"==c.toLowerCase())c=
!1;else if("interest"==c.toLowerCase())c=!0;else throw new ta(Error("Unrecognized <rule.for>: "+c+" in rule: "+b));for(var c=new Ic(b,c),f=a.get("filter"),t=0;t<f.length;++t)c.addFilter(tc.create(f[t]));a=a.get("checker");for(t=0;t<a.length;++t)c.addChecker(Bb.create(a[t]));if(0==a.length)throw new ta(Error("No <rule.checker> is specified in rule: "+b));return c};var Rb=a,m=a.Blob,N=a.CertificateV2,uc=function(a,b){this.certificates_=a;this.id_=b;this.anchorNameUris_={}};r.TrustAnchorGroup=uc;uc.prototype.getId=
function(){return this.id_};uc.prototype.size=function(){return Object.keys(this.anchorNameUris_).length};uc.prototype.refresh=function(){};uc.readCertificate=function(a){try{var b=Rb.readFileSync(a).toString(),c=new g(b,"base64"),f=new N;f.wireDecode(new m(c,!1));return f}catch(t){return null}};var b=a.SyncPromise,I=a.ValidationError,f=a.Log.LOG,Sa=a.VerificationHelpers,N=a.CertificateV2,Ib=function(){this.certificateChain_=[];this.seenCertificateNameUris_={};this.outcome_=this.hasOutcome_=!1};r.ValidationState=
Ib;Ib.prototype.hasOutcome=function(){return this.hasOutcome_};Ib.prototype.isOutcomeFailed=function(){return this.hasOutcome_&&!1==this.outcome_};Ib.prototype.isOutcomeSuccess=function(){return this.hasOutcome_&&!0==this.outcome_};Ib.prototype.fail=function(a){throw Error("ValidationState.fail is not implemented");};Ib.prototype.getDepth=function(){return this.certificateChain_.length};Ib.prototype.hasSeenCertificateName=function(a){a=a.toUri();if(void 0!==this.seenCertificateNameUris_[a])return!0;
this.seenCertificateNameUris_[a]=!0;return!1};Ib.prototype.addCertificate=function(a){this.certificateChain_.unshift(new N(a))};Ib.prototype.setOutcome=function(a){if(this.hasOutcome_)throw Error("The ValidationState already has an outcome");this.hasOutcome_=!0;this.outcome_=a};Ib.prototype.verifyOriginalPacketPromise_=function(a){return b.reject(Error("ValidationState.verifyOriginalPacketPromise_ is not implemented"))};Ib.prototype.bypassValidation_=function(){throw Error("ValidationState.bypassValidation_ is not implemented");
};Ib.prototype.verifyCertificateChainPromise_=function(a){var c=a,g=this,l=function(a){if(a>=g.certificateChain_.length)return b.resolve(c);var y=g.certificateChain_[a];return Sa.verifyDataSignaturePromise(y,c).then(function(m){if(m)3<f&&console.log("OK signature for certificate `"+y.getName().toUri()+"`"),c=y;else{for(g.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of certificate `"+y.getName().toUri()+"`"));g.certificateChain_.length>a;)g.certificateChain_.splice(a,1);return b.resolve(null)}++a;
return l(a)})};return l(0)};var c=a.Name,ia=a.Schedule,N=a.CertificateV2,f=a.Log.LOG,ec=function v(a){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE;this.maxLifetimeMilliseconds_=void 0==a?v.getDefaultLifetime():a;this.nowOffsetMilliseconds_=0};r.CertificateCacheV2=ec;ec.prototype.insert=function(a){var b=a.getValidityPeriod().getNotAfter(),c=(new Date).getTime()+this.nowOffsetMilliseconds_;if(b<c)3<f&&console.log("Not adding "+a.getName().toUri()+": already expired at "+ia.toIsoString(b));
else{b=Math.min(b,c+this.maxLifetimeMilliseconds_);b<this.nextRefreshTime_&&(this.nextRefreshTime_=b);3<f&&console.log("Adding "+a.getName().toUri()+", will remove in "+(b-c)/36E5+" hours");a=new N(a);var c=a.getName(),t=this.findFirstByName_(c);if(0>t)t=this.certificatesByName_.length;else if(this.certificatesByName_[t].name.equals(c)){this.certificatesByName_[t].certificate=a;this.certificatesByName_[t].removalTime=b;return}this.certificatesByName_.splice(t,0,{name:c,certificate:a,removalTime:b})}};
ec.prototype.find=function(a){if(a instanceof c){0<a.size()&&a.get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();var b=this.findFirstByName_(a);if(0>b)return null;b=this.certificatesByName_[b];return a.isPrefixOf(b.certificate.getName())?b.certificate:null}null!=a.getChildSelector()&&console.log("Certificate search using a ChildSelector is not supported. Searching as if this selector not specified");0<a.getName().size()&&
a.getName().get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();b=this.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.certificatesByName_.length;++b){var f=this.certificatesByName_[b].certificate;if(!a.getName().isPrefixOf(f.getName()))break;if(a.matchesData(f))return f}return null};ec.prototype.deleteCertificate=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(this.certificatesByName_[b].name.equals(a)){this.certificatesByName_.splice(b,
1);break}};ec.prototype.clear=function(){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE};ec.getDefaultLifetime=function(){return 36E5};ec.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};ec.prototype.findFirstByName_=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(0<=this.certificatesByName_[b].name.compare(a))return b;return-1};ec.prototype.refresh_=function(){var a=(new Date).getTime()+this.nowOffsetMilliseconds_;if(!(a<this.nextRefreshTime_)){for(var b=
Number.MAX_VALUE,c=this.certificatesByName_.length-1;0<=c;--c){var f=this.certificatesByName_[c];f.removalTime<=a?this.certificatesByName_.splice(c,1):b=Math.min(b,f.removalTime)}this.nextRefreshTime_=b}};var pe=function(){};r.CertificateContainerInterface=pe;pe.prototype.add=function(a){throw Error("CertificateContainerInterface.add is unimplemented");};pe.prototype.remove=function(a){throw Error("CertificateContainerInterface.remove is unimplemented");};var f=a.Log.LOG,vc=function(){this.certificateStorage_=
null};r.CertificateFetcher=vc;vc.prototype.setCertificateStorage=function(a){this.certificateStorage_=a};vc.prototype.fetch=function(a,b,c){if(null==this.certificateStorage_)throw Error("CertificateFetcher.fetch: You must first call setCertificateStorage");var t=this.certificateStorage_.getUnverifiedCertificateCache().find(a.interest_);if(null!=t)3<f&&console.log("Found certificate in **un**verified key cache "+t.getName().toUri()),c(t,b);else{var g=this;this.doFetch_(a,b,function(a,b){g.certificateStorage_.cacheUnverifiedCertificate(a);
c(a,b)})}};vc.prototype.doFetch_=function(a,b,c){throw Error("CertificateFetcher.doFetch_ is not implemented");};var f=a.Log.LOG,N=a.CertificateV2,I=a.ValidationError,vc=a.CertificateFetcher,Nd=function(a){vc.call(this);this.face_=a};Nd.prototype=new vc;Nd.prototype.name="CertificateFetcherFromNetwork";r.CertificateFetcherFromNetwork=Nd;Nd.prototype.doFetch_=function(a,b,c){var t=this;try{t.face_.expressInterest(a.interest_,function(a,t){3<f&&console.log("Fetched certificate from network "+t.getName().toUri());
var g;try{g=new N(t)}catch(y){b.fail(new I(I.MALFORMED_CERTIFICATE,"Fetched a malformed certificate `"+t.getName().toUri()+"` ("+y+")"));return}try{c(g,b)}catch(l){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in continueValidation: "+l))}},function(g){3<f&&console.log("Timeout while fetching certificate "+a.interest_.getName().toUri()+", retrying");--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{t.fetch(a,b,c)}catch(y){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+y))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))},function(g,y){3<f&&console.log("NACK ("+y.getReason()+") while fetching certificate "+a.interest_.getName().toUri());--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{t.fetch(a,b,c)}catch(l){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+l))}else b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))})}catch(g){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,
"Error in expressInterest: "+g))}};var I=a.ValidationError,vc=a.CertificateFetcher,Cd=function(){vc.call(this)};Cd.prototype=new vc;Cd.prototype.name="CertificateFetcherOffline";r.CertificateFetcherOffline=Cd;Cd.prototype.doFetch_=function(a,b,c){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate "+a.interest_.getName().toUri()+" in offline mode"))};var D=a.Interest,Dd=function(a){void 0!=a?(this.interest_=new D(a),this.nRetriesLeft_=3):(this.interest_=new D,this.nRetriesLeft_=0)};
r.CertificateRequest=Dd;var c=a.Name,jb=a.TrustAnchorContainer,N=a.CertificateV2,ec=a.CertificateCacheV2,Vb=function(){this.trustAnchors_=new jb;this.verifiedCertificateCache_=new ec(36E5);this.unverifiedCertificateCache_=new ec(3E5)};r.CertificateStorage=Vb;Vb.prototype.findTrustedCertificate=function(a){var b=this.trustAnchors_.find(a);return null!=b?b:b=this.verifiedCertificateCache_.find(a)};Vb.prototype.isCertificateKnown=function(a){return null!=this.trustAnchors_.find(a)||null!=this.verifiedCertificateCache_.find(a)||
null!=this.unverifiedCertificateCache_.find(a)};Vb.prototype.cacheUnverifiedCertificate=function(a){this.unverifiedCertificateCache_.insert(a)};Vb.prototype.getTrustAnchors=function(){return this.trustAnchors_};Vb.prototype.getVerifiedCertificateCache=function(){return this.verifiedCertificateCache_};Vb.prototype.getUnverifiedCertificateCache=function(){return this.unverifiedCertificateCache_};Vb.prototype.loadAnchor=function(a,b,c,f){this.trustAnchors_.insert(a,b,c,f)};Vb.prototype.resetAnchors=
function(){this.trustAnchors_.clear()};Vb.prototype.cacheVerifiedCertificate=function(a){this.verifiedCertificateCache_.insert(a)};Vb.prototype.resetVerifiedCertificates=function(){this.verifiedCertificateCache_.clear()};Vb.prototype.setCacheNowOffsetMilliseconds_=function(a){this.verifiedCertificateCache_.setNowOffsetMilliseconds_(a);this.unverifiedCertificateCache_.setNowOffsetMilliseconds_(a)};c=a.Name;R=a.Data;V=a.KeyLocator;ua=a.KeyLocatorType;Ja=a.Sha256WithRsaSignature;Xa=a.Sha256WithEcdsaSignature;
Da=a.ContentType;s=a.WireFormat;ia=a.Schedule;Ea=a.ValidityPeriod;fc=a.InvalidArgumentException;N=function(a){void 0!=a?(R.call(this,a),this.checkFormat_()):(R.call(this),this.getMetaInfo().setType(Da.KEY))};N.prototype=new R;N.prototype.name="CertificateV2";r.CertificateV2=N;N.Error=function(a){if(a)return a.__proto__=N.Error.prototype,a};N.Error.prototype=Error();N.Error.prototype.name="CertificateV2Error";N.prototype.checkFormat_=function(){if(!N.isValidName(this.getName()))throw new N.Error(Error("The Data Name does not follow the certificate naming convention"));
if(this.getMetaInfo().getType()!=Da.KEY)throw new N.Error(Error("The Data ContentType is not KEY"));if(0>this.getMetaInfo().getFreshnessPeriod())throw new N.Error(Error("The Data FreshnessPeriod is not set"));if(0==this.getContent().size())throw new N.Error(Error("The Data Content is empty"));};N.prototype.getKeyName=function(){return this.getName().getPrefix(N.KEY_ID_OFFSET+1)};N.prototype.getIdentity=function(){return this.getName().getPrefix(N.KEY_COMPONENT_OFFSET)};N.prototype.getKeyId=function(){return this.getName().get(N.KEY_ID_OFFSET)};
N.prototype.getIssuerId=function(){return this.getName().get(N.ISSUER_ID_OFFSET)};N.prototype.getPublicKey=function(){if(0==this.getContent().size())throw new N.Error(Error("The public key is not set (the Data content is empty)"));return this.getContent()};N.prototype.getValidityPeriod=function(){if(!Ea.canGetFromSignature(this.getSignature()))throw new fc(Error("The SignatureInfo does not have a ValidityPeriod"));return Ea.getFromSignature(this.getSignature())};N.prototype.isValid=function(a){return this.getValidityPeriod().isValid(a)};
N.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();R.prototype.wireDecode.call(this,a,b);this.checkFormat_()};N.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";a+="  NotBefore: "+ia.toIsoString(this.getValidityPeriod().getNotBefore())+"\n";a+="  NotAfter: "+ia.toIsoString(this.getValidityPeriod().getNotAfter())+"\n";a+="Public key bits:\n";try{for(var b=this.getPublicKey().buf().toString("base64"),c=0;c<b.length;c+=64)a+=
b.substr(c,64)+"\n"}catch(f){}a+="Signature Information:\n";a+="  Signature Type: ";a=this.getSignature()instanceof Xa?a+"SignatureSha256WithEcdsa\n":this.getSignature()instanceof Ja?a+"SignatureSha256WithRsa\n":a+"<unknown>\n";V.canGetFromSignature(this.getSignature())&&(a+="  Key Locator: ",b=V.getFromSignature(this.getSignature()),b.getType()==ua.KEYNAME?(b.getKeyName().equals(this.getKeyName())&&(a+="Self-Signed "),a+="Name="+b.getKeyName().toUri()+"\n"):a+="<no KeyLocator key name>\n");return a};
N.isValidName=function(a){return a.size()>=N.MIN_CERT_NAME_LENGTH&&a.get(N.KEY_COMPONENT_OFFSET).equals(N.KEY_COMPONENT)};N.extractIdentityFromCertName=function(a){if(!N.isValidName(a))throw new fc(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(N.KEY_COMPONENT_OFFSET)};N.extractKeyNameFromCertName=function(a){if(!N.isValidName(a))throw new fc(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(N.KEY_ID_OFFSET+
1)};N.VERSION_OFFSET=-1;N.ISSUER_ID_OFFSET=-2;N.KEY_ID_OFFSET=-3;N.KEY_COMPONENT_OFFSET=-4;N.MIN_CERT_NAME_LENGTH=4;N.MIN_KEY_NAME_LENGTH=2;N.KEY_COMPONENT=new c.Component("KEY");var b=a.SyncPromise,R=a.Data,f=a.Log.LOG,I=a.ValidationError,Ib=a.ValidationState,Sa=a.VerificationHelpers,M=a.NdnCommon,md=function(a,b,c){Ib.call(this);this.data_=new R(a);this.successCallback_=b;this.failureCallback_=c;if(null==this.successCallback_)throw Error("The successCallback is null");if(null==this.failureCallback_)throw Error("The failureCallback is null");
};md.prototype=new Ib;md.prototype.name="DataValidationState";r.DataValidationState=md;md.prototype.fail=function(a){3<f&&console.log(""+a);try{this.failureCallback_(this.data_,a)}catch(b){console.log("Error in failureCallback: "+M.getErrorWithStackTrace(b))}this.setOutcome(!1)};md.prototype.getOriginalData=function(){return this.data_};md.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Sa.verifyDataSignaturePromise(this.data_,a).then(function(a){if(a){3<f&&console.log("OK signature for data `"+
c.data_.getName().toUri()+"`");try{c.successCallback_(c.data_)}catch(t){console.log("Error in successCallback: "+M.getErrorWithStackTrace(t))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of data `"+c.data_.getName().toUri()+"`"));return b.resolve()})};md.prototype.bypassValidation_=function(){3<f&&console.log("Signature verification bypassed for data `"+this.data_.getName().toUri()+"`");try{this.successCallback_(this.data_)}catch(a){console.log("Error in successCallback: "+
M.getErrorWithStackTrace(a))}this.setOutcome(!0)};var ke=Rb=a,uc=a.TrustAnchorGroup,c=a.Name,f=a.Log.LOG,Od=function(a,b,c,t,g){uc.call(this,a,b);this.isDirectory_=g;this.path_=c;this.refreshPeriod_=t;this.expireTime_=0;if(0>=t)throw Error("Refresh period for the dynamic group must be positive");0<f&&console.log("Create a dynamic trust anchor group "+b+" for file/dir "+c+" with refresh time "+t);this.refresh()};Od.prototype=new uc;Od.prototype.name="DynamicTrustAnchorGroup";r.DynamicTrustAnchorGroup=
Od;Od.prototype.refresh=function(){var a=(new Date).getTime();if(!(this.expireTime_>a)){this.expireTime_=a+this.refreshPeriod_;0<f&&console.log("Reloading the dynamic trust anchor group");var a={},b;for(b in this.anchorNameUris_)a[b]=!0;if(this.isDirectory_){var g;try{g=Rb.readdirSync(this.path_)}catch(t){throw Error("Cannot list files in directory "+this.path_);}for(var y=0;y<g.length;++y)this.loadCertificate_(ke.join(this.path_,g[y]),a)}else this.loadCertificate_(this.path_,a);for(b in a)delete this.anchorNameUris_[b],
this.certificates_.remove(new c(b))}};Od.prototype.loadCertificate_=function(a,b){var c=uc.readCertificate(a);if(null!=c){var f=c.getName().toUri();this.anchorNameUris_[f]?delete b[f]:(this.anchorNameUris_[f]=!0,this.certificates_.add(c))}};var b=a.SyncPromise,D=a.Interest,f=a.Log.LOG,I=a.ValidationError,Ib=a.ValidationState,Sa=a.VerificationHelpers,M=a.NdnCommon,Wc=function(a,b,c){Ib.call(this);this.interest_=new D(a);this.successCallbacks_=[b];this.failureCallback_=c;if(null==b)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Wc.prototype=new Ib;Wc.prototype.name="InterestValidationState";r.InterestValidationState=Wc;Wc.prototype.fail=function(a){3<f&&console.log(""+a);try{this.failureCallback_(this.interest_,a)}catch(b){console.log("Error in failureCallback: "+M.getErrorWithStackTrace(b))}this.setOutcome(!1)};Wc.prototype.getOriginalInterest=function(){return this.interest_};Wc.prototype.addSuccessCallback=function(a){this.successCallbacks_.push(a)};
Wc.prototype.verifyOriginalPacketPromise_=function(a){var c=this;return Sa.verifyInterestSignaturePromise(this.interest_,a).then(function(a){if(a){3<f&&console.log("OK signature for interest `"+c.interest_.getName().toUri()+"`");for(a=0;a<c.successCallbacks_.length;++a)try{c.successCallbacks_[a](c.interest_)}catch(t){console.log("Error in successCallback: "+M.getErrorWithStackTrace(t))}c.setOutcome(!0)}else c.fail(new I(I.INVALID_SIGNATURE,"Invalid signature of interest `"+c.interest_.getName().toUri()+
"`"));return b.resolve()})};Wc.prototype.bypassValidation_=function(){3<f&&console.log("Signature verification bypassed for interest `"+this.interest_.getName().toUri()+"`");for(var a=0;a<this.successCallbacks_.length;++a)try{this.successCallbacks_[a](this.interest_)}catch(b){console.log("Error in successCallback: "+M.getErrorWithStackTrace(b))}this.setOutcome(!0)};var uc=a.TrustAnchorGroup,Ed=function(a,b){uc.call(this,a,b)};Ed.prototype=new uc;Ed.prototype.name="StaticTrustAnchorGroup";r.StaticTrustAnchorGroup=
Ed;Ed.prototype.add=function(a){var b=a.getName().toUri();this.anchorNameUris_[b]||(this.anchorNameUris_[b]=!0,this.certificates_.add(a))};Ed.prototype.remove=function(a){delete this.anchorNameUris_[a.toUri()];this.certificates_.remove(a)};c=a.Name;Ed=a.StaticTrustAnchorGroup;Od=a.DynamicTrustAnchorGroup;N=a.CertificateV2;pe=a.CertificateContainerInterface;jb=function w(){this.groups_={};this.anchors_=new w.AnchorContainer_};r.TrustAnchorContainer=jb;jb.Error=function(a){if(a)return a.__proto__=jb.Error.prototype,
a};jb.Error.prototype=Error();jb.Error.prototype.name="TrustAnchorContainerError";jb.prototype.insert=function(a,b,c,f){if(b instanceof N){c=this.groups_[a];void 0===c&&(c=new Ed(this.anchors_,a),this.groups_[a]=c);if(!(c instanceof Ed))throw new jb.Error(Error("Cannot add a static anchor to the non-static anchor group "+a));c.add(b)}else{null==f&&(f=!1);if(void 0!==this.groups_[a])throw new jb.Error(Error("Cannot create the dynamic group, because group "+a+" already exists"));this.groups_[a]=new Od(this.anchors_,
a,b,c,f)}};jb.prototype.clear=function(){this.groups_={};this.anchors_.clear()};jb.prototype.find=function(a){if(a instanceof c){this.refresh_();var b=this.anchors_.findFirstByName_(a);if(0>b)return null;var f=this.anchors_.anchorsByName_[b].certificate;return a.isPrefixOf(f.getName())?f:null}this.refresh_();b=this.anchors_.findFirstByName_(a.getName());if(0>b)return null;for(;b<this.anchors_.anchorsByName_.length;++b){f=this.anchors_.anchorsByName_[b].certificate;if(!a.getName().isPrefixOf(f.getName()))break;
if(a.matchesData(f))return f}return null};jb.prototype.getGroup=function(a){var b=this.groups_[a];if(void 0===b)throw new jb.Error(Error("Trust anchor group "+a+" does not exist"));return b};jb.prototype.size=function(){return this.anchors_.size()};jb.AnchorContainer_=function(){this.anchorsByName_=[]};jb.AnchorContainer_.prototype=new pe;jb.AnchorContainer_.prototype.name="TrustAnchorContainerAnchorContainer";jb.AnchorContainer_.prototype.add=function(a){a=new N(a);var b=a.getName(),c=this.findFirstByName_(b);
if(0>c)c=this.anchorsByName_.length;else if(this.anchorsByName_[c].name.equals(b)){this.anchorsByName_[c].certificate=a;return}this.anchorsByName_.splice(c,0,{name:b,certificate:a})};jb.AnchorContainer_.prototype.remove=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(this.anchorsByName_[b].name.equals(a)){this.anchorsByName_.splice(b,1);break}};jb.AnchorContainer_.prototype.clear=function(){this.anchorsByName_=[]};jb.AnchorContainer_.prototype.size=function(){return this.anchorsByName_.length};
jb.AnchorContainer_.prototype.findFirstByName_=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(0<=this.anchorsByName_[b].name.compare(a))return b;return-1};jb.prototype.refresh_=function(){for(var a in this.groups_)this.groups_[a].refresh()};I=function(a,b){this.code_=a;this.info_=void 0!=b?b:""};r.ValidationError=I;I.NO_ERROR=0;I.INVALID_SIGNATURE=1;I.NO_SIGNATURE=2;I.CANNOT_RETRIEVE_CERTIFICATE=3;I.EXPIRED_CERTIFICATE=4;I.LOOP_DETECTED=5;I.MALFORMED_CERTIFICATE=6;I.EXCEEDED_DEPTH_LIMIT=
7;I.INVALID_KEY_LOCATOR=8;I.POLICY_ERROR=9;I.IMPLEMENTATION_ERROR=255;I.USER_MIN=256;I.prototype.getCode=function(){return this.code_};I.prototype.getInfo=function(){return this.info_};I.prototype.toString=function(){var a;a=this.code_===I.NO_ERROR?"No error":this.code_===I.INVALID_SIGNATURE?"Invalid signature":this.code_===I.NO_SIGNATURE?"Missing signature":this.code_===I.CANNOT_RETRIEVE_CERTIFICATE?"Cannot retrieve certificate":this.code_===I.EXPIRED_CERTIFICATE?"Certificate expired":this.code_===
I.LOOP_DETECTED?"Loop detected in certification chain":this.code_===I.MALFORMED_CERTIFICATE?"Malformed certificate":this.code_===I.EXCEEDED_DEPTH_LIMIT?"Exceeded validation depth limit":this.code_===I.INVALID_KEY_LOCATOR?"Key locator violates validation policy":this.code_===I.POLICY_ERROR?"Validation policy error":this.code_===I.IMPLEMENTATION_ERROR?"Internal implementation error":this.code_>=I.USER_MIN?"Custom error code "+this.code_:"Unrecognized error code "+this.code_;0<this.info_.length&&(a+=
" ("+this.info_+")");return a};var c=a.Name,R=a.Data,V=a.KeyLocator,ua=a.KeyLocatorType,s=a.WireFormat,I=a.ValidationError,N=a.CertificateV2,Ta=function(){this.innerPolicy_=this.validator_=null};r.ValidationPolicy=Ta;Ta.prototype.setInnerPolicy=function(a){if(null==a)throw Error("The innerPolicy argument cannot be null");null!=this.validator_&&a.setValidator(this.validator_);null==this.innerPolicy_?this.innerPolicy_=a:this.innerPolicy_.setInnerPolicy(a)};Ta.prototype.hasInnerPolicy=function(){return null!=
this.innerPolicy_};Ta.prototype.getInnerPolicy=function(){return this.innerPolicy_};Ta.prototype.setValidator=function(a){this.validator_=a;null!=this.innerPolicy_&&this.innerPolicy_.setValidator(a)};Ta.prototype.checkPolicy=function(a,b,c){throw Error("ValidationPolicy.checkPolicy is not implemented");};Ta.prototype.checkCertificatePolicy=function(a,b,c){this.checkPolicy(a,b,c)};Ta.getKeyLocatorName=function(a,b){if(a instanceof R)return Ta.getKeyLocatorNameFromSignature_(a.getSignature(),b);if(2>
a.getName().size())return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: name too short")),new c;var f;try{f=s.getDefaultWireFormat().decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf())}catch(g){return b.fail(new I(I.INVALID_KEY_LOCATOR,"Invalid signed Interest: "+g)),new c}return Ta.getKeyLocatorNameFromSignature_(f,b)};Ta.getKeyLocatorNameFromSignature_=function(a,b){if(!V.canGetFromSignature(a))return b.fail(new I(I.INVALID_KEY_LOCATOR,
"KeyLocator is missing")),new c;var f=V.getFromSignature(a);return f.getType()!=ua.KEYNAME?(b.fail(new I(I.INVALID_KEY_LOCATOR,"KeyLocator type is not Name")),new c):f.getKeyName()};var Ta=a.ValidationPolicy,Pd=function(){Ta.call(this)};Pd.prototype=new Ta;Pd.prototype.name="ValidationPolicyAcceptAll";r.ValidationPolicyAcceptAll=Pd;Pd.prototype.checkPolicy=function(a,b,c){c(null,b)};var c=a.Name,R=a.Data,qc=a.CommandInterestSigner,I=a.ValidationError,Ta=a.ValidationPolicy,Wb=function nb(a,b){Ta.call(this);
this.options_=void 0==b?new nb.Options:new nb.Options(b);this.container_=[];this.nowOffsetMilliseconds_=0;if(null==a)throw Error("inner policy is missing");this.setInnerPolicy(a);0>this.options_.gracePeriod_&&(this.options_.gracePeriod_=0)};Wb.prototype=new Ta;Wb.prototype.name="ValidationPolicyCommandInterest";r.ValidationPolicyCommandInterest=Wb;Wb.Options=function(a,b,c){a instanceof Wb.Options?(this.gracePeriod_=a.gracePeriod_,this.maxRecords_=a.maxRecords_,this.recordLifetime_=a.recordLifetime_):
(void 0==a&&(a=12E4),void 0==b&&(b=1E3),void 0==c&&(c=36E5),this.gracePeriod_=a,this.maxRecords_=b,this.recordLifetime_=c)};Wb.prototype.checkPolicy=function(a,b,c){if(a instanceof R)this.getInnerPolicy().checkPolicy(a,b,c);else{var f=[null],g=[0];Wb.parseCommandInterest_(a,b,f,g)&&this.checkTimestamp_(b,f[0],g[0])&&this.getInnerPolicy().checkPolicy(a,b,c)}};Wb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Wb.LastTimestampRecord=function(a,b,f){this.keyName_=new c(a);
this.timestamp_=b;this.lastRefreshed_=f};Wb.prototype.cleanUp_=function(){for(var a=(new Date).getTime()+this.nowOffsetMilliseconds_-this.options_.recordLifetime_;0<this.container_.length&&this.container_[0].lastRefreshed_<=a||0<=this.options_.maxRecords_&&this.container_.length>this.options_.maxRecords_;)this.container_.shift()};Wb.parseCommandInterest_=function(a,b,f,g){f[0]=new c;g[0]=0;var l=a.getName();if(l.size()<qc.MINIMUM_SIZE)return b.fail(new I(I.POLICY_ERROR,"Command interest name `"+a.getName().toUri()+
"` is too short")),!1;g[0]=l.get(qc.POS_TIMESTAMP).toNumber();f[0]=Ta.getKeyLocatorName(a,b);return b.isOutcomeFailed()?!1:!0};Wb.prototype.checkTimestamp_=function(a,b,c){this.cleanUp_();var f=(new Date).getTime()+this.nowOffsetMilliseconds_;if(c<f-this.options_.gracePeriod_||c>f+this.options_.gracePeriod_)return a.fail(new I(I.POLICY_ERROR,"Timestamp is outside the grace period for key "+b.toUri())),!1;f=this.findByKeyName_(b);if(0<=f&&c<=this.container_[f].timestamp_)return a.fail(new I(I.POLICY_ERROR,
"Timestamp is reordered for key "+b.toUri())),!1;var g=this;a.addSuccessCallback(function(a){g.insertNewRecord_(a,b,c)});return!0};Wb.prototype.insertNewRecord_=function(a,b,c){a=(new Date).getTime()+this.nowOffsetMilliseconds_;c=new Wb.LastTimestampRecord(b,c,a);b=this.findByKeyName_(b);0<=b&&this.container_.splice(b,1);this.container_.push(c)};Wb.prototype.findByKeyName_=function(a){for(var b=0;b<this.container_.length;++b)if(this.container_[b].keyName_.equals(a))return b;return-1};var lc=a.BoostInfoParser,
Dd=a.CertificateRequest,ta=a.ValidatorConfigError,I=a.ValidationError,N=a.CertificateV2,Ic=a.ConfigRule,R=a.Data,D=a.Interest,Ta=a.ValidationPolicy,jc=function(){Ta.call(this);this.isConfigured_=this.shouldBypass_=!1;this.dataRules_=[];this.interestRules_=[]};jc.prototype=new Ta;jc.prototype.name="ValidationPolicyConfig";r.ValidationPolicyConfig=jc;jc.prototype.load=function(a,b){if("string"===typeof a&&void 0==b){var c=new lc;c.read(a);this.load(c.getRoot(),a)}else if("string"===typeof a&&"string"===
typeof b)c=new lc,c.read(a,b),this.load(c.getRoot(),b);else{this.isConfigured_&&(this.shouldBypass_=!1,this.dataRules_=[],this.interestRules_=[],this.validator_.resetAnchors(),this.validator_.resetVerifiedCertificates());this.isConfigured_=!0;c=a.get("validator");if(1!=c.length)throw new ta(Error("ValidationPolicyConfig: Expected one validator section"));for(var f=c[0],g=f.get("rule"),c=0;c<g.length;++c){var l=Ic.create(g[c]);l.getIsForInterest()?this.interestRules_.push(l):this.dataRules_.push(l)}f=
f.get("trust-anchor");for(c=0;c<f.length;++c)this.processConfigTrustAnchor_(f[c],b)}};jc.prototype.checkPolicy=function(a,b,c){if(this.hasInnerPolicy())throw new ta(Error("ValidationPolicyConfig must be a terminal inner policy"));if(this.shouldBypass_)c(null,b);else{var f=Ta.getKeyLocatorName(a,b);if(!b.isOutcomeFailed())if(a instanceof R){for(var g=0;g<this.dataRules_.length;++g){var l=this.dataRules_[g];if(l.match(!1,a.getName())){l.check(!1,a.getName(),f,b)&&c(new Dd(new D(f)),b);return}}b.fail(new I(I.POLICY_ERROR,
"No rule matched for data `"+a.getName().toUri()+"`"))}else{for(g=0;g<this.interestRules_.length;++g)if(l=this.interestRules_[g],l.match(!0,a.getName())){l.check(!0,a.getName(),f,b)&&c(new Dd(new D(f)),b);return}b.fail(new I(I.POLICY_ERROR,"No rule matched for interest `"+a.getName().toUri()+"`"))}}};jc.prototype.processConfigTrustAnchor_=function(a,b){var c=a.getFirstValue("type");if(null==c)throw new ta(Error("Expected <trust-anchor.type>"));if("file"==c.toLowerCase()){var f=a.getFirstValue("file-name");
if(null==f)throw new ta(Error("Expected <trust-anchor.file-name>"));c=jc.getRefreshPeriod_(a);this.validator_.loadAnchor(f,f,c,!1)}else if("base64"==c.toLowerCase()){c=a.getFirstValue("base64-string");if(null==c)throw new ta(Error("Expected <trust-anchor.base64-string>"));c=new g(c,"base64");f=new N;try{f.wireDecode(c)}catch(l){throw new ta(Error("Cannot decode certificate from base64-string: "+l));}this.validator_.loadAnchor("",f)}else if("dir"==c.toLowerCase()){f=a.getFirstValue("dir");if(null==
f)throw new ta(Error("Expected <trust-anchor.dir>"));c=jc.getRefreshPeriod_(a);this.validator_.loadAnchor(f,f,c,!0)}else if("any"==c.toLowerCase())this.shouldBypass_=!0;else throw new ta(Error("Unsupported trust-anchor.type"));};jc.getRefreshPeriod_=function(a){var b=a.getFirstValue("refresh");if(null==b)return 1E14;a=0;b=b.match(/(\d+)([hms])/);null!=b&&(a=parseInt(b[1]),"s"!=b[2]&&(a*=60,"m"!=b[2]&&(a*=60)));return 0==a?36E5:1E3*a};var D=a.Interest,Dd=a.CertificateRequest,qa=a.PibKey,I=a.ValidationError,
Ta=a.ValidationPolicy,qe=function(a){Ta.call(this);this.pib_=a};qe.prototype=new Ta;qe.prototype.name="ValidationPolicyFromPib";r.ValidationPolicyFromPib=qe;qe.prototype.checkPolicy=function(a,b,c){a=Ta.getKeyLocatorName(a,b);b.isOutcomeFailed()||this.checkPolicyHelper_(a,b,c)};qe.prototype.checkPolicyHelper_=function(a,b,c){var f;try{f=this.pib_.getIdentity(qa.extractIdentityFromKeyName(a))}catch(g){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB identity for key "+a.toUri()+": "+
g));return}var l;try{l=f.getKey(a)}catch(m){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB key "+a.toUri()+": "+m));return}var n;try{n=l.getDefaultCertificate()}catch(s){b.fail(new I(I.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the default certificate for key "+a.toUri()+": "+s));return}this.validator_.resetAnchors();this.validator_.loadAnchor("",n);c(new Dd(new D(a)),b);this.validator_.resetAnchors()};var Dd=a.CertificateRequest,I=a.ValidationError,D=a.Interest,Ta=a.ValidationPolicy,
Ee=function(){Ta.call(this)};Ee.prototype=new Ta;Ee.prototype.name="ValidationPolicySimpleHierarchy";r.ValidationPolicySimpleHierarchy=Ee;Ee.prototype.checkPolicy=function(a,b,c){keyLocatorName=Ta.getKeyLocatorName(a,b);b.isOutcomeFailed()||(keyLocatorName.getPrefix(-2).isPrefixOf(a.getName())?c(new Dd(new D(keyLocatorName)),b):b.fail(new I(I.INVALID_KEY_LOCATOR,"Signing policy violation for "+a.getName().toUri()+" by "+keyLocatorName.toUri())))};var b=a.SyncPromise,I=a.ValidationError,Cd=a.CertificateFetcherOffline,
Vb=a.CertificateStorage,md=a.DataValidationState,Wc=a.InterestValidationState,R=a.Data,f=a.Log.LOG,Nb=function(a,b){Vb.call(this);void 0==b&&(b=new Cd);this.policy_=a;this.certificateFetcher_=b;this.maxDepth_=25;if(null==this.policy_)throw Error("The policy is null");if(null==this.certificateFetcher_)throw Error("The certificateFetcher is null");this.policy_.setValidator(this);this.certificateFetcher_.setCertificateStorage(this)};Nb.prototype=new Vb;Nb.prototype.name="Validator";r.Validator=Nb;Nb.prototype.getPolicy=
function(){return this.policy_};Nb.prototype.getFetcher=function(){return this.certificateFetcher_};Nb.prototype.setMaxDepth=function(a){this.maxDepth_=a};Nb.prototype.getMaxDepth=function(){return this.maxDepth_};Nb.prototype.validate=function(a,b,c){a instanceof R?(b=new md(a,b,c),3<f&&console.log("Start validating data "+a.getName().toUri())):(b=new Wc(a,b,c),3<f&&console.log("Start validating interest "+a.getName().toUri()));var g=this;this.policy_.checkPolicy(a,b,function(a,b){null==a?b.bypassValidation_():
g.requestCertificate_(a,b)})};Nb.prototype.validateCertificate_=function(a,b){3<f&&console.log("Start validating certificate "+a.getName().toUri());if(a.isValid()){var c=this;this.policy_.checkCertificatePolicy(a,b,function(b,f){null==b?f.fail(new I(I.POLICY_ERROR,"Validation policy is not allowed to designate `"+a.getName().toUri()+"` as a trust anchor")):(f.addCertificate(a),c.requestCertificate_(b,f))})}else b.fail(new I(I.EXPIRED_CERTIFICATE,"Retrieved certificate is not yet valid or expired `"+
a.getName().toUri()+"`"))};Nb.prototype.requestCertificate_=function(a,c){if(c.getDepth()>=this.maxDepth_)c.fail(new I(I.EXCEEDED_DEPTH_LIMIT,"Exceeded validation depth limit"));else if(c.hasSeenCertificateName(a.interest_.getName()))c.fail(new I(I.LOOP_DETECTED,"Validation loop detected for certificate `"+a.interest_.getName().toUri()+"`"));else{3<f&&console.log("Retrieving "+a.interest_.getName().toUri());var g=this,l=this.findTrustedCertificate(a.interest_);null!=l?(3<f&&console.log("Found trusted certificate "+
l.getName().toUri()),c.verifyCertificateChainPromise_(l).then(function(a){return null!=a?c.verifyOriginalPacketPromise_(a):b.resolve()}).then(function(){for(var a=0;a<c.certificateChain_.length;++a)g.cacheVerifiedCertificate(c.certificateChain_[a])})):this.certificateFetcher_.fetch(a,c,function(a,b){g.validateCertificate_(a,b)})}};var W=Rb=ke=a,f=a.Log.LOG,c=a.Name,D=a.Interest,R=a.Data,Da=a.ContentType,m=a.Blob,zd=a.ConfigFile,s=a.WireFormat,x=a.SecurityException,cc=a.RsaKeyParams,Me=a.BasicIdentityStorage,
Na=a.IdentityCertificate,db=a.Tpm,Fe=a.TpmBackEndFile,dc=a.TpmBackEndMemory,b=a.SyncPromise,M=a.NdnCommon,ka=a.IdentityManager,N=a.CertificateV2,Z=a.SigningInfo,Ja=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,xb=a.DigestSha256Signature,pb=a.HmacWithSha256Signature,V=a.KeyLocator,ua=a.KeyLocatorType,Ga=a.DigestAlgorithm,ea=a.KeyType,Ea=a.ValidityPeriod,Sc=a.SafeBag,Sa=a.VerificationHelpers,Aa=a.PublicKey,hc=a.NoVerifyPolicyManager,C=function t(a,b,c){this.identityManager_=null;this.policyManager_=
new hc;this.tpm_=this.pib_=this.face_=null;if(void 0==a){if(!zd)throw new x(Error("KeyChain: The default KeyChain constructor is not supported in the browser"));Rb.existsSync(Me.getDefaultDatabaseFilePath())&&!Rb.existsSync(re.getDefaultDatabaseFilePath())?(a=new ka,b=new hc):b=a=""}if("string"===typeof a){void 0==c&&(c=!1);this.isSecurityV1_=!1;var f=[null],g=[null];t.parseAndCheckPibLocator_(a,f,g);this.pib_=t.createPib_(f[0]+":"+g[0]);this.tpm_=new db("","",null);this.pib_.initializeTpm_=this.tpm_;
this.pib_.initializePibLocator_=a;this.pib_.initializeTpmLocator_=b;this.pib_.initializeAllowReset_=c;this.tpm_.initializePib_=this.pib_}else a instanceof ca?(void 0==c&&(c=new hc),this.isSecurityV1_=!1,this.policyManager_=c,this.pib_=new la("","",a),this.tpm_=new db("","",b)):(c=b,this.isSecurityV1_=!0,void 0==a&&(a=new ka),void 0==c&&(c=new hc),this.identityManager_=a,this.policyManager_=c)};r.KeyChain=C;C.Error=function(a){if(a)return a.__proto__=C.Error.prototype,a};C.Error.prototype=Error();
C.Error.prototype.name="KeyChainError";C.prototype.getPib=function(){if(this.isSecurityV1_)throw new x(Error("getPib is not supported for security v1"));return this.pib_};C.prototype.getTpm=function(){if(this.isSecurityV1_)throw new x(Error("getTpm is not supported for security v1"));return this.tpm_};C.prototype.getIsSecurityV1=function(){return this.isSecurityV1_};C.prototype.createIdentityV2Promise=function(a,c,g){g="boolean"===typeof c?c:g;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());
var l=this,m;return this.pib_.addIdentityPromise_(a,g).then(function(a){m=a;return m.getDefaultKeyPromise(g).catch(function(a){return a instanceof la.Error?l.createKeyPromise(m,c,g):b.reject(a)})}).then(function(a){return a.getDefaultCertificatePromise(g).catch(function(c){return c instanceof la.Error?(2<f&&console.log("No default cert for "+a.getName()+", requesting self-signing"),l.selfSignPromise(a,g)):b.reject(c)})}).then(function(){return b.resolve(m)})};C.prototype.createIdentityV2=function(a,
c,f,g){g="function"===typeof c?f:g;f="function"===typeof c?c:f;return b.complete(f,g,this.createIdentityV2Promise(a,"function"!==typeof c&&c?c:void 0,!f))};C.prototype.deleteIdentityPromise=function(a,f){function g(a){return a>=n.length?b.resolve():l.tpm_.deleteKeyPromise_(n[a],f).then(function(){return g(a+1)})}var l=this;if(a instanceof c)return this.isSecurityV1_?b.reject(new C.Error(Error("deleteIdentityPromise is not supported for security v1. Use deleteIdentity."))):this.pib_.getIdentityPromise(a,
f).then(function(a){return l.deleteIdentityPromise(a,f)}).catch(function(a){return b.resolve()});var m=a.getName(),n=a.getKeys_().getKeyNames();return g(0).then(function(){return l.pib_.removeIdentityPromise_(m,f)})};C.prototype.deleteIdentity=function(a,f,g){if(a instanceof c&&this.isSecurityV1_)this.identityManager_.deleteIdentity(a,f,g);else return b.complete(f,g,this.deleteIdentityPromise(a,!f))};C.prototype.setDefaultIdentityPromise=function(a,b){return this.pib_.setDefaultIdentityPromise_(a.getName(),
b)};C.prototype.setDefaultIdentity=function(a,c,f){return b.complete(c,f,this.setDefaultIdentityPromise(a,!c))};C.prototype.createKeyPromise=function(a,c,g){g="boolean"===typeof c?c:g;c="boolean"!==typeof c&&c?c:void 0;void 0==c&&(c=C.getDefaultKeyParams());var l=this,m,n;return this.tpm_.createKeyPromise_(a.getName(),c,g).then(function(a){n=a;return l.tpm_.getPublicKeyPromise(n,g)}).then(function(b){return a.addKeyPromise_(b.buf(),n,g)}).then(function(a){m=a;2<f&&console.log("Requesting self-signing for newly created key "+
m.getName().toUri());return l.selfSignPromise(m,g)}).then(function(){return b.resolve(m)})};C.prototype.createKey=function(a,c,f,g){g="function"===typeof c?f:g;f="function"===typeof c?c:f;return b.complete(f,g,this.createKeyPromise(a,"function"!==typeof c&&c?c:void 0,!f))};C.prototype.deleteKeyPromise=function(a,c,f){var g=c.getName();if(!a.getName().equals(c.getIdentityName()))return b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+g.toUri()+"`"));var l=this;return a.removeKeyPromise_(g,
f).then(function(){return l.tpm_.deleteKeyPromise_(g,f)})};C.prototype.deleteKey=function(a,c,f,g){return b.complete(f,g,this.deleteKeyPromise(a,c,!f))};C.prototype.setDefaultKeyPromise=function(a,c,f){return a.getName().equals(c.getIdentityName())?a.setDefaultKeyPromise_(c.getName(),f):b.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+c.getName().toUri()+"`"))};C.prototype.setDefaultKey=function(a,c,f,g){return b.complete(f,g,this.setDefaultKeyPromise(a,c,!f))};C.prototype.addCertificatePromise=
function(a,c,f){return a.getName().equals(c.getKeyName())&&c.getContent().equals(a.getPublicKey())?a.addCertificatePromise_(c,f):b.reject(Error("Key `"+a.getName().toUri()+"` does not match certificate `"+c.getKeyName().toUri()+"`"))};C.prototype.addCertificate=function(a,c,f,g){return b.complete(f,g,this.addCertificatePromise(a,c,!f))};C.prototype.deleteCertificatePromise=function(a,c,f){return N.isValidName(c)?a.removeCertificatePromise_(c,f):b.reject(Error("Wrong certificate name `"+c.toUri()+
"`"))};C.prototype.deleteCertificate=function(a,c,f,g){return b.complete(f,g,this.deleteCertificatePromise(a,c,!f))};C.prototype.setDefaultCertificatePromise=function(a,b,c){return this.addCertificatePromise(a,b,c).then(function(){return a.setDefaultCertificatePromise_(b.getName(),c)})};C.prototype.setDefaultCertificate=function(a,c,f,g){return b.complete(f,g,this.setDefaultCertificatePromise(a,c,!f))};C.prototype.signPromise=function(a,f,g,l){var m=f,n=g,r=l;f=m instanceof Z||m instanceof c?m:void 0;
g=m instanceof s?m:n instanceof s?n:void 0;l="boolean"===typeof m?m:"boolean"===typeof n?n:"boolean"===typeof r?r:!1;void 0==g&&(g=s.getDefaultWireFormat());var F=this;return b.resolve().then(function(){if(void 0==f){if(F.isSecurityV1_)return F.prepareDefaultCertificateNamePromise_(l).then(function(a){f=a;return b.resolve()});f=C.defaultSigningInfo_}return b.resolve()}).then(function(){if(f instanceof c){var m=f;if(F.isSecurityV1_)return a instanceof D?F.identityManager_.signInterestByCertificatePromise(a,
m,g,l):a instanceof R?F.identityManager_.signByCertificatePromise(a,m,g,l):F.identityManager_.signByCertificatePromise(a,m,l);if(!(a instanceof D||a instanceof R))return b.reject(new x(Error("sign(buffer, certificateName) is not supported for security v2. Use sign with SigningInfo.")));var Eb=new Z;Eb.setSigningCertificateName(m);return F.signPromise(a,Eb,g,l).catch(function(a){return b.reject(new x(Error("Error in sign: "+a)))})}var mb=f;if(a instanceof R){var n=[null];return F.prepareSignatureInfoPromise_(mb,
n,l).then(function(b){a.setSignature(b);b=a.wireEncode(g);return F.signBufferPromise_(b.signedBuf(),n[0],mb.getDigestAlgorithm(),l)}).then(function(c){a.getSignature().setSignature(c);a.wireEncode(g);return b.resolve(a)})}if(a instanceof D){var s,n=[null];return F.prepareSignatureInfoPromise_(mb,n,l).then(function(b){s=b;a.getName().append(g.encodeSignatureInfo(s));a.getName().append(new c.Component);b=a.wireEncode(g);return F.signBufferPromise_(b.signedBuf(),n[0],mb.getDigestAlgorithm(),l)}).then(function(c){s.setSignature(c);
a.setName(a.getName().getPrefix(-1).append(g.encodeSignatureValue(s)));return b.resolve(a)})}n=[null];return F.prepareSignatureInfoPromise_(mb,n,l).then(function(b){return F.signBufferPromise_(a,n[0],mb.getDigestAlgorithm(),l)})})};C.prototype.sign=function(a,f,g,l,m){var n=f,r=g,F=l;f=n instanceof Z||n instanceof c?n:null;g=n instanceof s?n:r instanceof s?r:null;"function"===typeof n?(l=n,m=r):"function"===typeof r?(l=r,m=F):"function"===typeof F?l=F:m=l=null;return b.complete(l,m,this.signPromise(a,
f,g,!l))};C.prototype.selfSignPromise=function(a,f,g){var l=f,m=g;f=l instanceof s?l:void 0;g="boolean"===typeof l?l:"boolean"===typeof m?m:!1;void 0==f&&(f=s.getDefaultWireFormat());var n=new N,l=(new Date).getTime(),m=new c(a.getName());m.append("self").appendVersion(l);n.setName(m);n.getMetaInfo().setType(Da.KEY);n.getMetaInfo().setFreshnessPeriod(36E5);n.setContent(a.getPublicKey());signingInfo=new Z(a);signingInfo.setValidityPeriod(new Ea(l,l+63072E7));return this.signPromise(n,signingInfo,f,
g).then(function(){return a.addCertificatePromise_(n,g).catch(function(a){return b.reject(new C.Error(Error("Error encoding certificate: "+a)))})}).then(function(){return b.resolve(n)})};C.prototype.selfSign=function(a,c,f,g){"function"===typeof c&&(g=f,f=c,c=void 0);void 0==c&&(c=s.getDefaultWireFormat());return b.complete(f,g,this.selfSignPromise(a,c,!f))};C.prototype.exportSafeBagPromise=function(a,c,f){"boolean"===typeof c&&(f=c,c=void 0);var g=a.getKeyName(),l=this;return b.resolve().then(function(){return l.tpm_.exportPrivateKeyPromise_(g,
c,f)},function(a){return b.reject(new C.Error(Error("Failed to export private key `"+g.toUri()+"`: "+a)))}).then(function(c){return b.resolve(new Sc(a,c))})};C.prototype.exportSafeBag=function(a,c,f,g){g="function"===typeof c?f:g;f="function"===typeof c?c:f;return b.complete(f,g,this.exportSafeBagPromise(a,"function"===typeof c?null:c,!f))};C.prototype.importSafeBagPromise=function(a,c,f){"boolean"===typeof c&&(f=c,c=void 0);var g;try{g=new N(a.getCertificate())}catch(l){return b.reject(Error("Error reading CertificateV2: "+
l))}var n=g.getIdentity(),s=g.getKeyName(),r=g.getPublicKey(),F=new m([1,2,3,4]),Eb,mb=this;return b.resolve().then(function(){return mb.tpm_.hasKeyPromise(s,f)}).then(function(a){return a?b.reject(new C.Error(Error("Private key `"+s.toUri()+"` already exists"))):mb.pib_.getIdentityPromise(n,f).then(function(a){return a.getKeyPromise(s,f)}).then(function(){return b.reject(new C.Error(Error("Public key `"+s.toUri()+"` already exists")))},function(a){return b.resolve()})}).then(function(){return mb.tpm_.importPrivateKeyPromise_(s,
a.getPrivateKeyBag().buf(),c,f).catch(function(a){return b.reject(new C.Error(Error("Failed to import private key `"+s.toUri()+"`: "+a)))})}).then(function(){return mb.tpm_.signPromise(F.buf(),s,Ga.SHA256,f).then(function(a){Eb=a;return b.resolve()},function(a){return mb.tpm_.deleteKeyPromise_(s,f).then(function(){return b.reject(new C.Error(Error("Invalid private key `"+s.toUri()+"`")))})})}).then(function(){var a;try{a=new Aa(r)}catch(c){return mb.tpm_.deleteKeyPromise_(s,f).then(function(){return b.reject(new C.Error(Error("Error decoding public key "+
c)))})}return Sa.verifySignaturePromise(F,Eb,a,f)}).then(function(a){return a?mb.pib_.addIdentityPromise_(n,f):mb.tpm_.deleteKeyPromise_(s,f).then(function(){return b.reject(new C.Error(Error("Certificate `"+g.getName().toUri()+"` and private key `"+s.toUri()+"` do not match")))})}).then(function(a){return a.addKeyPromise_(g.getPublicKey().buf(),s,f)}).then(function(a){return a.addCertificatePromise_(g,f)})};C.prototype.importSafeBag=function(a,c,f,g){g="function"===typeof c?f:g;f="function"===typeof c?
c:f;return b.complete(f,g,this.importSafeBagPromise(a,"function"===typeof c?null:c,!f))};C.registerPibBackend=function(a,b){C.getPibFactories_()[a]=b};C.registerTpmBackend=function(a,b){C.getTpmFactories_()[a]=b};C.prototype.createIdentityAndCertificate=function(a,b,c,f){f="function"===typeof b?c:f;c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:C.getDefaultKeyParams();return this.identityManager_.createIdentityAndCertificate(a,b,c,f)};C.prototype.createIdentity=function(a,b){return Na.certificateNameToPublicKeyName(this.createIdentityAndCertificate(a,
b))};C.prototype.getDefaultIdentity=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultIdentity(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(a){return b.resolve(a.getName())}))};C.prototype.getDefaultCertificateName=function(a,c){return this.isSecurityV1_?this.identityManager_.getDefaultCertificateName(a,c):b.complete(a,c,this.pib_.getDefaultIdentityPromise(!a).then(function(b){return b.getDefaultKeyPromise(!a)}).then(function(b){return b.getDefaultCertificatePromise(!a)}).then(function(a){return b.resolve(a.getName())}))};
C.prototype.generateRSAKeyPair=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPair is not supported for security v2. Use createIdentityV2."));(c="boolean"===typeof b?b:c)||(c=2048);return this.identityManager_.generateRSAKeyPair(a,"boolean"===typeof b?b:!1,c)};C.prototype.setDefaultKeyForIdentity=function(a,c,f,g){return this.isSecurityV1_?this.identityManager_.setDefaultKeyForIdentity(a,c,f,g):b.complete(f,g,b.reject(new x(Error("setDefaultKeyForIdentity is not supported for security v2. Use getPib() methods."))))};
C.prototype.generateRSAKeyPairAsDefault=function(a,b,c){if(!this.isSecurityV1_)throw new x(Error("generateRSAKeyPairAsDefault is not supported for security v2. Use createIdentityV2."));return this.identityManager_.generateRSAKeyPairAsDefault(a,b,c)};C.prototype.createSigningRequest=function(a){return this.isSecurityV1_?this.identityManager_.getPublicKey(a).getKeyDer():b.complete(null,null,this.pib_.getIdentityPromise(qa.extractIdentityFromKeyName(a,!0)).then(function(b){return b.getKeyPromise(a,!0)}).then(function(a){return b.resolve(a.getPublicKey())}))};
C.prototype.installIdentityCertificate=function(a,c,f){if(!this.isSecurityV1_)return b.complete(c,f,b.reject(new x(Error("installIdentityCertificate is not supported for security v2. Use getPib() methods."))));this.identityManager_.addCertificate(a,c,f)};C.prototype.setDefaultCertificateForKey=function(a,c,f){if(!this.isSecurityV1_)return b.complete(c,f,b.reject(new x(Error("setDefaultCertificateForKey is not supported for security v2. Use getPib() methods."))));this.identityManager_.setDefaultCertificateForKey(a,
c,f)};C.prototype.getCertificate=function(a,c,f){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,f):b.complete(c,f,b.reject(new x(Error("getCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.getIdentityCertificate=function(a,c,f){return this.isSecurityV1_?this.identityManager_.getCertificate(a,c,f):b.complete(c,f,b.reject(new x(Error("getIdentityCertificate is not supported for security v2. Use getPib() methods."))))};C.prototype.revokeKey=function(a){};
C.prototype.revokeCertificate=function(a){};C.prototype.getIdentityManager=function(){if(!this.isSecurityV1_)throw new x(Error("getIdentityManager is not supported for security v2"));return this.identityManager_};C.prototype.getPolicyManager=function(){return this.policyManager_};C.prototype.signByIdentity=function(a,f,g,l,m){m="function"===typeof g?l:m;l="function"===typeof g?g:l;g="function"!==typeof g&&g?g:s.getDefaultWireFormat();if(!this.isSecurityV1_)return b.complete(l,m,b.reject(new x(Error("signByIdentity(buffer, identityName) is not supported for security v2. Use sign with SigningInfo."))));
var n=!l,r=this;null==f&&(f=new c);if(a instanceof R){var F=b.resolve().then(function(){if(0==f.size()){var b=r.policyManager_.inferSigningIdentity(a.getName());return 0==b.size()?r.identityManager_.getDefaultCertificateNamePromise(n):r.identityManager_.getDefaultCertificateNameForIdentityPromise(b,n)}return r.identityManager_.getDefaultCertificateNameForIdentityPromise(f,n)}).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));if(!r.policyManager_.checkSigningPolicy(a.getName(),
b))throw new x(Error("Signing Cert name does not comply with signing policy"));return r.identityManager_.signByCertificatePromise(a,b,g,n)});return b.complete(l,m,F)}return b.complete(l,m,this.identityManager_.getDefaultCertificateNameForIdentityPromise(f,n).then(function(b){if(0==b.size())throw new x(Error("No qualified certificate name found!"));return r.identityManager_.signByCertificatePromise(a,b,g,n)}))};C.prototype.signWithSha256=function(a,b){if(this.isSecurityV1_)a instanceof D?this.identityManager_.signInterestWithSha256(a,
b):this.identityManager_.signWithSha256(a,b);else{var c=Z();c.setSha256Signing();this.sign(a,c,b)}};C.prototype.verifyData=function(a,b,c,f){null==f&&(f=0);if(this.policyManager_.requireVerify(a)){var g=this.policyManager_.checkVerificationPolicy(a,f,b,c);if(null!=g){var l=this;this.face_.expressInterest(g.interest,function(a,b){l.onCertificateData(a,b,g)},function(b){l.onCertificateInterestTimeout(b,g.retry,c,a,g)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(m){console.log("Error in onVerified: "+
M.getErrorWithStackTrace(m))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(n){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(n))}};C.prototype.verifyInterest=function(a,b,c,f,g){null==f&&(f=0);g=g||s.getDefaultWireFormat();if(this.policyManager_.requireVerify(a)){var l=this.policyManager_.checkVerificationPolicy(a,f,b,c,g);if(null!=l){var m=this;this.face_.expressInterest(l.interest,function(a,b){m.onCertificateData(a,b,l)},function(b){m.onCertificateInterestTimeout(b,
l.retry,c,a,l)})}}else if(this.policyManager_.skipVerifyAndTrust(a))try{b(a)}catch(n){console.log("Error in onVerified: "+M.getErrorWithStackTrace(n))}else try{c(a,"The packet has no verify rule but skipVerifyAndTrust is false")}catch(r){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(r))}};C.prototype.setFace=function(a){this.face_=a};C.signWithHmacWithSha256=function(a,b,f,g){f instanceof s&&(g=f,f=void 0);g=g||s.getDefaultWireFormat();if(a instanceof R)f=a.wireEncode(g),b=
W.createHmac("sha256",b.buf()),b.update(f.signedBuf()),a.getSignature().setSignature(new m(b.digest(),!1));else if(a instanceof D){if(null==f)throw new x(Error("signWithHmacWithSha256: keyName is required to sign an Interest"));var l=new pb;l.getKeyLocator().setType(ua.KEYNAME);l.getKeyLocator().setKeyName(f);a.getName().append(g.encodeSignatureInfo(l));a.getName().append(new c.Component);f=a.wireEncode(g);b=W.createHmac("sha256",b.buf());b.update(f.signedBuf());l.setSignature(new m(b.digest(),!1));
a.setName(a.getName().getPrefix(-1).append(g.encodeSignatureValue(l)))}else throw new x(Error("signWithHmacWithSha256: Unrecognized target type"));};C.verifyDataWithHmacWithSha256=function(a,b,c){c=c||s.getDefaultWireFormat();c=a.wireEncode(c);b=W.createHmac("sha256",b.buf());b.update(c.signedBuf());return(new m(b.digest(),!1)).equals(a.getSignature().getSignature())};C.verifyInterestWithHmacWithSha256=function(a,b,c){c=c||s.getDefaultWireFormat();var f=c.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),
a.getName().get(-1).getValue().buf());a=a.wireEncode(c);b=W.createHmac("sha256",b.buf());b.update(a.signedBuf());return(new m(b.digest(),!1)).equals(f.getSignature())};C.getDefaultKeyParams=function(){return C.defaultKeyParams_};C.DEFAULT_KEY_PARAMS=new cc;C.getPibFactories_=function(){null==C.pibFactories_&&(C.pibFactories_={},re&&(C.pibFactories_[re.getScheme()]=function(a){return new re(a)}),C.pibFactories_[xa.getScheme()]=function(a){return new xa});return C.pibFactories_};C.getTpmFactories_=
function(){null==C.tpmFactories_&&(C.tpmFactories_={},Fe&&(C.tpmFactories_[Fe.getScheme()]=function(a){return new Fe(a)}),C.tpmFactories_[dc.getScheme()]=function(a){return new dc});return C.tpmFactories_};C.parseLocatorUri_=function(a,b,c){iColon=a.indexOf(":");0<=iColon?(b[0]=a.substring(0,iColon),c[0]=a.substring(iColon+1)):(b[0]=a,c[0]="")};C.parseAndCheckPibLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultPibScheme_());if(void 0==C.getPibFactories_()[b[0]])throw new C.Error(Error("PIB scheme `"+
b[0]+"` is not supported"));};C.parseAndCheckTpmLocator_=function(a,b,c){C.parseLocatorUri_(a,b,c);""==b[0]&&(b[0]=C.getDefaultTpmScheme_());if(void 0==C.getTpmFactories_()[b[0]])throw new C.Error(Error("TPM scheme `"+b[0]+"` is not supported"));};C.getDefaultPibScheme_=function(){return re.getScheme()};C.getDefaultTpmScheme_=function(){if("darwin"===process.platform)throw new C.Error(Error("TpmBackEndOsx is not implemented. You must use tpm-file."));return Fe.getScheme()};C.createPib_=function(a){var b=
[null],c=[null];C.parseAndCheckPibLocator_(a,b,c);a=C.getPibFactories_()[b[0]];return new la(b[0],c[0],a(c[0]))};C.setUpTpm_=function(a,b){var c=[null],f=[null];C.parseAndCheckTpmLocator_(b,c,f);var g=C.getTpmFactories_()[c[0]];a.scheme_=c[0];a.location_=f[0];a.backEnd_=g(f[0])};C.getDefaultPibLocator_=function(a){if(null!=C.defaultPibLocator_)return C.defaultPibLocator_;var b=process.env.NDN_CLIENT_PIB;C.defaultPibLocator_=void 0!=b&&""!=b?b:a.get("pib",C.getDefaultPibScheme_()+":");return C.defaultPibLocator_};
C.getDefaultTpmLocator_=function(a){if(null!=C.defaultTpmLocator_)return C.defaultTpmLocator_;var b=process.env.NDN_CLIENT_TPM;C.defaultTpmLocator_=void 0!=b&&""!=b?b:a.get("tpm",C.getDefaultTpmScheme_()+":");return C.defaultTpmLocator_};C.prototype.prepareSignatureInfoPromise_=function(a,c,f){var g=null,l=null,m=this;return b.resolve().then(function(){if(a.getSignerType()==Z.SignerType.NULL)return m.pib_.getDefaultIdentityPromise(f).then(function(a){g=a;return b.resolve(null)},function(a){c[0]=Z.getDigestSha256Identity();
return b.resolve(new xb)});if(a.getSignerType()==Z.SignerType.ID)return g=a.getPibIdentity(),null==g?m.pib_.getIdentityPromise(a.getSignerName(),f).then(function(a){g=a;return b.resolve(null)},function(c){return b.reject(new Xc(Error("Signing identity `"+a.getSignerName().toUri()+"` does not exist")))}):b.resolve(null);if(a.getSignerType()==Z.SignerType.KEY)return l=a.getPibKey(),null==l?(n=qa.extractIdentityFromKeyName(a.getSignerName()),m.pib_.getIdentityPromise(n,f).then(function(c){return c.getKeyPromise(a.getSignerName(),
f).then(function(a){l=a;g=null;return b.resolve(null)})},function(c){return b.reject(new Xc(Error("Signing key `"+a.getSignerName().toUri()+"` does not exist")))})):b.resolve(null);if(a.getSignerType()==Z.SignerType.CERT){var n=N.extractIdentityFromCertName(a.getSignerName());return m.pib_.getIdentityPromise(n,f).then(function(c){g=c;return g.getKeyPromise(N.extractKeyNameFromCertName(a.getSignerName()),f).then(function(a){l=a;return b.resolve(null)})},function(c){return b.reject(new Xc(Error("Signing certificate `"+
a.getSignerName().toUri()+"` does not exist")))})}return a.getSignerType()==Z.SignerType.SHA256?(c[0]=Z.getDigestSha256Identity(),b.resolve(new xb)):b.reject(new Xc(Error("Unrecognized signer type")))}).then(function(m){return null!=m?b.resolve(m):null==g&&null==l?b.reject(new Xc(Error("Cannot determine signing parameters"))):b.resolve().then(function(){return null!=g&&null==l?g.getDefaultKeyPromise(f).then(function(a){l=a;return b.resolve(null)},function(a){return b.reject(new Xc(Error("Signing identity `"+
g.getName().toUri()+"` does not have default certificate")))}):b.resolve()}).then(function(){if(l.getKeyType()==ea.RSA&&a.getDigestAlgorithm()==Ga.SHA256)signatureInfo=new Ja;else if(l.getKeyType()==ea.EC&&a.getDigestAlgorithm()==Ga.SHA256)signatureInfo=new Xa;else return b.reject(new C.Error(Error("Unsupported key type")));a.getValidityPeriod().hasPeriod()&&Ea.canGetFromSignature(signatureInfo)&&Ea.getFromSignature(signatureInfo).setPeriod(a.getValidityPeriod().getNotBefore(),a.getValidityPeriod().getNotAfter());
var f=V.getFromSignature(signatureInfo);f.setType(ua.KEYNAME);f.setKeyName(l.getName());c[0]=l.getName();return b.resolve(signatureInfo)})})};C.prototype.signBufferPromise_=function(a,c,f,g){return c.equals(Z.getDigestSha256Identity())?(c=W.createHash("sha256"),c.update(a),b.resolve(new m(c.digest(),!1))):this.tpm_.signPromise(a,c,f,g)};C.prototype.onCertificateData=function(a,b,c){this.verifyData(b,c.onVerified,c.onValidationFailed,c.stepCount)};C.prototype.onCertificateInterestTimeout=function(a,
b,c,f,g){if(0<b){var l=this;this.face_.expressInterest(a,function(a,b){l.onCertificateData(a,b,g)},function(a){l.onCertificateInterestTimeout(a,b-1,c,f,g)})}else try{c(f,"The retry count is zero after timeout for fetching "+a.getName().toUri())}catch(m){console.log("Error in onValidationFailed: "+M.getErrorWithStackTrace(m))}};C.prototype.prepareDefaultCertificateNamePromise_=function(a){var c,f=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(g){c=g;return null!=c?
b.resolve():f.setDefaultCertificatePromise_(a).then(function(){return f.identityManager_.getDefaultCertificatePromise(a)}).then(function(a){c=a;return b.resolve()})}).then(function(){return b.resolve(c.getName())})};C.prototype.setDefaultCertificatePromise_=function(a){var f=this;return this.identityManager_.getDefaultCertificatePromise(a).then(function(g){if(null!=g)return b.resolve();var l;return f.identityManager_.getDefaultIdentityPromise(a).then(function(a){l=a;return b.resolve()},function(a){randomComponent=
W.randomBytes(4);l=(new c).append("tmp-identity").append(new m(randomComponent,!1));return b.resolve()}).then(function(){return f.identityManager_.createIdentityAndCertificatePromise(l,C.getDefaultKeyParams(),a)}).then(function(){return f.identityManager_.setDefaultIdentityPromise(l,a)})})};C.defaultPibLocator_=null;C.defaultTpmLocator_=null;C.pibFactories_=null;C.tpmFactories_=null;C.defaultSigningInfo_=new Z;C.defaultKeyParams_=new cc;var Xc=function(a){C.Error.call(this,a)};Xc.prototype=new C.Error;
Xc.prototype.name="InvalidSigningInfoError";r.InvalidSigningInfoError=Xc;r.InvalidSigningInfoError=Xc;je=function(a){C.Error.call(this,a)};je.prototype=new C.Error;je.prototype.name="LocatorMismatchError";r.LocatorMismatchError=je;var la=a.Pib,ca=a.PibImpl,qa=a.PibKey,re=a.PibSqlite3,xa=a.PibMemory,ta=function y(a){if(a)return a.__proto__=y.prototype,a};ta.prototype=Error();ta.prototype.name="ValidatorConfigError";r.ValidatorConfigError=ta;var vc=a.CertificateFetcher,jc=a.ValidationPolicyConfig,Nd=
a.CertificateFetcherFromNetwork,Nb=a.Validator,Ge=function(a){a instanceof vc?Nb.call(this,new jc,a):Nb.call(this,new jc,new Nd(a));this.policyConfig_=this.getPolicy()};Ge.prototype=new Nb(new jc,new Nd(null));Ge.prototype.name="ValidatorConfig";r.ValidatorConfig=Ge;Ge.prototype.load=function(a,b){this.policyConfig_.load(a,b)};var Pd=a.ValidationPolicyAcceptAll,Cd=a.CertificateFetcherOffline,Nb=a.Validator,Qe=function(){Nb.call(this,new Pd,new Cd)};Qe.prototype=new Nb(new Pd);Qe.prototype.name="ValidatorNull";
r.ValidatorNull=Qe;var c=a.Name,L=a.DataUtils,m=a.Blob,Wa=function Ve(a){this.values=[];if("object"===typeof a&&a instanceof Ve)this.values=a.values.slice(0);else if(a)for(var b=this.changeCount=0;b<a.length;++b)a[b]==Ve.ANY?this.appendAny():this.appendComponent(a[b]);this.changeCount=0};r.Exclude=Wa;Wa.ANY="*";Wa.prototype.size=function(){return this.values.length};Wa.prototype.get=function(a){return this.values[a]};Wa.prototype.appendAny=function(){this.values.push(Wa.ANY);++this.changeCount;return this};
Wa.prototype.appendComponent=function(a){this.values.push(new c.Component(a));++this.changeCount;return this};Wa.prototype.clear=function(){++this.changeCount;this.values=[]};Wa.prototype.toUri=function(){if(null==this.values||0==this.values.length)return"";for(var a="",b=0;b<this.values.length;++b)0<b&&(a+=","),a=this.values[b]==Wa.ANY?a+"*":a+this.values[b].toEscapedString();return a};Wa.prototype.matches=function(a){"object"==typeof a&&a instanceof c.Component||(a=new c.Component(a));for(var b=
0;b<this.values.length;++b)if(this.values[b]==Wa.ANY){var f=null;0<b&&(f=this.values[b-1]);var g,l=null;for(g=b+1;g<this.values.length;++g)if(this.values[g]!=Wa.ANY){l=this.values[g];break}if(null!=l){if(null!=f){if(0<a.compare(f)&&0>a.compare(l))return!0}else if(0>a.compare(l))return!0;b=g-1}else if(null!=f){if(0<a.compare(f))return!0}else return!0}else if(a.equals(this.values[b]))return!0;return!1};Wa.compareComponents=function(a,b){"object"==typeof a&&a instanceof c.Component&&(a=a.getValue().buf());
"object"==typeof b&&b instanceof c.Component&&(b=b.getValue().buf());return c.Component.compareBuffers(a,b)};Wa.prototype.getChangeCount=function(){return this.changeCount};var W=a,m=a.Blob,bb=a.SignedBlob,pa=a.ChangeCounter,c=a.Name,Wa=a.Exclude,Fb=a.Link,V=a.KeyLocator,gb=a.DelegationSet,Ec=a.IncomingFaceId,s=a.WireFormat,D=function ha(a,b,f,g,l,Eb,mb,n,s,r){if(null!=g)throw Error("Interest constructor: PublisherPublicKeyDigest support has been removed.");if(null!=mb)throw Error("Interest constructor: answerOriginKind support has been removed. Use setMustBeFresh().");
if(null!=n)throw Error("Interest constructor: scope support has been removed.");if(null!=r)throw Error("Interest constructor: nonce support in the constructor has been removed.");null!=b&&console.log("Interest constructor: The minSuffixComponents param is deprecated. Use setMinSuffixComponents().");null!=f&&console.log("Interest constructor: The maxSuffixComponents param is deprecated. Use setMaxSuffixComponents().");null!=l&&console.log("Interest constructor: The exclude param is deprecated. Use setExclude().");
null!=Eb&&console.log("Interest constructor: The childSelector param is deprecated. Use setChildSelector().");null!=s&&console.log("Interest constructor: The interestLifetimeMilliseconds param is deprecated. Use setInterestLifetimeMilliseconds().");"object"===typeof a&&a instanceof ha?(this.name_=new pa(new c(a.getName())),this.maxSuffixComponents_=a.maxSuffixComponents_,this.didSetCanBePrefix_=a.didSetCanBePrefix_,this.minSuffixComponents_=a.minSuffixComponents_,this.keyLocator_=new pa(new V(a.getKeyLocator())),
this.exclude_=new pa(new Wa(a.getExclude())),this.childSelector_=a.childSelector_,this.mustBeFresh_=a.mustBeFresh_,this.interestLifetimeMilliseconds_=a.interestLifetimeMilliseconds_,this.forwardingHint_=new pa(new gb(a.getForwardingHint())),this.applicationParameters_=a.applicationParameters_,this.nonce_=a.nonce_,this.linkWireEncoding_=a.linkWireEncoding_,this.linkWireEncodingFormat_=a.linkWireEncodingFormat_,this.link_=new pa(null),null!=a.link_.get()&&this.link_.set(new Fb(a.link_.get())),this.selectedDelegationIndex_=
a.selectedDelegationIndex_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_=new pa(new c(a)),this.maxSuffixComponents_=null!=f?f:ha.defaultCanBePrefix_?null:1,this.didSetCanBePrefix_=ha.didSetDefaultCanBePrefix_,this.minSuffixComponents_=b,this.keyLocator_=new pa(new V),this.exclude_=new pa("object"===typeof l&&l instanceof Wa?new Wa(l):new Wa),this.childSelector_=Eb,this.mustBeFresh_=!1,this.interestLifetimeMilliseconds_=
s,this.forwardingHint_=new pa(new gb),this.applicationParameters_=new m,this.nonce_=new m,this.linkWireEncoding_=new m,this.linkWireEncodingFormat_=null,this.link_=new pa(null),this.selectedDelegationIndex_=null,this.defaultWireEncoding_=new bb,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=this.getNonceChangeCount_=0;this.lpPacket_=null};r.Interest=D;D.RECURSIVE_POSTFIX="*";D.CHILD_SELECTOR_LEFT=0;D.CHILD_SELECTOR_RIGHT=1;D.defaultCanBePrefix_=!0;
D.didSetDefaultCanBePrefix_=!1;D.getDefaultCanBePrefix=function(){return D.defaultCanBePrefix_};D.setDefaultCanBePrefix=function(a){D.defaultCanBePrefix_=a;D.didSetDefaultCanBePrefix_=!0};D.prototype.matchesName=function(a){return!this.getName().match(a)||null!=this.minSuffixComponents_&&!(a.size()+1-this.getName().size()>=this.minSuffixComponents_)||null!=this.maxSuffixComponents_&&!(a.size()+1-this.getName().size()<=this.maxSuffixComponents_)||null!=this.getExclude()&&a.size()>this.getName().size()&&
this.getExclude().matches(a.get(this.getName().size()))?!1:!0};D.prototype.matches_name=function(a){return this.matchesName(a)};D.prototype.matchesData=function(a,b){b=b||s.getDefaultWireFormat();var c=this.getName().size(),f=a.getName(),g=f.size()+1,l=null!=this.getMinSuffixComponents()?this.getMinSuffixComponents():0;if(!(c+l<=g&&(null==this.getMaxSuffixComponents()||c+this.getMaxSuffixComponents()>=g)))return!1;if(c===g)if(this.getName().get(-1).isImplicitSha256Digest()){if(!this.getName().equals(a.getFullName(b)))return!1}else return!1;
else if(!this.getName().isPrefixOf(f))return!1;if(0<this.getExclude().size()&&g>c)if(c==g-1){if(this.getExclude().matches(a.getFullName(b).get(c)))return!1}else if(this.getExclude().matches(f.get(c)))return!1;c=this.getKeyLocator();return!c.getType()||(f=a.getSignature(),V.canGetFromSignature(f)&&c.equals(V.getFromSignature(f)))?!0:!1};D.prototype.clone=function(){return new D(this)};D.prototype.getName=function(){return this.name_.get()};D.prototype.getMinSuffixComponents=function(){return this.minSuffixComponents_};
D.prototype.getMaxSuffixComponents=function(){return this.maxSuffixComponents_};D.prototype.getCanBePrefix=function(){return 1!=this.maxSuffixComponents_};D.prototype.getKeyLocator=function(){return this.keyLocator_.get()};D.prototype.getExclude=function(){return this.exclude_.get()};D.prototype.getChildSelector=function(){return this.childSelector_};D.prototype.getMustBeFresh=function(){return this.mustBeFresh_};D.prototype.getNonce=function(){this.getNonceChangeCount_!=this.getChangeCount()&&(this.nonce_=
new m,this.getNonceChangeCount_=this.getChangeCount());return this.nonce_};D.prototype.getForwardingHint=function(){return this.forwardingHint_.get()};D.prototype.hasApplicationParameters=function(){return 0<this.applicationParameters_.size()};D.prototype.hasParameters=function(){return this.hasApplicationParameters()};D.prototype.getApplicationParameters=function(){return this.applicationParameters_};D.prototype.getParameters=function(){return this.getApplicationParameters()};D.prototype.getNonceAsBuffer=
function(){return this.getNonce().buf()};D.prototype.hasLink=function(){return null!=this.link_.get()||!this.linkWireEncoding_.isNull()};D.prototype.getLink=function(){if(null!=this.link_.get())return this.link_.get();if(this.linkWireEncoding_.isNull())return null;var a=new Fb;a.wireDecode(this.linkWireEncoding_,this.linkWireEncodingFormat_);this.link_.set(a);this.linkWireEncoding_=new m;this.linkWireEncodingFormat_=null;return a};D.prototype.getLinkWireEncoding=function(a){a=a||s.getDefaultWireFormat();
if(!this.linkWireEncoding_.isNull()&&this.linkWireEncodingFormat_==a)return this.linkWireEncoding_;var b=this.getLink();return null!=b?b.wireEncode(a):new m};D.prototype.getSelectedDelegationIndex=function(){return this.selectedDelegationIndex_};D.prototype.getInterestLifetimeMilliseconds=function(){return this.interestLifetimeMilliseconds_};D.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new bb,this.defaultWireEncodingFormat_=
null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};D.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};D.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:Ec.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};D.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof c?new c(a):new c);++this.changeCount_;return this};D.prototype.setMinSuffixComponents=
function(a){this.minSuffixComponents_=a;++this.changeCount_;return this};D.prototype.setMaxSuffixComponents=function(a){this.maxSuffixComponents_=a;++this.changeCount_;return this};D.prototype.setCanBePrefix=function(a){this.maxSuffixComponents_=a?null:1;this.didSetCanBePrefix_=!0;++this.changeCount_;return this};D.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof V?new V(a):new V);++this.changeCount_;return this};D.prototype.setExclude=function(a){this.exclude_.set("object"===
typeof a&&a instanceof Wa?new Wa(a):new Wa);++this.changeCount_;return this};D.prototype.setForwardingHint=function(a){this.forwardingHint_.set("object"===typeof a&&a instanceof gb?new gb(a):new gb);++this.changeCount_;return this};D.prototype.setApplicationParameters=function(a){this.applicationParameters_="object"===typeof a&&a instanceof m?a:new m(a,!0);++this.changeCount_;return this};D.prototype.setParameters=function(a){return this.setApplicationParameters(a)};D.prototype.appendParametersDigestToName=
function(){if(!this.hasParameters())return this;var a=W.createHash("sha256");a.update(this.applicationParameters_.buf());this.getName().appendParametersSha256Digest(new m(a.digest(),!1));return this};D.prototype.setLinkWireEncoding=function(a,b){b=b||s.getDefaultWireFormat();this.linkWireEncoding_=a;this.linkWireEncodingFormat_=b;this.link_.set(null);++this.changeCount_;return this};D.prototype.unsetLink=function(){return this.setLinkWireEncoding(new m,null)};D.prototype.setSelectedDelegationIndex=
function(a){this.selectedDelegationIndex_=a;++this.changeCount_;return this};D.prototype.setChildSelector=function(a){this.childSelector_=a;++this.changeCount_;return this};D.prototype.setMustBeFresh=function(a){this.mustBeFresh_=a?!0:!1;++this.changeCount_;return this};D.prototype.setInterestLifetimeMilliseconds=function(a){this.interestLifetimeMilliseconds_=a;++this.changeCount_;return this};D.prototype.setNonce=function(a){this.nonce_="object"===typeof a&&a instanceof m?a:new m(a,!0);++this.changeCount_;
this.getNonceChangeCount_=this.getChangeCount();return this};D.prototype.toUri=function(){var a="";null!=this.minSuffixComponents_&&(a+="&ndn.MinSuffixComponents="+this.minSuffixComponents_);null!=this.maxSuffixComponents_&&(a+="&ndn.MaxSuffixComponents="+this.maxSuffixComponents_);null!=this.childSelector_&&(a+="&ndn.ChildSelector="+this.childSelector_);a+="&ndn.MustBeFresh="+(this.mustBeFresh_?1:0);null!=this.interestLifetimeMilliseconds_&&(a+="&ndn.InterestLifetime="+this.interestLifetimeMilliseconds_);
0<this.getNonce().size()&&(a+="&ndn.Nonce="+c.toEscapedString(this.getNonce().buf()));null!=this.getExclude()&&0<this.getExclude().size()&&(a+="&ndn.Exclude="+this.getExclude().toUri());var b=this.getName().toUri();""!=a&&(b+="?"+a.substr(1));return b};D.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeInterest(this),b=new bb(b.encoding,b.signedPortionBeginOffset,
b.signedPortionEndOffset);a==s.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,s.getDefaultWireFormat());return b};D.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();var c;c="object"===typeof a&&a instanceof m?b.decodeInterest(this,a.buf(),!1):b.decodeInterest(this,a,!0);b==s.getDefaultWireFormat()?this.setDefaultWireEncoding(new bb(new m(a,!0),c.signedPortionBeginOffset,c.signedPortionEndOffset),s.getDefaultWireFormat()):this.setDefaultWireEncoding(new bb,null)};D.prototype.refreshNonce=
function(){var a=this.getNonce();if(0!==a.size()){for(var b;b=new m(W.randomBytes(a.size()),!1),b.equals(a););this.nonce_=b;++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount()}};D.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};D.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),a=this.keyLocator_.checkChanged()||a,a=this.exclude_.checkChanged()||a;(a=this.forwardingHint_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};D.prototype.setDefaultWireEncoding=
function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(D.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(D.prototype,"minSuffixComponents",{get:function(){return this.getMinSuffixComponents()},set:function(a){this.setMinSuffixComponents(a)}});Object.defineProperty(D.prototype,"maxSuffixComponents",{get:function(){return this.getMaxSuffixComponents()},
set:function(a){this.setMaxSuffixComponents(a)}});Object.defineProperty(D.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(D.prototype,"exclude",{get:function(){return this.getExclude()},set:function(a){this.setExclude(a)}});Object.defineProperty(D.prototype,"childSelector",{get:function(){return this.getChildSelector()},set:function(a){this.setChildSelector(a)}});Object.defineProperty(D.prototype,"interestLifetime",
{get:function(){return this.getInterestLifetimeMilliseconds()},set:function(a){this.setInterestLifetimeMilliseconds(a)}});Object.defineProperty(D.prototype,"nonce",{get:function(){return this.getNonceAsBuffer()},set:function(a){this.setNonce(a)}});wa=function gf(a){"object"===typeof a&&a instanceof gf?(this.childInherit=a.childInherit,this.capture=a.capture,this.origin=a.origin):(this.childInherit=!0,this.capture=!1,this.origin=null)};r.RegistrationOptions=wa;wa.NfdForwardingFlags_CHILD_INHERIT=1;
wa.NfdForwardingFlags_CAPTURE=2;wa.prototype.getNfdForwardingFlags=function(){var a=0;this.childInherit&&(a|=wa.NfdForwardingFlags_CHILD_INHERIT);this.capture&&(a|=wa.NfdForwardingFlags_CAPTURE);return a};wa.prototype.setNfdForwardingFlags=function(a){this.childInherit=0!=(a&wa.NfdForwardingFlags_CHILD_INHERIT);this.capture=0!=(a&wa.NfdForwardingFlags_CAPTURE);return this};wa.prototype.getChildInherit=function(){return this.childInherit};wa.prototype.getCapture=function(){return this.capture};wa.prototype.getOrigin=
function(){return this.origin};wa.prototype.setChildInherit=function(a){this.childInherit=a;return this};wa.prototype.setCapture=function(a){this.capture=a;return this};wa.prototype.setOrigin=function(a){this.origin=a;return this};var wa=a.RegistrationOptions,He=function(a){wa.call(this,a)};He.prototype=new wa;r.ForwardingFlags=He;He.NfdForwardingFlags_CHILD_INHERIT=wa.NfdForwardingFlags_CHILD_INHERIT;He.NfdForwardingFlags_CAPTURE=wa.NfdForwardingFlags_CAPTURE;var wa=a.RegistrationOptions,c=a.Name,
s=a.WireFormat,m=a.Blob,Ua=function hf(a){"object"===typeof a&&a instanceof hf?(this.name=null==a.name?null:new c(a.name),this.faceId=a.faceId,this.uri=a.uri,this.localControlFeature=a.localControlFeature,this.origin=a.origin,this.cost=a.cost,this.flags=new wa(a.flags),this.strategy=new c(a.strategy),this.expirationPeriod=a.expirationPeriod):(this.faceId=this.name=null,this.uri="",this.cost=this.origin=this.localControlFeature=null,this.flags=new wa,this.strategy=new c,this.expirationPeriod=null)};
r.ControlParameters=Ua;Ua.prototype.clear=function(){this.faceId=this.name=null;this.uri="";this.cost=this.origin=this.localControlFeature=null;this.flags=new wa;this.strategy=new c;this.expirationPeriod=null};Ua.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeControlParameters(this)};Ua.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeControlParameters(this,a.buf(),!1):b.decodeControlParameters(this,a,!0)};
Ua.prototype.getName=function(){return this.name};Ua.prototype.getFaceId=function(){return this.faceId};Ua.prototype.getUri=function(){return this.uri};Ua.prototype.getLocalControlFeature=function(){return this.localControlFeature};Ua.prototype.getOrigin=function(){return this.origin};Ua.prototype.getCost=function(){return this.cost};Ua.prototype.getForwardingFlags=function(){return this.flags};Ua.prototype.getStrategy=function(){return this.strategy};Ua.prototype.getExpirationPeriod=function(){return this.expirationPeriod};
Ua.prototype.setName=function(a){this.name="object"===typeof a&&a instanceof c?new c(a):null};Ua.prototype.setFaceId=function(a){this.faceId=a};Ua.prototype.setUri=function(a){this.uri=a||""};Ua.prototype.setLocalControlFeature=function(a){this.localControlFeature=a};Ua.prototype.setOrigin=function(a){this.origin=a};Ua.prototype.setCost=function(a){this.cost=a};Ua.prototype.setForwardingFlags=function(a){this.flags="object"===typeof a&&a instanceof wa?new wa(a):new wa};Ua.prototype.setStrategy=function(a){this.strategy=
"object"===typeof a&&a instanceof c?new c(a):new c};Ua.prototype.setExpirationPeriod=function(a){this.expirationPeriod=a};var Ua=a.ControlParameters,s=a.WireFormat,m=a.Blob,wc=function jf(a){"object"===typeof a&&a instanceof jf?(this.statusCode_=a.statusCode_,this.statusText_=a.statusText_,this.bodyAsControlParameters_=null==a.bodyAsControlParameters_?null:new Ua(a.bodyAsControlParameters_)):(this.statusCode_=null,this.statusText_="",this.bodyAsControlParameters_=null)};r.ControlResponse=wc;wc.prototype.clear=
function(){this.statusCode_=null;this.statusText_="";this.bodyAsControlParameters_=null};wc.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeControlResponse(this)};wc.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeControlResponse(this,a.buf(),!1):b.decodeControlResponse(this,a,!0)};wc.prototype.getStatusCode=function(){return this.statusCode_};wc.prototype.getStatusText=function(){return this.statusText_};wc.prototype.getBodyAsControlParameters=
function(){return this.bodyAsControlParameters_};wc.prototype.setStatusCode=function(a){this.statusCode_=a;return this};wc.prototype.setStatusText=function(a){this.statusText_=a||"";return this};wc.prototype.setBodyAsControlParameters=function(a){this.bodyAsControlParameters_="object"===typeof a&&a instanceof Ua?new Ua(a):null;return this};c=a.Name;Za=a.NdnRegexTopMatcher;Cc=function Ue(a,b){"object"===typeof a&&a instanceof Ue?(this.prefix=new c(a.prefix),this.regexFilter=a.regexFilter,this.regexFilterPattern=
a.regexFilterPattern):(this.prefix=new c(a),b?(this.regexFilter=b,this.regexFilterPattern=Ue.makePattern(b)):this.regexFilterPattern=this.regexFilter=null)};r.InterestFilter=Cc;Cc.prototype.doesMatch=function(a){return a.size()<this.prefix.size()?!1:this.hasRegexFilter()?this.prefix.match(a)?(new Za(this.regexFilterPattern)).match(a.getSubName(this.prefix.size())):!1:this.prefix.match(a)};Cc.prototype.getPrefix=function(){return this.prefix};Cc.prototype.hasRegexFilter=function(){return null!=this.regexFilter};
Cc.prototype.getRegexFilter=function(){return this.regexFilter};Cc.makePattern=function(a){1<=a.length&&"^"==a[0]||(a="^"+a);1<=a.length&&"$"==a[-1]||(a+="$");return a};c=a.Name;m=a.Blob;s=a.WireFormat;gb=function kf(a){this.delegations_="object"===typeof a&&a instanceof kf?a.delegations_.slice(0):[];this.changeCount_=0};r.DelegationSet=gb;gb.Delegation=function(a,b){this.preference_=a;this.name_=new c(b)};gb.Delegation.prototype.getPreference=function(){return this.preference_};gb.Delegation.prototype.getName=
function(){return this.name_};gb.Delegation.prototype.compare=function(a){return this.preference_<a.preference_?-1:this.preference_>a.preference_?1:this.name_.compare(a.name_)};gb.prototype.add=function(a,b){this.remove(b);for(var c=new gb.Delegation(a,b),f=0;f<this.delegations_.length&&!(0<=this.delegations_[f].compare(c));)++f;this.delegations_.splice(f,0,c);++this.changeCount_};gb.prototype.addUnsorted=function(a,b){this.delegations_.push(new gb.Delegation(a,b));++this.changeCount_};gb.prototype.remove=
function(a){for(var b=!1,c=this.delegations_.length-1;0<=c;--c)this.delegations_[c].getName().equals(a)&&(b=!0,this.delegations_.splice(c,1));b&&++this.changeCount_;return b};gb.prototype.clear=function(){this.delegations_=[];++this.changeCount_};gb.prototype.size=function(){return this.delegations_.length};gb.prototype.get=function(a){return this.delegations_[a]};gb.prototype.find=function(a){for(var b=0;b<this.delegations_.length;++b)if(this.delegations_[b].getName().equals(a))return b;return-1};
gb.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeDelegationSet(this)};gb.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeDelegationSet(this,a.buf(),!1):b.decodeDelegationSet(this,a,!0)};gb.prototype.getChangeCount=function(){return this.changeCount_};gb=a.DelegationSet;Da=a.ContentType;s=a.WireFormat;R=a.Data;Fb=function(a){this.delegations_=new gb;if(a instanceof R){if(R.call(this,a),!this.getContent().isNull())try{this.delegations_.wireDecode(this.getContent()),
this.getMetaInfo().setType(Da.LINK)}catch(b){this.delegations_.clear()}}else void 0!=a?R.call(this,a):R.call(this),this.getMetaInfo().setType(Da.LINK)};Fb.prototype=new R;Fb.prototype.name="Link";r.Link=Fb;Fb.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();R.prototype.wireDecode.call(this,a,b);if(this.getMetaInfo().getType()!=Da.LINK)throw Error("Link.wireDecode: MetaInfo ContentType is not LINK.");this.delegations_.wireDecode(this.getContent())};Fb.prototype.addDelegation=function(a,
b,c){c=c||s.getDefaultWireFormat();this.delegations_.add(a,b);this.encodeContent(c);return this};Fb.prototype.removeDelegation=function(a,b){b=b||s.getDefaultWireFormat();var c=this.delegations_.remove(a);c&&this.encodeContent(b);return c};Fb.prototype.getDelegations=function(){return this.delegations_};Fb.prototype.encodeContent=function(a){this.setContent(this.delegations_.wireEncode(a));this.getMetaInfo().setType(Da.LINK)};var ab=function Eb(){this.reason_=Eb.Reason.NONE;this.otherReasonCode_=
-1};r.NetworkNack=ab;ab.Reason={NONE:0,CONGESTION:50,DUPLICATE:100,NO_ROUTE:150,OTHER_CODE:32767};ab.prototype.getReason=function(){return this.reason_};ab.prototype.getOtherReasonCode=function(){return this.otherReasonCode_};ab.prototype.setReason=function(a){this.reason_=a;return this};ab.prototype.setOtherReasonCode=function(a){if(0>a)throw Error("NetworkNack other reason code must be non-negative");this.otherReasonCode_=a;return this};ab.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=
a.getHeaderField(b);if(c instanceof ab)return c}return null};var W=a,m=a.Blob,c=a.Name,ib=a.ComponentType,wa=a.RegistrationOptions,n=a.Tlv,ra=a.TlvEncoder,oa=a.TlvDecoder,s=a.WireFormat,Wa=a.Exclude,Da=a.ContentType,ua=a.KeyLocatorType,Ja=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,bc=a.GenericSignature,pb=a.HmacWithSha256Signature,xb=a.DigestSha256Signature,Ua=a.ControlParameters,ab=a.NetworkNack,ia=a.Schedule,Ec=a.IncomingFaceId,gd=a.CongestionMark,S=a.DecodingException,G=function(){s.call(this)};
G.prototype=new s;G.prototype.name="Tlv0_2WireFormat";r.Tlv0_2WireFormat=G;G.instance=null;G.didCanBePrefixWarning_=!1;G.prototype.encodeName=function(a){var b=new ra;G.encodeName(a,b);return new m(b.getOutput(),!1)};G.prototype.decodeName=function(a,b,c){null==c&&(c=!0);b=new oa(b);G.decodeName(a,b,c)};G.prototype.encodeInterest=function(a){a.didSetCanBePrefix_||G.didCanBePrefixWarning_||(console.log("WARNING: The default CanBePrefix will change. See Interest.setDefaultCanBePrefix() for details."),
G.didCanBePrefixWarning_=!0);return G.encodeInterestV03_(a)};G.prototype.decodeInterest=function(a,b,c){try{return this.decodeInterestV02_(a,b,c)}catch(f){try{return G.decodeInterestV03_(a,b,c)}catch(g){throw f;}}};G.prototype.decodeInterestV02_=function(a,b,c){null==c&&(c=!0);b=new oa(b);var f=b.readNestedTlvsStart(n.Interest),g=G.decodeName(a.getName(),b,c);b.peekType(n.Selectors,f)?G.decodeSelectors(a,b,c):(a.setMinSuffixComponents(null),a.setMaxSuffixComponents(null),a.getKeyLocator().clear(),
a.getExclude().clear(),a.setChildSelector(null),a.setMustBeFresh(!1));var l=b.readBlobTlv(n.Nonce);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(n.InterestLifetime,f));if(b.peekType(n.ForwardingHint,f)){var s=b.readNestedTlvsStart(n.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),s,b,c);b.finishNestedTlvs(s)}if(b.peekType(n.Data,f)){var s=b.getOffset(),r=b.readNestedTlvsStart(n.Data);b.seek(r);a.setLinkWireEncoding(new m(b.getSlice(s,r),c),this)}else a.unsetLink();
a.setSelectedDelegationIndex(b.readOptionalNonNegativeIntegerTlv(n.SelectedDelegation,f));if(null!=a.getSelectedDelegationIndex()&&0<=a.getSelectedDelegationIndex()&&!a.hasLink())throw Error("Interest has a selected delegation, but no link object");a.setApplicationParameters(new m);a.setNonce(new m(l,c));b.finishNestedTlvs(f);return g};G.prototype.encodeData=function(a){var b=new ra(1500),c=b.getLength();b.writeBlobTlv(n.SignatureValue,a.getSignature().getSignature().buf());var f=b.getLength();G.encodeSignatureInfo_(a.getSignature(),
b);b.writeBlobTlv(n.Content,a.getContent().buf());G.encodeMetaInfo(a.getMetaInfo(),b);G.encodeName(a.getName(),b);a=b.getLength();b.writeTypeAndLength(n.Data,b.getLength()-c);c=b.getLength()-a;f=b.getLength()-f;return{encoding:new m(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:f}};G.prototype.decodeData=function(a,b,c){null==c&&(c=!0);b=new oa(b);var f=b.readNestedTlvsStart(n.Data),g=b.getOffset();G.decodeName(a.getName(),b,c);b.peekType(n.MetaInfo,f)?G.decodeMetaInfo(a.getMetaInfo(),
b,c):a.getMetaInfo().clear();a.setContent(new m(b.readOptionalBlobTlv(n.Content,f),c));G.decodeSignatureInfo(a,b,c);var l=b.getOffset();a.getSignature().setSignature(new m(b.readBlobTlv(n.SignatureValue),c));b.finishNestedTlvs(f);return{signedPortionBeginOffset:g,signedPortionEndOffset:l}};G.prototype.encodeControlParameters=function(a){var b=new ra(256);G.encodeControlParameters(a,b);return new m(b.getOutput(),!1)};G.prototype.decodeControlParameters=function(a,b,c){null==c&&(c=!0);b=new oa(b);G.decodeControlParameters(a,
b,c)};G.prototype.encodeControlResponse=function(a){var b=new ra(256),c=b.getLength();null!=a.getBodyAsControlParameters()&&G.encodeControlParameters(a.getBodyAsControlParameters(),b);b.writeBlobTlv(n.NfdCommand_StatusText,(new m(a.getStatusText())).buf());b.writeNonNegativeIntegerTlv(n.NfdCommand_StatusCode,a.getStatusCode());b.writeTypeAndLength(n.NfdCommand_ControlResponse,b.getLength()-c);return new m(b.getOutput(),!1)};G.prototype.decodeControlResponse=function(a,b,c){null==c&&(c=!0);b=new oa(b);
var f=b.readNestedTlvsStart(n.NfdCommand_ControlResponse);a.setStatusCode(b.readNonNegativeIntegerTlv(n.NfdCommand_StatusCode));var g=new m(b.readBlobTlv(n.NfdCommand_StatusText),!1);a.setStatusText(g.toString());b.peekType(n.ControlParameters_ControlParameters,f)?(a.setBodyAsControlParameters(new Ua),G.decodeControlParameters(a.getBodyAsControlParameters(),b,c)):a.setBodyAsControlParameters(null);b.finishNestedTlvs(f)};G.prototype.encodeSignatureInfo=function(a){var b=new ra(256);G.encodeSignatureInfo_(a,
b);return new m(b.getOutput(),!1)};G.SignatureHolder=function(){};G.SignatureHolder.prototype.setSignature=function(a){this.signature=a};G.SignatureHolder.prototype.getSignature=function(){return this.signature};G.prototype.decodeSignatureInfoAndValue=function(a,b,c){null==c&&(c=!0);var f=new G.SignatureHolder;a=new oa(a);G.decodeSignatureInfo(f,a,c);a=new oa(b);f.getSignature().setSignature(new m(a.readBlobTlv(n.SignatureValue),c));return f.getSignature()};G.prototype.encodeSignatureValue=function(a){var b=
new ra(256);b.writeBlobTlv(n.SignatureValue,a.getSignature().buf());return new m(b.getOutput(),!1)};G.prototype.decodeLpPacket=function(a,b,c){null==c&&(c=!0);a.clear();for(var f=new oa(b),g=f.readNestedTlvsStart(n.LpPacket_LpPacket);f.getOffset()<g;){var l=f.readVarNumber(),s=f.readVarNumber(),r=f.getOffset()+s;if(r>b.length)throw new S(Error("TLV length exceeds the buffer length"));if(l==n.LpPacket_Fragment){a.setFragmentWireEncoding(new m(f.getSlice(f.getOffset(),r),c));f.seek(r);break}else if(l==
n.LpPacket_Nack)s=new ab,l=f.readOptionalNonNegativeIntegerTlv(n.LpPacket_NackReason,r),0>l||l==ab.Reason.NONE?s.setReason(ab.Reason.NONE):l==ab.Reason.CONGESTION||l==ab.Reason.DUPLICATE||l==ab.Reason.NO_ROUTE?s.setReason(l):(s.setReason(ab.Reason.OTHER_CODE),s.setOtherReasonCode(l)),a.addHeaderField(s);else if(l==n.LpPacket_IncomingFaceId)l=new Ec,l.setFaceId(f.readNonNegativeInteger(s)),a.addHeaderField(l);else if(l==n.LpPacket_CongestionMark)l=new gd,l.setCongestionMark(f.readNonNegativeInteger(s)),
a.addHeaderField(l);else{if(!(l>=n.LpPacket_IGNORE_MIN&&l<=n.LpPacket_IGNORE_MAX&&0==(l&3)))throw new S(Error("Did not get the expected TLV type"));f.seek(r)}f.finishNestedTlvs(r)}f.finishNestedTlvs(g)};G.prototype.encodeDelegationSet=function(a){var b=new ra(256);G.encodeDelegationSet_(a,b);return new m(b.getOutput(),!1)};G.prototype.decodeDelegationSet=function(a,b,c){null==c&&(c=!0);var f=new oa(b);G.decodeDelegationSet_(a,b.length,f,c)};G.prototype.encodeEncryptedContent=function(a){var b=new ra(256),
c=b.getLength();b.writeBlobTlv(n.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeOptionalBlobTlv(n.Encrypt_InitialVector,a.getInitialVector().buf());b.writeNonNegativeIntegerTlv(n.Encrypt_EncryptionAlgorithm,a.getAlgorithmType());G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b);b.writeTypeAndLength(n.Encrypt_EncryptedContent,b.getLength()-c);return new m(b.getOutput(),!1)};G.prototype.decodeEncryptedContent=function(a,b,c){null==c&&(c=!0);b=new oa(b);var f=b.readNestedTlvsStart(n.Encrypt_EncryptedContent);
a.clear();G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c);a.setAlgorithmType(b.readNonNegativeIntegerTlv(n.Encrypt_EncryptionAlgorithm));a.setInitialVector(new m(b.readOptionalBlobTlv(n.Encrypt_InitialVector,f),c));a.setPayload(new m(b.readBlobTlv(n.Encrypt_EncryptedPayload),c));b.finishNestedTlvs(f)};G.prototype.encodeEncryptedContentV2=function(a){var b=new ra(256),c=b.getLength();a.getKeyLocator().getType()==ua.KEYNAME&&G.encodeName(a.getKeyLocator().getKeyName(),b);b.writeOptionalBlobTlv(n.Encrypt_EncryptedPayloadKey,
a.getPayloadKey().buf());b.writeOptionalBlobTlv(n.Encrypt_InitialVector,a.getInitialVector().buf());b.writeBlobTlv(n.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeTypeAndLength(n.Encrypt_EncryptedContent,b.getLength()-c);return new m(b.getOutput(),!1)};G.prototype.decodeEncryptedContentV2=function(a,b,c){null==c&&(c=!0);b=new oa(b);var f=b.readNestedTlvsStart(n.Encrypt_EncryptedContent);a.clear();a.setPayload(new m(b.readBlobTlv(n.Encrypt_EncryptedPayload),c));a.setInitialVector(new m(b.readOptionalBlobTlv(n.Encrypt_InitialVector,
f),c));a.setPayloadKey(new m(b.readOptionalBlobTlv(n.Encrypt_EncryptedPayloadKey,f),c));b.peekType(n.Name,f)&&(G.decodeName(a.getKeyLocator().getKeyName(),b,c),a.getKeyLocator().setType(ua.KEYNAME));b.finishNestedTlvs(f)};G.get=function(){null===G.instance&&(G.instance=new G);return G.instance};G.encodeNameComponent=function(a,b){var c;c=a.getType()===ib.OTHER_CODE?a.getOtherTypeCode():a.getType();b.writeBlobTlv(c,a.getValue().buf())};G.decodeNameComponent=function(a,b){null==b&&(b=!0);var f=a.getOffset(),
g=a.readVarNumber();a.seek(f);f=new m(a.readBlobTlv(g),b);return g===n.ImplicitSha256DigestComponent?c.Component.fromImplicitSha256Digest(f):g===n.ParametersSha256DigestComponent?c.Component.fromParametersSha256Digest(f):g===n.NameComponent?new c.Component(f):new c.Component(f,ib.OTHER_CODE,g)};G.encodeName=function(a,b){for(var c=b.getLength(),f,g=a.size()-1;0<=g;--g)G.encodeNameComponent(a.get(g),b),g==a.size()-1&&(f=b.getLength());g=b.getLength();b.writeTypeAndLength(n.Name,b.getLength()-c);c=
b.getLength()-g;f=0==a.size()?c:b.getLength()-f;return{signedPortionBeginOffset:c,signedPortionEndOffset:f}};G.decodeName=function(a,b,c){a.clear();for(var f=b.readNestedTlvsStart(n.Name),g=b.getOffset(),l=g;b.getOffset()<f;)l=b.getOffset(),a.append(G.decodeNameComponent(b,c));b.finishNestedTlvs(f);return{signedPortionBeginOffset:g,signedPortionEndOffset:l}};G.encodeSelectors=function(a,b){var c=b.getLength();a.getMustBeFresh()&&b.writeTypeAndLength(n.MustBeFresh,0);b.writeOptionalNonNegativeIntegerTlv(n.ChildSelector,
a.getChildSelector());0<a.getExclude().size()&&G.encodeExclude(a.getExclude(),b);null!=a.getKeyLocator().getType()&&G.encodeKeyLocator(n.PublisherPublicKeyLocator,a.getKeyLocator(),b);b.writeOptionalNonNegativeIntegerTlv(n.MaxSuffixComponents,a.getMaxSuffixComponents());b.writeOptionalNonNegativeIntegerTlv(n.MinSuffixComponents,a.getMinSuffixComponents());b.getLength()!=c&&b.writeTypeAndLength(n.Selectors,b.getLength()-c)};G.decodeSelectors=function(a,b,c){null==c&&(c=!0);var f=b.readNestedTlvsStart(n.Selectors);
a.setMinSuffixComponents(b.readOptionalNonNegativeIntegerTlv(n.MinSuffixComponents,f));a.setMaxSuffixComponents(b.readOptionalNonNegativeIntegerTlv(n.MaxSuffixComponents,f));b.peekType(n.PublisherPublicKeyLocator,f)?G.decodeKeyLocator(n.PublisherPublicKeyLocator,a.getKeyLocator(),b,c):a.getKeyLocator().clear();b.peekType(n.Exclude,f)?G.decodeExclude(a.getExclude(),b,c):a.getExclude().clear();a.setChildSelector(b.readOptionalNonNegativeIntegerTlv(n.ChildSelector,f));a.setMustBeFresh(b.readBooleanTlv(n.MustBeFresh,
f));b.finishNestedTlvs(f)};G.encodeExclude=function(a,b){for(var c=b.getLength(),f=a.size()-1;0<=f;--f){var g=a.get(f);g==Wa.ANY?b.writeTypeAndLength(n.Any,0):G.encodeNameComponent(g,b)}b.writeTypeAndLength(n.Exclude,b.getLength()-c)};G.decodeExclude=function(a,b,c){null==c&&(c=!0);var f=b.readNestedTlvsStart(n.Exclude);for(a.clear();b.getOffset()<f;)b.peekType(n.Any,f)?(b.readBooleanTlv(n.Any,f),a.appendAny()):a.appendComponent(G.decodeNameComponent(b,c));b.finishNestedTlvs(f)};G.encodeKeyLocator=
function(a,b,c){var f=c.getLength();if(null!=b.getType())if(b.getType()==ua.KEYNAME)G.encodeName(b.getKeyName(),c);else if(b.getType()==ua.KEY_LOCATOR_DIGEST&&0<b.getKeyData().size())c.writeBlobTlv(n.KeyLocatorDigest,b.getKeyData().buf());else throw Error("Unrecognized KeyLocatorType "+b.getType());c.writeTypeAndLength(a,c.getLength()-f)};G.decodeKeyLocator=function(a,b,c,f){null==f&&(f=!0);a=c.readNestedTlvsStart(a);b.clear();if(c.getOffset()!=a){if(c.peekType(n.Name,a))b.setType(ua.KEYNAME),G.decodeName(b.getKeyName(),
c,f);else if(c.peekType(n.KeyLocatorDigest,a))b.setType(ua.KEY_LOCATOR_DIGEST),b.setKeyData(new m(c.readBlobTlv(n.KeyLocatorDigest),f));else throw new S(Error("decodeKeyLocator: Unrecognized key locator type"));c.finishNestedTlvs(a)}};G.encodeValidityPeriod_=function(a,b){var c=b.getLength();b.writeBlobTlv(n.ValidityPeriod_NotAfter,(new m(ia.toIsoString(a.getNotAfter()))).buf());b.writeBlobTlv(n.ValidityPeriod_NotBefore,(new m(ia.toIsoString(a.getNotBefore()))).buf());b.writeTypeAndLength(n.ValidityPeriod_ValidityPeriod,
b.getLength()-c)};G.decodeValidityPeriod_=function(a,b){var c=b.readNestedTlvsStart(n.ValidityPeriod_ValidityPeriod);a.clear();var f=new m(b.readBlobTlv(n.ValidityPeriod_NotBefore),!1),g=ia.fromIsoString(f.toString()),f=new m(b.readBlobTlv(n.ValidityPeriod_NotAfter),!1),f=ia.fromIsoString(f.toString());a.setPeriod(g,f);b.finishNestedTlvs(c)};G.encodeSignatureInfo_=function(a,b){if(a instanceof bc){var c=a.getSignatureInfoEncoding();try{var f=new oa(c.buf()),g=f.readNestedTlvsStart(n.SignatureInfo);
f.readNonNegativeIntegerTlv(n.SignatureType);f.finishNestedTlvs(g,!0)}catch(l){throw Error("The GenericSignature encoding is not a valid NDN-TLV SignatureInfo: "+l.message);}b.writeBuffer(c.buf())}else{c=b.getLength();if(a instanceof Ja)a.getValidityPeriod().hasPeriod()&&G.encodeValidityPeriod_(a.getValidityPeriod(),b),G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureSha256WithRsa);else if(a instanceof Xa)a.getValidityPeriod().hasPeriod()&&
G.encodeValidityPeriod_(a.getValidityPeriod(),b),G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureSha256WithEcdsa);else if(a instanceof pb)G.encodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_SignatureHmacWithSha256);else if(a instanceof xb)b.writeNonNegativeIntegerTlv(n.SignatureType,n.SignatureType_DigestSha256);else throw Error("encodeSignatureInfo: Unrecognized Signature object type");
b.writeTypeAndLength(n.SignatureInfo,b.getLength()-c)}};G.decodeSignatureInfo=function(a,b,c){null==c&&(c=!0);var f=b.getOffset(),g=b.readNestedTlvsStart(n.SignatureInfo),l=b.readNonNegativeIntegerTlv(n.SignatureType);l==n.SignatureType_SignatureSha256WithRsa?(a.setSignature(new Ja),a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c),b.peekType(n.ValidityPeriod_ValidityPeriod,g)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):l==n.SignatureType_SignatureSha256WithEcdsa?(a.setSignature(new Xa),
a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c),b.peekType(n.ValidityPeriod_ValidityPeriod,g)&&G.decodeValidityPeriod_(a.getValidityPeriod(),b)):l==n.SignatureType_SignatureHmacWithSha256?(a.setSignature(new pb),a=a.getSignature(),G.decodeKeyLocator(n.KeyLocator,a.getKeyLocator(),b,c)):l==n.SignatureType_DigestSha256?a.setSignature(new xb):(a.setSignature(new bc),a=a.getSignature(),a.setSignatureInfoEncoding(new m(b.getSlice(f,g),c),l),b.finishNestedTlvs(g,!0));b.finishNestedTlvs(g)};
G.encodeMetaInfo=function(a,b){var c=b.getLength(),f=a.getFinalBlockId().getValue().buf();null!=f&&0<f.length&&(f=b.getLength(),G.encodeNameComponent(a.getFinalBlockId(),b),b.writeTypeAndLength(n.FinalBlockId,b.getLength()-f));b.writeOptionalNonNegativeIntegerTlv(n.FreshnessPeriod,a.getFreshnessPeriod());if(a.getType()!=Da.BLOB)if(a.getType()==Da.LINK||a.getType()==Da.KEY||a.getType()==Da.NACK)b.writeNonNegativeIntegerTlv(n.ContentType,a.getType());else if(a.getType()==Da.OTHER_CODE)b.writeNonNegativeIntegerTlv(n.ContentType,
a.getOtherTypeCode());else throw Error("unrecognized TLV ContentType");b.writeTypeAndLength(n.MetaInfo,b.getLength()-c)};G.decodeMetaInfo=function(a,b,c){null==c&&(c=!0);var f=b.readNestedTlvsStart(n.MetaInfo),g=b.readOptionalNonNegativeIntegerTlv(n.ContentType,f);null==g||0>g||g===Da.BLOB?a.setType(Da.BLOB):g===Da.LINK||g===Da.KEY||g===Da.NACK?a.setType(g):(a.setType(Da.OTHER_CODE),a.setOtherTypeCode(g));a.setFreshnessPeriod(b.readOptionalNonNegativeIntegerTlv(n.FreshnessPeriod,f));b.peekType(n.FinalBlockId,
f)?(g=b.readNestedTlvsStart(n.FinalBlockId),a.setFinalBlockId(G.decodeNameComponent(b,c)),b.finishNestedTlvs(g)):a.setFinalBlockId(null);b.finishNestedTlvs(f)};G.encodeControlParameters=function(a,b){var c=b.getLength();b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_ExpirationPeriod,a.getExpirationPeriod());if(0<a.getStrategy().size()){var f=b.getLength();G.encodeName(a.getStrategy(),b);b.writeTypeAndLength(n.ControlParameters_Strategy,b.getLength()-f)}f=a.getForwardingFlags().getNfdForwardingFlags();
f!=(new wa).getNfdForwardingFlags()&&b.writeNonNegativeIntegerTlv(n.ControlParameters_Flags,f);b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_Cost,a.getCost());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_Origin,a.getOrigin());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_LocalControlFeature,a.getLocalControlFeature());0!=a.getUri().length&&b.writeBlobTlv(n.ControlParameters_Uri,(new m(a.getUri())).buf());b.writeOptionalNonNegativeIntegerTlv(n.ControlParameters_FaceId,
a.getFaceId());null!=a.getName()&&G.encodeName(a.getName(),b);b.writeTypeAndLength(n.ControlParameters_ControlParameters,b.getLength()-c)};G.decodeControlParameters=function(a,b,f){null==f&&(f=!0);a.clear();var g=b.readNestedTlvsStart(n.ControlParameters_ControlParameters);if(b.peekType(n.Name,g)){var l=new c;G.decodeName(l,b,f);a.setName(l)}a.setFaceId(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_FaceId,g));b.peekType(n.ControlParameters_Uri,g)&&(l=new m(b.readOptionalBlobTlv(n.ControlParameters_Uri,
g),!1),a.setUri(l.toString()));b.skipOptionalTlv(n.ControlParameters_LocalUri,g);a.setLocalControlFeature(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_LocalControlFeature,g));a.setOrigin(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_Origin,g));a.setCost(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_Cost,g));b.skipOptionalTlv(n.ControlParameters_Capacity,g);b.skipOptionalTlv(n.ControlParameters_Count,g);b.skipOptionalTlv(n.ControlParameters_BaseCongestionMarkingInterval,
g);b.skipOptionalTlv(n.ControlParameters_DefaultCongestionThreshold,g);b.skipOptionalTlv(n.ControlParameters_Mtu,g);b.peekType(n.ControlParameters_Flags,g)&&(l=new wa,l.setNfdForwardingFlags(b.readNonNegativeIntegerTlv(n.ControlParameters_Flags,g)),a.setForwardingFlags(l));b.skipOptionalTlv(n.ControlParameters_Mask,g);b.peekType(n.ControlParameters_Strategy,g)&&(l=b.readNestedTlvsStart(n.ControlParameters_Strategy),G.decodeName(a.getStrategy(),b,f),b.finishNestedTlvs(l));a.setExpirationPeriod(b.readOptionalNonNegativeIntegerTlv(n.ControlParameters_ExpirationPeriod,
g));b.finishNestedTlvs(g)};G.encodeDelegationSet_=function(a,b){for(var c=a.size()-1;0<=c;--c){var f=b.getLength();G.encodeName(a.get(c).getName(),b);b.writeNonNegativeIntegerTlv(n.Link_Preference,a.get(c).getPreference());b.writeTypeAndLength(n.Link_Delegation,b.getLength()-f)}};G.decodeDelegationSet_=function(a,b,f,g){for(a.clear();f.getOffset()<b;){f.readTypeAndLength(n.Link_Delegation);var l=f.readNonNegativeIntegerTlv(n.Link_Preference),m=new c;G.decodeName(m,f,g);a.addUnsorted(l,m)}};G.encodeInterestV03_=
function(a){var b=new ra(256),c=b.getLength();b.writeOptionalBlobTlv(n.ApplicationParameters,a.getApplicationParameters().buf());b.writeOptionalNonNegativeIntegerTlv(n.InterestLifetime,a.getInterestLifetimeMilliseconds());if(a.getNonce().isNull()||0==a.getNonce().size())b.writeBlobTlv(n.Nonce,W.randomBytes(4));else if(4>a.getNonce().size()){var f=g(4);a.getNonce().buf().copy(f);for(var l=a.getNonce().size();4>l;++l)f[l]=W.randomBytes(1)[0];b.writeBlobTlv(n.Nonce,f)}else 4==a.getNonce().size()?b.writeBlobTlv(n.Nonce,
a.getNonce().buf()):b.writeBlobTlv(n.Nonce,a.getNonce().buf().slice(0,4));if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");f=b.getLength();G.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(n.ForwardingHint,b.getLength()-f)}a.getMustBeFresh()&&b.writeTypeAndLength(n.MustBeFresh,
0);a.getCanBePrefix()&&b.writeTypeAndLength(n.CanBePrefix,0);f=G.encodeName(a.getName(),b);a=b.getLength()-f.signedPortionBeginOffset;f=b.getLength()-f.signedPortionEndOffset;b.writeTypeAndLength(n.Interest,b.getLength()-c);c=b.getLength()-a;a=b.getLength()-f;return{encoding:new m(b.getOutput(),!1),signedPortionBeginOffset:c,signedPortionEndOffset:a}};G.decodeInterestV03_=function(a,b,c){null==c&&(c=!0);b=new oa(b);var f=b.readNestedTlvsStart(n.Interest),g=G.decodeName(a.getName(),b,c);a.setCanBePrefix(b.readBooleanTlv(n.CanBePrefix,
f));a.setMustBeFresh(b.readBooleanTlv(n.MustBeFresh,f));if(b.peekType(n.ForwardingHint,f)){var l=b.readNestedTlvsStart(n.ForwardingHint);G.decodeDelegationSet_(a.getForwardingHint(),l,b,c);b.finishNestedTlvs(l)}else a.getForwardingHint().clear();l=b.readOptionalBlobTlv(n.Nonce,f);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(n.InterestLifetime,f));a.setMinSuffixComponents(null);a.getKeyLocator().clear();a.getExclude().clear();a.setChildSelector(null);a.unsetLink();a.setSelectedDelegationIndex(null);
b.readOptionalBlobTlv(n.HopLimit,f);a.setApplicationParameters(new m(b.readOptionalBlobTlv(n.ApplicationParameters,f),c));a.setNonce(null==l?new m:new m(l,c));b.finishNestedTlvs(f);return g};var G=a.Tlv0_2WireFormat,xc=function(){G.call(this)};xc.prototype=new G;xc.prototype.name="Tlv0_1_1WireFormat";r.Tlv0_1_1WireFormat=xc;xc.instance=null;xc.get=function(){null===xc.instance&&(xc.instance=new xc);return xc.instance};var s=a.WireFormat,xc=a.Tlv0_1_1WireFormat,nd=function(){xc.call(this)};nd.prototype=
new xc;nd.prototype.name="Tlv0_1WireFormat";r.Tlv0_1WireFormat=nd;nd.instance=null;nd.get=function(){null===nd.instance&&(nd.instance=new nd);return nd.instance};s=a.WireFormat;G=a.Tlv0_2WireFormat;fb=function(){G.call(this)};fb.prototype=new G;fb.prototype.name="TlvWireFormat";r.TlvWireFormat=fb;fb.instance=null;fb.get=function(){null===fb.instance&&(fb.instance=new fb);return fb.instance};s.setDefaultWireFormat(fb.get());var L=a.DataUtils,ua=a.KeyLocatorType,D=a.Interest,R=a.Data,Ja=a.Sha256WithRsaSignature,
Xa=a.Sha256WithEcdsaSignature,pb=a.HmacWithSha256Signature,xb=a.DigestSha256Signature,Da=a.ContentType,s=a.WireFormat,Qd=function(){};r.EncodingUtils=Qd;Qd.encodeToHexInterest=function(a,b){b=b||s.getDefaultWireFormat();return L.toHex(a.wireEncode(b).buf())};Qd.encodeToHexData=function(a,b){b=b||s.getDefaultWireFormat();return L.toHex(a.wireEncode(b).buf())};Qd.decodeHexInterest=function(a,b){b=b||s.getDefaultWireFormat();var c=new D;c.wireDecode(L.toNumbers(a),b);return c};Qd.decodeHexData=function(a,
b){b=b||s.getDefaultWireFormat();var c=new R;c.wireDecode(L.toNumbers(a),b);return c};Qd.decodeSubjectPublicKeyInfo=function(a){a=L.toHex(a).toLowerCase();a=_x509_getPublicKeyHexArrayFromCertHex(a,_x509_getSubjectPublicKeyPosFromCertHex(a,0));var b=new A;b.setPublic(a[0],a[1]);return b};Qd.dataToHtml=function(a){function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");c+=a;c+="<br/>"}if(-1==a)return"NO CONTENT FOUND";if(-2==a)return"CONTENT NAME IS EMPTY";var c="";b("name: "+a.getName().toUri());
0<a.getContent().size()?(b("content (raw): "+a.getContent().buf().toString("binary")),b("content (hex): "+a.getContent().toHex())):b("content: <empty>");a.getMetaInfo().getType()!=Da.BLOB&&(a.getMetaInfo().getType()==Da.KEY?b("metaInfo.type: KEY"):a.getMetaInfo().getType()==Da.LINK?b("metaInfo.type: LINK"):a.getMetaInfo().getType()==Da.NACK?b("metaInfo.type: NACK"):a.getMetaInfo().getType()==Da.OTHER_CODE&&b("metaInfo.type: other code "+a.getMetaInfo().getOtherTypeCode()));b("metaInfo.freshnessPeriod (milliseconds): "+
(0<=a.getMetaInfo().getFreshnessPeriod()?""+a.getMetaInfo().getFreshnessPeriod():"<none>"));b("metaInfo.finalBlockId: "+(0<a.getMetaInfo().getFinalBlockId().getValue().size()?a.getMetaInfo().getFinalBlockId().getValue().toHex():"<none>"));var f=null,g=a.getSignature();g instanceof Ja?(g=a.getSignature(),b("Sha256WithRsa signature.signature: "+(0<g.getSignature().size()?g.getSignature().toHex():"<none>")),f=g.getKeyLocator()):g instanceof Xa?(g=a.getSignature(),b("Sha256WithEcdsa signature.signature: "+
(0<g.getSignature().size()?g.getSignature().toHex():"<none>")),f=g.getKeyLocator()):g instanceof pb?(g=a.getSignature(),b("HmacWithSha256 signature.signature: "+(0<g.getSignature().size()?g.getSignature().toHex():"<none>")),f=g.getKeyLocator()):g instanceof xb&&(g=a.getSignature(),b("DigestSha256 signature.signature: "+(0<g.getSignature().size()?g.getSignature().toHex():"<none>")));null!==f&&(null==f.getType()?b("signature.keyLocator: <none>"):f.getType()==ua.KEY_LOCATOR_DIGEST?b("signature.keyLocator: KeyLocatorDigest: "+
f.getKeyData().toHex()):f.getType()==ua.KEYNAME?b("signature.keyLocator: KeyName: "+f.getKeyName().toUri()):b("signature.keyLocator: <unrecognized ndn_KeyLocatorType>"));return c};var c=a.Name,R=a.Data,$d=function(){this.cache_=[]};r.InMemoryStorageRetaining=$d;$d.prototype.insert=function(a){this.cache_[a.getFullName().toUri()]=new R(a)};$d.prototype.find=function(a){for(var b in this.cache_)if(a.getName().isPrefixOf(new c(b)))return this.cache_[b]};$d.prototype.size=function(){return Object.keys(this.cache_).length};
var W=a,m=a.Blob,Rd=a.DecryptKey,ae=a.EncryptKey,fa=a.EncryptAlgorithmType,Hb=a.UseSubtleCrypto,b=a.SyncPromise,qb=function(){};r.AesAlgorithm=qb;qb.generateKey=function(a){a=W.randomBytes(a.getKeySize()/8);return new Rd(new m(a,!1))};qb.deriveEncryptKey=function(a){return new ae(a)};qb.decryptPromise=function(a,c,f,l){if(Hb()&&!l&&f.getAlgorithmType()!=fa.AesEcb)return f.getAlgorithmType()==fa.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"AES-CBC",
iv:f.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported encryption mode"));if(f.getAlgorithmType()==fa.AesEcb)try{var n=W.createDecipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),"");return b.resolve(new m(g.concat([n.update(c.buf()),n.final()]),!1))}catch(s){return b.reject(s)}else if(f.getAlgorithmType()==fa.AesCbc)try{return n=W.createDecipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),
f.getInitialVector().buf()),b.resolve(new m(g.concat([n.update(c.buf()),n.final()]),!1))}catch(r){return b.reject(r)}else return b.reject(Error("unsupported encryption mode"))};qb.decrypt=function(a,c,f){return b.getValue(this.decryptPromise(a,c,f,!0))};qb.encryptPromise=function(a,c,f,l){return f.getAlgorithmType()==fa.AesCbc&&f.getInitialVector().size()!=qb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):Hb()&&!l&&f.getAlgorithmType()!=fa.AesEcb?f.getAlgorithmType()==fa.AesCbc?crypto.subtle.importKey("raw",
a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.encrypt({name:"AES-CBC",iv:f.getInitialVector().buf()},a,c.buf())}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported encryption mode")):f.getAlgorithmType()==fa.AesEcb?(a=W.createCipheriv(32==a.size()?"aes-256-ecb":"aes-128-ecb",a.buf(),""),b.resolve(new m(g.concat([a.update(c.buf()),a.final()]),!1))):f.getAlgorithmType()==fa.AesCbc?(a=W.createCipheriv(32==
a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),f.getInitialVector().buf()),b.resolve(new m(g.concat([a.update(c.buf()),a.final()]),!1))):b.reject(Error("unsupported encryption mode"))};qb.encrypt=function(a,c,f){return b.getValue(this.encryptPromise(a,c,f,!0))};qb.BLOCK_SIZE=16;W=a;m=a.Blob;fa=function(){};r.EncryptAlgorithmType=fa;fa.AesEcb=0;fa.AesCbc=1;fa.RsaPkcs=2;fa.RsaOaep=3;var Gb=function(a,b){this.algorithmType_=a;if(null!=b&&0<b){var c=W.randomBytes(b);this.initialVector_=new m(c,!1)}else this.initialVector_=
new m};r.EncryptParams=Gb;Gb.prototype.getAlgorithmType=function(){return this.algorithmType_};Gb.prototype.getInitialVector=function(){return this.initialVector_};Gb.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};Gb.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof m?a:new m(a);return this};var W=a,c=a.Name,V=a.KeyLocator,ua=a.KeyLocatorType,fb=a.TlvWireFormat,m=a.Blob,qb=a.AesAlgorithm,rb=a.RsaAlgorithm,Gb=a.EncryptParams,fa=
a.EncryptAlgorithmType,La=a.EncryptedContent,b=a.SyncPromise,Fa=function(a){};r.Encryptor=Fa;Fa.NAME_COMPONENT_FOR=new c.Component("FOR");Fa.NAME_COMPONENT_READ=new c.Component("READ");Fa.NAME_COMPONENT_SAMPLE=new c.Component("SAMPLE");Fa.NAME_COMPONENT_ACCESS=new c.Component("ACCESS");Fa.NAME_COMPONENT_E_KEY=new c.Component("E-KEY");Fa.NAME_COMPONENT_D_KEY=new c.Component("D-KEY");Fa.NAME_COMPONENT_C_KEY=new c.Component("C-KEY");Fa.encryptDataPromise=function(a,f,l,n,s,r){a.getName().append(Fa.NAME_COMPONENT_FOR).append(l);
var F=s.getAlgorithmType();return F==fa.AesCbc||F==fa.AesEcb?Fa.encryptSymmetricPromise_(f,n,l,s,r).then(function(c){a.setContent(c.wireEncode(fb.get()));return b.resolve()}):F==fa.RsaPkcs||F==fa.RsaOaep?Fa.encryptAsymmetricPromise_(f,n,l,s,r).then(function(c){a.setContent(c.wireEncode(fb.get()));return b.resolve()},function(F){F=W.randomBytes(16);var x=new m(F,!1),Md=new c(l);Md.append("nonce");var sc=new Gb(fa.AesCbc,qb.BLOCK_SIZE),Ab;return Fa.encryptAsymmetricPromise_(x,n,l,s,r).then(function(a){Ab=
a;return Fa.encryptSymmetricPromise_(f,x,Md,sc,r)}).then(function(c){c=c.wireEncode();var f=Ab.wireEncode(),l=new g(c.size()+f.size());f.buf().copy(l,0);c.buf().copy(l,f.size());a.setContent(new m(l,!1));return b.resolve()})}):b.reject(Error("Unsupported encryption method"))};Fa.encryptData=function(a,c,f,g,l){return b.getValue(Fa.encryptDataPromise(a,c,f,g,l,!0))};Fa.encryptSymmetricPromise_=function(a,c,f,g,l){var m=g.getAlgorithmType(),n=g.getInitialVector(),s=new V;s.setType(ua.KEYNAME);s.setKeyName(f);
return m==fa.AesCbc||m==fa.AesEcb?m==fa.AesCbc&&n.size()!=qb.BLOCK_SIZE?b.reject(Error("incorrect initial vector size")):qb.encryptPromise(c,a,g,l).then(function(a){var c=new La;c.setAlgorithmType(m);c.setKeyLocator(s);c.setPayload(a);c.setInitialVector(n);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};Fa.encryptAsymmetricPromise_=function(a,c,f,g,l){var m=g.getAlgorithmType(),n=new V;n.setType(ua.KEYNAME);n.setKeyName(f);return m==fa.RsaPkcs||m==fa.RsaOaep?rb.encryptPromise(c,
a,g,l).then(function(a){var c=new La;c.setAlgorithmType(m);c.setKeyLocator(n);c.setPayload(a);return b.resolve(c)}):b.reject(Error("Unsupported encryption method"))};xd=a.constants;W=a;m=a.Blob;Rd=a.DecryptKey;ae=a.EncryptKey;fa=a.EncryptAlgorithmType;l=a.DerNode;lb=a.OID;sa=a.PrivateKeyStorage;Hb=a.UseSubtleCrypto;b=a.SyncPromise;Aa=a.PublicKey;Fc=null;try{Fc=a}catch(nf){}rb=function(){};r.RsaAlgorithm=rb;rb.generateKeyPromise=function(a,c){if(Hb()&&!c)return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",
modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){return Promise.resolve(new Rd(new m(new Uint8Array(a),!1)))});if(!Fc)return b.reject(Error("Need to install rsa-keypair: sudo npm install rsa-keypair"));try{var f=Fc.generate(a.getKeySize()).privateKey.toString().replace("-----BEGIN RSA PRIVATE KEY-----","").replace("-----END RSA PRIVATE KEY-----",
""),n=new g(f,"base64"),s=sa.encodePkcs8PrivateKey(n,new lb(sa.RSA_ENCRYPTION_OID),new l.DerNull).buf();return b.resolve(new Rd(s))}catch(r){return b.reject(r)}};rb.generateKey=function(a){return b.getValue(rb.generateKeyPromise(a,!0))};rb.deriveEncryptKey=function(a){a=rb.getRsaPrivateKeyDer(a);var b=l.parse(a.buf(),0).getChildren();a=b[1];var b=b[2],c=new l.DerSequence;c.addChild(a);c.addChild(b);a=c.encode();b=new l.DerSequence;b.addChild(new l.DerOid(new lb(sa.RSA_ENCRYPTION_OID)));b.addChild(new l.DerNull);
c=new l.DerSequence;c.addChild(b);c.addChild(new l.DerBitString(a.buf(),0));return new ae(c.encode())};rb.decryptPromise=function(a,c,f,g){if(Hb()&&!g&&f.getAlgorithmType()!=fa.RsaPkcs)return f.getAlgorithmType()==fa.RsaOaep?crypto.subtle.importKey("pkcs8",a.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"RSA-OAEP"},a,c.buf())}).then(function(a){return Promise.resolve(new m(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));
g=rb.getRsaPrivateKeyDer(a).buf().toString("base64");a="-----BEGIN RSA PRIVATE KEY-----\n";for(var l=0;l<g.length;l+=64)a+=g.substr(l,64)+"\n";a+="-----END RSA PRIVATE KEY-----";if(f.getAlgorithmType()==fa.RsaPkcs)f=xd.RSA_PKCS1_PADDING;else if(f.getAlgorithmType()==fa.RsaOaep)f=xd.RSA_PKCS1_OAEP_PADDING;else return b.reject(Error("unsupported padding scheme"));try{return b.resolve(new m(W.privateDecrypt({key:a,padding:f},c.buf()),!1))}catch(n){return b.reject(n)}};rb.decrypt=function(a,c,f){return b.getValue(rb.decryptPromise(a,
c,f,!0))};rb.encryptPromise=function(a,c,f,g){var l;try{l=new Aa(a)}catch(m){return b.reject(m)}return l.encryptPromise(c,f.getAlgorithmType(),g)};rb.encrypt=function(a,c,f){return b.getValue(rb.encryptPromise(a,c,f,!0))};rb.getRsaPrivateKeyDer=function(a){a=l.parse(a.buf(),0).getChildren();if(l.getSequence(a,1).getChildren()[0].toVal()!=sa.RSA_ENCRYPTION_OID)throw Error("The PKCS #8 private key is not RSA_ENCRYPTION");return a[2].getPayload()};var b=a.SyncPromise,od=function(){};r.ConsumerDb=od;
od.Error=function(a){if(a)return a.__proto__=od.Error.prototype,a};od.Error.prototype=Error();od.Error.prototype.name="ConsumerDbError";od.prototype.getKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.getKeyPromise is not implemented"))};od.prototype.addKeyPromise=function(a,c,f){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};od.prototype.deleteKeyPromise=function(a,c){return b.reject(Error("ConsumerDb.addKeyPromise is not implemented"))};var m=a.Blob,c=a.Name,D=
a.Interest,ab=a.NetworkNack,Fb=a.Link,La=a.EncryptedContent,ya=a.EncryptError,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,rb=a.RsaAlgorithm,qb=a.AesAlgorithm,Fa=a.Encryptor,b=a.SyncPromise,M=a.NdnCommon,Oa=function mb(a,b,f,g,l,m,n){this.database_=l;this.keyChain_=b;this.face_=a;this.groupName_=new c(f);this.consumerName_=new c(g);this.cKeyLink_=void 0==m?mb.NO_LINK:new Fb(m);this.dKeyLink_=void 0==n?mb.NO_LINK:new Fb(n);this.cKeyMap_={};this.dKeyMap_={}};r.Consumer=Oa;Oa.prototype.consume=function(a,
b,c,f){void 0==f&&(f=Oa.NO_LINK);a=new D(a);var g=this;this.sendInterest_(a,1,new Fb(f),function(a){g.decryptContent_(a,function(c){try{b(a,c)}catch(f){console.log("Error in onConsumeComplete: "+M.getErrorWithStackTrace(f))}},c)},c)};Oa.prototype.setGroup=function(a){this.groupName_=new c(a)};Oa.prototype.addDecryptionKeyPromise=function(a,c,f){return this.consumerName_.match(a)?this.database_.addKeyPromise(a,c,f):b.reject(Error("addDecryptionKey: The consumer name must be a prefix of the key name"))};
Oa.prototype.addDecryptionKey=function(a,c,f,g){return b.complete(f,g,this.addDecryptionKeyPromise(a,c,!f))};Oa.Error=function(a,b){this.errorCode=a;this.message=b};Oa.Error.callOnError=function(a,b,c){c||(c="");if(b instanceof Oa.Error)try{a(b.errorCode,b.message)}catch(f){console.log("Error in onError: "+M.getErrorWithStackTrace(f))}else try{a(ya.ErrorCode.General,c+b)}catch(g){console.log("Error in onError: "+M.getErrorWithStackTrace(g))}};Oa.decryptPromise_=function(a,c){return b.resolve().then(function(){if("object"==
typeof a&&a instanceof m){var f=a;a=new La;a.wireDecode(f)}f=a.getPayload();if(a.getAlgorithmType()==fa.AesCbc){var g=new Gb(fa.AesCbc);g.setInitialVector(a.getInitialVector());return qb.decryptPromise(c,f,g)}return a.getAlgorithmType()==fa.RsaOaep?(g=new Gb(fa.RsaOaep),rb.decryptPromise(c,f,g)):b.reject(new Oa.Error(ya.ErrorCode.UnsupportedEncryptionScheme,""+a.getAlgorithmType()))})};Oa.decrypt_=function(a,b,c,f){Oa.decryptPromise_(a,b).then(function(a){c(a)},function(a){Oa.Error.callOnError(f,
a)})};Oa.prototype.decryptContent_=function(a,b,f){var g=new La;try{g.wireDecode(a.getContent())}catch(l){Oa.Error.callOnError(f,l,"Error decoding EncryptedContent: ");return}var m=g.getKeyLocator().getKeyName();if(a=this.cKeyMap_[m.toUri()])this.decrypt_(g,a,b,f);else{a=new c(m);a.append(Fa.NAME_COMPONENT_FOR).append(this.groupName_);a=new D(a);var n=this;this.sendInterest_(a,1,this.cKeyLink_,function(a){n.decryptCKey_(a,function(a){n.cKeyMap_[m.toUri()]=a;Oa.decrypt_(g,a,b,f)},f)},f)}};Oa.prototype.decryptCKey_=
function(a,b,f){a=a.getContent();var g=new La;try{g.wireDecode(a)}catch(l){Oa.Error.callOnError(f,l,"Error decoding EncryptedContent: ");return}a=g.getKeyLocator().getKeyName();var m=a.getPrefix(-3);m.append(Fa.NAME_COMPONENT_D_KEY).append(a.getSubName(-2));if(a=this.dKeyMap_[m.toUri()])this.decrypt_(g,a,b,f);else{a=new c(m);a.append(Fa.NAME_COMPONENT_FOR).append(this.consumerName_);a=new D(a);var n=this;this.sendInterest_(a,1,this.dKeyLink_,function(a){n.decryptDKeyPromise_(a).then(function(a){n.dKeyMap_[m.toUri()]=
a;Oa.decrypt_(g,a,b,f)},function(a){Oa.Error.callOnError(f,a,"decryptDKey error: ")})},f)}};Oa.prototype.decryptDKeyPromise_=function(a){var c,f,g,l=this;return b.resolve().then(function(){c=a.getContent();f=new La;f.wireDecode(c);var b=f.getKeyLocator().getKeyName();return l.getDecryptionKeyPromise_(b)}).then(function(a){if(0==a.size())return b.reject(new Oa.Error(ya.ErrorCode.NoDecryptKey,"The desired consumer decryption key in not in the database"));var l=c.buf().slice(f.wireEncode().size());g=
new m(l,!1);return 0==g.size()?b.reject(new Oa.Error(ya.ErrorCode.InvalidEncryptedFormat,"The data packet does not satisfy the D-KEY packet format")):Oa.decryptPromise_(f,a)}).then(function(a){return Oa.decryptPromise_(g,a)})};Oa.prototype.sendInterest_=function(a,b,c,f,g){function l(a,b){try{g(ya.ErrorCode.DataRetrievalFailure,a.getName().toUri())}catch(c){console.log("Error in onError: "+M.getErrorWithStackTrace(c))}}var m=this,n=function(a,b){try{m.keyChain_.verifyData(b,f,function(a,b){try{g(ya.ErrorCode.Validation,
"verifyData failed. Reason: "+b)}catch(c){console.log("Error in onError: "+M.getErrorWithStackTrace(c))}})}catch(c){Oa.Error.callOnError(g,c,"verifyData error: ")}},s=function(a){0<b?m.sendInterest_(a,b-1,c,f,g):l(a,new ab)};0!==c.getDelegations().size()&&(a=new D(a),a.setLinkWireEncoding(c.wireEncode()));try{this.face_.expressInterest(a,n,s,l)}catch(r){Oa.Error.callOnError(g,r,"expressInterest error: ")}};Oa.prototype.getDecryptionKeyPromise_=function(a){return this.database_.getKeyPromise(a)};Oa.NO_LINK=
new Fb;m=a.Blob;Rd=function ze(a){this.keyBits_="object"===typeof a&&a instanceof ze?a.keyBits_:"object"===typeof a&&a instanceof m?a:new m(a)};r.DecryptKey=Rd;Rd.prototype.getKeyBits=function(){return this.keyBits_};var c=a.Name,D=a.Interest,ya=a.EncryptError,C=a.KeyChain,Sc=a.SafeBag,Ca=a.EncryptorV2,ya=a.EncryptError,La=a.EncryptedContent,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,qb=a.AesAlgorithm,M=a.NdnCommon,la=a.Pib,b=a.SyncPromise,ua=a.KeyLocatorType,f=a.Log.LOG,Jb=function(a,b,c,f){this.contentKeys_=
{};this.credentialsKey_=a;this.face_=f;this.keyChain_=c;this.internalKeyChain_=new C("pib-memory:","tpm-memory:")};r.DecryptorV2=Jb;Jb.prototype.shutdown=function(){for(var a in this.contentKeys_){var b=this.contentKeys_[a];if(0<b.pendingInterest){this.face_.removePendingInterest(b.pendingInterest);b.pendingInterest=0;for(var c in b.pendingDecrypts)b.pendingDecrypts[c].onError(ya.ErrorCode.CkRetrievalFailure,"Canceling pending decrypt as ContentKey is being destroyed");b.pendingDecrypts=[]}}};Jb.prototype.decrypt=
function(a,b,c){if(a.getKeyLocator().getType()!=ua.KEYNAME)3<f&&console.log("Missing required KeyLocator in the supplied EncryptedContent block"),c(ya.ErrorCode.MissingRequiredKeyLocator,"Missing required KeyLocator in the supplied EncryptedContent block");else if(a.hasInitialVector()){var g=a.getKeyLocatorName(),l=g.toUri(),m=this.contentKeys_[l],n=void 0===m;n&&(m=new Jb.ContentKey,this.contentKeys_[l]=m);m.isRetrieved?Jb.doDecrypt_(a,m.bits,b,c):(3<f&&console.log("CK "+g.toUri()+" not yet available, so adding to the pending decrypt queue"),
m.pendingDecrypts.push(new Jb.ContentKey.PendingDecrypt(a,b,c)));n&&this.fetchCk_(g,m,c,Ca.N_RETRIES)}else 3<f&&console.log("Missing required initial vector in the supplied EncryptedContent block"),c(ya.ErrorCode.MissingRequiredInitialVector,"Missing required initial vector in the supplied EncryptedContent block")};Jb.ContentKey=function(){this.isRetrieved=!1;this.bits=null;this.pendingInterest=0;this.pendingDecrypts=[]};Jb.ContentKey.PendingDecrypt=function(a,b,c){this.encryptedContent=a;this.onSuccess=
b;this.onError=c};Jb.prototype.fetchCk_=function(a,b,c,g){3<f&&console.log("Fetching CK "+a.toUri());var l=this,m=function(a,g){try{b.pendingInterest=0;var m=[null],n=[null],s=[null];if(Jb.extractKdkInfoFromCkName_(g.getName(),a.getName(),c,m,n,s)){var r=null;try{r=l.internalKeyChain_.getPib().getIdentity(n[0])}catch(sc){if(!(sc instanceof la.Error))throw sc;}if(null!=r){n=null;try{n=r.getKey(s[0])}catch(F){if(!(F instanceof la.Error))throw F;}if(null!=n){3<f&&console.log("KDK "+s.toUri()+" already exists, so directly using it to decrypt the CK");
l.decryptCkAndProcessPendingDecrypts_(b,g,s[0],c);return}}l.fetchKdk_(b,m[0],g,c,Ca.N_RETRIES)}}catch(x){c(ya.ErrorCode.General,"Error in fetchCk onData: "+x)}},n=function(f){b.pendingInterest=0;1<g?l.fetchCk_(a,b,c,g-1):c(ya.ErrorCode.CkRetrievalTimeout,"Retrieval of CK ["+f.getName().toUri()+"] timed out")},s=function(a,f){b.pendingInterest=0;c(ya.ErrorCode.CkRetrievalFailure,"Retrieval of CK ["+a.getName().toUri()+"] failed. Got NACK ("+f.getReason()+")")};try{b.pendingInterest=this.face_.expressInterest((new D(a)).setMustBeFresh(!1).setCanBePrefix(!0),
m,n,s)}catch(r){c(ya.ErrorCode.General,"expressInterest error: "+r)}};Jb.prototype.fetchKdk_=function(a,b,g,l,m){var n=new c(b);n.append(Ca.NAME_COMPONENT_ENCRYPTED_BY).append(this.credentialsKey_.getName());3<f&&console.log("Fetching KDK "+n.toUri());var s=this,r=function(c,f){a.pendingInterest=0;if(s.decryptAndImportKdk_(f,l)){var m=b.getPrefix(-2).append("KEY").append(b.get(-1));s.decryptCkAndProcessPendingDecrypts_(a,g,m,l)}},sc=function(c){a.pendingInterest=0;1<m?s.fetchKdk_(a,b,g,l,m-1):l(ya.ErrorCode.KdkRetrievalTimeout,
"Retrieval of KDK ["+c.getName().toUri()+"] timed out")},Ab=function(b,c){a.pendingInterest=0;l(ya.ErrorCode.KdkRetrievalFailure,"Retrieval of KDK ["+b.getName().toUri()+"] failed. Got NACK ("+c.getReason()+")")};try{a.pendingInterest=this.face_.expressInterest((new D(n)).setMustBeFresh(!0).setCanBePrefix(!1),r,sc,Ab)}catch(Pe){l(ya.ErrorCode.General,"expressInterest error: "+Pe)}};Jb.prototype.decryptAndImportKdk_=function(a,c){try{3<f&&console.log("Decrypting and importing KDK "+a.getName().toUri());
var g=new La;g.wireDecodeV2(a.getContent());var l=new Sc(g.getPayload()),m=b.getValue(this.keyChain_.getTpm().decryptPromise(g.getPayloadKey().buf(),this.credentialsKey_.getName(),!0));if(m.isNull())return c(ya.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+this.credentialsKey_.getName().toUri()+" not found in TPM"),!1;this.internalKeyChain_.importSafeBag(l,m.buf());return!0}catch(n){return c(ya.ErrorCode.DecryptionFailure,"Failed to decrypt KDK ["+a.getName().toUri()+"]: "+n),!1}};Jb.prototype.decryptCkAndProcessPendingDecrypts_=
function(a,c,g,l){3<f&&console.log("Decrypting CK data "+c.getName().toUri());var m=new La;try{m.wireDecodeV2(c.getContent())}catch(n){l(ya.ErrorCode.InvalidEncryptedFormat,"Error decrypting EncryptedContent: "+n);return}var s;try{s=b.getValue(this.internalKeyChain_.getTpm().decryptPromise(m.getPayload().buf(),g,!0))}catch(r){l(ya.ErrorCode.DecryptionFailure,"Error decrypting the CK EncryptedContent "+r);return}if(s.isNull())l(ya.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+g.toUri()+" not found in TPM");
else{a.bits=s;a.isRetrieved=!0;for(var sc in a.pendingDecrypts)c=a.pendingDecrypts[sc],Jb.doDecrypt_(c.encryptedContent,a.bits,c.onSuccess,c.onError);a.pendingDecrypts=[]}};Jb.doDecrypt_=function(a,b,c,f){if(a.hasInitialVector()){var g;try{var l=new Gb(fa.AesCbc);l.setInitialVector(a.getInitialVector());g=qb.decrypt(b,a.getPayload(),l)}catch(m){f(ya.ErrorCode.DecryptionFailure,"Decryption error in doDecrypt: "+m);return}try{c(g)}catch(n){console.log("Error in onSuccess: "+M.getErrorWithStackTrace(n))}}else f(ya.ErrorCode.MissingRequiredInitialVector,
"Expecting Initial Vector in the encrypted content, but it is not present")};Jb.convertKekNameToKdkPrefix_=function(a,b){return 2>a.size()||!a.get(-2).equals(Ca.NAME_COMPONENT_KEK)?(b(ya.ErrorCode.KekInvalidName,"Invalid KEK name ["+a.toUri()+"]"),null):a.getPrefix(-2).append(Ca.NAME_COMPONENT_KDK).append(a.get(-1))};Jb.extractKdkInfoFromCkName_=function(a,b,c,f,g,l){if(a.size()<b.size()+1||!a.getPrefix(b.size()).equals(b)||!a.get(b.size()).equals(Ca.NAME_COMPONENT_ENCRYPTED_BY))return c(ya.ErrorCode.CkInvalidName,
"Invalid CK name ["+a.toUri()+"]"),!1;a=a.getSubName(b.size()+1);f[0]=Jb.convertKekNameToKdkPrefix_(a,c);if(null==f[0])return!1;g[0]=a.getPrefix(-2);l[0]=a.getPrefix(-2).append("KEY").append(a.get(-1));return!0};ya=function(){};r.EncryptError=ya;ya.ErrorCode={KekRetrievalFailure:1,KekRetrievalTimeout:2,KekInvalidName:3,KdkRetrievalFailure:11,KdkRetrievalTimeout:12,KdkInvalidName:13,KdkDecryptionFailure:14,CkRetrievalFailure:21,CkRetrievalTimeout:22,CkInvalidName:23,MissingRequiredKeyLocator:101,TpmKeyNotFound:102,
EncryptionFailure:103,DecryptionFailure:104,MissingRequiredInitialVector:110,General:200,Timeout:1001,Validation:1002,UnsupportedEncryptionScheme:1032,InvalidEncryptedFormat:1033,NoDecryptKey:1034,DataRetrievalFailure:1036};m=a.Blob;ae=function Oe(a){this.keyBits_="object"===typeof a&&a instanceof Oe?a.keyBits_:"object"===typeof a&&a instanceof m?a:new m(a)};r.EncryptKey=ae;ae.prototype.getKeyBits=function(){return this.keyBits_};V=a.KeyLocator;ua=a.KeyLocatorType;s=a.WireFormat;m=a.Blob;La=function Ae(a){"object"===
typeof a&&a instanceof Ae?(this.algorithmType_=a.algorithmType_,this.keyLocator_=new V(a.keyLocator_),this.initialVector_=a.initialVector_,this.payload_=a.payload_,this.payloadKey_=a.payloadKey_):this.clear()};r.EncryptedContent=La;La.prototype.getAlgorithmType=function(){return this.algorithmType_};La.prototype.getKeyLocator=function(){return this.keyLocator_};La.prototype.getKeyLocatorName=function(){if(this.keyLocator_.getType()!=ua.KEYNAME)throw Error("getKeyLocatorName: The KeyLocator type must be KEYNAME");
return this.keyLocator_.getKeyName()};La.prototype.hasInitialVector=function(){return!this.initialVector_.isNull()};La.prototype.getInitialVector=function(){return this.initialVector_};La.prototype.getPayload=function(){return this.payload_};La.prototype.getPayloadKey=function(){return this.payloadKey_};La.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};La.prototype.setKeyLocator=function(a){this.keyLocator_="object"===typeof a&&a instanceof V?new V(a):new V;return this};
La.prototype.setKeyLocatorName=function(a){this.keyLocator_.setType(ua.KEYNAME);this.keyLocator_.setKeyName(a);return this};La.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof m?a:new m(a);return this};La.prototype.setPayload=function(a){this.payload_="object"===typeof a&&a instanceof m?a:new m(a);return this};La.prototype.setPayloadKey=function(a){this.payloadKey_="object"===typeof a&&a instanceof m?a:new m(a);return this};La.prototype.clear=function(){this.algorithmType_=
null;this.keyLocator_=new V;this.initialVector_=new m;this.payload_=new m;this.payloadKey_=new m};La.prototype.wireEncode=function(a){a=a||s.getDefaultWireFormat();return a.encodeEncryptedContent(this)};La.prototype.wireEncodeV2=function(a){a=a||s.getDefaultWireFormat();return a.encodeEncryptedContentV2(this)};La.prototype.wireDecode=function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeEncryptedContent(this,a.buf(),!1):b.decodeEncryptedContent(this,a,!0)};La.prototype.wireDecodeV2=
function(a,b){b=b||s.getDefaultWireFormat();"object"===typeof a&&a instanceof m?b.decodeEncryptedContentV2(this,a.buf(),!1):b.decodeEncryptedContentV2(this,a,!0)};W=a;m=a.Blob;c=a.Name;R=a.Data;D=a.Interest;Z=a.SigningInfo;$d=a.InMemoryStorageRetaining;Aa=a.PublicKey;La=a.EncryptedContent;Gb=a.EncryptParams;fa=a.EncryptAlgorithmType;qb=a.AesAlgorithm;M=a.NdnCommon;ya=a.EncryptError;f=a.Log.LOG;Ca=function Be(a,b,g,l,m,n,s){this.accessPrefix_=new c(a);this.ckPrefix_=new c(b);this.ckBits_=null;this.ckDataSigningInfo_=
new Z(g);this.isKekRetrievalInProgress_=!1;this.onError_=l;this.keyChain_=n;this.face_=s;this.kekData_=null;this.storage_=new $d;this.kekPendingInterestId_=0;this.regenerateCk();var r=this;this.ckRegisteredPrefixId_=this.face_.registerPrefix((new c(b)).append(Be.NAME_COMPONENT_CK),function(a,b,c,g,l){a=r.storage_.find(b);if(null!=a){3<f&&console.log("Serving "+a.getName().toUri()+" from InMemoryStorage");try{c.putData(a)}catch(m){console.log("Error in Face.putData: "+M.getErrorWithStackTrace(m))}}else 3<
f&&console.log("Didn't find CK data for "+b.getName().toUri())},function(a){0<f&&console.log("Failed to register prefix "+a.toUri())})};r.EncryptorV2=Ca;Ca.prototype.shutdown=function(){this.face_.unsetInterestFilter(this.ckRegisteredPrefixId_);0<this.kekPendingInterestId_&&this.face_.removePendingInterest(this.kekPendingInterestId_)};Ca.prototype.encrypt=function(a){var b=W.randomBytes(Ca.AES_IV_SIZE),c=new Gb(fa.AesCbc);c.setInitialVector(new m(b,!1));a instanceof m||(a=new m(a));a=qb.encrypt(new m(this.ckBits_,
!1),a,c);c=new La;c.setInitialVector(new m(b,!1));c.setPayload(a);c.setKeyLocatorName(this.ckName_);return c};Ca.prototype.regenerateCk=function(){this.ckName_=new c(this.ckPrefix_);this.ckName_.append(Ca.NAME_COMPONENT_CK);this.ckName_.appendVersion((new Date).getTime());3<f&&console.log("Generating new CK: "+this.ckName_.toUri());this.ckBits_=W.randomBytes(Ca.AES_KEY_SIZE);null==this.kekData_?this.retryFetchingKek_():this.makeAndPublishCkData_(this.onError_)};Ca.prototype.size=function(){return this.storage_.size()};
Ca.prototype.retryFetchingKek_=function(){if(!this.isKekRetrievalInProgress_){3<f&&console.log("Retrying fetching of the KEK");this.isKekRetrievalInProgress_=!0;var a=this;this.fetchKekAndPublishCkData_(function(){3<f&&console.log("The KEK was retrieved and published");a.isKekRetrievalInProgress_=!1},function(b,c){3<f&&console.log("Failed to retrieve KEK: "+c);a.isKekRetrievalInProgress_=!1;a.onError_(b,c)},Ca.N_RETRIES)}};Ca.prototype.fetchKekAndPublishCkData_=function(a,b,g){3<f&&console.log("Fetching KEK: "+
(new c(this.accessPrefix_)).append(Ca.NAME_COMPONENT_KEK).toUri());if(0<this.kekPendingInterestId_)b(ya.ErrorCode.General,"fetchKekAndPublishCkData: There is already a kekPendingInterestId_");else{var l=this,m=function(c,f){l.kekPendingInterestId_=0;l.kekData_=f;l.makeAndPublishCkData_(b)&&a()},n=function(c){l.kekPendingInterestId_=0;1<g?l.fetchKekAndPublishCkData_(a,b,g-1):(b(ya.ErrorCode.KekRetrievalTimeout,"Retrieval of KEK ["+c.getName().toUri()+"] timed out"),3<f&&console.log("Scheduling retry after all timeouts"),
setTimeout(function(){l.retryFetchingKek_()},Ca.RETRY_DELAY_KEK_RETRIEVAL_MS))},s=function(c,m){l.kekPendingInterestId_=0;1<g?setTimeout(function(){l.fetchKekAndPublishCkData_(a,b,g-1)},Ca.RETRY_DELAY_AFTER_NACK_MS):(b(ya.ErrorCode.KekRetrievalFailure,"Retrieval of KEK ["+c.getName().toUri()+"] failed. Got NACK ("+m.getReason()+")"),3<f&&console.log("Scheduling retry from NACK"),setTimeout(function(){l.retryFetchingKek_()},Ca.RETRY_DELAY_KEK_RETRIEVAL_MS))};try{this.kekPendingInterestId_=this.face_.expressInterest((new D((new c(this.accessPrefix_)).append(Ca.NAME_COMPONENT_KEK))).setMustBeFresh(!0).setCanBePrefix(!0),
m,n,s)}catch(r){b(ya.ErrorCode.General,"expressInterest error: "+r)}}};Ca.prototype.makeAndPublishCkData_=function(a){try{var b=new Aa(this.kekData_.getContent()),g=new La,l=b.encrypt(this.ckBits_,fa.RsaOaep);g.setPayload(l);var m=new R((new c(this.ckName_)).append(Ca.NAME_COMPONENT_ENCRYPTED_BY).append(this.kekData_.getName()));m.setContent(g.wireEncodeV2());m.getMetaInfo().setFreshnessPeriod(Ca.DEFAULT_CK_FRESHNESS_PERIOD_MS);this.keyChain_.sign(m,this.ckDataSigningInfo_);this.storage_.insert(m);
3<f&&console.log("Publishing CK data: "+m.getName().toUri());return!0}catch(n){return a(ya.ErrorCode.EncryptionFailure,"Failed to encrypt generated CK with KEK "+this.kekData_.getName().toUri()),!1}};Ca.NAME_COMPONENT_ENCRYPTED_BY=new c.Component("ENCRYPTED-BY");Ca.NAME_COMPONENT_NAC=new c.Component("NAC");Ca.NAME_COMPONENT_KEK=new c.Component("KEK");Ca.NAME_COMPONENT_KDK=new c.Component("KDK");Ca.NAME_COMPONENT_CK=new c.Component("CK");Ca.RETRY_DELAY_AFTER_NACK_MS=1E3;Ca.RETRY_DELAY_KEK_RETRIEVAL_MS=
6E4;Ca.AES_KEY_SIZE=32;Ca.AES_IV_SIZE=16;Ca.N_RETRIES=3;Ca.DEFAULT_CK_FRESHNESS_PERIOD_MS=36E5;var b=a.SyncPromise,hb=function(){};r.GroupManagerDb=hb;hb.Error=function(a){if(a)return a.__proto__=hb.Error.prototype,a};hb.Error.prototype=Error();hb.Error.prototype.name="GroupManagerDbError";hb.prototype.hasSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.hasSchedulePromise is not implemented"))};hb.prototype.listAllScheduleNamesPromise=function(a){return b.reject(Error("GroupManagerDb.listAllScheduleNamesPromise is not implemented"))};
hb.prototype.getSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getSchedulePromise is not implemented"))};hb.prototype.getScheduleMembersPromise=function(a,c){return b.reject(Error("GroupManagerDb.getScheduleMembersPromise is not implemented"))};hb.prototype.addSchedulePromise=function(a,c,f){return b.reject(Error("GroupManagerDb.addSchedulePromise is not implemented"))};hb.prototype.deleteSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteSchedulePromise is not implemented"))};
hb.prototype.renameSchedulePromise=function(a,c,f){return b.reject(Error("GroupManagerDb.renameSchedulePromise is not implemented"))};hb.prototype.updateSchedulePromise=function(a,c,f){return b.reject(Error("GroupManagerDb.updateSchedulePromise is not implemented"))};hb.prototype.hasMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasMemberPromise is not implemented"))};hb.prototype.listAllMembersPromise=function(a){return b.reject(Error("GroupManagerDb.listAllMembersPromise is not implemented"))};
hb.prototype.getMemberSchedulePromise=function(a,c){return b.reject(Error("GroupManagerDb.getMemberSchedulePromise is not implemented"))};hb.prototype.addMemberPromise=function(a,c,f,g){return b.reject(Error("GroupManagerDb.addMemberPromise is not implemented"))};hb.prototype.updateMemberSchedulePromise=function(a,c,f){return b.reject(Error("GroupManagerDb.updateMemberSchedulePromise is not implemented"))};hb.prototype.deleteMemberPromise=function(a,c){return b.reject(Error("GroupManagerDb.deleteMemberPromise is not implemented"))};
hb.prototype.hasEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.hasEKeyPromise is not implemented"))};hb.prototype.addEKeyPromise=function(a,c,f,g){return b.reject(Error("GroupManagerDb.addEKeyPromise is not implemented"))};hb.prototype.getEKeyPromise=function(a,c){return b.reject(Error("GroupManagerDb.getEKeyPromise is not implemented"))};hb.prototype.cleanEKeysPromise=function(a){return b.reject(Error("GroupManagerDb.cleanEKeysPromise is not implemented"))};hb.prototype.deleteEKeyPromise=
function(a,c){return b.reject(Error("GroupManagerDb.deleteEKeyPromise is not implemented"))};var c=a.Name,R=a.Data,b=a.SyncPromise,Na=a.IdentityCertificate,x=a.SecurityException,cc=a.RsaKeyParams,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,Fa=a.Encryptor,rb=a.RsaAlgorithm,sb=a.Interval,ia=a.Schedule,tb=function(a,b,f,g,l,m){this.namespace_=(new c(a)).append(Fa.NAME_COMPONENT_READ).append(b);this.database_=f;this.keySize_=g;this.freshnessHours_=l;this.keyChain_=m};r.GroupManager=tb;tb.prototype.getGroupKeyPromise=
function(a,f,g){void 0==f&&(f=!0);var l=[],m=[],n=this,s,r,F,x;return this.calculateIntervalPromise_(a,l,g).then(function(a){if(!1==a.isValid())return b.resolve(m);F=ia.toIsoString(a.getStartTime());x=ia.toIsoString(a.getEndTime());var P=new c(n.namespace_);P.append(Fa.NAME_COMPONENT_E_KEY).append(F).append(x);return b.resolve().then(function(){return f?b.resolve(!1):n.database_.hasEKeyPromise(P,g)}).then(function(a){return!f&&a?n.getEKeyPromise_(P,g).then(function(a){s=a.privateKey;r=a.publicKey;
return b.resolve()}):n.generateKeyPairPromise_(g).then(function(a){s=a.privateKeyBlob;r=a.publicKeyBlob;return n.deleteEKeyPromise_(P,g)}).then(function(){return n.addEKeyPromise_(P,r,s,g)})}).then(function(){return n.createEKeyDataPromise_(F,x,r,g)}).then(function(a){function c(a){return a>=l.length?b.resolve():n.createDKeyDataPromise_(F,x,l[a].keyName,s,l[a].publicKey,g).then(function(b){m.push(b);return c(a+1)})}m.push(a);return c(0)}).then(function(){return b.resolve(m)})})};tb.prototype.addSchedulePromise=
function(a,b,c){return this.database_.addSchedulePromise(a,b,c)};tb.prototype.deleteSchedulePromise=function(a,b){return this.database_.deleteSchedulePromise(a,b)};tb.prototype.updateSchedulePromise=function(a,b,c){return this.database_.updateSchedulePromise(a,b,c)};tb.prototype.addMemberPromise=function(a,b,c){b=new Na(b);return this.database_.addMemberPromise(a,b.getPublicKeyName(),b.getPublicKeyInfo().getKeyDer(),c)};tb.prototype.removeMemberPromise=function(a,b){return this.database_.deleteMemberPromise(a,
b)};tb.prototype.updateMemberSchedulePromise=function(a,b,c){return this.database_.updateMemberSchedulePromise(a,b,c)};tb.prototype.cleanEKeysPromise=function(a){return this.database_.cleanEKeysPromise(a)};tb.prototype.calculateIntervalPromise_=function(a,c,f){var g=new sb,l=new sb;c.splice(0,c.length);var m=this;return this.database_.listAllScheduleNamesPromise(f).then(function(n){function s(r){if(r>=n.length)return b.resolve();var F=n[r];return m.database_.getSchedulePromise(F,f).then(function(b){b=
b.getCoveringInterval(a);var n=b.interval;if(b.isPositive)return g.isValid()||(g=n),g.intersectWith(n),m.database_.getScheduleMembersPromise(F,f).then(function(a){for(var b=0;b<a.length;++b)tb.memberKeysAdd_(c,a[b]);return s(r+1)});l.isValid()||(l=n);l.intersectWith(n);return s(r+1)})}return s(0)}).then(function(){if(!g.isValid())return b.resolve(new sb(!1));var a;a=l.isValid()?g.intersectWith(l):g;return b.resolve(a)})};tb.memberKeysAdd_=function(a,b){for(var c=0;c<a.length;){var f=a[c].keyName.compare(b.keyName);
if(0==f)return;if(0<f)break;c+=1}a.splice(c,0,b)};tb.prototype.generateKeyPairPromise_=function(a){a=new cc(this.keySize_);return rb.generateKeyPromise(a).then(function(a){a=a.getKeyBits();var c=rb.deriveEncryptKey(a).getKeyBits();return b.resolve({privateKeyBlob:a,publicKeyBlob:c})})};tb.prototype.createEKeyDataPromise_=function(a,b,f,g){g=new c(this.namespace_);g.append(Fa.NAME_COMPONENT_E_KEY).append(a).append(b);a=new R(g);a.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*tb.MILLISECONDS_IN_HOUR);
a.setContent(f);return this.keyChain_.signPromise(a)};tb.prototype.createDKeyDataPromise_=function(a,f,g,l,m,n){var s=new c(this.namespace_);s.append(Fa.NAME_COMPONENT_D_KEY);s.append(a).append(f);var r=new R(s);r.getMetaInfo().setFreshnessPeriod(this.freshnessHours_*tb.MILLISECONDS_IN_HOUR);a=new Gb(fa.RsaOaep);var F=this;return Fa.encryptDataPromise(r,l,g,m,a,n).catch(function(a){return b.reject(x(Error("createDKeyData: Error in encryptData: "+a)))}).then(function(){return F.keyChain_.signPromise(r)})};
tb.prototype.addEKeyPromise_=function(a,b,c,f){return this.database_.addEKeyPromise(a,b,c,f)};tb.prototype.getEKeyPromise_=function(a,b){return this.database_.getEKeyPromise(a,b)};tb.prototype.deleteEKeyPromise_=function(a,b){return this.database_.deleteEKeyPromise(a,b)};tb.MILLISECONDS_IN_HOUR=36E5;sb=function Ce(a,b){if("object"===typeof a&&a instanceof Ce)this.startTime_=a.startTime_,this.endTime_=a.endTime_,this.isValid_=a.isValid_;else if("number"===typeof a){if(!(a<b))throw Error("Interval start time must be less than the end time");
this.startTime_=a;this.endTime_=b;this.isValid_=!0}else this.startTime_=-Number.MAX_VALUE,this.endTime_=-Number.MAX_VALUE,this.isValid_=a?!0:!1};r.Interval=sb;sb.prototype.set=function(a){this.startTime_=a.startTime_;this.endTime_=a.endTime_;this.isValid_=a.isValid_};sb.prototype.covers=function(a){if(!this.isValid_)throw Error("Interval.covers: This Interval is invalid");return this.isEmpty()?!1:this.startTime_<=a&&a<this.endTime_};sb.prototype.intersectWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");
if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");if(this.isEmpty()||a.isEmpty()||this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)return this.startTime_=this.endTime_,this;this.startTime_<=a.startTime_&&(this.startTime_=a.startTime_);this.endTime_>a.endTime_&&(this.endTime_=a.endTime_);return this};sb.prototype.unionWith=function(a){if(!this.isValid_)throw Error("Interval.intersectWith: This Interval is invalid");if(!a.isValid_)throw Error("Interval.intersectWith: The other Interval is invalid");
if(this.isEmpty())return this.startTime_=a.startTime_,this.endTime_=a.endTime_,this;if(a.isEmpty())return this;if(this.startTime_>=a.endTime_||this.endTime_<=a.startTime_)throw Error("Interval.unionWith: The two intervals do not have an intersection");this.startTime_>a.startTime_&&(this.startTime_=a.startTime_);this.endTime_<a.endTime_&&(this.endTime_=a.endTime_);return this};sb.prototype.getStartTime=function(){if(!this.isValid_)throw Error("Interval.getStartTime: This Interval is invalid");return this.startTime_};
sb.prototype.getEndTime=function(){if(!this.isValid_)throw Error("Interval.getEndTime: This Interval is invalid");return this.endTime_};sb.prototype.isValid=function(){return this.isValid_};sb.prototype.isEmpty=function(){if(!this.isValid_)throw Error("Interval.isEmpty: This Interval is invalid");return this.startTime_==this.endTime_};var b=a.SyncPromise,Jc=function(){};r.ProducerDb=Jc;Jc.Error=function(a){if(a)return a.__proto__=Jc.Error.prototype,a};Jc.Error.prototype=Error();Jc.Error.prototype.name=
"ProducerDbError";Jc.prototype.hasContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.hasContentKeyPromise is not implemented"))};Jc.prototype.getContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.getContentKeyPromise is not implemented"))};Jc.prototype.addContentKeyPromise=function(a,c,f){return b.reject(Error("ProducerDb.addContentKeyPromise is not implemented"))};Jc.prototype.deleteContentKeyPromise=function(a,c){return b.reject(Error("ProducerDb.deleteContentKeyPromise is not implemented"))};
Jc.getFixedTimeSlot=function(a){return Math.floor(Math.round(a)/36E5)};var c=a.Name,D=a.Interest,R=a.Data,Fb=a.Link,ab=a.NetworkNack,Wa=a.Exclude,Fa=a.Encryptor,Gb=a.EncryptParams,fa=a.EncryptAlgorithmType,wd=a.AesKeyParams,qb=a.AesAlgorithm,ia=a.Schedule,ya=a.EncryptError,M=a.NdnCommon,b=a.SyncPromise,ma=function De(a,b,f,g,l,m,n){this.face_=f;this.keyChain_=g;this.database_=l;this.maxRepeatAttempts_=void 0==m?3:m;this.keyRetrievalLink_=void 0==n?De.NO_LINK:new Fb(n);this.eKeyInfo_={};this.keyRequests_=
{};f=new c(a);g=new c(b);for(f.append(Fa.NAME_COMPONENT_READ);0<g.size();)l=new c(f),l.append(g),l.append(Fa.NAME_COMPONENT_E_KEY),this.eKeyInfo_[l.toUri()]={keyName:l,keyInfo:new De.KeyInfo_},g=g.getPrefix(-1);f.append(b);this.namespace_=new c(a);this.namespace_.append(Fa.NAME_COMPONENT_SAMPLE);this.namespace_.append(b)};r.Producer=ma;ma.prototype.createContentKey=function(a,b,f,g){g||(g=ma.defaultOnError);var l=ma.getRoundedTimeSlot_(a),m=new c(this.namespace_);m.append(Fa.NAME_COMPONENT_C_KEY);
m.append(ia.toIsoString(l));var n,s=this;this.database_.hasContentKeyPromise(a).then(function(l){l?null!=f&&f(m):(l=new wd(128),n=qb.generateKey(l).getKeyBits(),s.database_.addContentKeyPromise(a,n).then(function(){var l=Math.round(a);s.keyRequests_[l]=new ma.KeyRequest_(s.getEKeyInfoSize_());var l=s.keyRequests_[l],n=new Wa;ma.excludeAfter(n,new c.Component(ia.toIsoString(a)));for(var r in s.eKeyInfo_){var Ab=s.eKeyInfo_[r],F=Ab.keyInfo;a<F.beginTimeSlot||a>=F.endTimeSlot?(l.repeatAttempts[r]=0,
s.sendKeyInterest_((new D(Ab.keyName)).setExclude(n).setChildSelector(1),a,b,g)):(Ab=new c(Ab.keyName),Ab.append(ia.toIsoString(F.beginTimeSlot)),Ab.append(ia.toIsoString(F.endTimeSlot)),s.encryptContentKeyPromise_(F.keyBits,Ab,a,b,g))}null!=f&&f(m)}))})};ma.prototype.produce=function(a,b,f,g,l){l||(l=ma.defaultOnError);var m=this;this.createContentKey(b,null,function(n){m.database_.getContentKeyPromise(b).then(function(g){var l=new c(m.namespace_);l.append(ia.toIsoString(b));a.setName(l);l=new Gb(fa.AesCbc,
16);return Fa.encryptData(a,f,n,g,l)}).then(function(){return m.keyChain_.signPromise(a)}).then(function(){try{g()}catch(a){console.log("Error in onComplete: "+M.getErrorWithStackTrace(a))}},function(a){try{l(ya.ErrorCode.General,""+a)}catch(b){console.log("Error in onError: "+M.getErrorWithStackTrace(b))}})},l)};ma.defaultOnError=function(a,b){};ma.KeyInfo_=function(){this.endTimeSlot=this.beginTimeSlot=0;this.keyBits=null};ma.KeyRequest_=function(a){this.interestCount=a;this.repeatAttempts={};this.encryptedKeys=
[]};ma.getRoundedTimeSlot_=function(a){return Math.round(36E5*Math.floor(Math.round(a)/36E5))};ma.prototype.sendKeyInterest_=function(a,b,c,f){var g=this;0!==this.keyRetrievalLink_.getDelegations().size()&&(a=new D(a),a.setLinkWireEncoding(this.keyRetrievalLink_.wireEncode()));this.face_.expressInterest(a,function(a,l){g.handleCoveringKey_(a,l,b,c,f)},function(a){g.handleTimeout_(a,b,c,f)},function(a,l){g.handleNetworkNack_(a,l,b,c,f)})};ma.prototype.handleTimeout_=function(a,b,c,f){var g=Math.round(b),
g=this.keyRequests_[g],l=a.getName().toUri();g.repeatAttempts[l]<this.maxRepeatAttempts_?(++g.repeatAttempts[l],this.sendKeyInterest_(a,b,c,f)):this.handleNetworkNack_(a,new ab,b,c,f)};ma.prototype.handleNetworkNack_=function(a,b,c,f,g){a=Math.round(c);this.updateKeyRequest_(this.keyRequests_[a],a,f)};ma.prototype.updateKeyRequest_=function(a,b,c){--a.interestCount;if(0==a.interestCount&&null!=c){try{c(a.encryptedKeys)}catch(f){console.log("Error in onEncryptedKeys: "+M.getErrorWithStackTrace(f))}delete this.keyRequests_[b]}};
ma.prototype.handleCoveringKey_=function(a,b,c,f,g){var l=Math.round(c),l=this.keyRequests_[l],m=a.getName(),n=m.toUri(),s=b.getName(),r=ia.fromIsoString(s.get(ma.START_TIME_STAMP_INDEX).getValue().toString()),F=ia.fromIsoString(s.get(ma.END_TIME_STAMP_INDEX).getValue().toString());if(c>=F)a=new Wa(a.getExclude()),ma.excludeBefore(a,s.get(ma.START_TIME_STAMP_INDEX)),l.repeatAttempts[n]=0,this.sendKeyInterest_((new D(m)).setExclude(a).setChildSelector(1),c,f,g);else{var x=b.getContent(),P=this;this.encryptContentKeyPromise_(x,
s,c,f,g).then(function(a){a&&(a=P.eKeyInfo_[n].keyInfo,a.beginTimeSlot=r,a.endTimeSlot=F,a.keyBits=x)})}};ma.prototype.encryptContentKeyPromise_=function(a,f,g,l,m){var n=Math.round(g),s=this.keyRequests_[n],r=new c(this.namespace_);r.append(Fa.NAME_COMPONENT_C_KEY);r.append(ia.toIsoString(ma.getRoundedTimeSlot_(g)));var F,x=this;return this.database_.getContentKeyPromise(g).then(function(b){F=new R;F.setName(r);var c=new Gb(fa.RsaOaep);return Fa.encryptDataPromise(F,b,f,a,c)}).then(function(){return b.resolve(!0)},
function(a){try{m(ya.ErrorCode.EncryptionFailure,"encryptData failed: "+a)}catch(c){console.log("Error in onError: "+M.getErrorWithStackTrace(c))}return b.resolve(!1)}).then(function(a){return a?x.keyChain_.signPromise(F).then(function(){s.encryptedKeys.push(F);x.updateKeyRequest_(s,n,l);return b.resolve(!0)}):b.resolve(!1)})};ma.prototype.getEKeyInfoSize_=function(){var a=0;for(key in this.eKeyInfo_)this.eKeyInfo_.hasOwnProperty(key)&&++a;return a};ma.ExcludeEntry=function(a,b){this.component_=a;
this.anyFollowsComponent_=b};ma.getExcludeEntries=function(a){for(var b=[],f=0;f<a.size();++f)a.get(f)==Wa.ANY?0==b.length?b.push(new ma.ExcludeEntry(new c.Component,!0)):b[b.length-1].anyFollowsComponent_=!0:b.push(new ma.ExcludeEntry(a.get(f),!1));return b};ma.setExcludeEntries=function(a,b){a.clear();for(var c=0;c<b.length;++c){var f=b[c];0==c&&0==f.component_.getValue().size()&&f.anyFollowsComponent_?a.appendAny():(a.appendComponent(f.component_),f.anyFollowsComponent_&&a.appendAny())}};ma.findEntryBeforeOrAt=
function(a,b){for(var c=a.length-1;0<=c&&!(0>=a[c].component_.compare(b));)--c;return c};ma.excludeAfter=function(a,b){var c=ma.getExcludeEntries(a),f;f=ma.findEntryBeforeOrAt(c,b);if(0>f)c.splice(0,0,new ma.ExcludeEntry(b,!0)),f=0;else{var g=c[f];g.anyFollowsComponent_||(g.component_.equals(b)?g.anyFollowsComponent_=!0:(c.splice(f+1,0,new ma.ExcludeEntry(b,!0)),f+=1))}f+=1;c.splice(f,c.length-f);ma.setExcludeEntries(a,c)};ma.excludeBefore=function(a,b){ma.excludeRange(a,new c.Component,b)};ma.excludeRange=
function(a,b,c){if(0<=b.compare(c)){if(0==b.compare(c))throw Error("excludeRange: from == to. To exclude a single component, sue excludeOne.");throw Error("excludeRange: from must be less than to. Invalid range: ["+b.toEscapedString()+", "+c.toEscapedString()+"]");}var f=ma.getExcludeEntries(a),g=ma.findEntryBeforeOrAt(f,b);if(0>g)f.splice(0,0,new ma.ExcludeEntry(b,!0)),b=0;else{var l=f[g];l.anyFollowsComponent_?b=g:l.component_.equals(b)?(l.anyFollowsComponent_=!0,b=g):(f.splice(g+1,0,new ma.ExcludeEntry(b,
!0)),b=g+1)}g=ma.findEntryBeforeOrAt(f,c);l=f[g];g==b?f.splice(b+1,0,new ma.ExcludeEntry(c,!1)):(l.anyFollowsComponent_?c=g+1:l.component_.equals(c)?c=g:(f.splice(g+1,0,new ma.ExcludeEntry(c,!1)),c=g+1),b+=1,f.splice(b,c-b));ma.setExcludeEntries(a,f)};ma.START_TIME_STAMP_INDEX=-2;ma.END_TIME_STAMP_INDEX=-1;ma.NO_LINK=new Fb;var sb=a.Interval,Ia=function Bd(a,b,c,f,g,l){if("object"===typeof a&&a instanceof Bd)repetitiveInterval=a,this.startDate_=repetitiveInterval.startDate_,this.endDate_=repetitiveInterval.endDate_,
this.intervalStartHour_=repetitiveInterval.intervalStartHour_,this.intervalEndHour_=repetitiveInterval.intervalEndHour_,this.nRepeats_=repetitiveInterval.nRepeats_,this.repeatUnit_=repetitiveInterval.repeatUnit_;else if("number"===typeof a){void 0==g&&(g=0);void 0==l&&(l=Bd.RepeatUnit.NONE);this.startDate_=Bd.toDateOnlyMilliseconds_(a);this.endDate_=Bd.toDateOnlyMilliseconds_(b);this.intervalStartHour_=Math.round(c);this.intervalEndHour_=Math.round(f);this.nRepeats_=Math.round(g);this.repeatUnit_=
l;if(!(this.intervalStartHour_<this.intervalEndHour_))throw Error("ReptitiveInterval: startHour must be less than endHour");if(!(this.startDate_<=this.endDate_))throw Error("ReptitiveInterval: startDate must be earlier than or same as endDate");if(!(0<=this.intervalStartHour_))throw Error("ReptitiveInterval: intervalStartHour must be non-negative");if(!(1<=this.intervalEndHour_&&24>=this.intervalEndHour_))throw Error("ReptitiveInterval: intervalEndHour must be from 1 to 24");if(this.repeatUnit_==
Bd.RepeatUnit.NONE&&this.startDate_!=this.endDate_)throw Error("ReptitiveInterval: With RepeatUnit.NONE, startDate must equal endDate");}else this.startDate_=-Number.MAX_VALUE,this.endDate_=-Number.MAX_VALUE,this.intervalStartHour_=0,this.intervalEndHour_=24,this.nRepeats_=0,this.repeatUnit_=Bd.RepeatUnit.NONE};r.RepetitiveInterval=Ia;Ia.RepeatUnit={NONE:0,DAY:1,MONTH:2,YEAR:3};Ia.prototype.getInterval=function(a){var b,c;this.hasIntervalOnDate_(a)?(b=Ia.toDateOnlyMilliseconds_(a)+this.intervalStartHour_*
Ia.MILLISECONDS_IN_HOUR,c=Ia.toDateOnlyMilliseconds_(a)+this.intervalEndHour_*Ia.MILLISECONDS_IN_HOUR,a<b?(c=b,b=Ia.toDateOnlyMilliseconds_(a),a=!1):a>c?(b=c,c=Ia.toDateOnlyMilliseconds_(a)+Ia.MILLISECONDS_IN_DAY,a=!1):a=!0):(b=Ia.toDateOnlyMilliseconds_(a),c=Ia.toDateOnlyMilliseconds_(a)+24*Ia.MILLISECONDS_IN_HOUR,a=!1);return{isPositive:a,interval:new sb(b,c)}};Ia.prototype.compare=function(a){return this.startDate_<a.startDate_?-1:this.startDate_>a.startDate_?1:this.endDate_<a.endDate_?-1:this.endDate_>
a.endDate_?1:this.intervalStartHour_<a.intervalStartHour_?-1:this.intervalStartHour_>a.intervalStartHour_?1:this.intervalEndHour_<a.intervalEndHour_?-1:this.intervalEndHour_>a.intervalEndHour_?1:this.nRepeats_<a.nRepeats_?-1:this.nRepeats_>a.nRepeats_?1:this.repeatUnit_<a.repeatUnit_?-1:this.repeatUnit_>a.repeatUnit_?1:0};Ia.prototype.getStartDate=function(){return this.startDate_};Ia.prototype.getEndDate=function(){return this.endDate_};Ia.prototype.getIntervalStartHour=function(){return this.intervalStartHour_};
Ia.prototype.getIntervalEndHour=function(){return this.intervalEndHour_};Ia.prototype.getNRepeats=function(){return this.nRepeats_};Ia.prototype.getRepeatUnit=function(){return this.repeatUnit_};Ia.prototype.hasIntervalOnDate_=function(a){a=Ia.toDateOnlyMilliseconds_(a);if(a<this.startDate_||a>this.endDate_)return!1;if(this.repeatUnit_==Ia.RepeatUnit.NONE)return!0;if(this.repeatUnit_==Ia.RepeatUnit.DAY){if(0==(a-this.startDate_)/Ia.MILLISECONDS_IN_DAY%this.nRepeats_)return!0}else{a=new Date(a);var b=
new Date(this.startDate_);if(this.repeatUnit_==Ia.RepeatUnit.MONTH&&a.getUTCDate()==b.getUTCDate()){if(0==(12*(a.getUTCFullYear()-b.getUTCFullYear())+a.getUTCMonth()-b.getUTCMonth())%this.nRepeats_)return!0}else if(this.repeatUnit_==Ia.RepeatUnit.YEAR&&a.getUTCDate()==b.getUTCDate()&&a.getUTCMonth()==b.getUTCMonth()&&0==(a.getUTCFullYear()-b.getUTCFullYear())%this.nRepeats_)return!0}return!1};Ia.toDateOnlyMilliseconds_=function(a){a=Math.round(a);return a-=a%Ia.MILLISECONDS_IN_DAY};Ia.MILLISECONDS_IN_HOUR=
36E5;Ia.MILLISECONDS_IN_DAY=864E5;sb=a.Interval;Ia=a.RepetitiveInterval;n=a.Tlv;ra=a.TlvEncoder;oa=a.TlvDecoder;m=a.Blob;ia=function Md(a){"object"===typeof a&&a instanceof Md?(this.whiteIntervalList_=a.whiteIntervalList_.slice(0),this.blackIntervalList_=a.blackIntervalList_.slice(0)):(this.whiteIntervalList_=[],this.blackIntervalList_=[])};r.Schedule=ia;ia.prototype.addWhiteInterval=function(a){ia.sortedSetAdd_(this.whiteIntervalList_,a);return this};ia.prototype.addBlackInterval=function(a){ia.sortedSetAdd_(this.blackIntervalList_,
a);return this};ia.prototype.getCoveringInterval=function(a){var b=new sb(!0),c=new sb(!0),f=new sb,g=new sb;ia.calculateIntervalResult_(this.blackIntervalList_,a,b,f);if(!b.isEmpty())return{isPositive:!1,interval:b};ia.calculateIntervalResult_(this.whiteIntervalList_,a,c,g);return c.isEmpty()&&!g.isValid()?(a=Ia.toDateOnlyMilliseconds_(a),{isPositive:!1,interval:new sb(a,a+Ia.MILLISECONDS_IN_DAY)}):c.isEmpty()?{isPositive:!1,interval:g}:f.isValid()?{isPositive:!0,interval:c.intersectWith(f)}:{isPositive:!0,
interval:c}};ia.prototype.wireEncode=function(){for(var a=new ra(256),b=a.getLength(),c=a.getLength(),f=this.blackIntervalList_.length-1;0<=f;f--)ia.encodeRepetitiveInterval_(this.blackIntervalList_[f],a);a.writeTypeAndLength(n.Encrypt_BlackIntervalList,a.getLength()-c);c=a.getLength();for(f=this.whiteIntervalList_.length-1;0<=f;f--)ia.encodeRepetitiveInterval_(this.whiteIntervalList_[f],a);a.writeTypeAndLength(n.Encrypt_WhiteIntervalList,a.getLength()-c);a.writeTypeAndLength(n.Encrypt_Schedule,a.getLength()-
b);return new m(a.getOutput(),!1)};ia.prototype.wireDecode=function(a){a="object"===typeof a&&a instanceof m?a.buf():a;a=new oa(a);var b=a.readNestedTlvsStart(n.Encrypt_Schedule);this.whiteIntervalList_=[];for(var c=a.readNestedTlvsStart(n.Encrypt_WhiteIntervalList);a.getOffset()<c;)ia.sortedSetAdd_(this.whiteIntervalList_,ia.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);this.blackIntervalList_=[];for(c=a.readNestedTlvsStart(n.Encrypt_BlackIntervalList);a.getOffset()<c;)ia.sortedSetAdd_(this.blackIntervalList_,
ia.decodeRepetitiveInterval_(a));a.finishNestedTlvs(c);a.finishNestedTlvs(b)};ia.sortedSetAdd_=function(a,b){for(var c=0;c<a.length;){var f=a[c].compare(b);if(0==f)return;if(!(0>f))break;++c}a.splice(c,0,b)};ia.encodeRepetitiveInterval_=function(a,b){var c=b.getLength();b.writeNonNegativeIntegerTlv(n.Encrypt_RepeatUnit,a.getRepeatUnit());b.writeNonNegativeIntegerTlv(n.Encrypt_NRepeats,a.getNRepeats());b.writeNonNegativeIntegerTlv(n.Encrypt_IntervalEndHour,a.getIntervalEndHour());b.writeNonNegativeIntegerTlv(n.Encrypt_IntervalStartHour,
a.getIntervalStartHour());b.writeBlobTlv(n.Encrypt_EndDate,(new m(ia.toIsoString(a.getEndDate()))).buf());b.writeBlobTlv(n.Encrypt_StartDate,(new m(ia.toIsoString(a.getStartDate()))).buf());b.writeTypeAndLength(n.Encrypt_RepetitiveInterval,b.getLength()-c)};ia.decodeRepetitiveInterval_=function(a){var b=a.readNestedTlvsStart(n.Encrypt_RepetitiveInterval),c=ia.fromIsoString((new m(a.readBlobTlv(n.Encrypt_StartDate),!0)).toString()),f=ia.fromIsoString((new m(a.readBlobTlv(n.Encrypt_EndDate),!0)).toString()),
g=a.readNonNegativeIntegerTlv(n.Encrypt_IntervalStartHour),l=a.readNonNegativeIntegerTlv(n.Encrypt_IntervalEndHour),s=a.readNonNegativeIntegerTlv(n.Encrypt_NRepeats),r=a.readNonNegativeIntegerTlv(n.Encrypt_RepeatUnit);a.finishNestedTlvs(b);return new Ia(c,f,g,l,s,r)};ia.calculateIntervalResult_=function(a,b,c,f){for(var g=0;g<a.length;++g){var l=a[g].getInterval(b),m=l.interval;!0==l.isPositive?c.unionWith(m):f.isValid()?f.intersectWith(m):f.set(m)}};ia.toIsoString=function(a){a=new Date(Math.round(a));
return a.getUTCFullYear()+ia.to2DigitString(a.getUTCMonth()+1)+ia.to2DigitString(a.getUTCDate())+"T"+ia.to2DigitString(a.getUTCHours())+ia.to2DigitString(a.getUTCMinutes())+ia.to2DigitString(a.getUTCSeconds())};ia.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};ia.fromIsoString=function(a){if(15!=a.length||"T"!=a.substr(8,1))throw Error("fromIsoString: Format is not the expected yyyymmddThhmmss");return Date.UTC(parseInt(a.substr(0,4)),parseInt(a.substr(4,2)-1),parseInt(a.substr(6,
2)),parseInt(a.substr(9,2)),parseInt(a.substr(11,2)),parseInt(a.substr(13,2)))};new od;new hb;new Jc;var ub=a.DigestTree,D=a.Interest,R=a.Data,c=a.Name,m=a.Blob,Ra=a.MemoryContentCache,Ie=a.SyncStateProto,M=a.NdnCommon,Ka=function sc(b,c,f,g,l,m,n,s,r,F){this.onReceivedSyncState=b;this.onInitialized=c;this.applicationDataPrefixUri=f.toUri();this.applicationBroadcastPrefix=g;this.session=l;this.face=m;this.keyChain=n;this.certificateName=s;this.sync_lifetime=r;this.usrseq=-1;this.digest_tree=new ub;
this.contentCache=new Ra(m);this.digest_log=[];this.digest_log.push(new sc.DigestLogEntry("00",[]));this.contentCache.registerPrefix(this.applicationBroadcastPrefix,F,this.onInterest.bind(this));this.enabled=!0;b=new D(this.applicationBroadcastPrefix);b.getName().append("00");b.setInterestLifetimeMilliseconds(1E3);var x;try{x=dcodeIO.ProtoBuf.newBuilder().import(Ie).build("Sync")}catch(P){x=a.newBuilder().import(Ie).build("Sync")}this.SyncStateMsg=x.SyncStateMsg;this.SyncState=x.SyncState;this.face.expressInterest(b,
this.onData.bind(this),this.initialTimeOut.bind(this))};r.ChronoSync2013=Ka;Ka.prototype.getProducerPrefixes=function(){for(var a=[],b=0;b<this.digest_tree.digestnode.length;++b){var c=this.digest_tree.get(b);a.push(new Ka.PrefixAndSessionNo(c.getDataPrefix(),c.getSessionNo()))}return a};Ka.prototype.getProducerSequenceNo=function(a,b){var c=this.digest_tree.find(a,b);return 0>c?-1:this.digest_tree.get(c).getSequenceNo()};Ka.prototype.publishNextSequenceNo=function(a){a=a instanceof m?a:new m(a,!0);
this.usrseq++;var b={name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}};!a.isNull()&&0<a.size()&&(b.application_info=a.buf());a=[new this.SyncState(b)];b=new this.SyncStateMsg({ss:a});this.broadcastSyncState(this.digest_tree.getRoot(),b);this.update(a)||console.log("Warning: ChronoSync: update did not create a new digest log entry");a=new D(this.applicationBroadcastPrefix);a.getName().append(this.digest_tree.getRoot());a.setInterestLifetimeMilliseconds(this.sync_lifetime);
this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ka.prototype.getSequenceNo=function(){return this.usrseq};Ka.DigestLogEntry=function(a,b){this.digest=a;this.data=b};Ka.DigestLogEntry.prototype.getDigest=function(){return this.digest};Ka.DigestLogEntry.prototype.getData=function(){return this.data};Ka.prototype.shutdown=function(){this.enabled=!1;this.contentCache.unregisterAll()};Ka.SyncState=function(a,b,c,f){this.dataPrefixUri_=a;this.sessionNo_=b;this.sequenceNo_=
c;this.applicationInfo_=f};Ka.SyncState.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ka.SyncState.prototype.getSessionNo=function(){return this.sessionNo_};Ka.SyncState.prototype.getSequenceNo=function(){return this.sequenceNo_};Ka.SyncState.prototype.getApplicationInfo=function(){return this.applicationInfo_};Ka.PrefixAndSessionNo=function(a,b){this.dataPrefixUri_=a;this.sessionNo_=b};Ka.PrefixAndSessionNo.prototype.getDataPrefix=function(){return this.dataPrefixUri_};Ka.PrefixAndSessionNo.prototype.getSessionNo=
function(){return this.sessionNo_};Ka.prototype.broadcastSyncState=function(a,b){var c=new Uint8Array(b.toArrayBuffer()),f=new R(this.applicationBroadcastPrefix);f.getName().append(a);f.setContent(new m(c,!1));var g=this;this.keyChain.sign(f,this.certificateName,function(){g.contentCache.add(f)})};Ka.prototype.update=function(a){for(var b=0;b<a.length;b++)0==a[b].type&&this.digest_tree.update(a[b].name,a[b].seqno.session,a[b].seqno.seq)&&this.applicationDataPrefixUri==a[b].name&&(this.usrseq=a[b].seqno.seq);
return-1==this.logfind(this.digest_tree.getRoot())?(a=new Ka.DigestLogEntry(this.digest_tree.getRoot(),a),this.digest_log.push(a),!0):!1};Ka.prototype.logfind=function(a){for(var b=0;b<this.digest_log.length;b++)if(a==this.digest_log[b].digest)return b;return-1};Ka.prototype.onInterest=function(a,b,f,g,l){this.enabled&&(a=b.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString(),b.getName().size()==this.applicationBroadcastPrefix.size()+2&&(a=b.getName().get(this.applicationBroadcastPrefix.size()+
1).toEscapedString()),b.getName().size()==this.applicationBroadcastPrefix.size()+2||"00"==a?this.processRecoveryInst(b,a,f):(this.contentCache.storePendingInterest(b,f),a!=this.digest_tree.getRoot()&&(b=this.logfind(a),-1==b?(b=new D(new c("/local/timeout")),b.setInterestLifetimeMilliseconds(2E3),this.face.expressInterest(b,this.dummyOnData,this.judgeRecovery.bind(this,b,a,f))):this.processSyncInst(b,a,f))))};Ka.prototype.onData=function(a,b){if(this.enabled){var f=new Uint8Array(b.getContent().size());
f.set(b.getContent().buf());var f=this.SyncStateMsg.decode(f.buffer).ss,l=!1;"00"==this.digest_tree.getRoot()?(l=!0,this.initialOndata(f)):(this.update(f),l=a.getName().size()==this.applicationBroadcastPrefix.size()+2?!0:!1);for(var n=[],s=0;s<f.length;s++)if(0==f[s].type){var r;f[s].application_info?(r=f[s].application_info.toBinary(),r=0<r.length?new m(new g(r,"binary"),!1):new m):r=new m;n.push(new Ka.SyncState(f[s].name,f[s].seqno.session,f[s].seqno.seq,r))}try{this.onReceivedSyncState(n,l)}catch(F){console.log("Error in onReceivedSyncState: "+
M.getErrorWithStackTrace(F))}f=new c(this.applicationBroadcastPrefix);f.append(this.digest_tree.getRoot());a=new D(f);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ka.prototype.initialTimeOut=function(a){if(this.enabled){console.log("no other people");this.usrseq++;try{this.onInitialized()}catch(b){console.log("Error in onInitialized: "+M.getErrorWithStackTrace(b))}a=[new this.SyncState({name:this.applicationDataPrefixUri,
type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})];this.update(a);a=new c(this.applicationBroadcastPrefix);a.append(this.digest_tree.getRoot());a=new D(a);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};Ka.prototype.processRecoveryInst=function(a,b,c){if(-1!=this.logfind(b)){b=[];for(var f=0;f<this.digest_tree.digestnode.length;f++)b[f]=new this.SyncState({name:this.digest_tree.digestnode[f].getDataPrefix(),
type:"UPDATE",seqno:{seq:this.digest_tree.digestnode[f].getSequenceNo(),session:this.digest_tree.digestnode[f].getSessionNo()}});if(0!=b.length){b=new this.SyncStateMsg({ss:b});b=new Uint8Array(b.toArrayBuffer());var g=new R(a.getName());g.setContent(new m(b,!1));"00"==a.getName().get(-1).toEscapedString()&&g.getMetaInfo().setFreshnessPeriod(1E3);this.keyChain.sign(g,this.certificateName,function(){try{c.putData(g)}catch(a){console.log(a.toString())}})}}};Ka.prototype.processSyncInst=function(a,b,
f){for(var g=[],l=[],n=[],s=[],r=a+1;r<this.digest_log.length;r++)for(var F=this.digest_log[r].getData(),x=0;x<F.length;x++)0==F[x].type&&-1!=this.digest_tree.find(F[x].name,F[x].seqno.session)&&(a=l.indexOf(F[x].name),-1==a?(l.push(F[x].name),n.push(F[x].seqno.seq),s.push(F[x].seqno.session)):(n[a]=F[x].seqno.seq,s[a]=F[x].seqno.session));for(x=0;x<l.length;x++)g[x]=new this.SyncState({name:l[x],type:"UPDATE",seqno:{seq:n[x],session:s[x]}});if(0!=g.length){g=new this.SyncStateMsg({ss:g});g=new Uint8Array(g.toArrayBuffer());
a=new c(this.prefix);a.append(this.chatroom).append(b);var P=new R(a);P.setContent(new m(g,!1));this.keyChain.sign(P,this.certificateName,function(){try{f.putData(P)}catch(a){console.log(a.toString())}})}};Ka.prototype.sendRecovery=function(a){var b=new c(this.applicationBroadcastPrefix);b.append("recovery").append(a);a=new D(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};Ka.prototype.judgeRecovery=function(a,
b,c){a=this.logfind(b);-1!=a?b!=this.digest_tree.root&&this.processSyncInst(a,b,c):this.sendRecovery(b)};Ka.prototype.syncTimeout=function(a){if(this.enabled&&a.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString()==this.digest_tree.root){var b=new c(a.getName()),b=new D(b);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(b,this.onData.bind(this),this.syncTimeout.bind(this))}};Ka.prototype.initialOndata=function(a){this.update(a);for(var b=this.digest_tree.getRoot(),
c=0;c<a.length;c++)if(a[c].name==this.applicationDataPrefixUri&&a[c].seqno.session==this.session){var f=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:a[c].seqno.seq+1,session:this.session}})];if(this.update(f)){f=new Ka.DigestLogEntry(this.digest_tree.getRoot(),f);this.digest_log.push(f);try{this.onInitialized()}catch(g){console.log("Error in onInitialized: "+M.getErrorWithStackTrace(g))}}}f=0<=this.usrseq?new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",
seqno:{seq:this.usrseq,session:this.session}}):new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:0,session:this.session}});a=new this.SyncStateMsg({ss:f});this.broadcastSyncState(b,a);if(-1==this.digest_tree.find(this.applicationDataPrefixUri,this.session)&&(this.usrseq++,a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})],this.update(a)))try{this.onInitialized()}catch(l){console.log("Error in onInitialized: "+
M.getErrorWithStackTrace(l))}};Ka.prototype.dummyOnData=function(a,b){console.log("*** dummyOnData called. ***")};W=a;ub=function(){this.root="00";this.digestnode=[]};r.DigestTree=ub;ub.Node=function(a,b,c){this.dataPrefix=a;this.seqno_session=b;this.seqno_seq=c;this.recomputeDigest()};ub.Node.prototype.getDataPrefix=function(){return this.dataPrefix};ub.Node.prototype.getSessionNo=function(){return this.seqno_session};ub.Node.prototype.getSequenceNo=function(){return this.seqno_seq};ub.Node.prototype.getDigest=
function(){return this.digest};ub.Node.prototype.setSequenceNo=function(a){this.seqno_seq=a;this.recomputeDigest()};ub.Node.prototype.Int32ToBuffer=function(a){for(var b=new g(4),c=0;4>c;c++)b[c]=a%256,a=Math.floor(a/256);return b};ub.Node.prototype.recomputeDigest=function(){var a=W.createHash("sha256");a.update(this.Int32ToBuffer(this.seqno_session));a.update(this.Int32ToBuffer(this.seqno_seq));var a=a.digest(),b=W.createHash("sha256");b.update(this.dataPrefix);var b=b.digest(),c=W.createHash("sha256");
c.update(b);c.update(a);this.digest=c.digest("hex")};ub.Node.Compare=function(a,b){return a.dataPrefix!=b.dataPrefix?a.dataPrefix<b.dataPrefix:a.seqno_session<b.seqno_session};ub.prototype.update=function(a,b,c){var f=this.find(a,b);if(0<=f)if(this.digestnode[f].getSequenceNo()<c)this.digestnode[f].setSequenceNo(c);else return!1;else a=new ub.Node(a,b,c),this.digestnode.push(a),this.digestnode.sort(this.sortNodes);this.recomputeRoot();return!0};ub.prototype.sortNodes=function(){for(var a,b=this.digestnode.length;0<
b;b--)for(var c=0;c<b-1;c++)this.digestnode[c].getDataPrefix()>this.digestnode[c+1].getDataPrefix()&&(a=this.digestnode[c],this.digestnode[c]=this.digestnode[c+1],this.digestnode[c+1]=a)};ub.prototype.sortNodes=function(a,b){return a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()==b.getSessionNo()?0:a.getDataPrefix()>b.getDataPrefix()||a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()>b.getSessionNo()?1:-1};ub.prototype.find=function(a,b){for(var c=0;c<this.digestnode.length;++c)if(this.digestnode[c].getDataPrefix()==
a&&this.digestnode[c].getSessionNo()==b)return c;return-1};ub.prototype.size=function(){return this.digestnode.size()};ub.prototype.get=function(a){return this.digestnode[a]};ub.prototype.getRoot=function(){return this.root};ub.prototype.recomputeRoot=function(){for(var a=W.createHash("sha256"),b=0;b<this.digestnode.length;b++)a.update(new g(this.digestnode[b].digest,"hex"));this.root=a.digest("hex")};Ie={"package":"Sync",messages:[{name:"SyncState",fields:[{rule:"required",type:"string",name:"name",
id:1,options:{}},{rule:"required",type:"ActionType",name:"type",id:2,options:{}},{rule:"optional",type:"SeqNo",name:"seqno",id:3,options:{}},{rule:"optional",type:"bytes",name:"application_info",id:4,options:{}}],enums:[{name:"ActionType",values:[{name:"UPDATE",id:0},{name:"DELETE",id:1},{name:"OTHER",id:2}],options:{}}],messages:[{name:"SeqNo",fields:[{rule:"required",type:"uint32",name:"seq",id:1,options:{}},{rule:"required",type:"uint32",name:"session",id:2,options:{}}],enums:[],messages:[],options:{}}],
options:{}},{name:"SyncStateMsg",fields:[{rule:"repeated",type:"SyncState",name:"ss",id:1,options:{}}],enums:[],messages:[],options:{}}],enums:[],imports:[],options:{}};r.SyncStateProto=Ie;var s=a.WireFormat,id=a.CommandInterestPreparer,be=function(){id.call(this)};be.prototype=new id;be.prototype.name="CommandInterestGenerator";r.CommandInterestGenerator=be;be.prototype.generate=function(a,b,c,f,g){g="function"===typeof f?f:g;f="function"!==typeof f&&f?f:s.getDefaultWireFormat();this.prepareCommandInterestName(a,
f);b.sign(a,c,f,function(){(null==a.getInterestLifetimeMilliseconds()||0>a.getInterestLifetimeMilliseconds())&&a.setInterestLifetimeMilliseconds(1E3);g&&g()})};var f=a.Log.LOG,yc=function(){this.table_=[]};r.InterestFilterTable=yc;yc.Entry=function(a,b,c,f){this.interestFilterId_=a;this.filter_=b;this.onInterest_=c;this.face_=f};yc.Entry.prototype.getInterestFilterId=function(){return this.interestFilterId_};yc.Entry.prototype.getFilter=function(){return this.filter_};yc.Entry.prototype.getOnInterest=
function(){return this.onInterest_};yc.Entry.prototype.getFace=function(){return this.face_};yc.prototype.setInterestFilter=function(a,b,c,f){this.table_.push(new yc.Entry(a,b,c,f))};yc.prototype.getMatchedFilters=function(a,b){for(var c=0;c<this.table_.length;++c){var f=this.table_[c];f.getFilter().doesMatch(a.getName())&&b.push(f)}};yc.prototype.unsetInterestFilter=function(a){for(var b=0,c=this.table_.length-1;0<=c;--c)this.table_[c].getInterestFilterId()==a&&(++b,this.table_.splice(c,1));0===
b&&0<f&&console.log("unsetInterestFilter: Didn't find interestFilterId "+a)};var M=a.NdnCommon,f=a.Log.LOG,Tb=function(){this.table_=[];this.removeRequests_=[]};r.PendingInterestTable=Tb;Tb.Entry=function(a,b,c,f,g){this.pendingInterestId_=a;this.interest_=b;this.onData_=c;this.onTimeout_=f;this.onNetworkNack_=g;this.timerId_=-1};Tb.Entry.prototype.getPendingInterestId=function(){return this.pendingInterestId_};Tb.Entry.prototype.getInterest=function(){return this.interest_};Tb.Entry.prototype.getOnData=
function(){return this.onData_};Tb.Entry.prototype.getOnNetworkNack=function(){return this.onNetworkNack_};Tb.Entry.prototype.callTimeout=function(){if(this.onTimeout_)try{this.onTimeout_(this.interest_)}catch(a){console.log("Error in onTimeout: "+M.getErrorWithStackTrace(a))}};Tb.Entry.prototype.setTimeout=function(a,b){-1===this.timerId_&&(this.timerId_=setTimeout(a,b))};Tb.Entry.prototype.clearTimeout=function(){-1!==this.timerId_&&(clearTimeout(this.timerId_),this.timerId_=-1)};Tb.prototype.add=
function(a,b,c,g,l){var m=this.removeRequests_.indexOf(a);if(0<=m)return this.removeRequests_.splice(m,1),null;var n=new Tb.Entry(a,b,c,g,l);this.table_.push(n);a=b.getInterestLifetimeMilliseconds()||4E3;var s=this;n.setTimeout(function(){1<f&&console.log("Interest time out: "+b.getName().toUri());var a=s.table_.indexOf(n);0<=a&&s.table_.splice(a,1);n.callTimeout()},a);return n};Tb.prototype.extractEntriesForExpressedInterest=function(a,b){for(var c=this.table_.length-1;0<=c;--c){var f=this.table_[c];
f.getInterest().matchesData(a)&&(f.clearTimeout(),b.push(f),this.table_.splice(c,1))}};Tb.prototype.extractEntriesForNackInterest=function(a,b){for(var c=a.wireEncode(),f=this.table_.length-1;0<=f;--f){var g=this.table_[f];null!=g.getOnNetworkNack()&&g.getInterest().wireEncode().equals(c)&&(g.clearTimeout(),b.push(g),this.table_.splice(f,1))}};Tb.prototype.removePendingInterest=function(a){if(null!=a){for(var b=0,c=this.table_.length-1;0<=c;--c){var g=this.table_[c];g.getPendingInterestId()==a&&(g.clearTimeout(),
this.table_.splice(c,1),++b)}0===b&&0<f&&console.log("removePendingInterest: Didn't find pendingInterestId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)}};var f=a.Log.LOG,Yc=function(a){this.interestFilterTable_=a;this.table_=[];this.removeRequests_=[]};r.RegisteredPrefixTable=Yc;Yc.prototype.add=function(a,b,c){var f=this.removeRequests_.indexOf(a);if(0<=f)return this.removeRequests_.splice(f,1),!1;this.table_.push(new Yc._Entry(a,b,c));return!0};Yc.prototype.removeRegisteredPrefix=
function(a){for(var b=0,c=this.table_.length-1;0<=c;--c){var g=this.table_[c];g.getRegisteredPrefixId()==a&&(++b,0<g.getRelatedInterestFilterId()&&this.interestFilterTable_.unsetInterestFilter(g.getRelatedInterestFilterId()),this.table_.splice(c,1))}0===b&&0<f&&console.log("removeRegisteredPrefix: Didn't find registeredPrefixId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)};Yc._Entry=function(a,b,c){this.registeredPrefixId_=a;this.prefix_=b;this.relatedInterestFilterId_=
c};Yc._Entry.prototype.getRegisteredPrefixId=function(){return this.registeredPrefixId_};Yc._Entry.prototype.getPrefix=function(){return this.prefix_};Yc._Entry.prototype.getRelatedInterestFilterId=function(){return this.relatedInterestFilterId_};gd=function(){this.congestionMark_=0};r.CongestionMark=gd;gd.prototype.getCongestionMark=function(){return this.congestionMark_};gd.prototype.setCongestionMark=function(a){this.congestionMark_=a};gd.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=
a.getHeaderField(b);if(c instanceof gd)return c}return null};Ec=function(){this.faceId_=null};r.IncomingFaceId=Ec;Ec.prototype.getFaceId=function(){return this.faceId_};Ec.prototype.setFaceId=function(a){this.faceId_=a};Ec.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var c=a.getHeaderField(b);if(c instanceof Ec)return c}return null};var m=a.Blob,pd=function(){this.headerFields_=[];this.fragmentWireEncoding_=new m};r.LpPacket=pd;pd.prototype.getFragmentWireEncoding=function(){return this.fragmentWireEncoding_};
pd.prototype.countHeaderFields=function(){return this.headerFields_.length};pd.prototype.getHeaderField=function(a){return this.headerFields_[a]};pd.prototype.clear=function(){this.headerFields_=[];this.fragmentWireEncoding_=new m};pd.prototype.setFragmentWireEncoding=function(a){this.fragmentWireEncoding_="object"===typeof a&&a instanceof m?a:new m(a)};pd.prototype.addHeaderField=function(a){this.headerFields_.push(a)};var L=a.DataUtils,c=a.Name,D=a.Interest,R=a.Data,Ua=a.ControlParameters,wc=a.ControlResponse,
Cc=a.InterestFilter,s=a.WireFormat,fb=a.TlvWireFormat,n=a.Tlv,oa=a.TlvDecoder,ra=a.TlvEncoder,wa=a.RegistrationOptions,wb=a.Transport,Je=a.TcpTransport,Re=a.UnixTransport,be=a.CommandInterestGenerator,m=a.Blob,M=a.NdnCommon,ab=a.NetworkNack,pd=a.LpPacket,yc=a.InterestFilterTable,Tb=a.PendingInterestTable,Yc=a.RegisteredPrefixTable,Rb=a,f=a.Log.LOG;aa=function Ab(a,b){if(!Ab.supported)throw Error("The necessary JavaScript support is not available on this platform.");var g;if("object"==typeof a&&a instanceof
wb){if(this.getConnectionInfo=null,this.transport=a,this.connectionInfo=b||null,g={},null==this.connectionInfo&&this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name){var l=Ab.getUnixSocketFilePathForLocalhost();null!=l?this.connectionInfo=new Re.ConnectionInfo(l):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport");0<f&&console.log("Using "+this.connectionInfo.toString())}}else g=a||{},this.transport=(g.getTransport||
function(){return new Je})(),this.getConnectionInfo=g.getConnectionInfo||this.transport.defaultGetConnectionInfo,this.connectionInfo=g.connectionInfo||null,null==this.connectionInfo&&(l=void 0!==g.host?g.host:null,this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name?null!=l?this.connectionInfo=new Re.ConnectionInfo(l):null==this.getConnectionInfo&&(l=Ab.getUnixSocketFilePathForLocalhost(),null!=l?this.connectionInfo=new Re.ConnectionInfo(l):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport")):
null!=l&&(this.connectionInfo="undefined"!=typeof Lb?new Lb.ConnectionInfo(l,g.port||9696):new Je.ConnectionInfo(l,g.port||6363)));null==this.connectionInfo?this.host=this.host=null:(this.host=this.connectionInfo.host,this.host=this.connectionInfo.port);this.readyStatus=Ab.UNOPEN;this.onopen=g.onopen||function(){3<f&&console.log("Face connection established.")};this.onclose=g.onclose||function(){3<f&&console.log("Face connection closed.")};this.onConnectedCallbacks=[];this.commandKeyChain=null;this.commandCertificateName=
new c;this.commandInterestGenerator=new be;this.timeoutPrefix=new c("/local/timeout");this.pendingInterestTable_=new Tb;this.interestFilterTable_=new yc;this.registeredPrefixTable_=new Yc(this.interestFilterTable_);this.lastEntryId=0;this.interestLoopbackEnabled_=!1};r.Face=aa;aa.UNOPEN=0;aa.OPEN_REQUESTED=1;aa.OPENED=2;aa.CLOSED=3;Je.importFace(aa);aa.getUnixSocketFilePathForLocalhost=function(){var a="/var/run/nfd.sock";if(Rb.existsSync(a))return a;a="/tmp/.ndnd.sock";return Rb.existsSync(a)?a:
""};aa.getSupported=function(){try{(new g(1)).slice(0,1)}catch(a){return console.log("NDN not available: Buffer not supported. "+a),!1}return!0};aa.supported=aa.getSupported();aa.prototype.createRoute=function(a,b){this.connectionInfo=a instanceof wb.ConnectionInfo?a:new Je.ConnectionInfo(a,b);this.host=this.connectionInfo.host;this.host=this.connectionInfo.port};aa.prototype.close=function(){this.readyStatus==aa.OPENED&&(this.readyStatus=aa.CLOSED,this.transport.close())};aa.prototype.getNextEntryId=
function(){return++this.lastEntryId};aa.makeShuffledHostGetConnectionInfo=function(a,b,c){a=a.slice(0,a.length);L.shuffle(a);return function(){return 0==a.length?null:c(a.splice(0,1)[0],b)}};aa.prototype.setInterestLoopbackEnabled=function(a){this.interestLoopbackEnabled_=a};aa.prototype.expressInterest=function(a,b,c,f,g,l){var m;"object"===typeof a&&a instanceof D?m=new D(a):b&&"object"===typeof b&&b instanceof D?(m=new D(b),m.setName(a),b=c,c=f,f=g,g=l):(m=new D(a),m.setInterestLifetimeMilliseconds(4E3));
var n=b,r,F,x;r="function"===typeof c?c:function(){};F="function"===typeof f?f:null;x=c instanceof s?c:f instanceof s?f:g instanceof s?g:s.getDefaultWireFormat();var P=this.getNextEntryId();m.setNonce(aa.nonceTemplate_);m.refreshNonce();if(null==this.connectionInfo)if(null==this.getConnectionInfo)console.log("ERROR: connectionInfo is NOT SET");else{var z=this;this.connectAndExecute(function(){z.reconnectAndExpressInterest(P,m,n,r,F,x)})}else this.reconnectAndExpressInterest(P,m,n,r,F,x);return P};
aa.prototype.reconnectAndExpressInterest=function(a,b,c,f,g,l){var m=this;if(this.connectionInfo.equals(this.transport.connectionInfo)&&this.readyStatus!==aa.UNOPEN)if(this.readyStatus===aa.OPEN_REQUESTED)this.onConnectedCallbacks.push(function(){m.expressInterestHelper(a,b,c,f,g,l)});else if(this.readyStatus===aa.OPENED)this.expressInterestHelper(a,b,c,f,g,l);else throw Error("reconnectAndExpressInterest: unexpected connection is not opened");else this.readyStatus=aa.OPEN_REQUESTED,this.onConnectedCallbacks.push(function(){m.expressInterestHelper(a,
b,c,f,g,l)}),this.transport.connect(this.connectionInfo,this,function(){for(m.readyStatus=aa.OPENED;0<m.onConnectedCallbacks.length;)try{m.onConnectedCallbacks.shift()()}catch(a){console.log("Face.reconnectAndExpressInterest: ignoring exception from onConnectedCallbacks: "+a)}if(m.onopen)m.onopen()},function(){m.closeByTransport()})};aa.prototype.expressInterestHelper=function(a,b,c,f,g,l){if(null!=this.pendingInterestTable_.add(a,b,c,f,g)&&!this.timeoutPrefix.match(b.getName())){a=b.wireEncode(l);
if(a.size()>aa.getMaxNdnPacketSize())throw Error("The encoded interest size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a.buf());this.interestLoopbackEnabled_&&dispatchInterest(b)}};aa.prototype.removePendingInterest=function(a){this.pendingInterestTable_.removePendingInterest(a)};aa.prototype.setCommandSigningInfo=function(a,b){this.commandKeyChain=a;this.commandCertificateName=new c(b)};aa.prototype.setCommandCertificateName=function(a){this.commandCertificateName=new c(a)};
aa.prototype.makeCommandInterest=function(a,b,c){c="function"===typeof b?b:c;b="function"!==typeof b&&b?b:s.getDefaultWireFormat();this.nodeMakeCommandInterest(a,this.commandKeyChain,this.commandCertificateName,b,c)};aa.prototype.nodeMakeCommandInterest=function(a,b,c,f,g){this.commandInterestGenerator.generate(a,b,c,f,g)};aa.prototype.registerPrefix=function(a,b,c,f,g,l){var m=f,n=g,r=l;f="function"===typeof m?m:null;g=m instanceof wa?m:n instanceof wa?n:new wa;l=m instanceof s?m:n instanceof s?
n:r instanceof s?r:s.getDefaultWireFormat();c||(c=function(){});var F=this.getNextEntryId(),x=this,m=function(){x.nfdRegisterPrefix(F,a,b,g,c,f,x.commandKeyChain,x.commandCertificateName,l)};null==this.connectionInfo?null==this.getConnectionInfo?console.log("ERROR: connectionInfo is NOT SET"):this.connectAndExecute(m):m();return F};aa.getMaxNdnPacketSize=function(){return M.MAX_NDN_PACKET_SIZE};aa.RegisterResponse=function(a,b,c,f,g,l){this.prefix=a;this.onRegisterFailed=b;this.onRegisterSuccess=
c;this.registeredPrefixId=f;this.parent=g;this.onInterest=l};aa.RegisterResponse.prototype.onData=function(a,b){var c=new wc;try{c.wireDecode(b.getContent(),fb.get())}catch(g){0<f&&console.log("Register prefix failed: Error decoding the NFD response: "+g);if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(l){console.log("Error in onRegisterFailed: "+M.getErrorWithStackTrace(l))}return}if(200!=c.getStatusCode()){if(0<f&&console.log("Register prefix failed: Expected NFD status code 200, got: "+
c.getStatusCode()),this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(m){console.log("Error in onRegisterFailed: "+M.getErrorWithStackTrace(m))}}else{if(0!=this.registeredPrefixId&&(c=0,null!=this.onInterest&&(c=this.parent.setInterestFilter(new Cc(this.prefix),this.onInterest)),!this.parent.registeredPrefixTable_.add(this.registeredPrefixId,this.prefix,c))){0<c&&this.parent.unsetInterestFilter(c);return}2<f&&console.log("Register prefix succeeded with the NFD forwarder for prefix "+
this.prefix.toUri());if(null!=this.onRegisterSuccess)try{this.onRegisterSuccess(this.prefix,this.registeredPrefixId)}catch(n){console.log("Error in onRegisterSuccess: "+M.getErrorWithStackTrace(n))}}};aa.RegisterResponse.prototype.onTimeout=function(a){2<f&&console.log("Timeout for NFD register prefix command.");if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(b){console.log("Error in onRegisterFailed: "+M.getErrorWithStackTrace(b))}};aa.prototype.nfdRegisterPrefix=function(a,
b,g,l,m,n,s,r,F){if(null==s)throw Error("registerPrefix: The command KeyChain has not been set. You must call setCommandSigningInfo.");if(0==r.size())throw Error("registerPrefix: The command certificate name has not been set. You must call setCommandSigningInfo.");var x=new Ua;x.setName(b);x.setForwardingFlags(l);null!=l.getOrigin()&&0<=l.getOrigin()&&(x.setOrigin(l.getOrigin()),x.getForwardingFlags().setOrigin(null));var P=this;this.isLocal(function(f){var l=new D;l.setCanBePrefix(!0);l.setMustBeFresh(!0);
f?(l.setName(new c("/localhost/nfd/rib/register")),l.setInterestLifetimeMilliseconds(2E3)):(l.setName(new c("/localhop/nfd/rib/register")),l.setInterestLifetimeMilliseconds(4E3));l.getName().append(x.wireEncode(fb.get()));P.nodeMakeCommandInterest(l,s,r,fb.get(),function(){var c=new aa.RegisterResponse(b,m,n,a,P,g);P.reconnectAndExpressInterest(null,l,c.onData.bind(c),c.onTimeout.bind(c),null,F)})},function(a){0<f&&console.log("Error in Transport.isLocal: "+a);if(m)try{m(b)}catch(c){console.log("Error in onRegisterFailed: "+
M.getErrorWithStackTrace(c))}})};aa.prototype.removeRegisteredPrefix=function(a){this.registeredPrefixTable_.removeRegisteredPrefix(a)};aa.prototype.setInterestFilter=function(a,b){var c=this.getNextEntryId();this.interestFilterTable_.setInterestFilter(c,new Cc(a),b,this);return c};aa.prototype.unsetInterestFilter=function(a){this.interestFilterTable_.unsetInterestFilter(a)};aa.prototype.putData=function(a,b){b=b||s.getDefaultWireFormat();if(!this.interestLoopbackEnabled_||!this.satisfyPendingInterests(a)){var c=
a.wireEncode(b);if(c.size()>aa.getMaxNdnPacketSize())throw Error("The encoded Data packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())}};aa.prototype.putNack=function(a,b){var c=aa.encodeLpNack_(a,b);if(c.size()>aa.getMaxNdnPacketSize())throw Error("The encoded Nack packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(c.buf())};aa.prototype.send=function(a){if(a.length>aa.getMaxNdnPacketSize())throw Error("The encoded packet size exceeds the maximum limit getMaxNdnPacketSize()");
this.transport.send(a)};aa.prototype.isLocal=function(a,b){null==this.connectionInfo?a(!1):this.transport.isLocal(this.connectionInfo,a,b)};aa.prototype.onReceivedElement=function(a){3<f&&console.log("Complete element received. Length "+a.length+". Start decoding.");var b=null;a[0]==n.LpPacket_LpPacket&&(b=new pd,fb.get().decodeLpPacket(b,a,!1),a=b.getFragmentWireEncoding().buf());var c=null,g=null;if(a[0]==n.Interest||a[0]==n.Data){var l=new oa(a);l.peekType(n.Interest,a.length)?(c=new D,c.wireDecode(a,
fb.get()),null!=b&&c.setLpPacket(b)):l.peekType(n.Data,a.length)&&(g=new R,g.wireDecode(a,fb.get()),null!=b&&g.setLpPacket(b))}if(null!==b&&(b.setFragmentWireEncoding(new m),a=ab.getFirstHeader(b),null!=a)){if(null==c)return;g=[];this.pendingInterestTable_.extractEntriesForNackInterest(c,g);for(c=0;c<g.length;++c){b=g[c];try{b.getOnNetworkNack()(b.getInterest(),a)}catch(s){console.log("Error in onNetworkNack: "+M.getErrorWithStackTrace(s))}}return}null!==c?(3<f&&console.log("Interest packet received."),
this.dispatchInterest_(c)):null!==g&&(3<f&&console.log("Data packet received."),this.satisfyPendingInterests_(g))};aa.prototype.dispatchInterest_=function(a){var b=[];this.interestFilterTable_.getMatchedFilters(a,b);for(var c=0;c<b.length;++c){var g=b[c];3<f&&console.log("Found interest filter for "+a.getName().toUri());try{g.getOnInterest()(g.getFilter().getPrefix(),a,this,g.getInterestFilterId(),g.getFilter())}catch(l){console.log("Error in onInterest: "+M.getErrorWithStackTrace(l))}}};aa.prototype.satisfyPendingInterests_=
function(a){var b=!1,c=[];this.pendingInterestTable_.extractEntriesForExpressedInterest(a,c);for(var f=0;f<c.length;++f){var g=c[f],b=!0;try{g.getOnData()(g.getInterest(),a)}catch(l){console.log("Error in onData: "+M.getErrorWithStackTrace(l))}}return b};aa.prototype.connectAndExecute=function(a){var b=this.getConnectionInfo();if(null==b)console.log("ERROR: No more connectionInfo from getConnectionInfo"),this.host=this.host=this.connectionInfo=null;else if(b.equals(this.connectionInfo))console.log("ERROR: The host returned by getConnectionInfo is not alive: "+
this.connectionInfo.toString());else{this.connectionInfo=b;0<f&&console.log("connectAndExecute: trying host from getConnectionInfo: "+this.connectionInfo.toString());this.host=this.connectionInfo.host;this.host=this.connectionInfo.port;b=new D(new c("/"));b.setInterestLifetimeMilliseconds(4E3);var g=this,l=setTimeout(function(){0<f&&console.log("connectAndExecute: timeout waiting for host "+g.host);g.connectAndExecute(a)},3E3);this.reconnectAndExpressInterest(null,b,function(b,c){clearTimeout(l);
0<f&&console.log("connectAndExecute: connected to host "+g.host);a()},function(a){},null,s.getDefaultWireFormat())}};aa.prototype.closeByTransport=function(){this.readyStatus=aa.CLOSED;this.onclose()};aa.encodeLpNack_=function(a,b){var c=new ra(256),f=c.getLength();c.writeBlobTlv(n.LpPacket_Fragment,a.wireEncode(fb.get()).buf());var g;if(b.getReason()==ab.Reason.NONE||b.getReason()==ab.Reason.CONGESTION||b.getReason()==ab.Reason.DUPLICATE||b.getReason()==ab.Reason.NO_ROUTE)g=b.getReason();else if(b.getReason()==
ab.Reason.OTHER_CODE)g=b.getOtherReasonCode();else throw Error("unrecognized NetworkNack.getReason() value");var l=c.getLength();c.writeNonNegativeIntegerTlv(n.LpPacket_NackReason,g);c.writeTypeAndLength(n.LpPacket_Nack,c.getLength()-l);c.writeTypeAndLength(n.LpPacket_LpPacket,c.getLength()-f);return new m(c.getOutput(),!1)};aa.nonceTemplate_=new m(new g(4),!1);new aa(new wb,{equals:function(){return!0}});var Ke={};Object.keys(a).forEach(function(b){Ke[b]=na[b];na[b]=a[b]});a.noConflict=function(){Object.keys(Ke).forEach(function(b){na[b]===
a[b]&&("undefined"==typeof Ke[b]?delete na[b]:na[b]=Ke[b])});return a};na.ndn=a})(this);
(function(na,u,J){function T(g,u){"object"!==typeof u&&(u=u());Object.keys(u).forEach(function(E){g[E]=u[E]});return g}function U(g){return{from:function(u){g.prototype=Object.create(u.prototype);g.prototype.constructor=g;return{extend:function(E){T(g.prototype,"object"!==typeof E?E(u.prototype):E)}}}}}function X(g,u){return u(g)}function K(x,u){function E(a){this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null};this.stores({})}function fc(g,c,m,n){if(0===g){Object.keys(da).forEach(function(a){r(c,
a,da[a].primKey,da[a].indexes)});var s=L._createTransaction(b,dd,da);s.idbtrans=c;s.idbtrans.onerror=Qa(m,["populating database"]);s.on("error").subscribe(m);S.newPSD(function(){S.PSD.trans=s;try{L.on("populate").fire(s)}catch(a){n.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();m(a)}})}else{var x=[],f=Db.filter(function(a){return a._cfg.version===g})[0];if(!f)throw new Ma("Dexie specification of currently installed DB version is missing");da=L._dbSchema=f._cfg.dbschema;
var z=!1;Db.filter(function(a){return a._cfg.version>g}).forEach(function(f){var g=da,n=f._cfg.dbschema;Oc(g,c);Oc(n,c);da=L._dbSchema=n;g=a(g,n);g.add.forEach(function(a){x.push(function(b,c){r(b,a[0],a[1].primKey,a[1].indexes);c()})});g.change.forEach(function(a){if(a.recreate)throw new Ma("Not yet support for changing primary key");x.push(function(b,c){var f=b.objectStore(a.name);a.add.forEach(function(a){Zb(f,a)});a.change.forEach(function(a){f.deleteIndex(a.name);Zb(f,a)});a.del.forEach(function(a){f.deleteIndex(a)});
c()})});f._cfg.contentUpgrade&&x.push(function(a,c){z=!0;var g=L._createTransaction(b,[].slice.call(a.db.objectStoreNames,0),n);g.idbtrans=a;var s=0;g._promise=X(g._promise,function(a){return function(b,f,g){function l(a){return function(){a.apply(this,arguments);0===--s&&c()}}++s;return a.call(this,b,function(a,b,c){arguments[0]=l(a);arguments[1]=l(b);f.apply(this,arguments)},g)}});a.onerror=Qa(m,["running upgrader function for version",f._cfg.version]);g.on("error").subscribe(m);f._cfg.contentUpgrade(g);
0===s&&c()});z&&(0<=navigator.userAgent.indexOf("Trident")||0<=navigator.userAgent.indexOf("MSIE"))||x.push(function(a,b){for(var c=0;c<a.db.objectStoreNames.length;++c){var f=a.db.objectStoreNames[c];null!==n[f]&&n[f]!==J||a.db.deleteObjectStore(f)}b()})});var P=function(){try{x.length?x.shift()(c,P):na(da,c)}catch(a){n.onerror=c.onerror=function(a){a.preventDefault()};try{c.abort()}catch(b){}c.db.close();m(a)}};P()}}function a(a,b){var g={del:[],add:[],change:[]},m;for(m in a)b[m]||g.del.push(m);
for(m in b){var n=a[m],r=b[m];if(n){var f={name:m,def:b[m],recreate:!1,del:[],add:[],change:[]};if(n.primKey.src!==r.primKey.src)f.recreate=!0,g.change.push(f);else{var n=n.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),r=r.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),x;for(x in n)r[x]||f.del.push(x);for(x in r){var P=n[x],l=r[x];P?P.src!==l.src&&f.change.push(l):f.add.push(l)}(f.recreate||0<f.del.length||0<f.add.length||0<f.change.length)&&g.change.push(f)}}else g.add.push([m,r])}return g}
function r(a,b,g,m){var n=a.db.createObjectStore(b,g.keyPath?{keyPath:g.keyPath,autoIncrement:g.auto}:{autoIncrement:g.auto});m.forEach(function(a){Zb(n,a)});return n}function na(a,b){Object.keys(a).forEach(function(g){b.db.objectStoreNames.contains(g)||r(b,g,a[g].primKey,a[g].indexes)})}function Zb(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function Kd(a,b){throw new Ma("Table "+b[0]+" not part of transaction. Original Scope Function Source: "+K.Promise.PSD.trans.scopeFunc.toString());
}function Xb(a,b,g,m){this.name=a;this.schema=g;this.hook=M[a]?M[a].hook:sd(null,{creating:[Td,A],reading:[qd,Sd],updating:[se,A],deleting:[ve,A]});this._tpf=b;this._collClass=m||Cb}function Fd(a,b,g,m){Xb.call(this,a,b,g,m||Pa)}function Gd(a,b,g,m){function n(a,b,c,f){return r._promise(a,c,f)}var r=this;this.db=L;this.mode=a;this.storeNames=b;this.idbtrans=null;this.on=sd(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=!0;this._dbschema=g;m&&(this.parent=
m);this._tpf=n;this.tables=Object.create(td);for(m=b.length-1;-1!==m;--m){var f=b[m],x=L._tableFactory(a,g[f],n);this.tables[f]=x;this[f]||(this[f]=x)}}function Ac(a,b,g){this._ctx={table:a,index:":id"===b?null:b,collClass:a._collClass,or:g}}function Cb(a,b){var g=null,m=null;if(b)try{g=b()}catch(n){m=n}var r=a._ctx;this._ctx={table:r.table,index:r.index,isPrimKey:!r.index||r.table.schema.primKey.keyPath&&r.index===r.table.schema.primKey.name,range:g,op:"openCursor",dir:"next",unique:"",algorithm:null,
filter:null,isMatch:null,offset:0,limit:Infinity,error:m,or:r.or}}function Pa(){Cb.apply(this,arguments)}function bd(a,b){return a._cfg.version-b._cfg.version}function Nc(a,b,g,m,n,r){g.forEach(function(f){var g=L._tableFactory(m,n[f],b);a.forEach(function(a){a[f]||(r?Object.defineProperty(a,f,{configurable:!0,enumerable:!0,get:function(){var a=S.PSD&&S.PSD.trans;return a&&a.db===L?a.tables[f]:g}}):a[f]=g)})})}function kc(a){a.forEach(function(a){for(var b in a)a[b]instanceof Xb&&delete a[b]})}function Qb(a,
b,g,m,n,r){var f=S.PSD;r=r||Sd;a.onerror||(a.onerror=Qa(n));a.onsuccess=b?ga(function(f){var x=a.result;if(x){var l=function(){x.continue()};b(x,function(a){l=a},m,n)&&g(r(x.value),x,function(a){l=a});l()}else m()},n,f):ga(function(b){var c=a.result;if(c){var f=function(){c.continue()};g(r(c.value),c,function(a){f=a});f()}else m()},n,f)}function z(a){var b=[];a.split(",").forEach(function(a){a=a.trim();var g=a.replace("&","").replace("++","").replace("*",""),m=0!==g.indexOf("[")?g:a.substring(a.indexOf("[")+
1,a.indexOf("]")).split("+");b.push(new $c(g,m||null,-1!==a.indexOf("&"),-1!==a.indexOf("*"),-1!==a.indexOf("++"),Array.isArray(m),-1!==m.indexOf(".")))});return b}function H(a,b){return a<b?-1:a>b?1:0}function Ud(a,b){return a<b?1:a>b?-1:0}function Bc(a){return function(b,g){for(var m=0;;){var n=a(b[m],g[m]);if(0!==n)return n;++m;if(m===b.length||m===g.length)return a(b.length,g.length)}}}function Yb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}function Pb(){L.verno=
m.version/10;L._dbSchema=da={};dd=[].slice.call(m.objectStoreNames,0);if(0!==dd.length){var a=m.transaction(Lc(dd),"readonly");dd.forEach(function(b){for(var g=a.objectStore(b),m=g.keyPath,n=m&&"string"===typeof m&&-1!==m.indexOf("."),r=new $c(m,m||"",!1,!1,!!g.autoIncrement,m&&"string"!==typeof m,n),f=[],x=0;x<g.indexNames.length;++x){var P=g.index(g.indexNames[x]),n=(m=P.keyPath)&&"string"===typeof m&&-1!==m.indexOf("."),m=new $c(P.name,m,!!P.unique,!!P.multiEntry,!1,m&&"string"!==typeof m,n);f.push(m)}da[b]=
new ad(b,r,f,{})});Nc([M],L._transPromiseFactory,Object.keys(da),b,da)}}function Oc(a,b){for(var g=b.db.objectStoreNames,m=0;m<g.length;++m)for(var n=g[m],r=b.objectStore(n),f=0;f<r.indexNames.length;++f){var x=r.indexNames[f],P=r.index(x).keyPath,P="string"===typeof P?P:"["+[].slice.call(P).join("+")+"]";a[n]&&(P=a[n].idxByName[P])&&(P.name=x)}}var $b=u&&u.addons||K.addons,vb=K.dependencies,Kb=vb.indexedDB,O=vb.IDBKeyRange,cd=vb.TypeError,Ma=vb.Error,da=this._dbSchema={},Db=[],dd=[],M={},td={},m=
null,bb=!0,eb=null,pa=!1,b="readwrite",L=this,n=[],ra=!1,oa=!!g();this.version=function(a){if(m)throw new Ma("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=Db.filter(function(b){return b._cfg.version===a})[0];if(b)return b;b=new E(a);Db.push(b);Db.sort(bd);return b};T(E.prototype,{stores:function(a){this._cfg.storesSource=this._cfg.storesSource?T(this._cfg.storesSource,a):a;var c={};Db.forEach(function(a){T(c,a._cfg.storesSource)});a=this._cfg.dbschema={};this._parseStoresSpec(c,
a);da=L._dbSchema=a;kc([M,L,td]);Nc([td],Kd,Object.keys(a),b,a);Nc([M,L,this._cfg.tables],L._transPromiseFactory,Object.keys(a),b,a,!0);dd=Object.keys(a);return this},upgrade:function(a){var c=this;va(function(){a(L._createTransaction(b,Object.keys(c._cfg.dbschema),c._cfg.dbschema))});this._cfg.contentUpgrade=a;return this},_parseStoresSpec:function(a,b){Object.keys(a).forEach(function(g){if(null!==a[g]){var m={},n=z(a[g]),r=n.shift();if(r.multi)throw new Ma("Primary key cannot be multi-valued");
r.keyPath&&r.auto&&Ob(m,r.keyPath,0);n.forEach(function(a){if(a.auto)throw new Ma("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new Ma("Index must have a name and cannot be an empty string");Ob(m,a.keyPath,a.compound?a.keyPath.map(function(){return""}):"")});b[g]=new ad(g,r,n,m)}})}});this._allTables=M;this._tableFactory=function(a,b,g){return"readonly"===a?new Xb(b.name,g,b,Cb):new Fd(b.name,g,b)};this._createTransaction=function(a,b,g,m){return new Gd(a,b,g,m)};this._transPromiseFactory=
function(a,b,g){if(!bb||S.PSD&&S.PSD.letThrough){var m=L._createTransaction(a,b,da);return m._promise(a,function(a,b){m.error(function(a){L.on("error").fire(a)});g(function(b){m.complete(function(){a(b)})},b,m)})}var r=new S(function(m,f){n.push({resume:function(){var n=L._transPromiseFactory(a,b,g);r.onuncatched=n.onuncatched;n.then(m,f)}})});return r};this._whenReady=function(a){return!bb||S.PSD&&S.PSD.letThrough?new S(a):new S(function(b,g){va(function(){new S(function(){a(b,g)})});n.push({resume:function(){a(b,
g)}})})};this.verno=0;this.open=function(){return new S(function(a,b){function g(a){try{r.transaction.abort()}catch(f){}pa=!1;eb=a;bb=!1;b(eb);n.forEach(function(a){a.resume()});n=[]}if(m||pa)throw new Ma("Database already opened or being opened");var r;try{eb=null;pa=!0;0===Db.length&&(ra=!0);if(!Kb)throw new Ma("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");r=ra?Kb.open(x):Kb.open(x,
Math.round(10*L.verno));r.onerror=Qa(g,["opening database",x]);r.onblocked=function(a){L.on("blocked").fire(a)};r.onupgradeneeded=ga(function(a){ra&&!L._allowEmptyDB?(r.onerror=function(a){a.preventDefault()},r.transaction.abort(),r.result.close(),a=Kb.deleteDatabase(x),a.onsuccess=a.onerror=function(){g(new Ma("Database '"+x+"' doesnt exist"))}):(r.transaction.onerror=Qa(g),a=a.oldVersion>Math.pow(2,62)?0:a.oldVersion,fc(a/10,r.transaction,g,r))},g);r.onsuccess=ga(function(b){pa=!1;m=r.result;ra?
Pb():0<m.objectStoreNames.length&&Oc(da,m.transaction(Lc(m.objectStoreNames),"readonly"));m.onversionchange=L.on("versionchange").fire;oa||Wd(function(a){if(-1===a.indexOf(x))return a.push(x)});S.newPSD(function(){function b(){bb=!1;n.forEach(function(a){a.resume()});n=[];a()}S.PSD.letThrough=!0;try{var c=L.on.ready.fire();c&&"function"===typeof c.then?c.then(b,function(a){m.close();m=null;g(a)}):Hd(b)}catch(r){g(r)}})},g)}catch(s){g(s)}})};this.close=function(){m&&(m.close(),m=null,bb=!0,eb=null)};
this.delete=function(){var a=arguments;return new S(function(b,g){function m(){L.close();var a=Kb.deleteDatabase(x);a.onsuccess=function(){oa||Wd(function(a){var b=a.indexOf(x);if(0<=b)return a.splice(b,1)});b()};a.onerror=Qa(g,["deleting",x]);a.onblocked=function(){L.on("blocked").fire()}}if(0<a.length)throw new Ma("Arguments not allowed in db.delete()");pa?n.push({resume:m}):m()})};this.backendDB=function(){return m};this.isOpen=function(){return null!==m};this.hasFailed=function(){return null!==
eb};this.dynamicallyOpened=function(){return ra};this.name=x;Object.defineProperty(this,"tables",{get:function(){return Object.keys(M).map(function(a){return M[a]})}});this.on=sd(this,"error","populate","blocked",{ready:[ce,A],versionchange:[ue,A]});this.on.ready.subscribe=X(this.on.ready.subscribe,function(a){return function(b,g){function m(){g||L.on.ready.unsubscribe(m);return b.apply(this,arguments)}a.call(this,m);L.isOpen()&&(bb?n.push({resume:m}):m())}});va(function(){L.on("populate").fire(L._createTransaction(b,
dd,da));L.on("error").fire(new Ma)});this.transaction=function(a,c,g){function m(b,c){var r=null;try{if(f)throw f;var r=L._createTransaction(a,x,da,n),z=x.map(function(a){return r.tables[a]});z.push(r);var u,E=0;S.newPSD(function(){S.PSD.trans=r;r.scopeFunc=g;n&&(r.idbtrans=n.idbtrans,r._promise=X(r._promise,function(a){return function(b,c,f){function g(a){return function(b){var c;S._rootExec(function(){c=a(b);S._tickFinalize(function(){0===--E&&r.active&&(r.active=!1,r.on.complete.fire())})});return c}}
++E;return a.call(this,b,function(a,b,f){return c(g(a),g(b),f)},f)}}));r.complete(function(){b(u)});r.error(function(a){r.idbtrans&&(r.idbtrans.onerror=Vd);try{r.abort()}catch(b){}n&&(n.active=!1,n.on.error.fire(a));var f=c(a);n||f||L.on.error.fire(a)});S._rootExec(function(){u=g.apply(r,z)})});(!r.idbtrans||n&&0===E)&&r._nop()}catch(H){r&&r.idbtrans&&(r.idbtrans.onerror=Vd),r&&r.abort(),n&&n.on.error.fire(H),Hd(function(){c(H)||L.on("error").fire(H)})}}c=[].slice.call(arguments,1,arguments.length-
1);g=arguments[arguments.length-1];var n=S.PSD&&S.PSD.trans;n&&n.db===L&&-1===a.indexOf("!")||(n=null);var r=-1!==a.indexOf("?");a=a.replace("!","").replace("?","");var f=null,x=(Array.isArray(c[0])?c.reduce(function(a,b){return a.concat(b)}):c).map(function(a){if("string"===typeof a)return a;a instanceof Xb||(f=f||new cd("Invalid type. Arguments following mode must be instances of Table or String"));return a.name});"r"==a||"readonly"==a?a="readonly":"rw"==a||a==b?a=b:f=new Ma("Invalid transaction mode: "+
a);n&&!f&&(n&&"readonly"===n.mode&&a===b&&(r?n=null:f=f||new Ma("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY")),n&&x.forEach(function(a){n.tables.hasOwnProperty(a)||(r?n=null:f=f||new Ma("Table "+a+" not included in parent transaction. Parent Transaction function: "+n.scopeFunc.toString()))}));return n?n._promise(a,m,"lock"):L._whenReady(m)};this.table=function(a){if(!ra&&!M.hasOwnProperty(a))throw new Ma("Table does not exist");return M[a]};T(Xb.prototype,
function(){function a(){throw new Ma("Current Transaction is READONLY");}return{_trans:function(a,b,g){return this._tpf(a,[this.name],b,g)},_idbstore:function(a,b,g){var m=this;return this._tpf(a,[this.name],function(a,c,g){b(a,c,g.idbtrans.objectStore(m.name),g)},g)},get:function(a,b){var g=this;va(function(){b(g.schema.instanceTemplate)});return this._idbstore("readonly",function(b,m,f){var n=f.get(a);n.onerror=Qa(m,["getting",a,"from",g.name]);n.onsuccess=function(){b(g.hook.reading.fire(n.result))}}).then(b)},
where:function(a){return new Ac(this,a)},count:function(a){return this.toCollection().count(a)},offset:function(a){return this.toCollection().offset(a)},limit:function(a){return this.toCollection().limit(a)},reverse:function(){return this.toCollection().reverse()},filter:function(a){return this.toCollection().and(a)},each:function(a){var b=this;va(function(){a(b.schema.instanceTemplate)});return this._idbstore("readonly",function(g,m,n){n=n.openCursor();n.onerror=Qa(m,["calling","Table.each()","on",
b.name]);Qb(n,null,a,g,m,b.hook.reading.fire)})},toArray:function(a){var b=this;va(function(){a([b.schema.instanceTemplate])});return this._idbstore("readonly",function(a,c,g){var f=[];g=g.openCursor();g.onerror=Qa(c,["calling","Table.toArray()","on",b.name]);Qb(g,null,function(a){f.push(a)},function(){a(f)},c,b.hook.reading.fire)}).then(a)},orderBy:function(a){return new this._collClass(new Ac(this,a))},toCollection:function(){return new this._collClass(new Ac(this))},mapToClass:function(a,b){this.schema.mappedClass=
a;var g=Object.create(a.prototype);this.schema.primKey.keyPath&&(Ob(g,this.schema.primKey.keyPath,this.schema.primKey.auto?0:""),we(a.prototype,this.schema.primKey.keyPath));b&&zc(g,b);this.schema.instanceTemplate=g;g=Object.setPrototypeOf?function(b){if(!b)return b;Object.setPrototypeOf(b,a.prototype);return b}:function(b){if(!b)return b;var g=Object.create(a.prototype),f;for(f in b)b.hasOwnProperty(f)&&(g[f]=b[f]);return g};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);
this.schema.readHook=g;this.hook("reading",g);return a},defineClass:function(a){return this.mapToClass(K.defineClass(a),a)},add:a,put:a,"delete":a,clear:a,update:a}});U(Fd).from(Xb).extend(function(){return{add:function(a,c){var g=this,m=this.hook.creating.fire;return this._idbstore(b,function(b,n,f,r){var x={};if(m!==A){var l=c||(f.keyPath?ja(a,f.keyPath):J);r=m.call(x,l,a,r);l===J&&r!==J&&(f.keyPath?Ob(a,f.keyPath,r):c=r)}var z=c?f.add(a,c):f.add(a);z.onerror=Qa(function(a){if(x.onerror)x.onerror(a);
return n(a)},["adding",a,"into",g.name]);z.onsuccess=function(c){var g=f.keyPath;g&&Ob(a,g,c.target.result);if(x.onsuccess)x.onsuccess(c.target.result);b(z.result)}})},put:function(a,c){var g=this,m=this.hook.updating.fire;return this.hook.creating.fire!==A||m!==A?this._trans(b,function(b,m,f){var n=c||g.schema.primKey.keyPath&&ja(a,g.schema.primKey.keyPath);n===J?f.tables[g.name].add(a).then(b,m):(f._lock(),a=Zc(a),f.tables[g.name].where(":id").equals(n).modify(function(b){this.value=a}).then(function(b){return 0===
b?f.tables[g.name].add(a,c):n}).finally(function(){f._unlock()}).then(b,m))}):this._idbstore(b,function(b,m,f){var n=c?f.put(a,c):f.put(a);n.onerror=Qa(m,["putting",a,"into",g.name]);n.onsuccess=function(c){var g=f.keyPath;g&&Ob(a,g,c.target.result);b(n.result)}})},"delete":function(a){return this.hook.deleting.subscribers.length?this.where(":id").equals(a).delete():this._idbstore(b,function(b,g,m){var n=m.delete(a);n.onerror=Qa(g,["deleting",a,"from",m.name]);n.onsuccess=function(a){b(n.result)}})},
clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(b,function(a,b,g){var m=g.clear();m.onerror=Qa(b,["clearing",g.name]);m.onsuccess=function(b){a(m.result)}})},update:function(a,b){if("object"!==typeof b||Array.isArray(b))throw new Ma("db.update(keyOrObject, modifications). modifications must be an object.");if("object"!==typeof a||Array.isArray(a))return this.where(":id").equals(a).modify(b);Object.keys(b).forEach(function(g){Ob(a,g,b[g])});
var g=ja(a,this.schema.primKey.keyPath);g===J&&S.reject(new Ma("Object does not contain its primary key"));return this.where(":id").equals(g).modify(b)}}});T(Gd.prototype,{_lock:function(){++this._reculock;1===this._reculock&&S.PSD&&(S.PSD.lockOwnerFor=this);return this},_unlock:function(){if(0===--this._reculock)for(S.PSD&&(S.PSD.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{a()}catch(b){}}return this},_locked:function(){return this._reculock&&
(!S.PSD||S.PSD.lockOwnerFor!==this)},_nop:function(a){this.tables[this.storeNames[0]].get(0).then(a)},_promise:function(a,b,g){var n=this;return S.newPSD(function(){var r;n._locked()?r=new S(function(m,f){n._blockedFuncs.push(function(){n._promise(a,b,g).then(m,f)})}):(r=n.active?new S(function(r,f){if(!n.idbtrans&&a){if(!m)throw eb?new Ma("Database not open. Following error in populate, ready or upgrade function made Dexie.open() fail: "+eb):new Ma("Database not open");var s=n.idbtrans=m.transaction(Lc(n.storeNames),
n.mode);s.onerror=function(a){n.on("error").fire(a&&a.target.error);a.preventDefault();n.abort()};s.onabort=function(a){n.active=!1;n.on("abort").fire(a)};s.oncomplete=function(a){n.active=!1;n.on("complete").fire(a)}}g&&n._lock();try{b(r,f,n)}catch(x){K.ignoreTransaction(function(){n.on("error").fire(x)}),n.abort(),f(x)}}):S.reject(Le(new Ma("Transaction is inactive. Original Scope Function Source: "+n.scopeFunc.toString()))),n.active&&g&&r.finally(function(){n._unlock()}));r.onuncatched=function(a){K.ignoreTransaction(function(){n.on("error").fire(a)});
n.abort()};return r})},complete:function(a){return this.on("complete",a)},error:function(a){return this.on("error",a)},abort:function(){if(this.idbtrans&&this.active)try{this.active=!1,this.idbtrans.abort(),this.on.error.fire(new Ma("Transaction Aborted"))}catch(a){}},table:function(a){if(!this.tables.hasOwnProperty(a))throw new Ma("Table "+a+" not in transaction");return this.tables[a]}});T(Ac.prototype,function(){function a(b,c){try{throw c;}catch(g){b._ctx.error=g}return b}function b(a){return Array.prototype.slice.call(1===
a.length&&Array.isArray(a[0])?a[0]:a)}function g(a){return"next"===a?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function m(a){return"next"===a?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function n(a,b,c,g,m,r){for(var s=Math.min(a.length,g.length),x=-1,z=0;z<s;++z){var u=b[z];if(u!==g[z])return 0>m(a[z],c[z])?a.substr(0,z)+c[z]+c.substr(z+1):0>m(a[z],g[z])?a.substr(0,z)+g[z]+c.substr(z+1):0<=x?a.substr(0,x)+b[x]+c.substr(x+1):null;0>m(a[z],
u)&&(x=z)}return s<g.length&&"next"===r?a+c.substr(a.length):s<a.length&&"prev"===r?a.substr(0,c.length):0>x?null:a.substr(0,x)+g[x]+c.substr(x+1)}function r(a,b,c){function l(a){x=g(a);z=m(a);u="next"===a?H:Ud;F=x(c);E=z(c);Mc=a}var x,z,u,F,E,Mc;l("next");a._ondirectionchange=function(a){l(a)};a._addAlgorithm(function(a,c,f){var g=a.key;if("string"!==typeof g)return!1;var l=z(g);if(b(l,E))return c(function(){a.continue()}),!0;var m=n(g,l,F,E,u,Mc);m?c(function(){a.continue(m)}):c(f);return!1})}return{between:function(a,
b,c,g){c=!1!==c;g=!0===g;return a>b||a===b&&!(!c&&!g||c&&g)?(new this._ctx.collClass(this,function(){return O.only(a)})).limit(0):new this._ctx.collClass(this,function(){return O.bound(a,b,!c,!g)})},equals:function(a){return new this._ctx.collClass(this,function(){return O.only(a)})},above:function(a){return new this._ctx.collClass(this,function(){return O.lowerBound(a,!0)})},aboveOrEqual:function(a){return new this._ctx.collClass(this,function(){return O.lowerBound(a)})},below:function(a){return new this._ctx.collClass(this,
function(){return O.upperBound(a,!0)})},belowOrEqual:function(a){return new this._ctx.collClass(this,function(){return O.upperBound(a)})},startsWith:function(b){return"string"!==typeof b?a(new this._ctx.collClass(this),new cd("String expected")):this.between(b,b+String.fromCharCode(65535),!0,!0)},startsWithIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new cd("String expected"));if(""===b)return this.startsWith(b);var c=new this._ctx.collClass(this,function(){return O.bound(b.toUpperCase(),
b.toLowerCase()+String.fromCharCode(65535))});r(c,function(a,b){return 0===a.indexOf(b)},b);c._ondirectionchange=function(){a(c,new Ma("reverse() not supported with WhereClause.startsWithIgnoreCase()"))};return c},equalsIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new cd("String expected"));var c=new this._ctx.collClass(this,function(){return O.bound(b.toUpperCase(),b.toLowerCase())});r(c,function(a,b){return a===b},b);return c},anyOf:function(a){var g=this._ctx,
m=g.table.schema,l=(g=g.index?m.idxByName[g.index]:m.primKey)&&g.compound,n=b(arguments),r=l?Bc(H):H;n.sort(r);if(0===n.length)return(new this._ctx.collClass(this,function(){return O.only("")})).limit(0);g=new this._ctx.collClass(this,function(){return O.bound(n[0],n[n.length-1])});g._ondirectionchange=function(a){r="next"===a?H:Ud;l&&(r=Bc(r));n.sort(r)};var s=0;g._addAlgorithm(function(a,b,c){for(var f=a.key;0<r(f,n[s]);)if(++s,s===n.length)return b(c),!1;if(0===r(f,n[s]))return b(function(){a.continue()}),
!0;b(function(){a.continue(n[s])});return!1});return g}}});T(Cb.prototype,function(){function a(b,c){b.filter=Yb(b.filter,c)}function c(a,b){a.isMatch=Yb(a.isMatch,b)}function g(a,b){if(a.isPrimKey)return b;var c=a.table.schema.idxByName[a.index];if(!c)throw new Ma("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return a.isPrimKey?b:b.index(c.name)}function m(a,b){return g(a,b)[a.op](a.range||null,a.dir+a.unique)}function n(a,b,c,g,r){a.or?function(){function n(){2===++u&&c()}function s(a,
c,f){if(!x||x(c,f,n,g)){var m=c.primaryKey.toString();z.hasOwnProperty(m)||(z[m]=!0,b(a,c,f))}}var x=a.filter,z={},u=0;a.or._iterate(s,n,g,r);Qb(m(a,r),a.algorithm,s,n,g,a.table.hook.reading.fire)}():Qb(m(a,r),Yb(a.algorithm,a.filter),b,c,g,a.table.hook.reading.fire)}function r(a){return a.table.schema.instanceTemplate}return{_read:function(a,b){var c=this._ctx;return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore("readonly",a).then(b)},_write:function(a){var c=this._ctx;
return c.error?c.table._trans(null,function(a,b){b(c.error)}):c.table._idbstore(b,a,"locked")},_addAlgorithm:function(a){var b=this._ctx;b.algorithm=Yb(b.algorithm,a)},_iterate:function(a,b,c,g){return n(this._ctx,a,b,c,g)},each:function(a){var b=this._ctx;va(function(){a(r(b))});return this._read(function(c,g,m){n(b,a,c,g,m)})},count:function(a){va(function(){a(0)});var b=this,c=this._ctx;if(c.filter||c.algorithm||c.or){var l=0;return this._read(function(a,b,f){n(c,function(){++l;return!1},function(){a(l)},
b,f)},a)}return this._read(function(a,f,l){l=g(c,l);l=c.range?l.count(c.range):l.count();l.onerror=Qa(f,["calling","count()","on",b.name]);l.onsuccess=function(b){a(Math.min(b.target.result,Math.max(0,c.limit-c.offset)))}},a)},sortBy:function(a,b){function c(a,b){return b?c(a[n[b]],b-1):a[s]}function g(a,b){var f=c(a,x),l=c(b,x);return f<l?-z:f>l?z:0}var m=this._ctx;va(function(){b([r(m)])});var n=a.split(".").reverse(),s=n[0],x=n.length-1,z="next"===this._ctx.dir?1:-1;return this.toArray(function(a){return a.sort(g)}).then(b)},
toArray:function(a){var b=this._ctx;va(function(){a([r(b)])});return this._read(function(a,c,f){var g=[];n(b,function(a){g.push(a)},function(){a(g)},c,f)},a)},offset:function(b){var c=this._ctx;if(0>=b)return this;c.offset+=b;c.or||c.algorithm||c.filter?a(c,function(a,c,g){return 0>--b}):a(c,function(a,c,g){if(0===b)return!0;if(1===b)return--b,!1;c(function(){a.advance(b);b=0});return!1});return this},limit:function(b){this._ctx.limit=Math.min(this._ctx.limit,b);a(this._ctx,function(a,c,g){0>=--b&&
c(g);return 0<=b});return this},until:function(b,c){var g=this._ctx;va(function(){b(r(g))});a(this._ctx,function(a,g,m){return b(a.value)?(g(m),c):!0});return this},first:function(a){var b=this;va(function(){a(r(b._ctx))});return this.limit(1).toArray(function(a){return a[0]}).then(a)},last:function(a){return this.reverse().first(a)},and:function(b){var g=this;va(function(){b(r(g._ctx))});a(this._ctx,function(a){return b(a.value)});c(this._ctx,b);return this},or:function(a){return new Ac(this._ctx.table,
a,this)},reverse:function(){this._ctx.dir="prev"===this._ctx.dir?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this},desc:function(){return this.reverse()},eachKey:function(a){var b=this,c=this._ctx;va(function(){a(r(b._ctx)[b._ctx.index])});c.isPrimKey||(c.op="openKeyCursor");return this.each(function(b,c){a(c.key,c)})},eachUniqueKey:function(a){this._ctx.unique="unique";return this.eachKey(a)},keys:function(a){va(function(){a([r(c)[b._ctx.index]])});var b=
this,c=this._ctx;c.isPrimKey||(c.op="openKeyCursor");var g=[];return this.each(function(a,b){g.push(b.key)}).then(function(){return g}).then(a)},uniqueKeys:function(a){this._ctx.unique="unique";return this.keys(a)},firstKey:function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)},lastKey:function(a){return this.reverse().firstKey(a)},distinct:function(){var b={};a(this._ctx,function(a){a=a.primaryKey.toString();var c=b.hasOwnProperty(a);b[a]=!0;return!c});return this}}});U(Pa).from(Cb).extend({modify:function(a){var b=
this,g=this._ctx,m=g.table.hook,n=m.updating.fire,r=m.deleting.fire;va(function(){"function"===typeof a&&a.call({value:g.table.schema.instanceTemplate},g.table.schema.instanceTemplate)});return this._write(function(f,m,x,l){function z(a){a&&(M.push(a),Nc.push(fc));return m(new Jd("Error modifying one or more objects",M,C,Nc))}function u(){O&&C+M.length===D&&(0<M.length?z():f(C))}var E;if("function"===typeof a)E=n===A&&r===A?a:function(b){var c=Zc(b);if(!1===a.call(this,b))return!1;if(this.hasOwnProperty("value")){var f=
Kc(c,this.value),g=n.call(this,f,this.primKey,c,l);g&&(b=this.value,Object.keys(g).forEach(function(a){Ob(b,a,g[a])}))}else r.call(this,this.primKey,b,l)};else if(n===A){var H=Object.keys(a),Mc=H.length;E=function(b){for(var c=!1,f=0;f<Mc;++f){var g=H[f],l=a[g];ja(b,g)!==l&&(Ob(b,g,l),c=!0)}return c}}else{var L=a;a=ee(L);E=function(b){var c=!1,f=n.call(this,a,this.primKey,Zc(b),l);f&&T(a,f);Object.keys(a).forEach(function(f){var g=a[f];ja(b,f)!==g&&(Ob(b,f,g),c=!0)});f&&(a=ee(L));return c}}var D=
0,C=0,O=!1,M=[],Nc=[],fc=null;b._iterate(function(a,b,c){fc=b.primaryKey;var f={primKey:b.primaryKey,value:a};if(!1!==E.call(f,a))b=(c=!f.hasOwnProperty("value"))?b.delete():b.update(f.value),++D,b.onerror=Qa(function(a){M.push(a);Nc.push(f.primKey);if(f.onerror)f.onerror(a);u();return!0},c?["deleting",a,"from",g.table.name]:["modifying",a,"on",g.table.name]),b.onsuccess=function(a){if(f.onsuccess)f.onsuccess(f.value);++C;u()};else if(f.onsuccess)f.onsuccess(f.value)},function(){O=!0;u()},z,x)})},
"delete":function(){return this.modify(function(){delete this.value})}});T(this,{Collection:Cb,Table:Xb,Transaction:Gd,Version:E,WhereClause:Ac,WriteableCollection:Pa,WriteableTable:Fd});(function(){L.on("versionchange",function(a){L.close();L.on("error").fire(new Ma("Database version changed by other database connection."))})})();$b.forEach(function(a){a(L)})}function A(){}function Sd(g){return g}function qd(g,u){return g===Sd?u:function(E){return u(g(E))}}function Kb(g,u){return function(){g.apply(this,
arguments);u.apply(this,arguments)}}function Td(g,u){return g===A?u:function(){var E=g.apply(this,arguments);E!==J&&(arguments[0]=E);var A=this.onsuccess,a=this.onerror;delete this.onsuccess;delete this.onerror;var r=u.apply(this,arguments);A&&(this.onsuccess=this.onsuccess?Kb(A,this.onsuccess):A);a&&(this.onerror=this.onerror?Kb(a,this.onerror):a);return r!==J?r:E}}function se(g,u){return g===A?u:function(){var E=g.apply(this,arguments);E!==J&&T(arguments[0],E);var A=this.onsuccess,a=this.onerror;
delete this.onsuccess;delete this.onerror;var r=u.apply(this,arguments);A&&(this.onsuccess=this.onsuccess?Kb(A,this.onsuccess):A);a&&(this.onerror=this.onerror?Kb(a,this.onerror):a);return E===J?r===J?J:r:r===J?E:T(E,r)}}function te(g,u){return g===A?u:function(){return!1===g.apply(this,arguments)?!1:u.apply(this,arguments)}}function ue(g,u){return g===A?u:function(){return!1===u.apply(this,arguments)?!1:g.apply(this,arguments)}}function ve(g,u){return g===A?u:function(){g.apply(this,arguments);u.apply(this,
arguments)}}function ce(g,u){return g===A?u:function(){var E=g.apply(this,arguments);if(E&&"function"===typeof E.then){var A=this,a=arguments;return E.then(function(){return u.apply(A,a)})}return u.apply(this,arguments)}}function sd(g,u){function E(g,r,x){if(Array.isArray(g))return a(g);if("object"===typeof g)return K(g);r||(r=te);x||(x=A);var u={subscribers:[],fire:x,subscribe:function(a){u.subscribers.push(a);u.fire=r(u.fire,a)},unsubscribe:function(a){u.subscribers=u.subscribers.filter(function(g){return g!==
a});u.fire=u.subscribers.reduce(r,x)}};return J[g]=S[g]=u}function K(a){Object.keys(a).forEach(function(g){var r=a[g];if(Array.isArray(r))E(g,a[g][0],a[g][1]);else if("asap"===r){var x=E(g,null,function(){var a=arguments;x.subscribers.forEach(function(g){Hd(function(){g.apply(na,a)})})});x.subscribe=function(a){-1===x.subscribers.indexOf(a)&&x.subscribers.push(a)};x.unsubscribe=function(a){a=x.subscribers.indexOf(a);-1!==a&&x.subscribers.splice(a,1)}}else throw Error("Invalid event config");})}function a(a){function g(){if(r)return!1;
r=!0}var r=!1;a.forEach(function(a){E(a).subscribe(g)})}var r=arguments,J={},S=function(a,r){if(r){var u=[].slice.call(arguments,1),E=J[a];E.subscribe.apply(E,u);return g}if("string"===typeof a)return J[a]};S.addEventType=E;for(var T=1,U=r.length;T<U;++T)E(r[T]);return S}function Hd(g){na.setImmediate?setImmediate(g):setTimeout(g,0)}function de(g){g=setTimeout(g,1E3);clearTimeout(g)}function ga(g,u,E){return function(){var A=S.PSD;S.PSD=E;try{g.apply(this,arguments)}catch(a){u(a)}finally{S.PSD=A}}}
function ja(g,u){if(g.hasOwnProperty(u))return g[u];if(!u)return g;if("string"!==typeof u){for(var E=[],A=0,a=u.length;A<a;++A){var r=ja(g,u[A]);E.push(r)}return E}E=u.indexOf(".");return-1!==E?(A=g[u.substr(0,E)],A===J?J:ja(A,u.substr(E+1))):J}function Ob(g,u,E){if(g&&u!==J)if("string"!==typeof u&&"length"in u){if(!("string"!==typeof E&&"length"in E))throw Error("Assertion failed");for(var A=0,a=u.length;A<a;++A)Ob(g,u[A],E[A])}else a=u.indexOf("."),-1!==a?(A=u.substr(0,a),u=u.substr(a+1),""===u?
E===J?delete g[A]:g[A]=E:((a=g[A])||(a=g[A]={}),Ob(a,u,E))):E===J?delete g[u]:g[u]=E}function we(g,u){Ob(g,u,J)}function ee(g){var u={},E;for(E in g)g.hasOwnProperty(E)&&(u[E]=g[E]);return u}function Zc(g){if(!g||"object"!==typeof g)return g;var u;if(Array.isArray(g)){u=[];for(var E=0,A=g.length;E<A;++E)u.push(Zc(g[E]))}else if(g instanceof Date)u=new Date,u.setTime(g.getTime());else for(E in u=g.constructor?Object.create(g.constructor.prototype):{},g)g.hasOwnProperty(E)&&(u[E]=Zc(g[E]));return u}
function Kc(g,u){var E={},A;for(A in g)g.hasOwnProperty(A)&&(u.hasOwnProperty(A)?g[A]!==u[A]&&JSON.stringify(g[A])!=JSON.stringify(u[A])&&(E[A]=u[A]):E[A]=J);for(A in u)u.hasOwnProperty(A)&&!g.hasOwnProperty(A)&&(E[A]=u[A]);return E}function Id(g){if("function"===typeof g)return new g;if(Array.isArray(g))return[Id(g[0])];if(g&&"object"===typeof g){var u={};zc(u,g);return u}return g}function zc(g,u){Object.keys(u).forEach(function(E){var A=Id(u[E]);g[E]=A})}function Qa(g,u){return function(E){var A=
E&&E.target.error||Error();if(u){var a=" occurred when "+u.map(function(a){switch(typeof a){case "function":return a();case "string":return a;default:return JSON.stringify(a)}}).join(" ");A.name?A.toString=function(){return A.name+a+(A.message?". "+A.message:"")}:A+=a}g(A);E&&(E.stopPropagation&&E.stopPropagation(),E.preventDefault&&E.preventDefault());return!1}}function Le(g){try{throw g;}catch(u){return u}}function Vd(g){g.preventDefault()}function Wd(g){var u,A=K.dependencies.localStorage;if(!A)return g([]);
try{u=JSON.parse(A.getItem("Dexie.DatabaseNames")||"[]")}catch(J){u=[]}g(u)&&A.setItem("Dexie.DatabaseNames",JSON.stringify(u))}function $c(g,u,A,J,a,r,K){this.name=g;this.keyPath=u;this.unique=A;this.multi=J;this.auto=a;this.compound=r;this.dotted=K;g="string"===typeof u?u:u&&"["+[].join.call(u,"+")+"]";this.src=(A?"&":"")+(J?"*":"")+(a?"++":"")+g}function ad(g,u,A,J){this.name=g;this.primKey=u||new $c;this.indexes=A||[new $c];this.instanceTemplate=J;this.mappedClass=null;this.idxByName=A.reduce(function(a,
g){a[g.name]=g;return a},{})}function Jd(g,u,A,J){this.name="ModifyError";this.failures=u;this.failedKeys=J;this.successCount=A;this.message=u.join("\n")}function Lc(g){return 1===g.length?g[0]:g}function g(){var g=K.dependencies.indexedDB,u=g&&(g.getDatabaseNames||g.webkitGetDatabaseNames);return u&&u.bind(g)}var S=function(){function g(a,r){Pa.push([a,X.call(arguments,1)])}function u(){var a=Pa;Pa=[];for(var g=0,r=a.length;g<r;++g){var x=a[g];x[0].apply(na,x[1])}}function E(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");
if("function"!==typeof a)throw new TypeError("not a function");this._value=this._state=null;this._deferreds=[];this._catched=!1;var g=this,u=!0;this._PSD=E.PSD;try{U(this,a,function(a){u?ja(r,g,a):r(g,a)},function(a){return u?(ja(K,g,a),!1):K(g,a)})}finally{u=!1}}function J(r,A){if(null===r._state)r._deferreds.push(A);else{var K=r._state?A.onFulfilled:A.onRejected;if(null===K)return(r._state?A.resolve:A.reject)(r._value);var z,H=va;va=!1;ja=g;try{var S=E.PSD;E.PSD=r._PSD;z=K(r._value);r._state||z&&
"function"===typeof z.then&&!1===z._state||a(r);A.resolve(z)}catch(T){if(!A.reject(T)&&r.onuncatched)try{r.onuncatched(T)}catch(U){}}finally{if(E.PSD=S,H){do{for(;0<Pa.length;)u();if(K=Qa.pop())try{K()}catch(X){}}while(0<Qa.length||0<Pa.length);ja=ga;va=!0}}}}function a(g){g._catched=!0;g._parent&&a(g._parent)}function r(a,g){var u=E.PSD;E.PSD=a._PSD;try{if(g===a)throw new TypeError("A promise cannot be resolved with itself.");!g||"object"!==typeof g&&"function"!==typeof g||"function"!==typeof g.then?
(a._state=!0,a._value=g,S.call(a)):U(a,function(a,r){g.then(a,r)},function(g){r(a,g)},function(g){K(a,g)})}catch(x){K(x)}finally{E.PSD=u}}function K(a,g){var r=E.PSD;E.PSD=a._PSD;a._state=!1;a._value=g;S.call(a);if(!a._catched)try{if(a.onuncatched)a.onuncatched(a._value);E.on.error.fire(a._value)}catch(u){}E.PSD=r;return a._catched}function S(){for(var a=0,g=this._deferreds.length;a<g;a++)J(this,this._deferreds[a]);this._deferreds=[]}function T(a,g,r,u){this.onFulfilled="function"===typeof a?a:null;
this.onRejected="function"===typeof g?g:null;this.resolve=r;this.reject=u}function U(a,g,r,u){var x=!1;try{g(function(a){x||(x=!0,r(a))},function(g){if(x)return a._catched;x=!0;return u(g)})}catch(A){if(!x)return u(A)}}var X=[].slice,ga="undefined"===typeof setImmediate?function(a,g,r,u){var x=arguments;setTimeout(function(){a.apply(na,X.call(x,1))},0)}:setImmediate,ja=ga,va=!0,Pa=[],Qa=[];E.on=sd(null,"error");E.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&Array.isArray(arguments[0])?
arguments[0]:arguments);return new E(function(g,r){function u(A,E){try{if(E&&("object"===typeof E||"function"===typeof E)){var J=E.then;if("function"===typeof J){J.call(E,function(a){u(A,a)},r);return}}a[A]=E;0===--x&&g(a)}catch(K){r(K)}}if(0===a.length)return g([]);for(var x=a.length,A=0;A<a.length;A++)u(A,a[A])})};E.prototype.then=function(a,g){var r=this,u=new E(function(u,x){null===r._state?J(r,new T(a,g,u,x)):ja(J,r,new T(a,g,u,x))});u._PSD=this._PSD;u.onuncatched=this.onuncatched;u._parent=
this;return u};E.prototype._then=function(a,g){J(this,new T(a,g,A,A))};E.prototype["catch"]=function(a){if(1===arguments.length)return this.then(null,a);var g=arguments[0],r=arguments[1];return"function"===typeof g?this.then(null,function(a){return a instanceof g?r(a):E.reject(a)}):this.then(null,function(a){return a&&a.name===g?r(a):E.reject(a)})};E.prototype["finally"]=function(a){return this.then(function(g){a();return g},function(g){a();return E.reject(g)})};E.prototype.onuncatched=null;E.resolve=
function(a){var g=new E(function(){});g._state=!0;g._value=a;return g};E.reject=function(a){var g=new E(function(){});g._state=!1;g._value=a;return g};E.race=function(a){return new E(function(g,r){a.map(function(a){a.then(g,r)})})};E.PSD=null;E.newPSD=function(a){var g=E.PSD;E.PSD=g?Object.create(g):{};try{return a()}finally{E.PSD=g}};E._rootExec=function(a){var r=va;va=!1;ja=g;try{a()}finally{if(r){do{for(;0<Pa.length;)u();if(a=Qa.pop())try{a()}catch(A){}}while(0<Qa.length||0<Pa.length);ja=ga;va=
!0}}};E._tickFinalize=function(a){if(va)throw Error("Not in a virtual tick");Qa.push(a)};return E}(),va=function(){};U(Jd).from(Error);K.delete=function(g){var u=new K(g);g=u.delete();g.onblocked=function(g){u.on("blocked",g);return this};return g};K.getDatabaseNames=function(u){return(new S(function(u,x){var A=g();A?(A=A(),A.onsuccess=function(a){u([].slice.call(a.target.result,0))},A.onerror=Qa(x)):Wd(function(a){u(a);return!1})})).then(u)};K.defineClass=function(g){function u(g){g&&T(this,g)}zc(u.prototype,
g);return u};K.ignoreTransaction=function(g){return S.newPSD(function(){S.PSD.trans=null;return g()})};K.spawn=function(){na.console&&console.warn("Dexie.spawn() is deprecated. Use Dexie.ignoreTransaction() instead.");return K.ignoreTransaction.apply(this,arguments)};K.vip=function(g){return S.newPSD(function(){S.PSD.letThrough=!0;return g()})};Object.defineProperty(K,"currentTransaction",{get:function(){return S.PSD&&S.PSD.trans||null}});K.Promise=S;K.derive=U;K.extend=T;K.override=X;K.events=sd;
K.getByKeyPath=ja;K.setByKeyPath=Ob;K.delByKeyPath=we;K.shallowClone=ee;K.deepClone=Zc;K.addons=[];K.fakeAutoComplete=va;K.asap=Hd;K.ModifyError=Jd;K.MultiModifyError=Jd;K.IndexSpec=$c;K.TableSchema=ad;var Pb=na.idbModules&&na.idbModules.shimIndexedDB?na.idbModules:{};K.dependencies={indexedDB:Pb.shimIndexedDB||na.indexedDB||na.mozIndexedDB||na.webkitIndexedDB||na.msIndexedDB,IDBKeyRange:Pb.IDBKeyRange||na.IDBKeyRange||na.webkitIDBKeyRange,IDBTransaction:Pb.IDBTransaction||na.IDBTransaction||na.webkitIDBTransaction,
Error:na.Error||String,SyntaxError:na.SyntaxError||String,TypeError:na.TypeError||String,DOMError:na.DOMError||String,localStorage:null!=("undefined"!==typeof chrome&&null!==chrome?chrome.storage:void 0)?null:na.localStorage};K.version=1.1;u("Dexie",K);de(function(){va=de})}).apply(null,"function"===typeof define&&define.amd?[self||window,function(na,u){define(na,function(){return u})}]:"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?[global,function(na,u){module.exports=
u}]:[self||window,function(na,u){(self||window)[na]=u}]);
